(window.webpackJsonp=window.webpackJsonp||[]).push([[218],{14602:function(s,n,a){"use strict";a.r(n);var t=a(2),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"_1-ansible-roles基本概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-ansible-roles基本概述"}},[s._v("#")]),s._v(" 1，ansible roles基本概述")]),s._v(" "),n("p",[n("code",[s._v("roles")]),s._v("不管是Ansible还是saltstack，我在写一键部署的时候，都不可能把所有的步骤全部写入到一个’剧本’文件当中，我们肯定需要把不同的工作模块，拆分开来，解耦，那么说到解耦，我们就需要用到"),n("code",[s._v("roles")]),s._v("官方推荐，因为"),n("code",[s._v("roles")]),s._v("的目录结构层次更加清晰。")]),s._v(" "),n("p",[s._v("例如：我们之前推荐大家写一个"),n("code",[s._v("base.yml")]),s._v("里面写所有基础优化的项目，其实把所有东西摞进去也是很鸡肋的，不如我们把这些功能全部拆分开，谁需要使用，就调用即可。")]),s._v(" "),n("p",[s._v("建议：每个roles最好只使用一个tasks这样方便我们去调用，能够很好的做到解耦。（SOA）")]),s._v(" "),n("p",[n("strong",[s._v("1.官方推荐最佳实践目录结构定义方式")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("production                "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# inventory file for production servers")]),s._v("\nstaging                   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# inventory file for staging environment")]),s._v("\n\ngroup_vars/\n   group1.yml             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# here we assign variables to particular groups")]),s._v("\n   group2.yml\nhost_vars/\n   hostname1.yml          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# here we assign variables to particular systems")]),s._v("\n   hostname2.yml\n\nlibrary/                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if any custom modules, put them here (optional)")]),s._v("\nmodule_utils/             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if any custom module_utils to support modules, put them here (optional)")]),s._v("\nfilter_plugins/           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if any custom filter plugins, put them here (optional)")]),s._v("\n\nsite.yml                  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master playbook")]),s._v("\nwebservers.yml            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# playbook for webserver tier")]),s._v("\ndbservers.yml             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# playbook for dbserver tier")]),s._v("\n\nroles/\n    common/               "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# this hierarchy represents a "role"')]),s._v("\n        tasks/            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            main.yml      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- tasks file can include smaller files if warranted")]),s._v("\n        handlers/         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            main.yml      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- handlers file")]),s._v("\n        templates/        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- files for use with the template resource")]),s._v("\n            ntp.conf.j2   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <------- templates end in .j2")]),s._v("\n        files/            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            bar.txt       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- files for use with the copy resource")]),s._v("\n            foo.sh        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- script files for use with the script resource")]),s._v("\n        vars/             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            main.yml      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- variables associated with this role")]),s._v("\n        defaults/         "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            main.yml      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- default lower priority variables for this role")]),s._v("\n        meta/             "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n            main.yml      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  <-- role dependencies")]),s._v("\n        library/          "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# roles can also include custom modules")]),s._v("\n        module_utils/     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# roles can also include custom module_utils")]),s._v("\n        lookup_plugins/   "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or other types of plugins, like lookup in this case")]),s._v("\n\n    webtier/              "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# same kind of structure as "common" was above, done for the webtier role')]),s._v("\n    monitoring/           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ""')]),s._v("\n    fooapp/               "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ""')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br")])]),n("h3",{attrs:{id:"_2-重构backup"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-重构backup"}},[s._v("#")]),s._v(" 2，重构backup")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mkdir roles")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cd roles/")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ansible-galaxy init backup")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll backup/")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" 09:43 files\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":01 handlers\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":06 tasks\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" 09:53 templates\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" 09:50 vars\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll backup/handlers/")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("79")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":01 main.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll backup/tasks/")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("821")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":06 main.yml\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll backup/vars/")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" 09:50 main.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat backup/tasks/main.yml ")]),s._v("\n- name: Install Rsyncd Server\n  yum:\n    name: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rsync")]),s._v("\n    state: present\n \n- name: Configure Rsync Server\n  template:\n    src: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.src }}"')]),s._v("\n    dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.dest }}"')]),s._v("\n    mode: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.mode }}"')]),s._v("\n  notify: Restart Rsyncd Server\n  loop:\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("src: rsyncd.conf.j2,dest: /etc/rsyncd.conf,mode: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0644'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("src: rsync.passwd,dest: /etc/rsync.passwd,mode: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0600'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n- name: Create Group "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_user "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  group: \n    name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    gid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n \n- name: Create User www\n  user:\n    name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    uid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n    group: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    shell: /sbin/nologin\n    create_home: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n- name: Create "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_dir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  file:\n    path: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_dir }}"')]),s._v("\n    state: directory\n    owner: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    group: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n\n- name: Start Rsyncd Server\n  systemd:\n    name: rsyncd\n    state: started\n    enabled: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat backup/handlers/main.yml ")]),s._v("\n- name: Restart Rsyncd Server\n  systemd:\n    name: rsyncd\n    state: restarted\n\n\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat backup/vars/main.yml ")]),s._v("\nr_user: www\nr_port: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("873")]),s._v("\nr_dir: /backup\n\n\n两个配置文件内容:\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:templates"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /root/ansible/rsyncd.conf .")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat backup/templates/rsyncd.conf.j2 ")]),s._v("\nuid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_user "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\ngid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_user "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_port "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nfake super "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nuse "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" no\nmax connections "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\nignore errors\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" only "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nlist "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\nauth "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" rsync_backup\nsecrets "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /etc/rsync.passwd\nlog "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /var/log/rsyncd.log\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#####################################")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("backup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ncomment "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" welcome to backup"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\npath "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_dir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat backup/templates/rsync.passwd ")]),s._v("\nrsync_backup:123456\n\n调用paly执行\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat site.yml ")]),s._v("\n- hosts: all\n  roles:\n    - role: backup\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup"')]),s._v("\n      \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#rsync -avz /etc/hosts rsync_backup@10.0.0.41::backup")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 看backup相关的信息")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br")])]),n("h3",{attrs:{id:"_3-重构nfs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-重构nfs"}},[s._v("#")]),s._v(" 3，重构NFS")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# NFS恢复快照")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ssh-copy-id 10.0.0.31")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ssh 10.0.0.31")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nfs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ls ../backup/")]),s._v("\nfiles  handlers  tasks  templates  vars\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nfs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ls ../backup/|xargs mkdir")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nfs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":10 files\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":10 handlers\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":10 tasks\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":10 templates\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":10 vars\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#tree nfs/")]),s._v("\nnfs/\n├── files\n├── handlers\n│   └── main.yml\n├── tasks\n│   └── main.yml\n├── templates\n│   └── exports.j2\n└── vars\n    └── main.yml\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" directories, "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" files\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat nfs/tasks/main.yml ")]),s._v("\n- name: Install NFS Server\n  yum:\n    name: nfs-utils\n    state: present\n\n- name: Configure NFS Server\n  template:\n    src: exports.j2\n    dest: /etc/exports\n  notify: Restart NFS Server\n- name: Create Group "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" r_user "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  group: \n    name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    gid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n \n- name: Create User www\n  user:\n    name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    uid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n    group: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    shell: /sbin/nologin\n    create_home: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n\n- name: Create /data/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" wp_dir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  file:\n    path: /data/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" wp_dir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    state: directory\n    owner: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n    group: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ r_user }}"')]),s._v("\n\n- name: Start NFS Server\n  systemd:\n    name: nfs\n    state: started\n    enabled: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat nfs/handlers/main.yml ")]),s._v("\n- name: Restart NFS Server\n  systemd:\n    name: nfs\n    state: restarted\n    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat nfs/vars/main.yml ")]),s._v("\nwp_dir: wp\nnfs_ip: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.0/24\nnfs_uid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\nr_user: www\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat nfs/templates/exports.j2 ")]),s._v("\n/data/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" wp_dir "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" nfs_ip "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw,sync,all_squash,anonuid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" nfs_uid "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",anongid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" nfs_uid "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n\n调用角色\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat site.yml ")]),s._v("\n- hosts: all\n  roles:\n    - role: backup\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup"')]),s._v("\n    - role: nfs\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nfs"')]),s._v("\n      \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#showmount -e 172.16.1.31")]),s._v("\nExport list "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.31\n/data/wp "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".1.0/24\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mount -t nfs 172.16.1.31:/data/wp /mnt")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cd /mnt/")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:mnt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#touch 1.txt")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@nfs:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll /data/wp/")]),s._v("\n----------------  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".txt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试完卸载")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("umount")]),s._v(" /mnt\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br")])]),n("h3",{attrs:{id:"_4-基础优化项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-基础优化项目"}},[s._v("#")]),s._v(" 4，基础优化项目")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".创建group www\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".创建用户www\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".关闭防火墙\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(".时间同步\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(".配置nginx仓库\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(".加大文件描述符\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(".安装常用命令\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("安装服务框架：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("WEB01: nginx+php  /code 业务配置文件 *.conf  客户端备份脚本--"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("BACKUP 所有服务器 Tomcat jdk   https\n\nWEB02: nginx+php  /code 业务配置文件 *.conf   Tomcat jdk\t\t\nhttps\n\nMySQL: mariadb-server redis\nNFS: nfs-utils  lsync\nBACKUP: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rsync")]),s._v("\nlb01 nginx  keepalived\nlb02 nginx  keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("部署业务：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("wp\nzh\nzrlog\nphpmyadmin\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("基础优化项目"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("最基础的"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:basic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:basic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:basic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ls ../nfs/")]),s._v("\nfiles  handlers  tasks  templates  vars\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:basic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ls ../nfs/|xargs mkdir")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:basic"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":34 files\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":34 handlers\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":34 tasks\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":34 templates\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":34 vars\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#基础优化")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.安装EPEL仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2.安装Nginx仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#3.关闭Firewalld")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#4.时间同步")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#5.创建虚拟用户")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#6.加大文件描述符")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#基础优化")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.安装YUM仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2.安装EPEL仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#3.安装PHP仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#4.安装Nginx仓库")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#5.关闭SELINUX")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#6.关闭Firewalld")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#7.修改SSH默认连接端口 SSH禁止DNS解析")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#8.时间同步")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#9.创建虚拟用户")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#10.加大文件描述符")]),s._v("\n- name: Add Epel repository\n  yum_repository:\n    name: epel\n    description: EPEL repo\n    gpgcheck: no\n    gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7\n    baseurl: http://mirrors.aliyun.com/epel/7/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("\n\n\n- name: Add Nginx Repository\n  yum_repository:\n    name: nginx\n    description: Nginx YUM repo\n    gpgcheck: no\n    baseurl: http://nginx.org/packages/centos/7/"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\n\n    \n- name: Install ALL package\n  yum:\n    name: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item }}"')]),s._v("\n    state: present\n  loop:\n      - net-tools\n      - ntpdate\n      - "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("\n      - tree\n      - lrzsz\n      - "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v("\n      - "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("unzip")]),s._v("\n      - telnet\n      - "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rsync")]),s._v("\n      - nfs-utils\n      - python3-mysqlclient\n\n- name: Disabled Firewalld\n  systemd:\n    name: firewalld\n    state: stopped\n    enabled: no\n\n- name: Crond NTP DATE\n  cron:\n    name: ntpdate\n    minute: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*/5"')]),s._v("\n    job: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/sbin/ntpdate ntp1.aliyun.com > /dev/null"')]),s._v("        \n \n- name: Create www Group\n  group:\n    name: www\n    gid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n\n- name: Create www user\n  user:\n    name: www\n    uid: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n    group: www\n    create_home: "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    shell: /sbin/nologin\n- name: limit\n  pam_limits:\n    domain: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*'")]),s._v("\n    dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.dest }}"')]),s._v("\n    limit_type: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.limit_type }}"')]),s._v("\n    limit_item: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.limit_item }}"')]),s._v("\n    value: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ item.value }}"')]),s._v("\n  with_items:\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/security/limits.conf'")]),s._v(",limit_type: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'soft'")]),s._v(",limit_item: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nofile'")]),s._v(", value: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'655350'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/security/limits.conf'")]),s._v(",limit_type: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hard'")]),s._v(",limit_item: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nofile'")]),s._v(", value: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'655350'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/security/limits.conf'")]),s._v(",limit_type: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'soft'")]),s._v(",limit_item: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nproc'")]),s._v(", value: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'102400'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    - "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" dest: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/security/limits.conf'")]),s._v(",limit_type: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hard'")]),s._v(",limit_item: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nproc'")]),s._v(", value: "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'102400'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br")])]),n("h3",{attrs:{id:"_5-重构nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-重构nginx"}},[s._v("#")]),s._v(" 5，重构nginx")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ls ../nfs/|xargs mkdir")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":07 files\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":07 handlers\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":07 tasks\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":07 templates\ndrwxr-xr-x "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":07 vars\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat tasks/main.yml")]),s._v("\n- name: Install Nginx Server\n  yum:\n    name: nginx\n    state: present\n\n\n- name: Configure Nginx Server\n  copy:\n    src: nginx.conf\n    dest: /etc/nginx/nginx.conf\n  notify: Restart nginx Server\n\n- name: Start Nginx Server\n  systemd:\n    name: nginx\n    state: started\n    enabled: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat handlers/main.yml ")]),s._v("\n- name: Restart nginx Server\n  systemd:\n    name: nginx\n    state: restarted\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat site.yml")]),s._v("\n- hosts: all\n  roles:\n    - role: basic\n    - role: backup\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup"')]),s._v("\n    - role: nfs\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nfs"')]),s._v("\n    - role: nginx\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br")])]),n("h3",{attrs:{id:"_6-重构mysql"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-重构mysql"}},[s._v("#")]),s._v(" 6，重构mysql")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:files"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2536")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2592862")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":21 all.sql\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:mysql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat tasks/main.yml")]),s._v("\n- name: Install MySQL Server\n  yum:\n    name: mariadb-server\n    state: present\n \n- name: Start MySQL Server\n  systemd:\n    name: mairadb\n    state: started\n    enabled: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n- name: copy all.sql to "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n  copy:\n    src: all.sql\n    dest: /root/all.sql\n \n- name: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" all.sql\n  mysql_db:\n    name: all\n    state: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" \n    target: /root/all.sql\n    login_user: root\n\n- name: Reart MySQL Server\n  systemd:\n    name: mairadb\n    state: restarted\n\n\n成功后web01测试远程连接数据库\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#yum -y install mariadb   # 安装mysql命令")]),s._v("\n测试是否可以远程连接\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@web01:~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql -h 172.16.1.31 -ulzy -plzy123.com")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("h3",{attrs:{id:"_7-重构wp业务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-重构wp业务"}},[s._v("#")]),s._v(" 7，重构wp业务")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:files"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll")]),s._v("\ntotal "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("306348")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("313699921")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":36 code.tar.gz\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:wordpress"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat tasks/main.yml")]),s._v("\n- name: Delete default config\n  file:\n    path: /etc/nginx/conf.d/default.conf\n    state: absent\n\n- name: Configure Nginx wp-config\n  copy:\n    src: wordpress.conf\n    dest: /etc/nginx/conf.d/\n  notify: Restart Nginx Server\n\n- name: Unarchive code to /code\n  unarchive:\n    src: code.tar.gz\n    dest: /\n    creates: /code/wp\n    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:wordpress"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat handlers/main.yml ")]),s._v("\n- name: Restart Nginx Server\n  systemd:\n    name: nginx\n    state: restarted\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h3",{attrs:{id:"_8-重构php"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-重构php"}},[s._v("#")]),s._v(" 8，重构php")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mkdir php")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cd php/")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mkdir files")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:php"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mkdir tasks")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat php/tasks/main.yml ")]),s._v("\n- name: Install PHP Server\n  yum:\n    name:\n      - php\n      - php-bcmath\n      - php-cli\n      - php-common\n      - php-devel\n      - php-embedded\n      - php-fpm\n      - php-gd\n      - php-intl\n      - php-mbstring\n      - php-mysqlnd\n      - php-opcache\n      - php-pdo\n      - php-process\n      - php-xml\n      - php-json\n    state: present\n\n- name: Configure PHP\n  copy:\n    src: www.conf\n    dest: /etc/php-fpm.d/\n\n- name: Start PHP Server\n  systemd:\n    name: php-fpm\n    state: started\n    enabled: "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n    \n    \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ll php/files/www.conf ")]),s._v("\n-rw-r--r-- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19404")]),s._v(" Aug "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":40 php/files/www.conf\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ansible:roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat site.yml ")]),s._v("\n- hosts: all\n  roles:\n    - role: basic\n    - role: backup\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backup"')]),s._v("\n    - role: nfs\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nfs"')]),s._v("\n    - role: nginx\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web"')]),s._v("\n    - role: mysql\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"db"')]),s._v("\n    - role: php\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web"')]),s._v("\n    - role: wordpress\n      when: ansible_hostname is match "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"web"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);