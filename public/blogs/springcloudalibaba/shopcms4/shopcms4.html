<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>11-shoping项目04 | devops</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/devops/public/favicon.ico">
    <meta name="description" content="快来玩devops">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/devops/public/assets/css/0.styles.4a69f283.css" as="style"><link rel="preload" href="/devops/public/assets/js/app.5825cff9.js" as="script"><link rel="preload" href="/devops/public/assets/js/113.2f71a2bc.js" as="script"><link rel="preload" href="/devops/public/assets/js/1.774fca24.js" as="script"><link rel="preload" href="/devops/public/assets/js/62.1ac6f2a8.js" as="script"><link rel="prefetch" href="/devops/public/assets/js/10.4da19cb5.js"><link rel="prefetch" href="/devops/public/assets/js/100.bbba7404.js"><link rel="prefetch" href="/devops/public/assets/js/101.639eefc9.js"><link rel="prefetch" href="/devops/public/assets/js/102.d4bd7c20.js"><link rel="prefetch" href="/devops/public/assets/js/103.5b09b74b.js"><link rel="prefetch" href="/devops/public/assets/js/104.d433eb7f.js"><link rel="prefetch" href="/devops/public/assets/js/105.2ec6002e.js"><link rel="prefetch" href="/devops/public/assets/js/106.ebe3f9be.js"><link rel="prefetch" href="/devops/public/assets/js/107.5430f265.js"><link rel="prefetch" href="/devops/public/assets/js/108.926bc99d.js"><link rel="prefetch" href="/devops/public/assets/js/109.9d522bf4.js"><link rel="prefetch" href="/devops/public/assets/js/11.2942e201.js"><link rel="prefetch" href="/devops/public/assets/js/110.e08bfd30.js"><link rel="prefetch" href="/devops/public/assets/js/111.5f88b202.js"><link rel="prefetch" href="/devops/public/assets/js/112.ca730c43.js"><link rel="prefetch" href="/devops/public/assets/js/114.f326ec9a.js"><link rel="prefetch" href="/devops/public/assets/js/115.8296a9c2.js"><link rel="prefetch" href="/devops/public/assets/js/116.a319c796.js"><link rel="prefetch" href="/devops/public/assets/js/117.0aaa6551.js"><link rel="prefetch" href="/devops/public/assets/js/118.cdc51977.js"><link rel="prefetch" href="/devops/public/assets/js/119.3d572e24.js"><link rel="prefetch" href="/devops/public/assets/js/12.40b6e2ae.js"><link rel="prefetch" href="/devops/public/assets/js/120.e63dbce1.js"><link rel="prefetch" href="/devops/public/assets/js/121.84af7eeb.js"><link rel="prefetch" href="/devops/public/assets/js/122.9f5eb9ab.js"><link rel="prefetch" href="/devops/public/assets/js/123.4bc47ab1.js"><link rel="prefetch" href="/devops/public/assets/js/124.425c0443.js"><link rel="prefetch" href="/devops/public/assets/js/125.448d8d46.js"><link rel="prefetch" href="/devops/public/assets/js/126.0e917f73.js"><link rel="prefetch" href="/devops/public/assets/js/127.d56bb020.js"><link rel="prefetch" href="/devops/public/assets/js/128.cdf4c71a.js"><link rel="prefetch" href="/devops/public/assets/js/129.b020e6f9.js"><link rel="prefetch" href="/devops/public/assets/js/13.19ff0e37.js"><link rel="prefetch" href="/devops/public/assets/js/130.e5476d9a.js"><link rel="prefetch" href="/devops/public/assets/js/131.df2f9c72.js"><link rel="prefetch" href="/devops/public/assets/js/132.02667eb4.js"><link rel="prefetch" href="/devops/public/assets/js/133.0432cad1.js"><link rel="prefetch" href="/devops/public/assets/js/134.b216bd39.js"><link rel="prefetch" href="/devops/public/assets/js/135.ef2e3bf9.js"><link rel="prefetch" href="/devops/public/assets/js/136.75976e52.js"><link rel="prefetch" href="/devops/public/assets/js/137.73c7c9a1.js"><link rel="prefetch" href="/devops/public/assets/js/138.5001691b.js"><link rel="prefetch" href="/devops/public/assets/js/139.a582a594.js"><link rel="prefetch" href="/devops/public/assets/js/14.f248a219.js"><link rel="prefetch" href="/devops/public/assets/js/140.a6fdda38.js"><link rel="prefetch" href="/devops/public/assets/js/141.7b3e148c.js"><link rel="prefetch" href="/devops/public/assets/js/142.e85c7899.js"><link rel="prefetch" href="/devops/public/assets/js/143.9b145154.js"><link rel="prefetch" href="/devops/public/assets/js/144.f749ba37.js"><link rel="prefetch" href="/devops/public/assets/js/145.e5a9047d.js"><link rel="prefetch" href="/devops/public/assets/js/146.e3a150c2.js"><link rel="prefetch" href="/devops/public/assets/js/147.4a3759fd.js"><link rel="prefetch" href="/devops/public/assets/js/148.c937eb65.js"><link rel="prefetch" href="/devops/public/assets/js/149.4c7277fa.js"><link rel="prefetch" href="/devops/public/assets/js/15.a088b999.js"><link rel="prefetch" href="/devops/public/assets/js/150.2192b064.js"><link rel="prefetch" href="/devops/public/assets/js/151.faa54761.js"><link rel="prefetch" href="/devops/public/assets/js/152.8bff3d58.js"><link rel="prefetch" href="/devops/public/assets/js/153.a39e8324.js"><link rel="prefetch" href="/devops/public/assets/js/154.742d3624.js"><link rel="prefetch" href="/devops/public/assets/js/155.2566a8d6.js"><link rel="prefetch" href="/devops/public/assets/js/156.96e10476.js"><link rel="prefetch" href="/devops/public/assets/js/157.789457c1.js"><link rel="prefetch" href="/devops/public/assets/js/158.543aa74d.js"><link rel="prefetch" href="/devops/public/assets/js/159.afb1cf83.js"><link rel="prefetch" href="/devops/public/assets/js/16.0d9934f1.js"><link rel="prefetch" href="/devops/public/assets/js/160.d11fc47d.js"><link rel="prefetch" href="/devops/public/assets/js/161.68085c48.js"><link rel="prefetch" href="/devops/public/assets/js/162.4d4733a7.js"><link rel="prefetch" href="/devops/public/assets/js/163.1459f57a.js"><link rel="prefetch" href="/devops/public/assets/js/164.af88778b.js"><link rel="prefetch" href="/devops/public/assets/js/165.f90528f0.js"><link rel="prefetch" href="/devops/public/assets/js/166.e528f5b0.js"><link rel="prefetch" href="/devops/public/assets/js/167.30efb17e.js"><link rel="prefetch" href="/devops/public/assets/js/168.2f0790ec.js"><link rel="prefetch" href="/devops/public/assets/js/169.372f977f.js"><link rel="prefetch" href="/devops/public/assets/js/17.5fe17218.js"><link rel="prefetch" href="/devops/public/assets/js/170.22dda53f.js"><link rel="prefetch" href="/devops/public/assets/js/171.50da113a.js"><link rel="prefetch" href="/devops/public/assets/js/172.4a3784f3.js"><link rel="prefetch" href="/devops/public/assets/js/173.0ab8bd81.js"><link rel="prefetch" href="/devops/public/assets/js/174.4cbd19fe.js"><link rel="prefetch" href="/devops/public/assets/js/175.f4f007f7.js"><link rel="prefetch" href="/devops/public/assets/js/176.02b476b0.js"><link rel="prefetch" href="/devops/public/assets/js/177.3dbc9c3c.js"><link rel="prefetch" href="/devops/public/assets/js/178.9ca0661f.js"><link rel="prefetch" href="/devops/public/assets/js/179.c9ed62d7.js"><link rel="prefetch" href="/devops/public/assets/js/18.db5f4615.js"><link rel="prefetch" href="/devops/public/assets/js/180.e1cd432d.js"><link rel="prefetch" href="/devops/public/assets/js/181.ed361ef3.js"><link rel="prefetch" href="/devops/public/assets/js/182.e5e67f9c.js"><link rel="prefetch" href="/devops/public/assets/js/183.c4d604ad.js"><link rel="prefetch" href="/devops/public/assets/js/184.7ca07d6c.js"><link rel="prefetch" href="/devops/public/assets/js/185.e5907f93.js"><link rel="prefetch" href="/devops/public/assets/js/186.a992f87b.js"><link rel="prefetch" href="/devops/public/assets/js/187.938c4584.js"><link rel="prefetch" href="/devops/public/assets/js/188.39ad7861.js"><link rel="prefetch" href="/devops/public/assets/js/189.79618cb6.js"><link rel="prefetch" href="/devops/public/assets/js/19.8b63e315.js"><link rel="prefetch" href="/devops/public/assets/js/190.cdee4b88.js"><link rel="prefetch" href="/devops/public/assets/js/191.d8e36956.js"><link rel="prefetch" href="/devops/public/assets/js/192.a7d92fb4.js"><link rel="prefetch" href="/devops/public/assets/js/193.1d1b97f5.js"><link rel="prefetch" href="/devops/public/assets/js/194.caab0079.js"><link rel="prefetch" href="/devops/public/assets/js/195.66c16643.js"><link rel="prefetch" href="/devops/public/assets/js/196.6c2fbf22.js"><link rel="prefetch" href="/devops/public/assets/js/197.4aaf761f.js"><link rel="prefetch" href="/devops/public/assets/js/198.2cf0f907.js"><link rel="prefetch" href="/devops/public/assets/js/199.b0ed054b.js"><link rel="prefetch" href="/devops/public/assets/js/20.f6db8c9e.js"><link rel="prefetch" href="/devops/public/assets/js/200.b0217582.js"><link rel="prefetch" href="/devops/public/assets/js/201.1d5eeee9.js"><link rel="prefetch" href="/devops/public/assets/js/202.552095ca.js"><link rel="prefetch" href="/devops/public/assets/js/203.c02af648.js"><link rel="prefetch" href="/devops/public/assets/js/204.ecd5b121.js"><link rel="prefetch" href="/devops/public/assets/js/205.aae12631.js"><link rel="prefetch" href="/devops/public/assets/js/206.30947e5f.js"><link rel="prefetch" href="/devops/public/assets/js/207.975516e6.js"><link rel="prefetch" href="/devops/public/assets/js/208.53f42b19.js"><link rel="prefetch" href="/devops/public/assets/js/209.5db96a62.js"><link rel="prefetch" href="/devops/public/assets/js/21.4b22d1e5.js"><link rel="prefetch" href="/devops/public/assets/js/210.53c76907.js"><link rel="prefetch" href="/devops/public/assets/js/211.5f627b59.js"><link rel="prefetch" href="/devops/public/assets/js/212.ecf1b0e6.js"><link rel="prefetch" href="/devops/public/assets/js/213.8e7cb1bd.js"><link rel="prefetch" href="/devops/public/assets/js/214.ed34c0e4.js"><link rel="prefetch" href="/devops/public/assets/js/215.186eaa4f.js"><link rel="prefetch" href="/devops/public/assets/js/216.ab54cc52.js"><link rel="prefetch" href="/devops/public/assets/js/217.23915005.js"><link rel="prefetch" href="/devops/public/assets/js/218.c0560695.js"><link rel="prefetch" href="/devops/public/assets/js/219.b2cfda52.js"><link rel="prefetch" href="/devops/public/assets/js/22.0c7f6537.js"><link rel="prefetch" href="/devops/public/assets/js/220.051e75db.js"><link rel="prefetch" href="/devops/public/assets/js/221.9ee65b3d.js"><link rel="prefetch" href="/devops/public/assets/js/222.251e5b74.js"><link rel="prefetch" href="/devops/public/assets/js/223.a23e49e4.js"><link rel="prefetch" href="/devops/public/assets/js/224.7b9de25a.js"><link rel="prefetch" href="/devops/public/assets/js/225.b2e6949a.js"><link rel="prefetch" href="/devops/public/assets/js/226.9a999711.js"><link rel="prefetch" href="/devops/public/assets/js/227.86062e4b.js"><link rel="prefetch" href="/devops/public/assets/js/228.1ba6d2b4.js"><link rel="prefetch" href="/devops/public/assets/js/229.21562b32.js"><link rel="prefetch" href="/devops/public/assets/js/23.0808e8c1.js"><link rel="prefetch" href="/devops/public/assets/js/230.65c5474b.js"><link rel="prefetch" href="/devops/public/assets/js/231.dd279d2f.js"><link rel="prefetch" href="/devops/public/assets/js/232.dbf7160b.js"><link rel="prefetch" href="/devops/public/assets/js/233.4c5d241c.js"><link rel="prefetch" href="/devops/public/assets/js/234.33fab0be.js"><link rel="prefetch" href="/devops/public/assets/js/235.9f9263bf.js"><link rel="prefetch" href="/devops/public/assets/js/236.b23af8d9.js"><link rel="prefetch" href="/devops/public/assets/js/237.8ac4091e.js"><link rel="prefetch" href="/devops/public/assets/js/238.f1970e0f.js"><link rel="prefetch" href="/devops/public/assets/js/239.c940fc58.js"><link rel="prefetch" href="/devops/public/assets/js/24.6c65bc57.js"><link rel="prefetch" href="/devops/public/assets/js/240.49a7b890.js"><link rel="prefetch" href="/devops/public/assets/js/241.9e02b296.js"><link rel="prefetch" href="/devops/public/assets/js/242.0601c484.js"><link rel="prefetch" href="/devops/public/assets/js/243.b8f96062.js"><link rel="prefetch" href="/devops/public/assets/js/244.7fe9c17f.js"><link rel="prefetch" href="/devops/public/assets/js/245.cd619c39.js"><link rel="prefetch" href="/devops/public/assets/js/246.400d6277.js"><link rel="prefetch" href="/devops/public/assets/js/247.b7150aea.js"><link rel="prefetch" href="/devops/public/assets/js/248.eadd3b79.js"><link rel="prefetch" href="/devops/public/assets/js/249.0157c75e.js"><link rel="prefetch" href="/devops/public/assets/js/25.0bd47b72.js"><link rel="prefetch" href="/devops/public/assets/js/250.b5a5964d.js"><link rel="prefetch" href="/devops/public/assets/js/251.53b0d8dd.js"><link rel="prefetch" href="/devops/public/assets/js/252.15cff207.js"><link rel="prefetch" href="/devops/public/assets/js/253.cdc27e5e.js"><link rel="prefetch" href="/devops/public/assets/js/254.192b5df0.js"><link rel="prefetch" href="/devops/public/assets/js/255.37f28525.js"><link rel="prefetch" href="/devops/public/assets/js/256.df0f9287.js"><link rel="prefetch" href="/devops/public/assets/js/257.f8e9cfd7.js"><link rel="prefetch" href="/devops/public/assets/js/26.35c553a0.js"><link rel="prefetch" href="/devops/public/assets/js/27.58296125.js"><link rel="prefetch" href="/devops/public/assets/js/28.2f944e5a.js"><link rel="prefetch" href="/devops/public/assets/js/29.a2a98aa2.js"><link rel="prefetch" href="/devops/public/assets/js/3.34eb11b1.js"><link rel="prefetch" href="/devops/public/assets/js/30.5453ef8f.js"><link rel="prefetch" href="/devops/public/assets/js/31.9b77b69c.js"><link rel="prefetch" href="/devops/public/assets/js/32.4825fbea.js"><link rel="prefetch" href="/devops/public/assets/js/33.c390335b.js"><link rel="prefetch" href="/devops/public/assets/js/34.14d4f1be.js"><link rel="prefetch" href="/devops/public/assets/js/35.e531e3c0.js"><link rel="prefetch" href="/devops/public/assets/js/36.9bc1bacc.js"><link rel="prefetch" href="/devops/public/assets/js/37.0f53acf8.js"><link rel="prefetch" href="/devops/public/assets/js/38.91acdbcb.js"><link rel="prefetch" href="/devops/public/assets/js/39.85802f01.js"><link rel="prefetch" href="/devops/public/assets/js/4.1fd2fdb5.js"><link rel="prefetch" href="/devops/public/assets/js/40.2c002e71.js"><link rel="prefetch" href="/devops/public/assets/js/41.cd4bdd2d.js"><link rel="prefetch" href="/devops/public/assets/js/42.26a4fe54.js"><link rel="prefetch" href="/devops/public/assets/js/43.7116914a.js"><link rel="prefetch" href="/devops/public/assets/js/44.0c2c15b8.js"><link rel="prefetch" href="/devops/public/assets/js/45.2abc19b6.js"><link rel="prefetch" href="/devops/public/assets/js/46.8368b159.js"><link rel="prefetch" href="/devops/public/assets/js/47.140e61e1.js"><link rel="prefetch" href="/devops/public/assets/js/48.6cd060f9.js"><link rel="prefetch" href="/devops/public/assets/js/49.5d5ca41c.js"><link rel="prefetch" href="/devops/public/assets/js/5.a90fcb6b.js"><link rel="prefetch" href="/devops/public/assets/js/50.d63f3c8c.js"><link rel="prefetch" href="/devops/public/assets/js/51.d4122a4d.js"><link rel="prefetch" href="/devops/public/assets/js/52.e1fec5e3.js"><link rel="prefetch" href="/devops/public/assets/js/53.9670f5e6.js"><link rel="prefetch" href="/devops/public/assets/js/54.b7dfc65c.js"><link rel="prefetch" href="/devops/public/assets/js/55.c8f48aa2.js"><link rel="prefetch" href="/devops/public/assets/js/56.d643bca1.js"><link rel="prefetch" href="/devops/public/assets/js/57.2801576d.js"><link rel="prefetch" href="/devops/public/assets/js/58.5304e194.js"><link rel="prefetch" href="/devops/public/assets/js/59.877539e5.js"><link rel="prefetch" href="/devops/public/assets/js/6.8288c75c.js"><link rel="prefetch" href="/devops/public/assets/js/60.e2908ba7.js"><link rel="prefetch" href="/devops/public/assets/js/61.2fb56d6b.js"><link rel="prefetch" href="/devops/public/assets/js/63.b8e12589.js"><link rel="prefetch" href="/devops/public/assets/js/64.c0432fde.js"><link rel="prefetch" href="/devops/public/assets/js/65.ccf81088.js"><link rel="prefetch" href="/devops/public/assets/js/66.0e05e5ba.js"><link rel="prefetch" href="/devops/public/assets/js/67.9954a7f2.js"><link rel="prefetch" href="/devops/public/assets/js/68.327e9900.js"><link rel="prefetch" href="/devops/public/assets/js/69.6efd4d3d.js"><link rel="prefetch" href="/devops/public/assets/js/7.08e4ee8c.js"><link rel="prefetch" href="/devops/public/assets/js/70.01768eb3.js"><link rel="prefetch" href="/devops/public/assets/js/71.96b53d33.js"><link rel="prefetch" href="/devops/public/assets/js/72.23fb881c.js"><link rel="prefetch" href="/devops/public/assets/js/73.46788df2.js"><link rel="prefetch" href="/devops/public/assets/js/74.bf4e2788.js"><link rel="prefetch" href="/devops/public/assets/js/75.38bb6c74.js"><link rel="prefetch" href="/devops/public/assets/js/76.cc745417.js"><link rel="prefetch" href="/devops/public/assets/js/77.9b1c7581.js"><link rel="prefetch" href="/devops/public/assets/js/78.8da7267c.js"><link rel="prefetch" href="/devops/public/assets/js/79.1d6b0822.js"><link rel="prefetch" href="/devops/public/assets/js/8.7d3e31a7.js"><link rel="prefetch" href="/devops/public/assets/js/80.080a771e.js"><link rel="prefetch" href="/devops/public/assets/js/81.dddabd25.js"><link rel="prefetch" href="/devops/public/assets/js/82.8f766d2b.js"><link rel="prefetch" href="/devops/public/assets/js/83.1b1ea4e5.js"><link rel="prefetch" href="/devops/public/assets/js/84.450e5f6f.js"><link rel="prefetch" href="/devops/public/assets/js/85.cd47d195.js"><link rel="prefetch" href="/devops/public/assets/js/86.c8d0c479.js"><link rel="prefetch" href="/devops/public/assets/js/87.3a16dafb.js"><link rel="prefetch" href="/devops/public/assets/js/88.3512bc9b.js"><link rel="prefetch" href="/devops/public/assets/js/89.f8082a19.js"><link rel="prefetch" href="/devops/public/assets/js/9.f6097e11.js"><link rel="prefetch" href="/devops/public/assets/js/90.83c37b49.js"><link rel="prefetch" href="/devops/public/assets/js/91.6a1ba0b9.js"><link rel="prefetch" href="/devops/public/assets/js/92.798df04e.js"><link rel="prefetch" href="/devops/public/assets/js/93.fb9d290b.js"><link rel="prefetch" href="/devops/public/assets/js/94.4b02b73a.js"><link rel="prefetch" href="/devops/public/assets/js/95.5b0d9879.js"><link rel="prefetch" href="/devops/public/assets/js/96.39fa603e.js"><link rel="prefetch" href="/devops/public/assets/js/97.9d9b34a7.js"><link rel="prefetch" href="/devops/public/assets/js/98.7bb39cc0.js"><link rel="prefetch" href="/devops/public/assets/js/99.4d52d3be.js">
    <link rel="stylesheet" href="/devops/public/assets/css/0.styles.4a69f283.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>devops</h3> <p class="description" data-v-59e6cb88>快来玩devops</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devops/public/" class="home-link router-link-active"><img src="/devops/public/logo.png" alt="devops" class="logo"> <span class="site-name">devops</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/devops/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    devops
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>232</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>11-shoping项目04</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">11-shoping项目04</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>devops</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>sentinel</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="_1-创建秒杀相关模块"><a href="#_1-创建秒杀相关模块" class="header-anchor">#</a> 1, 创建秒杀相关模块</h3> <p>“秒杀”是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。秒杀技术实现核心思想是运用缓存减少数据库瞬间的访问压力。在秒杀时，首先会将数据库的秒杀商品同步到缓存中，用户从缓存中查询秒杀商品，抢购商品时减少缓存中的库存数量。产生的秒杀订单先写到缓存，付款成功后再写入数据库。</p> <p><img src="/devops/public/assets/img/1727162113303.6bba20a0.png" alt="1727162113303"></p> <p>创建名为<code>shoping_seckill_service</code>的SpringBoot工程，添加相关依赖。</p> <p><img src="/devops/public/assets/img/1730098979469.6c770dc0.png" alt="1730098979469"></p> <p><img src="/devops/public/assets/img/1730099043846.8c34565c.png" alt="1730099043846"></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- MyBatisPlus --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- mysql驱动 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- common --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shoping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- dubbo --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- nacos --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- test --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- redis --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- hutool工具包，里面带有布隆过滤器 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.7.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- sentinel --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Redisson --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.27.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>在Nacos配置中心创建配置文件<code>shoping_seckill_service-dev.yaml</code></p> <p><img src="/devops/public/assets/img/1730099298921.92df896a.png" alt="1730099298921"></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9005</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_seckill_service <span class="token comment">#服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心地址</span>
 <span class="token comment"># 数据源</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
   <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
   <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span>3306/mlshoping<span class="token punctuation">?</span>serverTimezone=UTC
   <span class="token key atrule">username</span><span class="token punctuation">:</span> malu
   <span class="token key atrule">password</span><span class="token punctuation">:</span> 123456Abc.com
 <span class="token comment"># redis</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
   <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.0.0.41
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">30000</span>
    <span class="token key atrule">jedis</span><span class="token punctuation">:</span>
     <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>


<span class="token comment">#配置mybatis-plus</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
   <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
   <span class="token comment"># 表名前缀</span>
    <span class="token key atrule">table-prefix</span><span class="token punctuation">:</span> ml_
   <span class="token comment"># 主键生成策略为自增</span>
    <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
  <span class="token comment"># 关闭列名自动驼峰命名规则映射</span>
   <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
   <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl <span class="token comment">#开启sql日志</span>
  
<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_seckill_service <span class="token comment">#服务名</span>
   <span class="token key atrule">serialize-check-status</span><span class="token punctuation">:</span> DISABLE
   <span class="token key atrule">check-serializable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo <span class="token comment"># 通讯协议</span>
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 端口号，-1表示自动扫描可用端口。</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 9d7f5ef3<span class="token punctuation">-</span>29be<span class="token punctuation">-</span>4710<span class="token punctuation">-</span>85bd<span class="token punctuation">-</span>7b293e633ff6 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shoping_seckill_service <span class="token comment">#文件名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>启动类扫描Mapper</p> <p><img src="/devops/public/assets/img/1730099477767.be98315a.png" alt="1730099477767"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>shoping_seckill_service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>bloomfilter<span class="token punctuation">.</span></span><span class="token class-name">BitMapBloomFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">DbType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span></span><span class="token class-name">MybatisPlusInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>inner<span class="token punctuation">.</span></span><span class="token class-name">PaginationInnerInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableDubbo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">MapperScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RefreshScope</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableScheduling</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.ityls.shoping_seckill_service.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingSeckillServiceApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingSeckillServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>创建名为<code>shoping_seckill_customer_api</code>的SpringBoot工程，添加相关依赖。</p> <p><img src="/devops/public/assets/img/1730099572727.29d8ee2c.png" alt="1730099572727"></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shoping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- dubbo --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- nacos --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- sentinel --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>在Nacos配置中心编写配置文件<code>shoping_seckill_customer_api-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8007</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token comment"># Nacos</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_seckill_customer_api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>


<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  <span class="token comment">#项目名字</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_seckill_customer_api
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
  <span class="token comment"># 注册地址</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 9d7f5ef3<span class="token punctuation">-</span>29be<span class="token punctuation">-</span>4710<span class="token punctuation">-</span>85bd<span class="token punctuation">-</span>7b293e633ff6 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shoping_seckill_customer_api

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>编写启动类</p> <p><img src="/devops/public/assets/img/1730099739020.4f9653ea.png" alt="1730099739020"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>shoping_seckill_customer_api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceAutoConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RefreshScope</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingSeckillCustomerApiApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingSeckillCustomerApiApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_2-编写秒杀服务接口"><a href="#_2-编写秒杀服务接口" class="header-anchor">#</a> 2, 编写秒杀服务接口</h3> <p>在<strong>通用模块</strong>编写秒杀服务接口</p> <p><img src="/devops/public/assets/img/1730100121529.44d78400.png" alt="1730100121529"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 前台用户查询秒杀商品
   * @param page 页数
   * @param size 每页条数
   * @return 查询结果
   */</span>
  <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByRedis</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/**
   * 查询秒杀商品详情
   * @param goodsId 秒杀商品对应的商品Id
   * @return 查询结果
   */</span>
  <span class="token class-name">SeckillGoods</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>




  <span class="token comment">/**
   * 生成秒杀订单
   * @param orders 订单数据
   * @return
   */</span>
  <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/**
   * 根据id查询秒杀订单
   * @param id 订单id
   * @return
   */</span>
  <span class="token class-name">Orders</span> <span class="token function">findOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/**
   * 支付秒杀订单
   * @param orderId 订单id
   * @return
   */</span>
  <span class="token class-name">Orders</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="_3-同步秒杀商品到redis-1"><a href="#_3-同步秒杀商品到redis-1" class="header-anchor">#</a> 3, 同步秒杀商品到redis(1)</h3> <p>我们需要将正在秒杀的商品从数据库同步保存到redis中，在redis中秒杀商品是以Hash类型保存，Hash的键是商品id，值是商品对象。</p> <p><img src="/devops/public/assets/img/1727162588454.eefbe540.png" alt="1727162588454"></p> <p>在后台添加商品：</p> <p><img src="/devops/public/assets/img/1730100383014.20f20544.png" alt="1730100383014"></p> <p><img src="/devops/public/assets/img/1730100344958.c9a58d37.png" alt="1730100344958"></p> <p><img src="/devops/public/assets/img/1730100401245.d18bddc3.png" alt="1730100401245"></p> <p><img src="/devops/public/assets/img/1730100428659.7805c954.png" alt="1730100428659"></p> <p><img src="/devops/public/assets/img/1730100553001.28c0c270.png" alt="1730100553001"></p> <p><img src="/devops/public/assets/img/1730100564326.47b0889f.png" alt="1730100564326"></p> <p><img src="/devops/public/assets/img/1730100607342.89b0e2a4.png" alt="1730100607342"></p> <p>用户只能查询<strong>正在秒杀</strong>的商品<code>( 开始时间 &lt; 当前时间 &lt; 结束时间，且库存 &gt; 0 )</code>，所以我们在redis中只保存正在秒杀的商品。由于每分钟都有商品开始秒杀，也有商品结束秒杀。所以需要定时查询数据库中正在秒杀的商品，同步到redis中。我们使用SpringTask技术，每分钟同步一次数据：</p> <ol><li><p>修改秒杀服务的启动类，开启定时任务：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.ityls.shopping_seckill_service.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableScheduling</span> <span class="token comment">// 开启定时任务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingSeckillServiceApplication</span> <span class="token punctuation">{</span>


  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingSeckillServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>添加mapper</p> <p><img src="/devops/public/assets/img/1730101079791.7f2bf548.png" alt="1730101079791"></p></li> <li><p>创建秒杀接口实现类，重写同步方法</p> <p><img src="/devops/public/assets/img/1730101186269.81356f4c.png" alt="1730101186269"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  
  <span class="token comment">/**
 * 每分钟查询一次数据库，更新redis中的秒杀商品数据
 * 条件为startTime &lt; 当前时间 &lt; endTime，库存大于0
 */</span>
  <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/5 * * * * *&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;同步mysql秒杀商品到redis...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1730101281607.11fd067b.png" alt="1730101281607"></p></li></ol> <h3 id="_4-同步秒杀商品到redis-2"><a href="#_4-同步秒杀商品到redis-2" class="header-anchor">#</a> 4, 同步秒杀商品到redis(2)</h3> <p>创建秒杀接口实现类，重写同步方法</p> <p><img src="/devops/public/assets/img/1730101903030.89319f33.png" alt="1730101903030"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  
  <span class="token comment">/**
 * 每分钟查询一次数据库，更新redis中的秒杀商品数据
 * 条件为startTime &lt; 当前时间 &lt; endTime，库存大于0
 */</span>
  <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/5 * * * * *&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;同步mysql秒杀商品到redis...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 1.查询数据库中正在秒杀的商品</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token string">&quot;startTime&quot;</span><span class="token punctuation">,</span>now<span class="token punctuation">)</span> <span class="token comment">// 当前时间晚于开始时间</span>
       <span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span>now<span class="token punctuation">)</span> <span class="token comment">// 当前时间早于开始时间</span>
       <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stockCount&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 库存大于0</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 2.删除之前的秒杀商品</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 3.保存现在正在秒杀的商品</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1730102176102.1f25ac12.png" alt="1730102176102"></p> <h3 id="_5-分页查询秒杀商品列表-1"><a href="#_5-分页查询秒杀商品列表-1" class="header-anchor">#</a> 5, 分页查询秒杀商品列表(1)</h3> <p>在秒杀实现类重写查询商品列表方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByRedis</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.查询所有秒杀商品列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.获取当前页商品列表</span>
  <span class="token comment">// 开始截取索引</span>
  <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">;</span>
  <span class="token comment">// 结束截取索引</span>
  <span class="token keyword">int</span> end <span class="token operator">=</span> start <span class="token operator">+</span> size <span class="token operator">&gt;</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
  <span class="token comment">// 获取当前页结果集</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoods <span class="token operator">=</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.构造页面对象</span>
  <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsPage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  seckillGoodsPage<span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token comment">// 当前页</span>
     <span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token comment">// 每页条数</span>
     <span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 总条数</span>
     <span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果集</span>
  <span class="token keyword">return</span> seckillGoodsPage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_6-分页查询秒杀商品列表-2"><a href="#_6-分页查询秒杀商品列表-2" class="header-anchor">#</a> 6, 分页查询秒杀商品列表(2)</h3> <p>修改秒杀服务的启动类，添加分页插件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.ityls.shoping_seckill_service.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingSeckillServiceApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingSeckillServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 分页插件</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MybatisPlusInterceptor</span> <span class="token function">mybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MybatisPlusInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PaginationInnerInterceptor</span><span class="token punctuation">(</span><span class="token class-name">DbType</span><span class="token punctuation">.</span><span class="token constant">MYSQL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在秒杀Api模块编写秒杀控制器</p> <p><img src="/devops/public/assets/img/1730103316487.ee198c38.png" alt="1730103316487"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 秒杀商品
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/seckillGoods&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillGoodsController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillService</span> seckillService<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 用户分页查询秒杀商品
   * @param page 页数
   * @param size 每页条数
   * @return 查询结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findPage&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsPage <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findPageByRedis</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>seckillGoodsPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>配置higress，测试接口</p> <p><img src="/devops/public/assets/img/1730103419326.492c1ae1.png" alt="1730103419326"></p> <p><img src="/devops/public/assets/img/1727163450277.a766d686.png" alt="1727163450277"></p> <h3 id="_7-测试查询秒杀商品列表"><a href="#_7-测试查询秒杀商品列表" class="header-anchor">#</a> 7, 测试查询秒杀商品列表</h3> <p>点击秒杀商品：</p> <p><img src="/devops/public/assets/img/1727163535666.fee99f6a.png" alt="1727163535666"></p> <p><img src="/devops/public/assets/img/1727163589818.816bf244.png" alt="1727163589818"></p> <p><img src="/devops/public/assets/img/1727163611879.f69f4e34.png" alt="1727163611879"></p> <p>时间过后，再次查看：</p> <p><img src="/devops/public/assets/img/1727163641283.3b5f67a8.png" alt="1727163641283"></p> <h3 id="_8-查询秒杀商品详情"><a href="#_8-查询秒杀商品详情" class="header-anchor">#</a> 8, 查询秒杀商品详情</h3> <p>在秒杀实现类重写根据id查询秒杀商品方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>编写秒杀控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 用户查询秒杀商品详情
 * @param id 商品Id
 * @return 查询结果
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试接口</p> <p><img src="/devops/public/assets/img/1727163860033.893ecfa1.png" alt="1727163860033"></p> <h3 id="_9-生成秒杀订单-1"><a href="#_9-生成秒杀订单-1" class="header-anchor">#</a> 9, 生成秒杀订单(1)</h3> <p>为了让用户购买速度更快，秒杀商品时不会将商品添加到购物车，而是直接生成订单。并且由于访问量较大，为了避免数据库压力过大，我们会先将订单数据保存在redis当中，等用户支付完成后，再将redis中的订单数据保存到数据库中。</p> <ol><li><p>在秒杀实现类重写生成秒杀订单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.生成订单对象</span>
  orders<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动生产订单id</span>
  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态未付款</span>
  orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单创建时间</span>
  orders<span class="token punctuation">.</span><span class="token function">setExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单过期时间</span>
  <span class="token comment">// 计算商品价格</span>
  <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Integer</span> num <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.减少秒杀商品库存</span>
  <span class="token comment">// 查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查询库存，库存不足抛出异常</span>
  <span class="token class-name">Integer</span> stockCount <span class="token operator">=</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stockCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 减少库存</span>
  seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.保存订单数据</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div></li></ol> <h3 id="_10-生成秒杀订单-2"><a href="#_10-生成秒杀订单-2" class="header-anchor">#</a> 10, 生成秒杀订单(2)</h3> <ol start="2"><li><p>编写秒杀控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 生成秒杀订单
 * @param orders 订单对象
 * @return 生成的订单
 */</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Orders</span> orders<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> verify <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> userId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>verify<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    orders<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Orders</span> order <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>测试接口</p> <p><img src="/devops/public/assets/img/1730105991911.b5b66e33.png" alt="1730105991911"></p></li></ol> <h3 id="_11-将redis商品同步到mysql中"><a href="#_11-将redis商品同步到mysql中" class="header-anchor">#</a> 11, 将redis商品同步到mysql中</h3> <p>用户秒杀会修改redis中的商品库存，而此时mysql中的库存是没有修改的。等到下次同步数据的时候，redis中的库存数就又成了mysql中没有修改过的库存了，所以出现了秒杀商品库存不变的Bug。</p> <p>为了保证数据的同步，我们在将数据库数据同步到redis之前，先将redis中的商品库存数据同步到数据库中。</p> <p>修改同步秒杀商品到redis方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 每分钟查询一次数据库，更新redis中的秒杀商品数据
 * 条件为startTime &lt; 当前时间 &lt; endTime，库存大于0
 */</span>
<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/5 * * * * *&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将redis中秒杀商品的库存数据同步到mysql</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsListOld <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsListOld<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在数据库查询秒杀商品</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SeckillGoods</span> sqlSeckillGoods <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlSeckillGoods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 修改数据库中秒杀商品的库存，和redis中的库存保持一致</span>
      sqlSeckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>sqlSeckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 1.查询数据库中正在秒杀的商品</span>
  <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
  queryWrapper<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token string">&quot;startTime&quot;</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token comment">// 当前时间晚于开始时间</span>
     <span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token comment">// 当前时间早于开始时间</span>
     <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stockCount&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 库存大于0</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.删除之前的秒杀商品</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.保存现在正在秒杀的商品</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>测试库存是否正常：</p> <p><img src="/devops/public/assets/img/1730106824711.d3abde6f.png" alt="1730106824711"></p> <h3 id="_12-查询秒杀订单详情"><a href="#_12-查询秒杀订单详情" class="header-anchor">#</a> 12, 查询秒杀订单详情</h3> <p>在秒杀实现类重写根据id查询秒杀订单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">findOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>编写秒杀控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据id查询秒杀订单
 * @param id 订单id
 * @return 查询结果
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findOrder&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">Orders</span> orders <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findOrder</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>前端没有写这个页面，直接使用postman测试接口</p> <p><img src="/devops/public/assets/img/1730165750297.40d43fe7.png" alt="1730165750297"></p> <p><img src="/devops/public/assets/img/1730165733618.f215e74b.png" alt="1730165733618"></p> <h3 id="_13-支付秒杀订单"><a href="#_13-支付秒杀订单" class="header-anchor">#</a> 13, 支付秒杀订单</h3> <p>我们之前已经编写过支付宝支付的功能，此处不进行功能的重复编写。我们不调用支付宝支付，直接点击支付按钮，完成假支付即可。</p> <p>支付秒杀订单时需要删除redis中的订单数据，并将订单保存到数据库中</p> <ol><li><p>在秒杀实现类重写支付秒杀订单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.查询订单，设置数据</span>
  <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_EXPIRED_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单过期</span>
   <span class="token punctuation">}</span>


  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPaymentTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付宝支付</span>


  <span class="token comment">// 2.从redis删除订单数据</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 3.返回订单数据</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p>编写秒杀控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboReference</span>
<span class="token keyword">private</span> <span class="token class-name">OrdersService</span> ordersService<span class="token punctuation">;</span>

<span class="token comment">/**
 * 支付秒杀订单
 * @param id 订单id
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 支付秒杀订单</span>
  <span class="token class-name">Orders</span> orders <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将订单数据存入数据库</span>
  ordersService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>测试，发现有个小bug。因为在调用add方法时，把订单的状态又变成了1。</p></li> <li><p>修改订单服务的生成订单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 订单状态未付款</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 订单创建时间</span>
  orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 计算订单价格</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BigDecimal</span> num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数量</span>
    <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGood<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 单价</span>
    <span class="token class-name">BigDecimal</span> multiply <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>multiply<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存订单</span>
  ordersMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将订单商品（购物车商品）保存到数据库中</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cartGood<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartGoodsMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li></ol> <p>测试，支付完秒杀商品后，订单的状态变成了2。</p> <h3 id="_14-删除过期秒杀订单"><a href="#_14-删除过期秒杀订单" class="header-anchor">#</a> 14, 删除过期秒杀订单</h3> <p>用户成功秒杀下单后，如果长时间不支付，则该商品始终被用户占据，其他用户无法购买。我们需要给订单设置过期时间，过期后<strong>删除订单，回退商品库存</strong>。我们已经说过三种删除过期订单的方法：</p> <ol><li>定时任务定期扫描所有订单，发现过时后删除。</li> <li>利用延迟队列，过一段时间后查询订单是否已经支付。</li> <li>设置redis过期时间，利用redis过期监听方法在一段时间后查看订单状态。</li></ol> <p>之前我们采用第二种方式删除普通过期订单，在秒杀服务中，我们采用第三种方式删除过期秒杀订单</p> <ol><li><p>设置订单过期时间：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.生成订单对象</span>
  orders<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动生产订单id</span>
  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态未付款</span>
  orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单创建时间</span>
  orders<span class="token punctuation">.</span><span class="token function">setExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 计算商品价格</span>
  <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Integer</span> num <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.减少秒杀商品库存</span>
  <span class="token comment">// 查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查询库存，库存不足抛出异常</span>
  <span class="token class-name">Integer</span> stockCount <span class="token operator">=</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stockCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 减少库存</span>
  seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.保存订单数据</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置订单一分钟过期</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orders<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 给订单创建副本，副本的过期时间长于原订单
   * redis过期后触发过期事件时，redis数据已经过期，此时只能拿到key，拿不到value。
   * 而过期事件需要回退商品库存，必须拿到value即订单详情，才能拿到商品数据，进行回退操作
   * 我们保存一个订单副本，过期时间长于原订单，此时就可以通过副本拿到原订单数据
   */</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_copy&quot;</span><span class="token punctuation">,</span>orders<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div></li></ol> <h3 id="_15-监听秒杀订单过期事件"><a href="#_15-监听秒杀订单过期事件" class="header-anchor">#</a> 15, 监听秒杀订单过期事件</h3> <p>配置redis监听器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 配置redis监听器
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisListenerConfig</span> <span class="token punctuation">{</span>
  <span class="token comment">// 配置redis监听器，监听redis过期事件</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">RedisMessageListenerContainer</span> <span class="token function">container</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisMessageListenerContainer</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> container<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>创建redis监听类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * redis监听类继承KeyExpirationEventMessageListener
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisKeyExpirationListener</span> <span class="token keyword">extends</span> <span class="token class-name">KeyExpirationEventMessageListener</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillService</span> seckillService<span class="token punctuation">;</span>


  <span class="token keyword">public</span> <span class="token class-name">RedisKeyExpirationListener</span><span class="token punctuation">(</span><span class="token class-name">RedisMessageListenerContainer</span> listenerContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>listenerContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 订单过期后，关闭交易，回退商品库存
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取失效key，即订单id</span>
    <span class="token class-name">String</span> expiredKey <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 拿到复制订单信息</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>expiredKey <span class="token operator">+</span> <span class="token string">&quot;_copy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> goodId <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 产品id</span>
    <span class="token class-name">Integer</span> num <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 产品数量</span>


    <span class="token comment">// 查询秒杀商品</span>
    <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 回退库存</span>
    seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>goodId<span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 删除复制订单数据</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>expiredKey<span class="token operator">+</span><span class="token string">&quot;_copy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>修改支付代码，支付时删除复制订单</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.查询订单，设置相应数据</span>
  <span class="token class-name">Orders</span> orders <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Orders</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_EXPIRED_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPaymentTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付宝支付</span>


  <span class="token comment">// 2.从redis删除订单</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>orderId<span class="token operator">+</span><span class="token string">&quot;_copy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.返回订单数据</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这样生成订单时还会生成一个复制订单，订单数据过期触发过期事件，在过期事件中找到订单的复制订单，从复制订单中拿到商品数据，对商品进行回退库存。</p> <h3 id="_16-测试删除过期秒杀订单"><a href="#_16-测试删除过期秒杀订单" class="header-anchor">#</a> 16, 测试删除过期秒杀订单</h3> <p>测试：</p> <p><img src="/devops/public/assets/img/1727177085542.3f20cc74.png" alt="1727177085542"></p> <p><img src="/devops/public/assets/img/1727177093974.bab0a48b.png" alt="1727177093974"></p> <p><img src="/devops/public/assets/img/1727177108350.717eeaf7.png" alt="1727177108350"></p> <p>一分钟过后，又会变成剩余5件。</p> <p><img src="/devops/public/assets/img/1727177136576.e5666251.png" alt="1727177136576"></p> <p>但是在点击支付时，有一个bug如下，并且数据库也没有这个订单：</p> <p><img src="/devops/public/assets/img/1727177169294.5447adaa.png" alt="1727177169294"></p> <h3 id="_17-查询秒杀商品详情漏洞"><a href="#_17-查询秒杀商品详情漏洞" class="header-anchor">#</a> 17, 查询秒杀商品详情漏洞</h3> <p>在秒杀服务中，用户从redis查询秒杀商品，但redis缓存中的数据是不保证安全的，如果某个商品从redis中丢失，则用户没有办法查询到这件商品。</p> <p>我们在秒杀服务模块编写一个模拟redis中商品丢失的测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">ShoppingSeckillServiceApplicationTests</span> <span class="token punctuation">{</span>


  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">149187842867998L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试商品丢失后，用户是否能查询商品详情。
<img src="/devops/public/assets/img/1730170213816.46634906.png" alt="1730170213816"></p> <p><img src="/devops/public/assets/img/1727177444046.f0d19f2f.png" alt="1727177444046"></p> <p>所以我们要优化查询秒杀商品详情的方法，优化思路如下：</p> <ul><li>用户先从redis中查询秒杀商品，如果查到，直接返回。</li> <li>如果没有查到，则从数据库中查询秒杀商品。</li> <li>如果数据库商品不在秒杀状态，返回空</li> <li>如果数据库商品在秒杀状态，将数据库中的秒杀商品保存到redis中，将商品返回。</li></ul> <h3 id="_18-优化查询秒杀商品详情"><a href="#_18-优化查询秒杀商品详情" class="header-anchor">#</a> 18, 优化查询秒杀商品详情</h3> <p>在<strong>秒杀模块</strong>添加向缓存添加秒杀商品的方法：</p> <p><img src="/devops/public/assets/img/1730170697462.67f87fe2.png" alt="1730170697462"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 将一个秒杀商品保存到redis中
   * @param seckillGoods 秒杀商品对象
   */</span>
  <span class="token keyword">void</span> <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token number">2</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>修改查询秒杀商品详情方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.从redis中查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.如果查到商品，返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从redis中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> seckillGoods<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.如果没有查到商品，从数据库查询秒杀商品</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SeckillGoods</span> seckillGoodsMysql <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从mysql中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.如果该商品不在秒杀状态，抛出异常</span>
    <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoodsMysql <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token number">0</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 5.如果该商品在秒杀状态，将商品保存到redis，并返回该商品</span>
    <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> seckillGoodsMysql<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_19-测试优化查询秒杀商品详情"><a href="#_19-测试优化查询秒杀商品详情" class="header-anchor">#</a> 19, 测试优化查询秒杀商品详情</h3> <p><img src="/devops/public/assets/img/1727178383034.8759a61f.png" alt="1727178383034"></p> <p><img src="/devops/public/assets/img/1727178406956.c42e7fd5.png" alt="1727178406956"></p> <p><img src="/devops/public/assets/img/1727178395465.3729f473.png" alt="1727178395465"></p> <h3 id="_20-缓存穿透的产生"><a href="#_20-缓存穿透的产生" class="header-anchor">#</a> 20, 缓存穿透的产生</h3> <p>缓存穿透是指，用户查询数据库不存在的数据。数据库没有的数据，缓存中自然也不会有。这就导致用户查询的时候，在缓存中找不到，每次都要去数据库查询一遍，然后返回空，相当于进行了两次无用的查询。</p> <p>此时的用户很可能是一名攻击者，用户不断进行这种访问，相当于请求不断的绕过缓存，直接查数据库，所以称之为<strong>缓存穿透</strong>。这种攻击会导致数据库压力过大。我们通过测试模拟用户攻击通过缓存穿透攻击系统：</p> <ol><li><p>在Postman中测试查询id=-1的秒杀商品</p> <p><img src="/devops/public/assets/img/1730171359951.a28ef771.png" alt="1730171359951"></p> <p><img src="/devops/public/assets/img/1730171412574.a0cf32ee.png" alt="1730171412574"></p></li> <li><p>在Postman中进行查询秒杀商品详情的压力测试</p> <p><img src="/devops/public/assets/img/1727178739400.ce0f6f59.png" alt="1727178739400"></p> <ul><li><p>将测试接口保存到另一个Collection中</p></li> <li><p>在另一个Collection中使用Run功能进行压力测试</p></li></ul></li></ol> <p>我们可以看到所有的请求都穿透了redis缓存，连接数据库进行查询，这对于数据库的压力非常大。</p> <h3 id="_21-布隆过滤器"><a href="#_21-布隆过滤器" class="header-anchor">#</a> 21, 布隆过滤器</h3> <p>我们通过布隆过滤器解决缓存穿透的问题。</p> <p>布隆过滤器是一种概率型数据结构，它可以高效的插入元素，并可以判断某个元素是否存在，布隆过滤器判断不存在的元素<strong>一定不存在</strong>，但布隆过滤器判断存在的元素只是<strong>有可能存在</strong>。</p> <p>布隆过滤器的工作流程如下：</p> <ol><li>准备一个bit类型的数组，初始化时里面的元素全部为0</li> <li>将要保存的元素，通过Hash算法得出几个下标，将数组中元素对应的下标都改为1。</li> <li>验证这个元素是否存在时，只需要将该元素通过Hash算法得出下标，查看数组中这些下标对应的元素是否都为1。如果不是都为1，该元素不存在，如果都为1，该元素<strong>大概率存在</strong>。</li></ol> <p><img src="/devops/public/assets/img/1727178795637.8cad2278.png" alt="1727178795637"></p> <h3 id="_22-解决缓存穿透"><a href="#_22-解决缓存穿透" class="header-anchor">#</a> 22, 解决缓存穿透</h3> <p>接下来我们使用布隆过滤器解决缓存穿透：</p> <ol><li><p>在秒杀模块引入hutool依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- hutool工具包，里面带有布隆过滤器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.7.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>在启动类向容器注入布隆过滤器的Map</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 布隆过滤器</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">BitMapBloomFilter</span> <span class="token function">bloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 构造方法的参数 决定了布隆过滤器能存放多少元素</span>
  <span class="token class-name">BitMapBloomFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitMapBloomFilter</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> filter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>修改同步秒杀商品、向redis添加秒杀商品方法，将秒杀商品存入redis的同时，也存入布隆过滤器的Map中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">BitMapBloomFilter</span> bitMapBloomFilter<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 每分钟查询一次数据库，更新redis中的秒杀商品数据
   * 条件为startTime &lt; 当前时间 &lt; endTime,库存大于0
   */</span>
  <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 * * * * *&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;同步mysql秒杀商品到redis...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将redis中秒杀商品的库存数据同步到mysql</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsListOld <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsListOld<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在数据库查询秒杀商品</span>
      <span class="token class-name">SeckillGoods</span> sqlSeckillGoods <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 修改数据库中秒杀商品的库存，和redis中的库存保持一致</span>
      sqlSeckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>sqlSeckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>


    <span class="token comment">// 1.查询数据库中“正在秒杀”的商品</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token string">&quot;startTime&quot;</span><span class="token punctuation">,</span>now<span class="token punctuation">)</span> <span class="token comment">// 当前时间晚于开始时间</span>
       <span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span>now<span class="token punctuation">)</span> <span class="token comment">// 当前时间早于结束时间</span>
       <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stockCount&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 库存大于0</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.删除之前的秒杀商品</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 3.保存现在正在秒杀的商品</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将正在秒杀的商品保存到布隆过滤器</span>
      bitMapBloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bitMapBloomFilter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div></li> <li><p>修改查询秒杀商品详情方法，在查询秒杀商品前，先使用布隆过滤器判断商品是否存在。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 布隆过滤器判断秒杀商品是否存在，如果不存在，直接返回空</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bitMapBloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;布隆过滤器判断商品不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 1.从redis中查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.如果查到商品，返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从redis中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> seckillGoods<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.如果没有查到商品，从数据库查询秒杀商品</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SeckillGoods</span> seckillGoodsMysql <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从mysql中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.如果该商品不在秒杀状态，抛出异常</span>
    <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoodsMysql <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token number">0</span>
     <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 5.如果该商品在秒杀状态，将商品保存到redis，并返回该商品</span>
    <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> seckillGoodsMysql<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div></li> <li><p>测试布隆过滤器是否生效</p> <p><img src="/devops/public/assets/img/1727179193576.64e24d2f.png" alt="1727179193576"></p></li></ol> <h3 id="_23-缓存击穿的产生和解决"><a href="#_23-缓存击穿的产生和解决" class="header-anchor">#</a> 23, 缓存击穿的产生和解决</h3> <p>缓存击穿是指，redis缓存中的数据在过期的一瞬间，突然有大量请求拥入，由于此时缓存过期，所以请求最终都会流入数据库，造成瞬时数据库请求量大、压力骤增，甚至可能打垮数据库。</p> <p>在我们的秒杀功能中不会出现缓存击穿问题。因为我们的秒杀商品数据是没有设置过期时间的，也就不存在过期时的击穿问题。并且<strong>将缓存设置为不过期,由定时任务去更新缓存</strong>就是解决缓存击穿的一种方案。</p> <p>缓存击穿的另一种解决方案是利用互斥锁，即要求只能有一个线程拿到锁并执行数据库查询操作，其他没有锁的线程会被阻塞，等到第一个线程将数据写入缓存后，其他线程直接查询缓存。</p> <h3 id="_24-缓存雪崩的产生"><a href="#_24-缓存雪崩的产生" class="header-anchor">#</a> 24, 缓存雪崩的产生</h3> <p>缓存雪崩是指在某一时刻，大量缓存突然失效，请求全部转发到数据库，数据库瞬时压力过大导致崩溃。缓存雪崩的产生原因一般有两种：</p> <p>原因一</p> <p>缓存中大量的数据同时过期。在某一时刻，大量的缓存同时过期，此时如果有请求访问这些数据的话，缓存不存在，会将请求转移到数据库，如果这些的请求量比较大的，导致数据库的压力增大，严重会导致数据库崩溃。此时解决方案一般有以下几种：</p> <ol><li><p>设置缓存不过期。我们项目中的秒杀商品数据没有设置过期时间，所以不会出现缓存中大量的数据同时过期的问题。</p></li> <li><p>过期时间设置随机值。为了避免给数据设置相同的过期时间，在设置过期时间时，可以增加一点随机值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>time<span class="token operator">+</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p>原因二</p> <p>Redis服务挂掉了。即Redis服务发生宕机，无法处理请求，这就会导致全部转移到数据库去，发生雪崩。此时的解决方案一般有以下几种：</p> <ol><li>配置Redis高可用。也就是搭建Redis集群，这样即便个别Redis节点下线，整个缓存层依然可以使用。除此之外，还可以在多个机房部署Redis，这样即便是机房死机，依然可以实现缓存层的高可用。这些操作一般由运维人员完成。</li> <li>添加熔断机制。即发生雪崩时，暂停对缓存的访问。我们可以监控数据库的压力，如果数据库的请求压力倍增，可以启动熔断机制，暂停对缓存和数据库的访问。等redis服务恢复正常后，再允许访问缓存。</li> <li>添加限流机制。暂停对缓存系统的访问，但是对整个业务系统影响很大，导致很多数据不能查看，为了减少这种影响还有另一个方案：请求限流。请求限流就是限制数据库方法的访问量，过多的请求直接拒绝。</li></ol> <p>为了防止缓存雪崩以及访问量过大时对系统的冲击，我们引入分布式流量防护工具——Sentinel保护我们的系统。</p> <h3 id="_25-安装sentinel"><a href="#_25-安装sentinel" class="header-anchor">#</a> 25, 安装Sentinel</h3> <ol><li><p>使用rz命令将Sentinel上传到虚拟机</p></li> <li><p>启动Sentinel</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>nohup java <span class="token operator">-</span>server <span class="token operator">-</span><span class="token class-name">Xms64m</span> <span class="token operator">-</span><span class="token class-name">Xmx256m</span> <span class="token operator">-</span><span class="token class-name">Dserver</span><span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8899</span> <span class="token operator">-</span><span class="token class-name">Dcsp</span><span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>dashboard<span class="token punctuation">.</span>server<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.99</span><span class="token operator">:</span><span class="token number">8899</span> <span class="token operator">-</span><span class="token class-name">Dproject</span><span class="token punctuation">.</span>name<span class="token operator">=</span>sentinel<span class="token operator">-</span>dashboard <span class="token operator">-</span>jar sentinel<span class="token operator">-</span>dashboard<span class="token operator">-</span><span class="token number">1.8</span><span class="token number">.6</span><span class="token punctuation">.</span>jar <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>opt<span class="token operator">/</span>sentinel<span class="token punctuation">.</span>log <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">&amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>登录Sentinel，在浏览器输入<a href="http://192.168.0.99:8899/" target="_blank" rel="noopener noreferrer">http://192.168.0.99:8899<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，登录用户名密码都是<code>sentinel</code></p></li></ol> <h3 id="_26-将sentinel接入项目"><a href="#_26-将sentinel接入项目" class="header-anchor">#</a> 26, 将Sentinel接入项目</h3> <p>在<strong>秒杀服务模块</strong>和<strong>秒杀Api模块</strong>添加Setinel依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>修改nacos配置中心的<code>shopping_seckill_service-dev.yaml</code>和<code>shopping_seckill_customer_api-dev.yaml</code>配置文件</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">transport</span><span class="token punctuation">:</span>
    <span class="token comment"># Sentinel 控制台地址</span>
     <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8899</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>启动项目，在Postman访问查询秒杀商品详情方法，将该接口注册到Setinel中。</p> <p><img src="/devops/public/assets/img/1727180043278.23b39f72.png" alt="1727180043278"></p> <h3 id="_27-sentinel解决缓存雪崩"><a href="#_27-sentinel解决缓存雪崩" class="header-anchor">#</a> 27, Sentinel解决缓存雪崩</h3> <p>在我们的项目中，由于秒杀商品的缓存没有设置过期时间，所以雪崩的产生一定是因为Redis服务异常。</p> <p>当Redis服务异常后，所有请求都访问数据库，造成数据库压力过大。我们的解决思路就是，监控查询数据库秒杀商品的方法，如果该方法的流量突然增加，不会是某件商品从缓存丢失，一定是Redis服务异常，此时我们对服务进行限流降级处理。</p> <ol><li><p>修改查询秒杀商品详情方法，因为Setinel只能将生产者方法作为资源进行防护，所以将从数据库查询秒杀商品的方法独立出来。</p> <p><img src="/devops/public/assets/img/1730251962607.b49a0293.png" alt="1730251962607"></p> <p><img src="/devops/public/assets/img/1730252114378.d969ebef.png" alt="1730252114378"></p> <p><img src="/devops/public/assets/img/1730252140100.20462fa0.png" alt="1730252140100"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
     * 从数据库根据商品id查询秒杀商品
   */</span>
  <span class="token class-name">SeckillGoods</span> <span class="token function">findSecillGoodsByMySql</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 布隆过滤器判断商品是否存在，如果不存在，直接返回空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bitMapBloomFilter<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;布隆过滤器判断商品不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 1. 从redis中查询秒杀商品</span>
    <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 如果查到商品，返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从redis中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> seckillGoods<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSecillGoodsByMySql</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4. 如果该商品不在秒杀状态，返回null</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SeckillGoods</span> seckillGoodsMysql <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从mysql中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoodsMysql <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 5. 如果该商品在秒杀状态，将商品保存到redis中，并返回该商品</span>
    <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> seckillGoodsMysql<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></li> <li><p>修改查询秒杀商品详情的控制器方法</p> <p><img src="/devops/public/assets/img/1730252215543.36c2c92e.png" alt="1730252215543"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
   * 用户查询秒杀商品详情
   * @param id 商品id
   * @return 查询结果
   */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从redis中查询秒杀商品详情</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果redis中查找不到，再从数据库查询秒杀商品详情</span>
    <span class="token class-name">SeckillGoods</span> secillGoodsByMySql <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">findSecillGoodsByMySql</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>secillGoodsByMySql<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>给从数据库查询秒杀商品详情方法设置Setinel资源</p> <p><img src="/devops/public/assets/img/1730252271198.431dbf72.png" alt="1730252271198"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;findSecillGoodsByMySql&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSecillGoodsByMySql</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 4. 如果该商品不在秒杀状态，返回null</span>
  <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SeckillGoods</span> seckillGoodsMysql <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从mysql中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoodsMysql <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 5. 如果该商品在秒杀状态，将商品保存到redis中，并返回该商品</span>
  <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> seckillGoodsMysql<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li></ol> <p><img src="/devops/public/assets/img/1730252529271.dadd2c56.png" alt="1730252529271"></p> <p><img src="/devops/public/assets/img/1730252569372.1ed5cfaa.png" alt="1730252569372"></p> <p><img src="/devops/public/assets/img/1727180788992.eabe8bc8.png" alt="1727180788992"></p> <p><img src="/devops/public/assets/img/1727180820199.6e34da3f.png" alt="1727180820199"></p> <h3 id="_28-配置服务降级方法"><a href="#_28-配置服务降级方法" class="header-anchor">#</a> 28, 配置服务降级方法</h3> <p>我们测试时访问id=-1的资源模拟redis服务崩溃，为了方便测试，注释掉布隆过滤器的代码。</p> <p>重新启动项目，设置从数据库查询秒杀商品资源的QPS为5，测试大量访问id=-1的秒杀资源时，限流是否生效。</p> <p>限流时会产生大量失败请求，为了响应更加友好，我们配置Setinel服务降级。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;findSecillGoodsByMySql&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;mysqlBlockHandler&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">findSecillGoodsByMySql</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 4. 如果该商品不在秒杀状态，返回null</span>
  <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">SeckillGoods</span> seckillGoodsMysql <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;从mysql中查询秒杀商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoodsMysql <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> seckillGoodsMysql<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 5. 如果该商品在秒杀状态，将商品保存到redis中，并返回该商品</span>
  <span class="token function">addRedisSeckillGoods</span><span class="token punctuation">(</span>seckillGoodsMysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> seckillGoodsMysql<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
   * 降级处理
   * @return 空值
   */</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillGoods</span> <span class="token function">mysqlBlockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">,</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务降级处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>测试服务降级是否生效</p> <p><img src="/devops/public/assets/img/1727181023247.40c00560.png" alt="1727181023247"></p> <h3 id="_29-sentinel流量防护"><a href="#_29-sentinel流量防护" class="header-anchor">#</a> 29, Sentinel流量防护</h3> <p>除了使用Setinel解决缓存雪崩，我们可以使用Setinel对项目的任何接口进行流量防护。我们以分页查询秒杀商品为例，配置Setinel流量防护。</p> <ol><li><p>重启秒杀相关模块，在Sentinel配置分页查询秒杀接口的QPS为1</p> <p><img src="/devops/public/assets/img/1727181132472.2c0ab9c6.png" alt="1727181132472"></p></li> <li><p>在Postman中测试分页查询秒杀接口是否被流量防护。</p> <p><img src="/devops/public/assets/img/1727181173368.87aef903.png" alt="1727181173368"></p></li> <li><p>流量异常时，提示信息不是很友好，所以我们在代码中对流量异常进行统一处理。</p></li> <li><p>在通用模块引入Sentinel依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>在通用模块编写自定义流量异常处理器，统一处理流量异常。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBlockExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">BlockExceptionHandler</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>   
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">FlowException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">BaseResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseResult</span><span class="token punctuation">(</span><span class="token number">701</span><span class="token punctuation">,</span><span class="token string">&quot;流量异常&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      httpServletResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/json;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>在<code>org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>中配置流量异常处理器，让每个模块都可以加载该处理器。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.ityls.shopping_common.result.GlobalExceptionHandler
com.ityls.shopping_common.result.MyBlockExceptionHandler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>重启项目，访问分页查询秒杀商品功能</p> <p><img src="/devops/public/assets/img/1727181356925.27420bc2.png" alt="1727181356925"></p></li></ol> <h3 id="_30-sentinel服务熔断"><a href="#_30-sentinel服务熔断" class="header-anchor">#</a> 30, Sentinel服务熔断</h3> <p>Setinel可以监测我们项目中的任意服务，如果响应时间过长或出现异常，可以对服务进行熔断保护，避免一个服务的问题引发整个项目的崩溃。我们以分页查询秒杀商品的生产者为例，配置服务熔断保护。</p> <ol><li><p>修改分页查询秒杀商品的生产者，让该服务的响应时间加长，并配置Sentinel资源。</p> <p><img src="/devops/public/assets/img/1730256530359.58e48ff0.png" alt="1730256530359"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;findPageByRedis&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByRedis</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 查询所有秒杀商品列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2. 获取当前页商品列表</span>
  <span class="token comment">// 开启截取索引</span>
  <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">;</span>
  <span class="token comment">// 结束截取索引</span>
  <span class="token keyword">int</span> end <span class="token operator">=</span> start <span class="token operator">+</span> size <span class="token operator">&gt;</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
  <span class="token comment">// 截取当前页的结果集</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoods <span class="token operator">=</span> seckillGoodsList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.构造页面对象</span>
  <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsPage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  seckillGoodsPage<span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token comment">// 当前页</span>
       <span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token comment">// 每页条数</span>
       <span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>seckillGoodsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 总条数</span>
       <span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果集</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> seckillGoodsPage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></li> <li><p>配置熔断保护参数</p> <p><img src="/devops/public/assets/img/1727224736633.aa451aac.png" alt="1727224736633"></p></li> <li><p>测试分页查询秒杀商品，看该服务是否被熔断保护</p> <p><img src="/devops/public/assets/img/1727224835085.9e338651.png" alt="1727224835085"></p> <p>熔断后，至于如何处理，大家自行实现。</p></li></ol> <h3 id="_31-秒杀超卖现象-1"><a href="#_31-秒杀超卖现象-1" class="header-anchor">#</a> 31, 秒杀超卖现象(1)</h3> <p>一个物品库存里有100件，但是由于秒杀环境的高并发，导致该物品被卖出超过100件。这就是超卖问题。</p> <p>我们通过一个测试演示超卖现象：</p> <ol><li><p>新增两个秒杀商品</p></li> <li><p>修改秒杀下单的代码，提示订单生成。</p> <p><img src="/devops/public/assets/img/1730258048609.eec43f62.png" alt="1730258048609"></p> <p><img src="/devops/public/assets/img/1730258108813.72c922a8.png" alt="1730258108813"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.生成订单对象</span>
  orders<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动使用雪花算法生成订单id</span>
  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态未付款</span>
  orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单创建时间</span>
  orders<span class="token punctuation">.</span><span class="token function">setExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单过期时间</span>
  <span class="token comment">// 计算商品价格</span>
  <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Integer</span> num <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.减少秒杀商品库存</span>
  <span class="token comment">// 查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 查询库存，库存不足抛出异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 减少库存</span>
  seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.将订单数据保存到Redis中</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置订单1分钟过期</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
     * 给订单创建副本，副本的过期时间长于原订单
     * redis过期后触发过期事件时，redis的数据已经过期，此时只能拿到key，拿不到value
     * 而过期事件需要回退商品库存，必须拿到value即订单详情，才能拿到商品数据，进行回退操作
     * 我们保存一个订单副本，过期时间长于原订单，我们就可以通过副本拿到订单数据
     */</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_copy&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;下单成功,订单号:&quot;</span><span class="token operator">+</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div></li> <li><p>重启秒杀服务</p></li> <li><p>由于Postman只能批量发送是串行发送，也就是第一个请求发送完成才能发送第二个请求，无法模拟高并发下单，所以我们需要使用另一个测试工具——JMeter。</p></li> <li><p>解压JMeter，启动JMeter（启动JMeter要求我们的电脑必须安装JDK并配置好环境变量）。</p></li> <li><p>添加线程组，在线程组下添加HTTP请求、查看结果树。在HTTP请求下添加HTTP信息头管理器。</p> <p><img src="/devops/public/assets/img/1727225053027.065047e0.png" alt="1727225053027"></p></li> <li><p>在HTTP信息头管理器下添加请求头。</p> <p><img src="/devops/public/assets/img/1727225072496.45a56763.png" alt="1727225072496"></p></li> <li><p>添加HTTP请求</p> <p><img src="/devops/public/assets/img/1727225098076.582daa8b.png" alt="1727225098076"></p></li> <li><p>分别测试普通并发和高并发情况下，秒杀商品下单是否会出现超卖现象</p> <p><img src="/devops/public/assets/img/1727225119612.0216e833.png" alt="1727225119612"></p></li></ol> <p><img src="/devops/public/assets/img/1727225367039.a161b4b0.png" alt="1727225367039"></p> <p>一个一个下单，不会有超卖问题。如果并发的话，就可能产生超卖问题：</p> <p><img src="/devops/public/assets/img/1730249508381.9b91c3d0.png" alt="1730249508381"></p> <p><img src="/devops/public/assets/img/1727225425931.38043e63.png" alt="1727225425931"></p> <p><img src="/devops/public/assets/img/1727225499544.67485f0a.png" alt="1727225499544"></p> <h3 id="_32-秒杀超卖的产生原因"><a href="#_32-秒杀超卖的产生原因" class="header-anchor">#</a> 32, 秒杀超卖的产生原因</h3> <p><img src="/devops/public/assets/img/1727225531613.dc327291.png" alt="1727225531613"></p> <h3 id="_33-synchronized解决秒杀超卖"><a href="#_33-synchronized解决秒杀超卖" class="header-anchor">#</a> 33, synchronized解决秒杀超卖</h3> <p>在单体项目中，可以通过给秒杀下单方法添加<code>synchronized</code>关键字解决超卖问题，即有锁的线程才能秒杀下单，其他线程只能等待，这样就把并发下单变成了顺序下单。解决了超卖问题。</p> <ol><li><p>添加两个秒杀商品</p></li> <li><p>修改秒杀下单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.生成订单对象</span>
  orders<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动使用雪花算法生成订单id</span>
  orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态未付款</span>
  orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单创建时间</span>
  orders<span class="token punctuation">.</span><span class="token function">setExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单过期时间</span>
  <span class="token comment">// 计算商品价格</span>
  <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Integer</span> num <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 2.减少秒杀商品库存</span>
  <span class="token comment">// 查询秒杀商品</span>
  <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 查询库存，库存不足抛出异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 减少库存</span>
  seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 3.将订单数据保存到Redis中</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置订单1分钟过期</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 给订单创建副本，副本的过期时间长于原订单
   * redis过期后触发过期事件时，redis的数据已经过期，此时只能拿到key，拿不到value
   * 而过期事件需要回退商品库存，必须拿到value即订单详情，才能拿到商品数据，进行回退操作
   * 我们保存一个订单副本，过期时间长于原订单，我们就可以通过副本拿到订单数据
   */</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_copy&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;下单成功，订单号:&quot;</span><span class="token operator">+</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;库存还有:&quot;</span><span class="token operator">+</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div></li> <li><p>使用Jmeter测试高并发秒杀</p></li> <li><p><img src="/devops/public/assets/img/1727225855566.0129b56a.png" alt="1727225855566"></p> <p><img src="/devops/public/assets/img/1727225748464.b27cafc3.png" alt="1727225748464"></p></li></ol> <h3 id="_34-代码锁在分布式项目中的局限性"><a href="#_34-代码锁在分布式项目中的局限性" class="header-anchor">#</a> 34, 代码锁在分布式项目中的局限性</h3> <p>代码锁的方式只能解决单体项目中的秒杀超卖问题。而在分布式项目中，秒杀服务是一个集群，有很多节点共同维护秒杀服务，而代码锁只在当前JVM中生效，不同的服务器间无法互相访问锁。所以代码锁是不能解决分布式项目中秒杀超卖问题的。接下来我们就演示一下秒杀服务集群中，代码锁的局限性。</p> <p><img src="/devops/public/assets/img/1727226003345.db34d5d4.png" alt="1727226003345"></p> <ol><li><p>修改<code>shopping_seckill_service-dev.yaml</code>中的项目端口号。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9095</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>再启动一个秒杀服务模块</p> <p><img src="/devops/public/assets/img/1727226032802.08ac3a81.png" alt="1727226032802"></p></li> <li><p>使用Jmeter测试高并发秒杀</p> <p><img src="/devops/public/assets/img/1727226047013.8708be0f.png" alt="1727226047013"></p> <p><img src="/devops/public/assets/img/1727226091016.6df85c22.png" alt="1727226091016"></p></li></ol> <h3 id="_35-分布式锁解决方案"><a href="#_35-分布式锁解决方案" class="header-anchor">#</a> 35, 分布式锁解决方案</h3> <p>在项目中，分布式锁的解决方案有以下几种：</p> <p>基于数据库实现的分布式锁</p> <ol><li>数据库乐观锁：在秒杀商品表中添加version字段。查询秒杀商品时，获取当前version。更新时，修改version字段，并判断version号是否等于之前获得的version号，如果不等于，证明在更新操作时，有别的线程修改了数据库，此时更新失败。</li> <li>数据库悲观锁：在数据库查询秒杀商品时的sql语句后添加<code>for update</code>，即可防止修改秒杀商品库存期间，有别的线程修改数据库。</li></ol> <p>我们的秒杀商品数据不在数据库中保存，而在redis中保存，所以这些基于数据库实现的分布式锁都不可用。</p> <p>基于Zookeeper实现分布式锁</p> <ol><li>我们也可以通过创建Zookeper临时顺序节点实现分布式锁。但我们的项目中并没有使用Zookeeper，所以也不用这种方案</li></ol> <p>基于Redis实现分布式锁</p> <ol><li><p>使用Redis来实现分布式锁的效率最高，加锁速度最快，因为Redis几乎都是纯内存操作，而基于数据库的方案和基于Zookeeper的方案都会涉及到磁盘文件IO，效率相对低下。所以在开发过程中，最常用的分布式锁方案就是使用Redis的SETNX命令实现分布式锁。SETNX即只有在键不存在时，才能设置键。我们在秒杀时，必须要设置秒杀商品id的键，此时键已经存在，别人无法设置秒杀商品id，也就不能进行秒杀，这就相当于加锁。等我们秒杀结束，删除秒杀商品id的键，别人又可以设置秒杀商品id，别人可以进行秒杀，这就相当于解锁。</p></li> <li><p>我们用这种方式，可以很优雅的为代码设置分布式锁。</p></li></ol> <h3 id="_36-redisson实现分布式锁"><a href="#_36-redisson实现分布式锁" class="header-anchor">#</a> 36, Redisson实现分布式锁</h3> <p>Redisson是一个高级的分布式协调Redis客户端，能帮助用户在分布式环境中轻松操作Redis服务，Jedis更侧重对Redis的增删改查，而Redisson侧重于分布式开发。</p> <p>在秒杀服务模块引入Redisson依赖，秒杀服务模块已经配置了redis连接，所以不需要再配置了。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- Redisson --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.27.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>编写Redisson工具类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonLock</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>


  <span class="token comment">// 加锁</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expireTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到锁的名字。redis的key，即锁的名为秒杀商品id</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * 尝试获取锁，如果没有别人占用这把锁，则拿到锁
       *
       * 参数代表redis过期时间，即如果没有主动释放锁，到期会自动释放，防止服务器出现问题后引发死锁
       */</span>
      <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * 没有拿到锁证明别人占用，中断当前线程
       */</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 释放锁</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿到锁的名字</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果锁被占用，释放锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>修改秒杀下单方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> lockKey <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>redissonLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token comment">// 1.生成订单对象</span>
      orders<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动使用雪花算法生成订单id</span>
      orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态未付款</span>
      orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单创建时间</span>
      orders<span class="token punctuation">.</span><span class="token function">setExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单过期时间</span>
      <span class="token comment">// 计算商品价格</span>
      <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Integer</span> num <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token comment">// 2.减少秒杀商品库存</span>
      <span class="token comment">// 查询秒杀商品</span>
      <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token function">findSeckillGoodsByRedis</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>


      <span class="token comment">// 查询库存，库存不足抛出异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>


      <span class="token comment">// 减少库存</span>
      seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getGoodsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


      <span class="token comment">// 3.将订单数据保存到Redis中</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置订单1分钟过期</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/**
       * 给订单创建副本，副本的过期时间长于原订单
       * redis过期后触发过期事件时，redis的数据已经过期，此时只能拿到key，拿不到value
       * 而过期事件需要回退商品库存，必须拿到value即订单详情，才能拿到商品数据，进行回退操作
       * 我们保存一个订单副本，过期时间长于原订单，我们就可以通过副本拿到订单数据
       */</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_copy&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;下单成功，订单号:&quot;</span><span class="token operator">+</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;库存还有:&quot;</span><span class="token operator">+</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
      redissonLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h3 id="_37-测试分布式锁"><a href="#_37-测试分布式锁" class="header-anchor">#</a> 37, 测试分布式锁</h3> <p>新增秒杀商品</p> <p>重启两个服务，测试秒杀下单功能。</p> <p><img src="/devops/public/assets/img/1727226699254.804d28f7.png" alt="1727226699254"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/26/2024, 9:15:52 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_1-创建秒杀相关模块" class="sidebar-link reco-side-_1-创建秒杀相关模块" data-v-b57cc07c>1, 创建秒杀相关模块</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_2-编写秒杀服务接口" class="sidebar-link reco-side-_2-编写秒杀服务接口" data-v-b57cc07c>2, 编写秒杀服务接口</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_3-同步秒杀商品到redis-1" class="sidebar-link reco-side-_3-同步秒杀商品到redis-1" data-v-b57cc07c>3, 同步秒杀商品到redis(1)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_4-同步秒杀商品到redis-2" class="sidebar-link reco-side-_4-同步秒杀商品到redis-2" data-v-b57cc07c>4, 同步秒杀商品到redis(2)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_5-分页查询秒杀商品列表-1" class="sidebar-link reco-side-_5-分页查询秒杀商品列表-1" data-v-b57cc07c>5, 分页查询秒杀商品列表(1)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_6-分页查询秒杀商品列表-2" class="sidebar-link reco-side-_6-分页查询秒杀商品列表-2" data-v-b57cc07c>6, 分页查询秒杀商品列表(2)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_7-测试查询秒杀商品列表" class="sidebar-link reco-side-_7-测试查询秒杀商品列表" data-v-b57cc07c>7, 测试查询秒杀商品列表</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_8-查询秒杀商品详情" class="sidebar-link reco-side-_8-查询秒杀商品详情" data-v-b57cc07c>8, 查询秒杀商品详情</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_9-生成秒杀订单-1" class="sidebar-link reco-side-_9-生成秒杀订单-1" data-v-b57cc07c>9, 生成秒杀订单(1)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_10-生成秒杀订单-2" class="sidebar-link reco-side-_10-生成秒杀订单-2" data-v-b57cc07c>10, 生成秒杀订单(2)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_11-将redis商品同步到mysql中" class="sidebar-link reco-side-_11-将redis商品同步到mysql中" data-v-b57cc07c>11, 将redis商品同步到mysql中</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_12-查询秒杀订单详情" class="sidebar-link reco-side-_12-查询秒杀订单详情" data-v-b57cc07c>12, 查询秒杀订单详情</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_13-支付秒杀订单" class="sidebar-link reco-side-_13-支付秒杀订单" data-v-b57cc07c>13, 支付秒杀订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_14-删除过期秒杀订单" class="sidebar-link reco-side-_14-删除过期秒杀订单" data-v-b57cc07c>14, 删除过期秒杀订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_15-监听秒杀订单过期事件" class="sidebar-link reco-side-_15-监听秒杀订单过期事件" data-v-b57cc07c>15, 监听秒杀订单过期事件</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_16-测试删除过期秒杀订单" class="sidebar-link reco-side-_16-测试删除过期秒杀订单" data-v-b57cc07c>16, 测试删除过期秒杀订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_17-查询秒杀商品详情漏洞" class="sidebar-link reco-side-_17-查询秒杀商品详情漏洞" data-v-b57cc07c>17, 查询秒杀商品详情漏洞</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_18-优化查询秒杀商品详情" class="sidebar-link reco-side-_18-优化查询秒杀商品详情" data-v-b57cc07c>18, 优化查询秒杀商品详情</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_19-测试优化查询秒杀商品详情" class="sidebar-link reco-side-_19-测试优化查询秒杀商品详情" data-v-b57cc07c>19, 测试优化查询秒杀商品详情</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_20-缓存穿透的产生" class="sidebar-link reco-side-_20-缓存穿透的产生" data-v-b57cc07c>20, 缓存穿透的产生</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_21-布隆过滤器" class="sidebar-link reco-side-_21-布隆过滤器" data-v-b57cc07c>21, 布隆过滤器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_22-解决缓存穿透" class="sidebar-link reco-side-_22-解决缓存穿透" data-v-b57cc07c>22, 解决缓存穿透</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_23-缓存击穿的产生和解决" class="sidebar-link reco-side-_23-缓存击穿的产生和解决" data-v-b57cc07c>23, 缓存击穿的产生和解决</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_24-缓存雪崩的产生" class="sidebar-link reco-side-_24-缓存雪崩的产生" data-v-b57cc07c>24, 缓存雪崩的产生</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_25-安装sentinel" class="sidebar-link reco-side-_25-安装sentinel" data-v-b57cc07c>25, 安装Sentinel</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_26-将sentinel接入项目" class="sidebar-link reco-side-_26-将sentinel接入项目" data-v-b57cc07c>26, 将Sentinel接入项目</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_27-sentinel解决缓存雪崩" class="sidebar-link reco-side-_27-sentinel解决缓存雪崩" data-v-b57cc07c>27, Sentinel解决缓存雪崩</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_28-配置服务降级方法" class="sidebar-link reco-side-_28-配置服务降级方法" data-v-b57cc07c>28, 配置服务降级方法</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_29-sentinel流量防护" class="sidebar-link reco-side-_29-sentinel流量防护" data-v-b57cc07c>29, Sentinel流量防护</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_30-sentinel服务熔断" class="sidebar-link reco-side-_30-sentinel服务熔断" data-v-b57cc07c>30, Sentinel服务熔断</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_31-秒杀超卖现象-1" class="sidebar-link reco-side-_31-秒杀超卖现象-1" data-v-b57cc07c>31, 秒杀超卖现象(1)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_32-秒杀超卖的产生原因" class="sidebar-link reco-side-_32-秒杀超卖的产生原因" data-v-b57cc07c>32, 秒杀超卖的产生原因</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_33-synchronized解决秒杀超卖" class="sidebar-link reco-side-_33-synchronized解决秒杀超卖" data-v-b57cc07c>33, synchronized解决秒杀超卖</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_34-代码锁在分布式项目中的局限性" class="sidebar-link reco-side-_34-代码锁在分布式项目中的局限性" data-v-b57cc07c>34, 代码锁在分布式项目中的局限性</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_35-分布式锁解决方案" class="sidebar-link reco-side-_35-分布式锁解决方案" data-v-b57cc07c>35, 分布式锁解决方案</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_36-redisson实现分布式锁" class="sidebar-link reco-side-_36-redisson实现分布式锁" data-v-b57cc07c>36, Redisson实现分布式锁</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms4/shopcms4.html#_37-测试分布式锁" class="sidebar-link reco-side-_37-测试分布式锁" data-v-b57cc07c>37, 测试分布式锁</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/devops/public/assets/js/app.5825cff9.js" defer></script><script src="/devops/public/assets/js/113.2f71a2bc.js" defer></script><script src="/devops/public/assets/js/1.774fca24.js" defer></script><script src="/devops/public/assets/js/62.1ac6f2a8.js" defer></script>
  </body>
</html>
