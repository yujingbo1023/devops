<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>10-shoping项目03 | devops</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/devops/public/favicon.ico">
    <meta name="description" content="快来玩devops">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/devops/public/assets/css/0.styles.4a69f283.css" as="style"><link rel="preload" href="/devops/public/assets/js/app.ab309b1f.js" as="script"><link rel="preload" href="/devops/public/assets/js/106.7b430306.js" as="script"><link rel="preload" href="/devops/public/assets/js/1.774fca24.js" as="script"><link rel="preload" href="/devops/public/assets/js/103.9d419e8b.js" as="script"><link rel="prefetch" href="/devops/public/assets/js/10.8c8bb3c8.js"><link rel="prefetch" href="/devops/public/assets/js/100.897a8f9f.js"><link rel="prefetch" href="/devops/public/assets/js/101.1fde4021.js"><link rel="prefetch" href="/devops/public/assets/js/102.98394abd.js"><link rel="prefetch" href="/devops/public/assets/js/104.baed74c0.js"><link rel="prefetch" href="/devops/public/assets/js/105.f33f084f.js"><link rel="prefetch" href="/devops/public/assets/js/107.0639b33b.js"><link rel="prefetch" href="/devops/public/assets/js/108.62e98a2f.js"><link rel="prefetch" href="/devops/public/assets/js/109.bd1f6c2b.js"><link rel="prefetch" href="/devops/public/assets/js/11.12d4d6ba.js"><link rel="prefetch" href="/devops/public/assets/js/110.8739272b.js"><link rel="prefetch" href="/devops/public/assets/js/111.02b59c44.js"><link rel="prefetch" href="/devops/public/assets/js/112.0dfed024.js"><link rel="prefetch" href="/devops/public/assets/js/113.da988737.js"><link rel="prefetch" href="/devops/public/assets/js/114.61d8c8eb.js"><link rel="prefetch" href="/devops/public/assets/js/115.a9594cf2.js"><link rel="prefetch" href="/devops/public/assets/js/116.2e506c7e.js"><link rel="prefetch" href="/devops/public/assets/js/117.66707189.js"><link rel="prefetch" href="/devops/public/assets/js/118.fe343ea6.js"><link rel="prefetch" href="/devops/public/assets/js/119.e9b655cf.js"><link rel="prefetch" href="/devops/public/assets/js/12.5471f0ea.js"><link rel="prefetch" href="/devops/public/assets/js/120.5aeb6353.js"><link rel="prefetch" href="/devops/public/assets/js/121.c515bf86.js"><link rel="prefetch" href="/devops/public/assets/js/122.c0143580.js"><link rel="prefetch" href="/devops/public/assets/js/123.e764d1f3.js"><link rel="prefetch" href="/devops/public/assets/js/124.0fcec5d0.js"><link rel="prefetch" href="/devops/public/assets/js/125.194c5231.js"><link rel="prefetch" href="/devops/public/assets/js/126.a12d08f3.js"><link rel="prefetch" href="/devops/public/assets/js/127.00cf0c5b.js"><link rel="prefetch" href="/devops/public/assets/js/128.3852829f.js"><link rel="prefetch" href="/devops/public/assets/js/129.5761dd66.js"><link rel="prefetch" href="/devops/public/assets/js/13.0f59e3c3.js"><link rel="prefetch" href="/devops/public/assets/js/130.ce242554.js"><link rel="prefetch" href="/devops/public/assets/js/131.56b07ff5.js"><link rel="prefetch" href="/devops/public/assets/js/132.dbc5c47f.js"><link rel="prefetch" href="/devops/public/assets/js/133.35cdddcb.js"><link rel="prefetch" href="/devops/public/assets/js/134.71113eea.js"><link rel="prefetch" href="/devops/public/assets/js/135.95a7509d.js"><link rel="prefetch" href="/devops/public/assets/js/136.f2e86da7.js"><link rel="prefetch" href="/devops/public/assets/js/137.a243b4e6.js"><link rel="prefetch" href="/devops/public/assets/js/138.19f66e13.js"><link rel="prefetch" href="/devops/public/assets/js/139.bdd4d990.js"><link rel="prefetch" href="/devops/public/assets/js/14.e294bb34.js"><link rel="prefetch" href="/devops/public/assets/js/140.a97dcafc.js"><link rel="prefetch" href="/devops/public/assets/js/141.7367b5df.js"><link rel="prefetch" href="/devops/public/assets/js/142.53c85e15.js"><link rel="prefetch" href="/devops/public/assets/js/143.95efa5c2.js"><link rel="prefetch" href="/devops/public/assets/js/144.af09a8fe.js"><link rel="prefetch" href="/devops/public/assets/js/145.6e11ca39.js"><link rel="prefetch" href="/devops/public/assets/js/146.637e6410.js"><link rel="prefetch" href="/devops/public/assets/js/147.0d652a2a.js"><link rel="prefetch" href="/devops/public/assets/js/148.d8b218e7.js"><link rel="prefetch" href="/devops/public/assets/js/149.d3564d76.js"><link rel="prefetch" href="/devops/public/assets/js/15.47739eb1.js"><link rel="prefetch" href="/devops/public/assets/js/150.01b7295a.js"><link rel="prefetch" href="/devops/public/assets/js/151.fadc95a1.js"><link rel="prefetch" href="/devops/public/assets/js/152.9c31fe33.js"><link rel="prefetch" href="/devops/public/assets/js/153.2ce65edb.js"><link rel="prefetch" href="/devops/public/assets/js/154.dcb65d17.js"><link rel="prefetch" href="/devops/public/assets/js/155.3850d9ec.js"><link rel="prefetch" href="/devops/public/assets/js/156.f401c9f3.js"><link rel="prefetch" href="/devops/public/assets/js/157.5ceac090.js"><link rel="prefetch" href="/devops/public/assets/js/158.03349984.js"><link rel="prefetch" href="/devops/public/assets/js/159.61d232fb.js"><link rel="prefetch" href="/devops/public/assets/js/16.57582450.js"><link rel="prefetch" href="/devops/public/assets/js/160.6b14c4e8.js"><link rel="prefetch" href="/devops/public/assets/js/161.1de62a87.js"><link rel="prefetch" href="/devops/public/assets/js/162.f8925338.js"><link rel="prefetch" href="/devops/public/assets/js/163.1e638040.js"><link rel="prefetch" href="/devops/public/assets/js/164.7086a801.js"><link rel="prefetch" href="/devops/public/assets/js/165.810d32d8.js"><link rel="prefetch" href="/devops/public/assets/js/166.5d834186.js"><link rel="prefetch" href="/devops/public/assets/js/167.c3ca7bcb.js"><link rel="prefetch" href="/devops/public/assets/js/168.d1e36dbd.js"><link rel="prefetch" href="/devops/public/assets/js/169.db275164.js"><link rel="prefetch" href="/devops/public/assets/js/17.f580faaa.js"><link rel="prefetch" href="/devops/public/assets/js/170.eb371e6d.js"><link rel="prefetch" href="/devops/public/assets/js/171.cda866aa.js"><link rel="prefetch" href="/devops/public/assets/js/172.b7343f34.js"><link rel="prefetch" href="/devops/public/assets/js/173.a437a3e5.js"><link rel="prefetch" href="/devops/public/assets/js/174.44ceeda0.js"><link rel="prefetch" href="/devops/public/assets/js/175.4085cb9e.js"><link rel="prefetch" href="/devops/public/assets/js/176.e2869389.js"><link rel="prefetch" href="/devops/public/assets/js/177.6eef5090.js"><link rel="prefetch" href="/devops/public/assets/js/178.1dd59a41.js"><link rel="prefetch" href="/devops/public/assets/js/179.968bfc5c.js"><link rel="prefetch" href="/devops/public/assets/js/18.e6c1e9bf.js"><link rel="prefetch" href="/devops/public/assets/js/180.e57cc3d8.js"><link rel="prefetch" href="/devops/public/assets/js/181.edf97886.js"><link rel="prefetch" href="/devops/public/assets/js/182.4676f3f3.js"><link rel="prefetch" href="/devops/public/assets/js/183.a2c1841a.js"><link rel="prefetch" href="/devops/public/assets/js/184.78a8cfbd.js"><link rel="prefetch" href="/devops/public/assets/js/185.20558e9d.js"><link rel="prefetch" href="/devops/public/assets/js/186.dd3c8df5.js"><link rel="prefetch" href="/devops/public/assets/js/187.c9edca55.js"><link rel="prefetch" href="/devops/public/assets/js/188.1b269591.js"><link rel="prefetch" href="/devops/public/assets/js/189.b080af15.js"><link rel="prefetch" href="/devops/public/assets/js/19.59d2bbeb.js"><link rel="prefetch" href="/devops/public/assets/js/190.04027bea.js"><link rel="prefetch" href="/devops/public/assets/js/191.cfc6447d.js"><link rel="prefetch" href="/devops/public/assets/js/192.ee112536.js"><link rel="prefetch" href="/devops/public/assets/js/193.5ca766d5.js"><link rel="prefetch" href="/devops/public/assets/js/194.7ed47ae9.js"><link rel="prefetch" href="/devops/public/assets/js/195.11435028.js"><link rel="prefetch" href="/devops/public/assets/js/196.c640defd.js"><link rel="prefetch" href="/devops/public/assets/js/197.2e101f12.js"><link rel="prefetch" href="/devops/public/assets/js/198.25589715.js"><link rel="prefetch" href="/devops/public/assets/js/199.b62689d7.js"><link rel="prefetch" href="/devops/public/assets/js/20.095191b8.js"><link rel="prefetch" href="/devops/public/assets/js/200.bd54fb31.js"><link rel="prefetch" href="/devops/public/assets/js/201.1c0dcd44.js"><link rel="prefetch" href="/devops/public/assets/js/202.79348ce4.js"><link rel="prefetch" href="/devops/public/assets/js/203.dfb3b5f1.js"><link rel="prefetch" href="/devops/public/assets/js/204.a744705e.js"><link rel="prefetch" href="/devops/public/assets/js/205.1c44258c.js"><link rel="prefetch" href="/devops/public/assets/js/206.4e433ccb.js"><link rel="prefetch" href="/devops/public/assets/js/207.127bd57a.js"><link rel="prefetch" href="/devops/public/assets/js/208.9401ff7c.js"><link rel="prefetch" href="/devops/public/assets/js/209.eb231e36.js"><link rel="prefetch" href="/devops/public/assets/js/21.c901efa4.js"><link rel="prefetch" href="/devops/public/assets/js/210.710a435b.js"><link rel="prefetch" href="/devops/public/assets/js/211.f49da7ee.js"><link rel="prefetch" href="/devops/public/assets/js/212.86208474.js"><link rel="prefetch" href="/devops/public/assets/js/213.59db11bd.js"><link rel="prefetch" href="/devops/public/assets/js/214.102ca8e9.js"><link rel="prefetch" href="/devops/public/assets/js/215.25c7d495.js"><link rel="prefetch" href="/devops/public/assets/js/216.eb5f7ee3.js"><link rel="prefetch" href="/devops/public/assets/js/217.a886e065.js"><link rel="prefetch" href="/devops/public/assets/js/218.a642360d.js"><link rel="prefetch" href="/devops/public/assets/js/219.f9edf22e.js"><link rel="prefetch" href="/devops/public/assets/js/22.1caded76.js"><link rel="prefetch" href="/devops/public/assets/js/23.81cb3916.js"><link rel="prefetch" href="/devops/public/assets/js/24.2cb1340d.js"><link rel="prefetch" href="/devops/public/assets/js/25.ea715045.js"><link rel="prefetch" href="/devops/public/assets/js/26.f39c1e68.js"><link rel="prefetch" href="/devops/public/assets/js/27.589a3294.js"><link rel="prefetch" href="/devops/public/assets/js/28.69d2e7a4.js"><link rel="prefetch" href="/devops/public/assets/js/29.4b53a059.js"><link rel="prefetch" href="/devops/public/assets/js/3.8aa7b56c.js"><link rel="prefetch" href="/devops/public/assets/js/30.9508e987.js"><link rel="prefetch" href="/devops/public/assets/js/31.a3f42d88.js"><link rel="prefetch" href="/devops/public/assets/js/32.aaaa0b91.js"><link rel="prefetch" href="/devops/public/assets/js/33.c1d76b12.js"><link rel="prefetch" href="/devops/public/assets/js/34.43fcb036.js"><link rel="prefetch" href="/devops/public/assets/js/35.e252f3ca.js"><link rel="prefetch" href="/devops/public/assets/js/36.62c54901.js"><link rel="prefetch" href="/devops/public/assets/js/37.0189f6ac.js"><link rel="prefetch" href="/devops/public/assets/js/38.0678ec19.js"><link rel="prefetch" href="/devops/public/assets/js/39.e97eeb9a.js"><link rel="prefetch" href="/devops/public/assets/js/4.0e6db211.js"><link rel="prefetch" href="/devops/public/assets/js/40.b2e01724.js"><link rel="prefetch" href="/devops/public/assets/js/41.1ea621fe.js"><link rel="prefetch" href="/devops/public/assets/js/42.0fbbb137.js"><link rel="prefetch" href="/devops/public/assets/js/43.42d95421.js"><link rel="prefetch" href="/devops/public/assets/js/44.865adc2a.js"><link rel="prefetch" href="/devops/public/assets/js/45.8d8aeb05.js"><link rel="prefetch" href="/devops/public/assets/js/46.637ae4aa.js"><link rel="prefetch" href="/devops/public/assets/js/47.4ea1eb5f.js"><link rel="prefetch" href="/devops/public/assets/js/48.15572dc3.js"><link rel="prefetch" href="/devops/public/assets/js/49.47aa2d1b.js"><link rel="prefetch" href="/devops/public/assets/js/5.399e3fa6.js"><link rel="prefetch" href="/devops/public/assets/js/50.ae25f221.js"><link rel="prefetch" href="/devops/public/assets/js/51.ee5d1f7f.js"><link rel="prefetch" href="/devops/public/assets/js/52.ef745e8e.js"><link rel="prefetch" href="/devops/public/assets/js/53.a90adad8.js"><link rel="prefetch" href="/devops/public/assets/js/54.dc342c55.js"><link rel="prefetch" href="/devops/public/assets/js/55.9a958bf8.js"><link rel="prefetch" href="/devops/public/assets/js/56.5837acb6.js"><link rel="prefetch" href="/devops/public/assets/js/57.c7f4e02b.js"><link rel="prefetch" href="/devops/public/assets/js/58.9d2a65bd.js"><link rel="prefetch" href="/devops/public/assets/js/59.12f88cb3.js"><link rel="prefetch" href="/devops/public/assets/js/6.f08550c5.js"><link rel="prefetch" href="/devops/public/assets/js/60.85eca84c.js"><link rel="prefetch" href="/devops/public/assets/js/61.10e497fd.js"><link rel="prefetch" href="/devops/public/assets/js/62.8771fde6.js"><link rel="prefetch" href="/devops/public/assets/js/63.d8b121f6.js"><link rel="prefetch" href="/devops/public/assets/js/64.cf88d1a2.js"><link rel="prefetch" href="/devops/public/assets/js/65.440b72ce.js"><link rel="prefetch" href="/devops/public/assets/js/66.aa819439.js"><link rel="prefetch" href="/devops/public/assets/js/67.3a0c59e5.js"><link rel="prefetch" href="/devops/public/assets/js/68.d50a6e0f.js"><link rel="prefetch" href="/devops/public/assets/js/69.ccbcfd69.js"><link rel="prefetch" href="/devops/public/assets/js/7.a1ffb4d9.js"><link rel="prefetch" href="/devops/public/assets/js/70.9b40996b.js"><link rel="prefetch" href="/devops/public/assets/js/71.1afe3872.js"><link rel="prefetch" href="/devops/public/assets/js/72.1b55ae25.js"><link rel="prefetch" href="/devops/public/assets/js/73.5e85037f.js"><link rel="prefetch" href="/devops/public/assets/js/74.392894b2.js"><link rel="prefetch" href="/devops/public/assets/js/75.e4e6362e.js"><link rel="prefetch" href="/devops/public/assets/js/76.3fb8d1c2.js"><link rel="prefetch" href="/devops/public/assets/js/77.08812886.js"><link rel="prefetch" href="/devops/public/assets/js/78.ac0a368c.js"><link rel="prefetch" href="/devops/public/assets/js/79.bd26089f.js"><link rel="prefetch" href="/devops/public/assets/js/8.4d197999.js"><link rel="prefetch" href="/devops/public/assets/js/80.7b9d60d6.js"><link rel="prefetch" href="/devops/public/assets/js/81.21d9ace9.js"><link rel="prefetch" href="/devops/public/assets/js/82.35882c5c.js"><link rel="prefetch" href="/devops/public/assets/js/83.4fd65fca.js"><link rel="prefetch" href="/devops/public/assets/js/84.caa3ead7.js"><link rel="prefetch" href="/devops/public/assets/js/85.a356835e.js"><link rel="prefetch" href="/devops/public/assets/js/86.db7d92f7.js"><link rel="prefetch" href="/devops/public/assets/js/87.b140929f.js"><link rel="prefetch" href="/devops/public/assets/js/88.c15f88e1.js"><link rel="prefetch" href="/devops/public/assets/js/89.9ae31c15.js"><link rel="prefetch" href="/devops/public/assets/js/9.9ca15f8e.js"><link rel="prefetch" href="/devops/public/assets/js/90.3bf9fb12.js"><link rel="prefetch" href="/devops/public/assets/js/91.c259d35b.js"><link rel="prefetch" href="/devops/public/assets/js/92.a4596303.js"><link rel="prefetch" href="/devops/public/assets/js/93.c39732b8.js"><link rel="prefetch" href="/devops/public/assets/js/94.35195001.js"><link rel="prefetch" href="/devops/public/assets/js/95.0697a328.js"><link rel="prefetch" href="/devops/public/assets/js/96.417c9abb.js"><link rel="prefetch" href="/devops/public/assets/js/97.6e6f509c.js"><link rel="prefetch" href="/devops/public/assets/js/98.8f2ab3b6.js"><link rel="prefetch" href="/devops/public/assets/js/99.e67dff90.js">
    <link rel="stylesheet" href="/devops/public/assets/css/0.styles.4a69f283.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>devops</h3> <p class="description" data-v-59e6cb88>快来玩devops</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devops/public/" class="home-link router-link-active"><img src="/devops/public/logo.png" alt="devops" class="logo"> <span class="site-name">devops</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/devops/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    devops
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>206</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>10-shoping项目03</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">10-shoping项目03</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>devops</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>sentinel</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="_1-编写购物车服务接口"><a href="#_1-编写购物车服务接口" class="header-anchor">#</a> 1, 编写购物车服务接口</h3> <p>用户购买商品的流程为：<code>搜索商品 &gt; 查看商品详情 &gt; 添加到购物车 &gt; 生成商品订单 &gt; 支付</code>，搜索商品和查看商品详情功能已经完成，接下来我们编写购物车服务。购物车数据属于临时数据，为了节约数据库开销，我们会将其存放到redis中。</p> <p>在<strong>通用模块</strong>编写购物车服务接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 购物车服务</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartService</span> <span class="token punctuation">{</span>
  <span class="token comment">// 新增商品到购物车</span>
  <span class="token keyword">void</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 修改购物车商品数量</span>
  <span class="token keyword">void</span> <span class="token function">handleCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 删除购物车商品</span>
  <span class="token keyword">void</span> <span class="token function">deleteCartOption</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 获取用户购物车</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCartList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 更新redis中的商品数据，在管理员更新商品后执行</span>
  <span class="token keyword">void</span> <span class="token function">refreshCartGoods</span><span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 删除redis中的商品数据，在管理员下架商品后执行</span>
  <span class="token keyword">void</span> <span class="token function">deleteCartGoods</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_2-创建购物车相关模块"><a href="#_2-创建购物车相关模块" class="header-anchor">#</a> 2, 创建购物车相关模块</h3> <p>创建名为<code>shopping_cart_service</code>的SpringBoot工程，添加相关依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shopping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- dubbo --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- nacos --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- redis --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在Nacos配置中心创建配置文件<code>shopping_cart_service-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9009</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_cart_service <span class="token comment">#服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心地址</span>
 <span class="token comment"># redis</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
   <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.0.0.41
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">30000</span>
    <span class="token key atrule">jedis</span><span class="token punctuation">:</span>
     <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>


<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_cart_service <span class="token comment">#服务名</span>
   <span class="token key atrule">serialize-check-status</span><span class="token punctuation">:</span> DISABLE
   <span class="token key atrule">check-serializable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo <span class="token comment"># 通讯协议</span>
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 端口号，-1表示自动扫描可用端口。</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 5455dc7a<span class="token punctuation">-</span>b343<span class="token punctuation">-</span>4866<span class="token punctuation">-</span>a973<span class="token punctuation">-</span>96d5cc1d9312 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shoping_cart_service <span class="token comment">#文件名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>编写启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingCartServiceApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCartServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>创建名为<code>shoping_cart_customer_api</code>的SpringBoot工程，添加相关依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- dubbo --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- nacos --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shoping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>在Nacos配置中心编写配置文件<code>shopping_cart_customer_api-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8005</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token comment"># Nacos</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_cart_customer_api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>


<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  <span class="token comment">#项目名字</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_cart_customer_api
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
  <span class="token comment"># 注册地址</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 5455dc7a<span class="token punctuation">-</span>b343<span class="token punctuation">-</span>4866<span class="token punctuation">-</span>a973<span class="token punctuation">-</span>96d5cc1d9312 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shopping_cart_customer_api
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>编写启动类，忽略数据源自动配置，向Nacos注册服务</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">//向注册中心注册该服务</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 配置动态刷新</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingUserCustomerApiApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingUserCustomerApiApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-查询用户购物车"><a href="#_3-查询用户购物车" class="header-anchor">#</a> 3, 查询用户购物车</h3> <p>我们将用户的购物车信息保存到redis当中，所有用户的购物车作为一个hash类型的数据保存，hash的键是用户id，hash的值是购物车商品列表。</p> <p><img src="/devops/public/assets/img/1726753291616.b42b388e.png" alt="1726753291616"></p> <p>在<strong>购物车服务模块</strong>创建购物车服务接口的实现类，重写查询用户购物车功能</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CartService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCartList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> cartList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cartList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> cartList<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_4-添加商品到购物车"><a href="#_4-添加商品到购物车" class="header-anchor">#</a> 4, 添加商品到购物车</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.根据用户id获取用户购物车列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartList <span class="token operator">=</span> <span class="token function">findCartList</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.查询购物车是否有该商品，如果有商品，添加商品数量</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods1 <span class="token operator">:</span> cartList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cartGoods1<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">int</span> newNum <span class="token operator">=</span> cartGoods1<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> cartGoods<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartGoods1<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>newNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>cartList<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 3.如果购物车没有该商品，将商品添加到购物车列表</span>
  cartList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>cartList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_5-修改与删除购物车商品"><a href="#_5-修改与删除购物车商品" class="header-anchor">#</a> 5, 修改与删除购物车商品</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取用户购物车列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartList <span class="token operator">=</span> <span class="token function">findCartList</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 遍历列表找到对应商品</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods <span class="token operator">:</span> cartList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>goodId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 改变商品数量</span>
      cartGoods<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 将新的购物车列表保存到redis中</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> cartList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCartOption</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取用户购物车列表</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartList <span class="token operator">=</span> <span class="token function">findCartList</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将商品移出列表</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods <span class="token operator">:</span> cartList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>goodId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cartList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 将新的购物车列表保存到redis中</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> cartList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_6-编写购物车控制器"><a href="#_6-编写购物车控制器" class="header-anchor">#</a> 6, 编写购物车控制器</h3> <p>用户操作购物车时，需要拿到用户的id，而用户id可以通过解析用户的令牌拿到，所以我们需要在Higress中添加购物车路由，并开启JWT认证。</p> <p>在Higress中添加购物车Api路由</p> <p><img src="/devops/public/assets/img/1726754133205.e18c3afb.png" alt="1726754133205"></p> <p>给购物车Api路由开启JWT认证</p> <p><img src="/devops/public/assets/img/1726754151126.8a55c836.png" alt="1726754151126"></p> <p>编写购物车控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 购物车
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/cart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 查询用户购物车
   * @param userId 令牌中携带的用户Id
   * @return 用户购物车列表
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findCartList&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCartList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartList <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">findCartList</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>cartList<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 新增商品到购物车
   * @param cartGoods 购物车商品
   * @param userId 令牌中携带的用户Id
   * @return 操作结果
   */</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addCart&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">addCart</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 修改购物车商品数量
   * @param userId 令牌中携带的用户Id
   * @param goodId 商品id
   * @param num 修改后的数量
   * @return 操作结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/handleCart&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span><span class="token class-name">Long</span> goodId<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">handleCart</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>goodId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 删除购物车商品
   * @param userId 令牌中携带的用户Id
   * @param goodId 商品id
   * @return 操作结果
   */</span>
  <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/deleteCart&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">deleteCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span><span class="token class-name">Long</span> goodId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">deleteCartOption</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>goodId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="_7-测试购物车控制器"><a href="#_7-测试购物车控制器" class="header-anchor">#</a> 7, 测试购物车控制器</h3> <p>启动相关的模块：</p> <p><img src="/devops/public/assets/img/1726754617512.c65c5a0c.png" alt="1726754617512"></p> <p><img src="/devops/public/assets/img/1726754791603.e8da8895.png" alt="1726754791603"></p> <p><img src="/devops/public/assets/img/1726754826290.a5d22f19.png" alt="1726754826290"></p> <p><img src="/devops/public/assets/img/1726754910141.bb6b1b9f.png" alt="1726754910141"></p> <p><img src="/devops/public/assets/img/1726754918965.5cfc306b.png" alt="1726754918965"></p> <p><img src="/devops/public/assets/img/1726754965446.749a4ca1.png" alt="1726754965446"></p> <p><img src="/devops/public/assets/img/1726755004359.206ac6ef.png" alt="1726755004359"></p> <h3 id="_8-修改所有用户购物车商品"><a href="#_8-修改所有用户购物车商品" class="header-anchor">#</a> 8, 修改所有用户购物车商品</h3> <p>当管理员修改了商品的价格等数据后，需要将数据同步到用户购物车中，所以我们要编写给所有用户的购物车中修改某件商品的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshCartGoods</span><span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所有用户的购物车</span>
  <span class="token class-name">BoundHashOperations</span> cartList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> allCartGoods <span class="token operator">=</span> cartList<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> allCartGoods<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 遍历所有用户的购物车</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> goodsList <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历一个用户购物车的所有商品</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> goods <span class="token operator">:</span> goodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果该商品是被更新的商品，修改商品数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        goods<span class="token punctuation">.</span><span class="token function">setGoodsName</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        goods<span class="token punctuation">.</span><span class="token function">setHeaderPic</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getHeaderPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        goods<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>cartGoods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 将改变后所有用户购物车重新放入redis</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>allCartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_9-删除所有用户购物车商品"><a href="#_9-删除所有用户购物车商品" class="header-anchor">#</a> 9, 删除所有用户购物车商品</h3> <p>当管理员下架某件商品后，所有用户的购物车中该商品也应该被删除，所以我们要编写给所有用户的购物车中删除某件商品的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCartGoods</span><span class="token punctuation">(</span><span class="token class-name">Long</span> goodId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所有用户购物车</span>
  <span class="token class-name">BoundHashOperations</span> cartList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> allCartGoods <span class="token operator">=</span> cartList<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> allCartGoods<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 遍历所有用户的购物车</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> goodsList <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历一个用户购物车的所有商品</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> goods <span class="token operator">:</span> goodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果该商品是被下架的商品，在购物车删除该商品</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>goodId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        goodsList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 将改变后所有用户购物车重新放入redis</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;cartList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>allCartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_10-修改商品服务"><a href="#_10-修改商品服务" class="header-anchor">#</a> 10, 修改商品服务</h3> <p>接下来我们修改<strong>商品服务</strong>模块代码，在修改商品后发送消息同步修改购物车数据；在下架商品后发送消息同步删除购物车数据：</p> <ol><li>在RocketMQ中创建主题<code>del_cart_queue</code>和<code>sync_cart_queue</code></li> <li>修改商品服务实现类中的修改商品、上下架商品方法：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">GoodsMapper</span> goodsMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">GoodsImageMapper</span> goodsImageMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span> <span class="token comment">// RocketMQ工具类</span>
  <span class="token comment">// 同步商品到ES主题</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYNC_GOOD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;sync_goods_queue&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 删除商品到ES主题</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEL_GOOD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;del_goods_queue&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 同步商品到购物车主题</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYNC_CART_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;sync_cart_queue&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 删除商品到购物车主题</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEL_CART_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;del_cart_queue&quot;</span><span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除旧图片数据</span>
    <span class="token class-name">Long</span> goodsId <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取商品主键</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GoodsImage</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goodsId&quot;</span><span class="token punctuation">,</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    goodsImageMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除旧规格数据</span>
    goodsMapper<span class="token punctuation">.</span><span class="token function">deleteGoodsSpecificationOption</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 修改商品数据</span>
    goodsMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 插入图片数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GoodsImage</span><span class="token punctuation">&gt;</span></span> images <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 商品图片集合</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GoodsImage</span> image <span class="token operator">:</span> images<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      image<span class="token punctuation">.</span><span class="token function">setGoodsId</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给图片设置商品id</span>
      goodsImageMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 插入图片</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 插入商品_规格项数据</span>
    <span class="token comment">// 1.获取规格</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Specification</span><span class="token punctuation">&gt;</span></span> specifications <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSpecifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.获取规格项</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpecificationOption</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历规格，获取规格中的所有规格项</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Specification</span> specification <span class="token operator">:</span> specifications<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>specification<span class="token punctuation">.</span><span class="token function">getSpecificationOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token comment">// 遍历规格项，插入商品_规格项数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SpecificationOption</span> option <span class="token operator">:</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      goodsMapper<span class="token punctuation">.</span><span class="token function">addGoodsSpecificationOption</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">,</span>option<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>


    <span class="token comment">// 将商品数据同步到ES中</span>
    <span class="token class-name">GoodsDesc</span> goodsDesc <span class="token operator">=</span> <span class="token function">findDesc</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">SYNC_GOOD_QUEUE</span><span class="token punctuation">,</span>goodsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将商品数据同步到购物车中</span>
    <span class="token class-name">CartGoods</span> cartGoods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartGoods<span class="token punctuation">.</span><span class="token function">setGoodId</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartGoods<span class="token punctuation">.</span><span class="token function">setGoodsName</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartGoods<span class="token punctuation">.</span><span class="token function">setHeaderPic</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getHeaderPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartGoods<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>goods<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">SYNC_CART_QUEUE</span><span class="token punctuation">,</span>cartGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putAway</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isMarketable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    goodsMapper<span class="token punctuation">.</span><span class="token function">putAway</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>isMarketable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 上架时数据同步到ES，下架时删除ES数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isMarketable<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 将商品数据同步到ES中</span>
      <span class="token class-name">GoodsDesc</span> goodsDesc <span class="token operator">=</span> <span class="token function">findDesc</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">SYNC_GOOD_QUEUE</span><span class="token punctuation">,</span>goodsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除商品数据同步到ES中</span>
      rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">DEL_GOOD_QUEUE</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 删除商品数据同步到购物车中</span>
      rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">DEL_CART_QUEUE</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h3 id="_11-发送修改与删除商品的消息"><a href="#_11-发送修改与删除商品的消息" class="header-anchor">#</a> 11, 发送修改与删除商品的消息</h3> <p>启动的服务：</p> <p><img src="/devops/public/assets/img/1726755693944.8c78e1ff.png" alt="1726755693944"></p> <p><img src="/devops/public/assets/img/1726755827479.34a82e99.png" alt="1726755827479"></p> <p><img src="/devops/public/assets/img/1726755841278.4b8e3e8d.png" alt="1726755841278"></p> <h3 id="_12-监听修改与删除商品的消息"><a href="#_12-监听修改与删除商品的消息" class="header-anchor">#</a> 12, 监听修改与删除商品的消息</h3> <p>在<strong>购物车服务模块</strong>添加RocketMQ起步依赖.</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- rocketmq --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在<code>shopping_cart_service-dev.yaml</code>中添加RocketMQ相关配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">rocketmq</span><span class="token punctuation">:</span>
 <span class="token comment"># nameserver地址</span>
  <span class="token key atrule">name-server</span><span class="token punctuation">:</span> 192.168.0.99<span class="token punctuation">:</span><span class="token number">9876</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在购物车服务模块的<code>resources</code>目录下建立<code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件，添加如下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>org.apache.rocketmq.spring.autoconfigure.RocketMQAutoConfiguration
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编写消息监听器，监听队列，处理消息</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 监听同步商品消息</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;sync_cart_queue&quot;</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">&quot;sync_cart_group&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncCartListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">refreshCartGoods</span><span class="token punctuation">(</span>goodsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 监听删除商品消息</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;del_cart_queue&quot;</span><span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> <span class="token string">&quot;del_cart_group&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelCartListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">deleteCartGoods</span><span class="token punctuation">(</span>goodsDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>测试管理员修改商品、下架商品，看用户购物车是否发生改变。</p> <h3 id="_13-测试同步购物车商品数据"><a href="#_13-测试同步购物车商品数据" class="header-anchor">#</a> 13, 测试同步购物车商品数据</h3> <p>启动的服务：</p> <p><img src="/devops/public/assets/img/1726756110541.028f54c6.png" alt="1726756110541"></p> <p><img src="/devops/public/assets/img/1726756286986.3d55a5b5.png" alt="1726756286986"></p> <p><img src="/devops/public/assets/img/1726756204787.38ea4966.png" alt="1726756204787"></p> <p><img src="/devops/public/assets/img/1726756252314.c2379e2b.png" alt="1726756252314"></p> <p><img src="/devops/public/assets/img/1726756265056.3f6ba91f.png" alt="1726756265056"></p> <h3 id="_14-创建订单相关模块"><a href="#_14-创建订单相关模块" class="header-anchor">#</a> 14, 创建订单相关模块</h3> <p>接下来我们编写订单业务，首先创建订单服务的提供者和订单API模块：</p> <p>创建名为<code>shopping_order_service</code>的SpringBoot工程，添加相关依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shopping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- MyBatisPlus --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- mysql驱动 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- dubbo --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- nacos --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>在Nacos配置中心创建配置文件<code>shopping_order_service-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9010</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_order_service <span class="token comment">#服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心地址</span>
 <span class="token comment"># 数据源</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
   <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
   <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>///mlshopping<span class="token punctuation">?</span>serverTimezone=UTC
   <span class="token key atrule">username</span><span class="token punctuation">:</span> root
   <span class="token key atrule">password</span><span class="token punctuation">:</span> root
     
<span class="token comment">#配置mybatis-plus</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
   <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
   <span class="token comment"># 表名前缀</span>
    <span class="token key atrule">table-prefix</span><span class="token punctuation">:</span> ml_
   <span class="token comment"># 主键生成策略为自增</span>
    <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
  <span class="token comment"># 关闭列名自动驼峰命名规则映射</span>
   <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
   <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl <span class="token comment">#开启sql日志</span>
  
<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_order_service <span class="token comment">#服务名</span>
   <span class="token key atrule">serialize-check-status</span><span class="token punctuation">:</span> DISABLE
   <span class="token key atrule">check-serializable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo <span class="token comment"># 通讯协议</span>
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 端口号，-1表示自动扫描可用端口。</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 5455dc7a<span class="token punctuation">-</span>b343<span class="token punctuation">-</span>4866<span class="token punctuation">-</span>a973<span class="token punctuation">-</span>96d5cc1d9312 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shoping_order_service <span class="token comment">#文件名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>编写启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.ityls.shoping_order_service.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingOrderServiceApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingOrderServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>创建名为<code>shopping_order_customer_api</code>的SpringBoot工程，添加相关依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- dubbo --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- nacos --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ityls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shopping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>在Nacos配置中心编写配置文件<code>shopping_order_customer_api-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8006</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token comment"># Nacos</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_order_customer_api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>


<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  <span class="token comment">#项目名字</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shoping_order_customer_api
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
  <span class="token comment"># 注册地址</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 10.0.0.41<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 5455dc7a<span class="token punctuation">-</span>b343<span class="token punctuation">-</span>4866<span class="token punctuation">-</span>a973<span class="token punctuation">-</span>96d5cc1d9312 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shoping_order_customer_api

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>编写启动类，忽略数据源自动配置，向Nacos注册服务</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">//向注册中心注册该服务</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 配置动态刷新</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingOrderCustomerApiApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingOrderCustomerApiApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在Higress中添加订单路由</p> <p><img src="/devops/public/assets/img/1726756687728.53837440.png" alt="1726756687728"></p> <p><img src="/devops/public/assets/img/1726756712144.e0009a4c.png" alt="1726756712144"></p> <h3 id="_15-地址服务接口"><a href="#_15-地址服务接口" class="header-anchor">#</a> 15, 地址服务接口</h3> <p>在生成订单前，用户首先要选择收货地址，在<strong>通用模块</strong>编写地址服务接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AddressService</span> <span class="token punctuation">{</span>
  <span class="token comment">// 查询所有省份</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Province</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 查询省份下的城市</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCityByProvince</span><span class="token punctuation">(</span><span class="token class-name">Long</span> provinceId<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 查询城市下的区县</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAreaByCity</span><span class="token punctuation">(</span><span class="token class-name">Long</span> cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 增加地址</span>
  <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Address</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 修改地址</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Address</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 根据id获取地址</span>
  <span class="token class-name">Address</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 删除地址</span>
  <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// 查询登录用户的所有地址</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_16-地址服务接口实现类"><a href="#_16-地址服务接口实现类" class="header-anchor">#</a> 16, 地址服务接口实现类</h3> <p>在<strong>订单服务模块</strong>编写地址相关的Mapper接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AddressMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProvinceMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Province</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CityMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AreaMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>编写地址服务接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddressServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AddressService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">ProvinceMapper</span> provinceMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CityMapper</span> cityMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">AreaMapper</span> areaMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">AddressMapper</span> addressMapper<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Province</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> provinceMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCityByProvince</span><span class="token punctuation">(</span><span class="token class-name">Long</span> provinceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;provinceId&quot;</span><span class="token punctuation">,</span>provinceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> cities <span class="token operator">=</span> cityMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cities<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAreaByCity</span><span class="token punctuation">(</span><span class="token class-name">Long</span> cityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;cityId&quot;</span><span class="token punctuation">,</span>cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> areas <span class="token operator">=</span> areaMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> areas<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Address</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    addressMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Address</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    addressMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Address</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> addressMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    addressMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> addresses <span class="token operator">=</span> addressMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> addresses<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h3 id="_17-地址控制器"><a href="#_17-地址控制器" class="header-anchor">#</a> 17, 地址控制器</h3> <p>在<strong>订单Api模块</strong>编写地址控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 收货地址
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/address&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddressController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">AddressService</span> addressService<span class="token punctuation">;</span>
  
  <span class="token comment">/**
   * 查询所有省份
   * @return 所有省份集合
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findAllProvince&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Province</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Province</span><span class="token punctuation">&gt;</span></span> provinces <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">findAllProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>provinces<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查询某省下的所有城市
   * @param provinceId 省份id
   * @return 城市集合
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findCityByProvince&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCityByProvince</span><span class="token punctuation">(</span><span class="token class-name">Long</span> provinceId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">City</span><span class="token punctuation">&gt;</span></span> cities <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">findCityByProvince</span><span class="token punctuation">(</span>provinceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>cities<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查询某市下的所有区县
   * @param cityId 城市id
   * @return 区县集合
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findAreaByCity&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAreaByCity</span><span class="token punctuation">(</span><span class="token class-name">Long</span> cityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Area</span><span class="token punctuation">&gt;</span></span> areas <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">findAreaByCity</span><span class="token punctuation">(</span>cityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>areas<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 新增地址
   * @param userId 用户id
   * @param address 地址对象
   * @return 执行结果
   */</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Address</span> address<span class="token punctuation">)</span><span class="token punctuation">{</span>
    address<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    addressService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 删除地址
   * @param userId 用户id
   * @param address 地址对象
   * @return 执行结果
   */</span>
  <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Address</span> address<span class="token punctuation">)</span><span class="token punctuation">{</span>
    address<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    addressService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 根据id查询地址
   * @param id 地址id
   * @return 查询结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Address</span> address <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 删除地址
   * @param id 地址id
   * @return 执行结果
   */</span>
  <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    addressService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">/**
   * 查询登录用户的所有地址
   * @param userId 用户id
   * @return 查询结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findByUser&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> addresses <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">findByUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><p><img src="/devops/public/assets/img/1726757848720.4a1252c4.png" alt="1726757848720"></p> <p><img src="/devops/public/assets/img/1726757860878.423b73d3.png" alt="1726757860878"></p> <h3 id="_18-测试地址功能"><a href="#_18-测试地址功能" class="header-anchor">#</a> 18, 测试地址功能</h3> <p><img src="/devops/public/assets/img/1726757886721.a4a083e7.png" alt="1726757886721"></p> <h3 id="_19-订单服务接口"><a href="#_19-订单服务接口" class="header-anchor">#</a> 19, 订单服务接口</h3> <p>在<strong>通用模块</strong>编写订单服务接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrdersService</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成订单</span>
  <span class="token class-name">Orders</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 修改订单</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据id查询订单</span>
  <span class="token class-name">Orders</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 查询用户的订单</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserOrders</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span><span class="token class-name">Integer</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_20-新增订单功能"><a href="#_20-新增订单功能" class="header-anchor">#</a> 20, 新增订单功能</h3> <p>用户从购物车选中要下单的商品，下单成功后，生成订单数据保存到数据库，并将该商品从用户购物车中删除：</p> <ol><li><p>在<strong>订单服务模块</strong>编写订单商品Mapper和订单Mapper</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 订单商品Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartGoodsMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token comment">// 订单Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrdersMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>在<strong>订单服务模块</strong>编写订单服务接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrdersService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">OrdersMapper</span> ordersMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CartGoodsMapper</span> cartGoodsMapper<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 订单状态未付款</span>
    orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订单创建时间</span>
    orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算订单价格，遍历订单所有商品</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 数量</span>
      <span class="token class-name">BigDecimal</span> num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 单价</span>
      <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGood<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 数量*单价</span>
      <span class="token class-name">BigDecimal</span> multiply <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>multiply<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存订单</span>
    ordersMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 购物车商品保存到数据库中</span>
      cartGood<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartGoodsMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></li></ol> <h3 id="_21-测试下单功能"><a href="#_21-测试下单功能" class="header-anchor">#</a> 21, 测试下单功能</h3> <p>在<strong>订单Api模块</strong>编写订单控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/orders&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 生成订单
   * @param orders 订单对象
   * @param userId 用户Id
   * @return 生成的订单
   */</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Orders</span> orders<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    orders<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存订单</span>
    <span class="token class-name">Orders</span> orders1 <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将redis中购物车商品删除</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cartService<span class="token punctuation">.</span><span class="token function">deleteCartOption</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>cartGood<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orders1<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_22-查询订单详情"><a href="#_22-查询订单详情" class="header-anchor">#</a> 22, 查询订单详情</h3> <p>在<strong>订单服务模块</strong>编写订单Mapper</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrdersMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// 查询订单详情</span>
  <span class="token class-name">Orders</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>编写订单Mapper的映射文件</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">&quot;com.itbaizhan.shopping_order_service.mapper.OrdersMapper&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>resultMap id<span class="token operator">=</span><span class="token string">&quot;ordersMapper&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;com.itbaizhan.shopping_common.pojo.Orders&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>id property<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;id&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>id<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;payment&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;payment&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;paymentType&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;paymentType&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;postFee&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;postFee&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;status&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;status&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;createTime&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;createTime&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;paymentTime&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;paymentTime&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;consignTime&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;consignTime&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;endTime&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;endTime&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;closeTime&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;closeTime&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;shippingName&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;shippingName&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;shippingCode&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;shippingCode&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;userId&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;userId&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;buyerMessage&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;buyerMessage&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;buyerNick&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;buyerNick&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;receiverAreaName&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;receiverAreaName&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;receiverMobile&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;receiverMobile&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;receiverZipCode&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;receiverZipCode&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;receiver&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;receiver&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;expire&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;expire&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>collection property<span class="token operator">=</span><span class="token string">&quot;cartGoods&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;orderId&quot;</span> ofType<span class="token operator">=</span><span class="token string">&quot;com.itbaizhan.shopping_common.pojo.CartGoods&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;goodId&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;goodId&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;goodsName&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;goodsName&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;price&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;price&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;headerPic&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;headerPic&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;num&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;num&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">&quot;orderId&quot;</span> column<span class="token operator">=</span><span class="token string">&quot;orderId&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>collection<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>resultMap<span class="token operator">&gt;</span>


  <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;findById&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;string&quot;</span> resultMap<span class="token operator">=</span><span class="token string">&quot;ordersMapper&quot;</span><span class="token operator">&gt;</span>
     <span class="token constant">SELECT</span>
     <span class="token operator">*</span>
     <span class="token constant">FROM</span>
     bz_orders
     <span class="token constant">LEFT</span> <span class="token constant">JOIN</span> bz_cart_goods
     <span class="token constant">ON</span> bz_orders<span class="token punctuation">.</span>id <span class="token operator">=</span> bz_cart_goods<span class="token punctuation">.</span>orderId
     where bz_orders<span class="token punctuation">.</span>id <span class="token operator">=</span> #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>在<strong>订单服务模块</strong>编写订单服务接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> ordersMapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_23-查询用户订单与修改订单"><a href="#_23-查询用户订单与修改订单" class="header-anchor">#</a> 23, 查询用户订单与修改订单</h3> <p>在<strong>订单服务模块</strong>编写订单Mapper</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrdersMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// 查询用户订单</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">findOrdersByUserIdAndStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span>
                       <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>编写订单Mapper的映射文件</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>findOrdersByUserIdAndStatus<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ordersMapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   SELECT
   *
   FROM
   bz_orders
   LEFT JOIN bz_cart_goods
   ON bz_orders.id = bz_cart_goods.orderId
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">&gt;</span></span>
     bz_orders.userId = #{userId}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status != null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
       and bz_orders.status = #{status}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在<strong>订单服务模块</strong>编写订单服务接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserOrders</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span><span class="token class-name">Integer</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> ordersMapper<span class="token punctuation">.</span><span class="token function">findOrdersByUserIdAndStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ordersMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_24-订单控制器"><a href="#_24-订单控制器" class="header-anchor">#</a> 24, 订单控制器</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/orders&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 生成订单
   * @param orders 订单对象
   * @param userId 用户Id
   * @return 生成的订单
   */</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Orders</span> orders<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    orders<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存订单</span>
    <span class="token class-name">Orders</span> orders1 <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将redis中购物车商品删除</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cartService<span class="token punctuation">.</span><span class="token function">deleteCartOption</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>cartGood<span class="token punctuation">.</span><span class="token function">getGoodId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orders1<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


   <span class="token comment">/**
   * 根据id查询订单
   * @param id 订单id
   * @return 查询结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * 查询用户的订单
   * @param status 订单状态：1.未付款 2.已付款 3.未发货 4.已发货 5.交易成功 6.交易关闭 7.待评价，传入空值代表查询所有
   * @param userId 用户id
   * @return 查询结果
   */</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findUserOrders&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserOrders</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestHeader</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Orders</span><span class="token punctuation">&gt;</span></span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">findUserOrders</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>修改订单的功能并不是让用户主动调用的，而是在用户支付完成后修改订单状态时调用，所以只重写接口方法即可，不需要写控制器</p> <h3 id="_25-创建支付服务模块"><a href="#_25-创建支付服务模块" class="header-anchor">#</a> 25, 创建支付服务模块</h3> <p><img src="/devops/public/assets/img/1727073849453.7bc1ffb7.png" alt="1727073849453"></p> <p>创建名为<code>shopping_pay_service</code>的SpringBoot工程，添加相关依赖。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--支付宝SDK--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.22.86.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- MyBatisPlus --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- mysql驱动 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- common --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.itbaizhan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shopping_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- dubbo --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- nacos --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- test --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>在Nacos配置中心创建配置文件<code>shopping_pay_service-dev.yaml</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9011</span>


<span class="token comment"># 日志格式</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
   <span class="token key atrule">console</span><span class="token punctuation">:</span> <span class="token string">'%d{HH:mm:ss.SSS} %clr(%-5level) ---  [%-15thread] %cyan(%-50logger{50}):%msg%n'</span>


<span class="token comment">#配置mybatis-plus</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
   <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
   <span class="token comment"># 表名前缀</span>
    <span class="token key atrule">table-prefix</span><span class="token punctuation">:</span> bz_
   <span class="token comment"># 主键生成策略为自增</span>
    <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
  <span class="token comment"># 关闭列名自动驼峰命名规则映射</span>
   <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
   <span class="token key atrule">log-impl</span><span class="token punctuation">:</span> org.apache.ibatis.logging.stdout.StdOutImpl <span class="token comment">#开启sql日志</span>


<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shopping_pay_service <span class="token comment">#服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.99<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心地址</span>
 <span class="token comment"># 数据源</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
   <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
   <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>///baizhanshopping<span class="token punctuation">?</span>serverTimezone=UTC
   <span class="token key atrule">username</span><span class="token punctuation">:</span> root
   <span class="token key atrule">password</span><span class="token punctuation">:</span> root


<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> shopping_pay_service <span class="token comment">#服务名</span>
   <span class="token key atrule">serialize-check-status</span><span class="token punctuation">:</span> DISABLE
   <span class="token key atrule">check-serializable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo <span class="token comment"># 通讯协议</span>
   <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 端口号，-1表示自动扫描可用端口。</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
   <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//192.168.0.99<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># 注册中心</span>


<span class="token comment"># 支付配置</span>
<span class="token key atrule">alipay</span><span class="token punctuation">:</span>
  <span class="token key atrule">appId</span><span class="token punctuation">:</span> <span class="token number">2021000122663020</span>
  <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCuzdOHuNEHaOwSmacCwZKgiDPu4Fg8RwOJv7wIL8hwNHCyR0/6/8E6b4iWetFg2RP2oAjVxq/+Z0JvW2bDD/E3J3ADX4UAQvWerSpSJv53KTaT2M0xyQgaHWBsktjbLYtlQ/pYlkP6Zw0pX6VLSThHjuTRZyvOUOprMpbqL7ljQm4X9/F0WtiiSwycSjPz2fyzdLuGBOH9djjFAqHNisaIKteOvyy0bttSU3VVZmqwd9aMhfPnSXc0ZxEzVubC1HN9D/qEkI9ejDXRsR/30jfR/9Scv5cTvGyA6YvA43wN+nlpW0pAlcqhBnyh3zUxHjabgH8Y6J2ITcHcyz95SbjpAgMBAAECggEAG5cRFBLvqyO8XxMxcRXsdroIuGNgieMLg+pnW0Nvd4ZPY1QuI4fKj9aa0GWCNq8Mn5iSzGsXzCewLLNYfOE/SV1IKMAi1e+7pNfgHidZcqVmn99QQ9NfHAAXAAwNfkqp/cnE8caF5Dfvs+AMzt03rNO4+fQ2zdGnrlPFziDKOgg2PG67YGsDpyo1k71/XnpAu6rV/ENWay1+8wfvR7BrGf25REwpVAeyTS5zpgQ0OyFD4Sf1rkwneEHT+DoI/hJNCg5gm/cPbJQvhXMKS0PD3P5B996lfWqX3SBSAifaXrr0ABctsORlll+E7JtL+b7GBgW71xj/7sVZQ7rxBVSSIQKBgQD+eHFLUnzl2gFT/aTgKelz4MZ8gQ4mWl4jNYhy5RQWNuDSiPqgN1qpAtAhX5QKKDakWsO6XetcaL49z2AN0VHIXbqnovAngeFMzdS4WHkZ+/GjfXr715ZbIRUL62g33/D5lbeA0x6DvfpeoO3DR6lPjCdeHsCgpMij7X1tx3UL5wKBgQCv2sy96XraYDLVxl2UCXQ3gDqUYAGOVZVb1WUjocn5HjAAneMZDmCpYR2KfqLN1rho+joJd+YtsX4nSXurAdytMUQIYSPJYW3T/N4xalXFtlMeKVmomQDpyI/RisskVrDuOramlGsKCSIDLEwcDs7+TdHbKliE6bmVS6ksK0H6rwKBgQDjDL4xscEFKTYkJd21sU++d+FB97iTWfBCxCIiOelpRL/muhe9WoaG5J6mGGyzf1v5245mPCSjiEWuStjum0S4XYEM0CItbgKDj+fsL+yl1ZmuAWj5Sku6tdLclsefiy2s0/wucrD4ZUr+oeJjag5Ujr4ViaTf8Qeg1Gcky2HRIwKBgQCTeIpALL8gyJF44nvxPChgrsDxUr2bTjwNohvJ0NCef+lDayRaC8uV32I1lVMUCR/msQjgjdLSuMkRSzdRRiN4fhsOZ9/p7jF7F9CBYioBvo9feM++amjwpIeu8pS+qZCAh25KraZB6TzDqm89DFIbwsjc4VsQQyylfail6LTQ8wKBgGDhypYjEbtRaJalwANIKkNTjJ8OLBzUYtF39gNjUQTYdTk1DboSc2PbFbB6d0LnoR7kT3OgJz25tuT6cBvxCjzy7lo/inpjpGV7D/wCUxM1aDWvbU6Bw0vX8+1c467WyZxX4rWD8BKYLESfL5t4uZPOWxqE1ZRhRUPYAttUxtUS
  <span class="token key atrule">publicKey</span><span class="token punctuation">:</span> MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAolZYB8CHfAH/NJo64+SSMB/AIYwOF1VIEeP40ycRazIYVG24M6xZrkh4fox44ABy9jwU+wcVTJFnHo+kskGF5S3rPqUs0fHLypCM9SHEZZbbcl7NbzlBeKUw+FWZwxLtTTts5TnTOapeULIxez6Nq/1W5oyKNWKVFjZbN8KZtSy5/IeF4gVTGRMLuo8CM0ChjgWBP5TnZirx6Y3+8MYPLZNSHXpRiBQuIVkWXtvbWrreIndrQlxmJnvc5bCL0rh2KQhEYjThDyXzfTtgSt6HNtL4IeP3/sjuojWWy3Yem6seXTJjXfxOxxSmQz6vQ+ZkuuTADLDv+l/PDmONJUWqOwIDAQAB
  <span class="token key atrule">gateway</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//openapi<span class="token punctuation">-</span>sandbox.dl.alipaydev.com/gateway.do
  <span class="token key atrule">notifyUrl</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//kalista.natapp1.cc
  <span class="token key atrule">pcNotify</span><span class="token punctuation">:</span> /user/payment/success/notify
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>编写配置文件<code>bootstrap.yml</code>，连接配置中心</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token comment"># 环境</span>
   <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
   <span class="token comment"># 注册中心</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
     <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.99<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#注册中心地址</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 5455dc7a<span class="token punctuation">-</span>b343<span class="token punctuation">-</span>4866<span class="token punctuation">-</span>a973<span class="token punctuation">-</span>96d5cc1d9312 <span class="token comment">#命名空间</span>
     <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#文件名后缀</span>
     <span class="token key atrule">prefix</span><span class="token punctuation">:</span> shopping_pay_service <span class="token comment">#文件名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>编写启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingPayServiceApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingPayServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_26-编写支付相关配置类"><a href="#_26-编写支付相关配置类" class="header-anchor">#</a> 26, 编写支付相关配置类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 支付宝配置
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;alipay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZfbPayConfig</span> <span class="token punctuation">{</span>
  <span class="token comment">// 应用id</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span>
  <span class="token comment">// 应用私钥</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> privateKey<span class="token punctuation">;</span>
  <span class="token comment">// 支付宝公钥</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> publicKey<span class="token punctuation">;</span>
  <span class="token comment">// 网关</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> gateway<span class="token punctuation">;</span>
  <span class="token comment">// 回调网址</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span>
  <span class="token comment">// 支付成功回调接口</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> pcNotify<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 设置支付宝客户端
   */</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AlipayClient</span> <span class="token function">setAlipayClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>gateway<span class="token punctuation">,</span> appId<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZfbVerifierUtils</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 验证支付宝异步通知签名合法性
   *
   * @param requestParameterMap 支付宝请求的所有参数
   * @param alipayPublicKey   支付宝公钥
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParameterMap<span class="token punctuation">,</span> <span class="token class-name">String</span> alipayPublicKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 获取支付宝post发送过来的信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> v <span class="token operator">:</span> requestParameterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
      resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">,</span> alipayPublicKey<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="_27-创建支付服务接口"><a href="#_27-创建支付服务接口" class="header-anchor">#</a> 27, 创建支付服务接口</h3> <p>在<strong>通用模块</strong>编写支付服务接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 支付服务接口
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ZfbPayService</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 生成二维码
   * @param orders 订单对象
   * @return 二维码字符串
   */</span>
  <span class="token class-name">String</span> <span class="token function">pcPay</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/**
   * 验签
   * @param paramMap 支付相关参数
   */</span>
  <span class="token keyword">void</span> <span class="token function">checkSign</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">/**
   * 生成交易记录
   * @param payment 交易记录对象
   */</span>
  <span class="token keyword">void</span> <span class="token function">addPayment</span><span class="token punctuation">(</span><span class="token class-name">Payment</span> payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_28-生成二维码"><a href="#_28-生成二维码" class="header-anchor">#</a> 28, 生成二维码</h3> <p>在<strong>支付服务模块</strong>编写支付接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZfbPayServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ZfbPayService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">ZfbPayConfig</span> zfbPayConfig<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">AlipayClient</span> alipayClient<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">PaymentMapper</span> paymentMapper<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">pcPay</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建请求对象</span>
    <span class="token class-name">AlipayTradePrecreateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePrecreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.设置请求内容</span>
    request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>zfbPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> zfbPayConfig<span class="token punctuation">.</span><span class="token function">getPcNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单编号</span>
    bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_amount&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单金额</span>
    bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;subject&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//订单标题</span>
    request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 3.发送请求</span>
      <span class="token class-name">AlipayTradePrecreateResponse</span> response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 4.返回二维码</span>
      <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getQrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">QR_CODE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_29-生成二维码控制器"><a href="#_29-生成二维码控制器" class="header-anchor">#</a> 29, 生成二维码控制器</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 支付
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@DubboReference</span>
  <span class="token keyword">private</span> <span class="token class-name">ZfbPayService</span> zfbPayService<span class="token punctuation">;</span>


  <span class="token comment">/**
   * 生成二维码
   *
   * @param orderId 订单号
   * @return 二维码url
   */</span>
  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pcPay&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">pcPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> codeUrl <span class="token operator">=</span> zfbPayService<span class="token punctuation">.</span><span class="token function">pcPay</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>codeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在Higress中配置支付路由</p> <p><img src="/devops/public/assets/img/1727074656516.934ffccd.png" alt="1727074656516"></p> <p>测试生成二维码功能</p> <h3 id="_30-测试支付二维码的生成"><a href="#_30-测试支付二维码的生成" class="header-anchor">#</a> 30, 测试支付二维码的生成</h3> <p><img src="/devops/public/assets/img/1727074740261.f727ea46.png" alt="1727074740261"></p> <p><img src="/devops/public/assets/img/1727074771669.c120c989.png" alt="1727074771669"></p> <h3 id="_31-编写支付回调方法-1"><a href="#_31-编写支付回调方法-1" class="header-anchor">#</a> 31, 编写支付回调方法(1)</h3> <p>在支付成功后，支付宝会通知我们支付成功，此时我们需要准备一个回调方法供支付宝调用，在该方法中我们要进行验签、修改订单状态、生成交易记录。我们先重写支付接口实现类中的相关方法：</p> <ol><li><p>在<strong>支付服务模块</strong>编写交易记录Mapper</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>在启动类扫描交易记录Mapper</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableDubbo</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.itbaizhan.shopping_pay_service.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingPayServiceApplication</span> <span class="token punctuation">{</span>


  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ShoppingPayServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>在<strong>支付服务模块</strong>编写支付接口实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkSign</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所有参数</span>
  <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParameterMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> paramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;requestParameterMap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 验签</span>
  <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token class-name">ZfbVerifierUtils</span><span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>requestParameterMap<span class="token punctuation">,</span> zfbPayConfig<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 验签失败，抛出异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">CHECK_SIGN_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPayment</span><span class="token punctuation">(</span><span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  paymentMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li></ol> <h3 id="_32-编写支付回调方法-2"><a href="#_32-编写支付回调方法-2" class="header-anchor">#</a> 32, 编写支付回调方法(2)</h3> <p>编写支付控制器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 该方法是用户扫码支付后支付宝调用的。
 * @return
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/success/notify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">successNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 1.验签</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;requestParameterMap&quot;</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  zfbPayService<span class="token punctuation">.</span><span class="token function">checkSign</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token class-name">String</span> trade_status <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单状态</span>
  <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单编号</span>


  <span class="token comment">// 如果支付成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 2.修改订单状态</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态为已付款</span>
    orders<span class="token punctuation">.</span><span class="token function">setPaymentTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orders<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付宝支付</span>
    orderService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 3.添加交易记录</span>
    <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payment<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单编号</span>
    payment<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易号</span>
    payment<span class="token punctuation">.</span><span class="token function">setTradeType</span><span class="token punctuation">(</span><span class="token string">&quot;支付宝支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易类型</span>
    payment<span class="token punctuation">.</span><span class="token function">setTradeState</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易状态</span>
    payment<span class="token punctuation">.</span><span class="token function">setPayerTotal</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 付款数</span>
    payment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付详情</span>
    payment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付时间</span>
    zfbPayService<span class="token punctuation">.</span><span class="token function">addPayment</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="_33-测试支付功能"><a href="#_33-测试支付功能" class="header-anchor">#</a> 33, 测试支付功能</h3> <p>由于回调方法需要让支付宝服务器调用，而我们的项目只能在内网访问，所以我们需要搭建内网穿透服务，让外部可以访问订单api。</p> <ol><li>访问<a href="https://natapp.cn/" target="_blank" rel="noopener noreferrer">https://natapp.cn/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，登录并创建隧道。</li> <li>配置隧道，代理本地的8006端口。</li> <li>在natapp目录打开cmd控制台，输入<code>natapp -authtoken=生成的令牌</code>。启动natapp。</li> <li>打开支付服务配置文件，修改回调网址为natapp暴露的网址，回调路径为回调方法路径。</li> <li>启动项目，生成支付二维码，使用手机支付宝沙箱环境进行支付。</li></ol> <h3 id="_34-解决验签时序列化失败异常"><a href="#_34-解决验签时序列化失败异常" class="header-anchor">#</a> 34, 解决验签时序列化失败异常</h3> <p>在支付的时候，会报序列化Map异常，这是因为支付消费者在调用支付生产者验签时，会传入Request对象中的所有参数的Map，这个Map只能查询，不能修改键值对，而FastJson2在序列化Map时，会对键值对进行修改，所以会抛出异常，解决方法如下：</p> <p>新建一个Map，将参数Map中的数据传入新Map中，构造parameterMap时传入新Map即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
   * 支付成功的回调方法，用户扫码支付后支付宝调用的
   * @param request
   * @return
   */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/success/notify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">successNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 1.验签</span>
  <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> parameterMap <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 新Map</span>
  <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;requestParameterMap&quot;</span><span class="token punctuation">,</span>newMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  zfbPayService<span class="token punctuation">.</span><span class="token function">checkSign</span><span class="token punctuation">(</span>paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token class-name">String</span> trade_status <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单状态</span>
  <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单编号</span>
  <span class="token comment">// 如果支付成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 2.修改订单状态</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单状态为已付款</span>
    orders<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 支付宝支付</span>
    orders<span class="token punctuation">.</span><span class="token function">setPaymentTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ordersService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.添加交易记录</span>
    <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payment<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单编号</span>
    payment<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易号</span>
    payment<span class="token punctuation">.</span><span class="token function">setTradeType</span><span class="token punctuation">(</span><span class="token string">&quot;支付宝支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易类型</span>
    payment<span class="token punctuation">.</span><span class="token function">setTradeState</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交易状态</span>
    payment<span class="token punctuation">.</span><span class="token function">setPayerTotal</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 付款金额</span>
    payment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付详情</span>
    payment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付时间</span>
    zfbPayService<span class="token punctuation">.</span><span class="token function">addPayment</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_35-删除过期订单"><a href="#_35-删除过期订单" class="header-anchor">#</a> 35, 删除过期订单</h3> <p>用户下单后，如果长时间不支付，则该商品始终被用户占据，其他用户也无法购买。我们需要给订单设置过期时间，过期后<strong>修改订单状态</strong>。如何能够在订单生成后一段时间执行代码，验证订单状态呢？有如下一些处理方式：</p> <ul><li>定时任务定期扫描所有订单，发现过时后删除。这种方式较为浪费资源，时效性也较低，不建议使用。</li> <li>利用消息队列中的延时消息，过一段时间后查询订单是否已经支付，未支付删除订单。该方式建议使用</li> <li>设置redis过期时间，并编写redis过期监听方法，当redis中的订单过期后回退商品库存。该方式建议使用</li></ul> <p>对于普通订单，我们采用第二种方式删除过期订单</p> <ol><li><p>在订单服务模块添加RocketMQ起步依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- rocketmq --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>rocketmq-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>在<code>shopping_orders_service-dev.yaml</code>中添加RocketMQ相关配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">rocketmq</span><span class="token punctuation">:</span>
 <span class="token comment"># nameserver地址</span>
  <span class="token key atrule">name-server</span><span class="token punctuation">:</span> 192.168.0.99<span class="token punctuation">:</span><span class="token number">9876</span>
  <span class="token key atrule">producer</span><span class="token punctuation">:</span>
  <span class="token comment"># 生产组</span>
   <span class="token key atrule">group</span><span class="token punctuation">:</span> my_group1
  <span class="token comment"># 发送消息超时时间</span>
   <span class="token key atrule">send-message-timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>在商品服务模块的<code>resources</code>目录下建立<code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code>文件，添加如下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>org.apache.rocketmq.spring.autoconfigure.RocketMQAutoConfiguration
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>在RocketMQ中创建队列<code>check_orders_queue</code></p></li></ol> <h3 id="_36-发送检查订单状态消息"><a href="#_36-发送检查订单状态消息" class="header-anchor">#</a> 36, 发送检查订单状态消息</h3> <p>修改新增订单方法，新增订单后发送延迟消息</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DubboService</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrdersService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">OrdersMapper</span> ordersMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CartGoodsMapper</span> cartGoodsMapper<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CHECK_ORDERS_QUEUE</span><span class="token operator">=</span> <span class="token string">&quot;check_orders_queue&quot;</span><span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Orders</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 订单状态未付款</span>
    orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订单创建时间</span>
    orders<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算订单价格，遍历订单所有商品</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartGoods</span><span class="token punctuation">&gt;</span></span> cartGoods <span class="token operator">=</span> orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 数量</span>
      <span class="token class-name">BigDecimal</span> num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 单价</span>
      <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> cartGood<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 数量 * 单价</span>
      <span class="token class-name">BigDecimal</span> multiply <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>multiply<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    orders<span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存订单</span>
    ordersMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存订单商品</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartGoods</span> cartGood <span class="token operator">:</span> cartGoods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cartGood<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cartGoodsMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>cartGood<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>


    <span class="token comment">//发送延时消息，30m后判断订单是否支付</span>
    <span class="token comment">//延时等级1到16分别表示 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</span>
    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span><span class="token constant">CHECK_ORDERS_QUEUE</span><span class="token punctuation">,</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="_37-消费检查订单状态消息"><a href="#_37-消费检查订单状态消息" class="header-anchor">#</a> 37, 消费检查订单状态消息</h3> <p>在订单服务模块添加延迟消息的消费者</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 延迟队列消费者，检查订单状态
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> <span class="token string">&quot;check_orders_queue&quot;</span><span class="token punctuation">,</span>consumerGroup <span class="token operator">=</span> <span class="token string">&quot;check_orders_queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckOrdersListener</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">OrdersService</span> ordersService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询订单</span>
    <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果此时订单状态还是未支付，则将状态改为交易关闭</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ordersService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>修改生成二维码方法，未支付订单才会生成二维码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">pcPay</span><span class="token punctuation">(</span><span class="token class-name">Orders</span> orders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 判断订单状态，未支付才会生成二维码
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


  <span class="token comment">// 1.创建请求对象</span>
  <span class="token class-name">AlipayTradePrecreateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePrecreateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.设置请求内容</span>
  request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>zfbPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>zfbPayConfig<span class="token punctuation">.</span><span class="token function">getPcNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单编号</span>
  bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_amount&quot;</span><span class="token punctuation">,</span>orders<span class="token punctuation">.</span><span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单金额</span>
  bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;subject&quot;</span><span class="token punctuation">,</span>orders<span class="token punctuation">.</span><span class="token function">getCartGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单标题</span>
  request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">AlipayTradePrecreateResponse</span> response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.返回二维码</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getQrCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusException</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">QR_CODE_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_38-测试删除过期订单"><a href="#_38-测试删除过期订单" class="header-anchor">#</a> 38, 测试删除过期订单</h3> <h3 id="_39-分布式事务的产生"><a href="#_39-分布式事务的产生" class="header-anchor">#</a> 39, 分布式事务的产生</h3> <p>在支付订单的回调方法中，我们既调用了订单服务修改订单，又调用了支付服务添加交易记录。假如修改订单后代码出现BUG，此时交易记录无法生成，但订单状态已经改为已支付，这就造成了数据不一致的情况。我们需要加入事务让支付回调方法成为不可分割的原子方法。但由于这两次数据库操作属于不同的服务，普通的事务管理器无法生效，所以我们需要安装使用分布式事务管理器——Seata。</p> <p><img src="/devops/public/assets/img/1727140299127.91eb657e.png" alt="1727140299127"></p> <h3 id="_40-安装seata"><a href="#_40-安装seata" class="header-anchor">#</a> 40, 安装Seata</h3> <ol><li><p>使用rz命令上传Seata到虚拟机</p></li> <li><p>安装Seata</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> seata-server-1.8.0.tar.gz <span class="token parameter variable">-C</span> /usr/local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>创建Seata日志文件夹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir /root/logs/seata
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>修改Seata配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vim /usr/local/seata/conf/application.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>改为如下内容：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#  Copyright 1999-2019 Seata.io Group.</span>
<span class="token comment">#</span>
<span class="token comment">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="token comment">#  you may not use this file except in compliance with the License.</span>
<span class="token comment">#  You may obtain a copy of the License at</span>
<span class="token comment">#</span>
<span class="token comment">#  http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#</span>
<span class="token comment">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="token comment">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment">#  See the License for the specific language governing permissions and</span>
<span class="token comment">#  limitations under the License.</span>


server:
  port: <span class="token number">7091</span>


spring:
  application:
   name: seata-server


logging:
  config: classpath:logback-spring.xml
  file:
   path: /usr/local/seata/logs/seata
 <span class="token comment">#extend:</span>
 <span class="token comment">#  logstash-appender:</span>
 <span class="token comment">#   destination: 127.0.0.1:4560</span>
 <span class="token comment">#  kafka-appender:</span>
 <span class="token comment">#   bootstrap-servers: 127.0.0.1:9092</span>
 <span class="token comment">#   topic: logback_to_logstash</span>


console:
  user:
   username: seata
   password: seata
seata:
  config:
  <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span>
   type: nacos
   nacos:
    application: seata-tc-server
    server-addr: <span class="token number">127.0</span>.0.1:8848
    namespace:
    group: DEFAULT_GROUP
    data-id: seataServer.properties
  registry:
  <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span>
   type: nacos
   nacos:
    application: seata-tc-server
    server-addr: <span class="token number">127.0</span>.0.1:8848
    group: DEFAULT_GROUP
    namespace:
    cluster: BJ
<span class="token comment">#  server:</span>
<span class="token comment">#   service-port: 8091 #If not configured, the default is '${server.port} + 1000'</span>
  security:
   secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017
   tokenValidityInMilliseconds: <span class="token number">1800000</span>
   ignore:
    urls: /,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.jpeg,/**/*.ico,/api/v1/auth/login
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div></li> <li><p>在nacos配置中心添加Seata服务配置文件<code>seataServer.properties</code>。</p> <p><img src="/devops/public/assets/img/1727140519973.ecc977a5.png" alt="1727140519973"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#这里的地址需要配置成seata所在服务器的地址
service.default.grouplist=192.168.0.99:8091
service.enableDegrade=false
service.disableGlobalTransaction=false
#此处对于数据存储使用的是数据库存储所以需要配置数据库的连接信息
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver 
store.db.url=jdbc:mysql://192.168.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true
store.db.user=root
store.db.password=root
store.db.minConn=5
store.db.maxConn=30
#此处有四张表的配置，所以需要在数据库中执行对应的SQL创建表
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.distributedLockTable=distributed_lock
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000
 
#Transaction rule configuration, only for the server
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.distributedLockExpireTime=10000
server.xaerNotaRetryTimeout=60000
server.session.branchAsyncQueueSize=5000
server.session.enableBranchAsyncRemove=false
 
#Transaction rule configuration, only for the client
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=true
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
client.rm.sagaJsonParser=fastjson
client.rm.tccActionInterceptorOrder=-2147482648
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000
client.tm.interceptorOrder=-2147482648
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
 
#For TCC transaction mode
tcc.fence.logTableName=tcc_fence_log
tcc.fence.cleanPeriod=1h
 
#Log rule configuration, for client and server
log.exceptionRate=100
 
#Metrics configuration, only for the server
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
 
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableTmClientBatchSendRequest=false
transport.enableRmClientBatchSendRequest=true
transport.enableTcServerBatchSendResponse=false
transport.rpcRmRequestTimeout=30000
transport.rpcTmRequestTimeout=30000
transport.rpcTcRequestTimeout=30000
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
transport.serialization=seata
transport.compressor=none
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div></li> <li><p>创建数据库<code>seata</code></p></li> <li><p>创建全局事务表和分支事务表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- -------------------------------- The script used when storeMode is 'db' --------------------------------</span>
<span class="token comment">-- the table to store GlobalSession data</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>global_table<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>            <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>          <span class="token keyword">TINYINT</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>application_id<span class="token punctuation">`</span></span>      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_service_group<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_name<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>timeout<span class="token punctuation">`</span></span>          <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>begin_time<span class="token punctuation">`</span></span>        <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>        <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>       <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status_gmt_modified<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_transaction_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>


<span class="token comment">-- the table to store BranchSession data</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>branch_table<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>        <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>  <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_group_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_type<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>      <span class="token keyword">TINYINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>    <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>


<span class="token comment">-- the table to store lock data</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>lock_table<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>table_name<span class="token punctuation">`</span></span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pk<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>     <span class="token keyword">TINYINT</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'0:locked ,1:rollbacking'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>  <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_branch_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span>
<span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span>    <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>lock_value<span class="token punctuation">`</span></span>   <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>expire<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
 <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>


<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'AsyncCommitting'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'RetryCommitting'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'RetryRollbacking'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'TxTimeoutCheck'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div></li> <li><p>启动Seata</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /usr/local/seata/bin/
./seata-server.sh <span class="token parameter variable">-p</span> <span class="token number">8091</span> <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.0.99
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>访问Seata，浏览器输入<a href="http://192.168.0.99:7091/" target="_blank" rel="noopener noreferrer">http://192.168.0.99:7091<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，用户名和密码都是seata。</p></li></ol> <h3 id="_41-使用seata管理分布式事务"><a href="#_41-使用seata管理分布式事务" class="header-anchor">#</a> 41, 使用Seata管理分布式事务</h3> <h3 id="_42-测试分布式事务"><a href="#_42-测试分布式事务" class="header-anchor">#</a> 42, 测试分布式事务</h3></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_1-编写购物车服务接口" class="sidebar-link reco-side-_1-编写购物车服务接口" data-v-b57cc07c>1, 编写购物车服务接口</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_2-创建购物车相关模块" class="sidebar-link reco-side-_2-创建购物车相关模块" data-v-b57cc07c>2, 创建购物车相关模块</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_3-查询用户购物车" class="sidebar-link reco-side-_3-查询用户购物车" data-v-b57cc07c>3, 查询用户购物车</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_4-添加商品到购物车" class="sidebar-link reco-side-_4-添加商品到购物车" data-v-b57cc07c>4, 添加商品到购物车</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_5-修改与删除购物车商品" class="sidebar-link reco-side-_5-修改与删除购物车商品" data-v-b57cc07c>5, 修改与删除购物车商品</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_6-编写购物车控制器" class="sidebar-link reco-side-_6-编写购物车控制器" data-v-b57cc07c>6, 编写购物车控制器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_7-测试购物车控制器" class="sidebar-link reco-side-_7-测试购物车控制器" data-v-b57cc07c>7, 测试购物车控制器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_8-修改所有用户购物车商品" class="sidebar-link reco-side-_8-修改所有用户购物车商品" data-v-b57cc07c>8, 修改所有用户购物车商品</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_9-删除所有用户购物车商品" class="sidebar-link reco-side-_9-删除所有用户购物车商品" data-v-b57cc07c>9, 删除所有用户购物车商品</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_10-修改商品服务" class="sidebar-link reco-side-_10-修改商品服务" data-v-b57cc07c>10, 修改商品服务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_11-发送修改与删除商品的消息" class="sidebar-link reco-side-_11-发送修改与删除商品的消息" data-v-b57cc07c>11, 发送修改与删除商品的消息</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_12-监听修改与删除商品的消息" class="sidebar-link reco-side-_12-监听修改与删除商品的消息" data-v-b57cc07c>12, 监听修改与删除商品的消息</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_13-测试同步购物车商品数据" class="sidebar-link reco-side-_13-测试同步购物车商品数据" data-v-b57cc07c>13, 测试同步购物车商品数据</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_14-创建订单相关模块" class="sidebar-link reco-side-_14-创建订单相关模块" data-v-b57cc07c>14, 创建订单相关模块</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_15-地址服务接口" class="sidebar-link reco-side-_15-地址服务接口" data-v-b57cc07c>15, 地址服务接口</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_16-地址服务接口实现类" class="sidebar-link reco-side-_16-地址服务接口实现类" data-v-b57cc07c>16, 地址服务接口实现类</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_17-地址控制器" class="sidebar-link reco-side-_17-地址控制器" data-v-b57cc07c>17, 地址控制器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_18-测试地址功能" class="sidebar-link reco-side-_18-测试地址功能" data-v-b57cc07c>18, 测试地址功能</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_19-订单服务接口" class="sidebar-link reco-side-_19-订单服务接口" data-v-b57cc07c>19, 订单服务接口</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_20-新增订单功能" class="sidebar-link reco-side-_20-新增订单功能" data-v-b57cc07c>20, 新增订单功能</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_21-测试下单功能" class="sidebar-link reco-side-_21-测试下单功能" data-v-b57cc07c>21, 测试下单功能</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_22-查询订单详情" class="sidebar-link reco-side-_22-查询订单详情" data-v-b57cc07c>22, 查询订单详情</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_23-查询用户订单与修改订单" class="sidebar-link reco-side-_23-查询用户订单与修改订单" data-v-b57cc07c>23, 查询用户订单与修改订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_24-订单控制器" class="sidebar-link reco-side-_24-订单控制器" data-v-b57cc07c>24, 订单控制器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_25-创建支付服务模块" class="sidebar-link reco-side-_25-创建支付服务模块" data-v-b57cc07c>25, 创建支付服务模块</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_26-编写支付相关配置类" class="sidebar-link reco-side-_26-编写支付相关配置类" data-v-b57cc07c>26, 编写支付相关配置类</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_27-创建支付服务接口" class="sidebar-link reco-side-_27-创建支付服务接口" data-v-b57cc07c>27, 创建支付服务接口</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_28-生成二维码" class="sidebar-link reco-side-_28-生成二维码" data-v-b57cc07c>28, 生成二维码</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_29-生成二维码控制器" class="sidebar-link reco-side-_29-生成二维码控制器" data-v-b57cc07c>29, 生成二维码控制器</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_30-测试支付二维码的生成" class="sidebar-link reco-side-_30-测试支付二维码的生成" data-v-b57cc07c>30, 测试支付二维码的生成</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_31-编写支付回调方法-1" class="sidebar-link reco-side-_31-编写支付回调方法-1" data-v-b57cc07c>31, 编写支付回调方法(1)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_32-编写支付回调方法-2" class="sidebar-link reco-side-_32-编写支付回调方法-2" data-v-b57cc07c>32, 编写支付回调方法(2)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_33-测试支付功能" class="sidebar-link reco-side-_33-测试支付功能" data-v-b57cc07c>33, 测试支付功能</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_34-解决验签时序列化失败异常" class="sidebar-link reco-side-_34-解决验签时序列化失败异常" data-v-b57cc07c>34, 解决验签时序列化失败异常</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_35-删除过期订单" class="sidebar-link reco-side-_35-删除过期订单" data-v-b57cc07c>35, 删除过期订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_36-发送检查订单状态消息" class="sidebar-link reco-side-_36-发送检查订单状态消息" data-v-b57cc07c>36, 发送检查订单状态消息</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_37-消费检查订单状态消息" class="sidebar-link reco-side-_37-消费检查订单状态消息" data-v-b57cc07c>37, 消费检查订单状态消息</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_38-测试删除过期订单" class="sidebar-link reco-side-_38-测试删除过期订单" data-v-b57cc07c>38, 测试删除过期订单</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_39-分布式事务的产生" class="sidebar-link reco-side-_39-分布式事务的产生" data-v-b57cc07c>39, 分布式事务的产生</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_40-安装seata" class="sidebar-link reco-side-_40-安装seata" data-v-b57cc07c>40, 安装Seata</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_41-使用seata管理分布式事务" class="sidebar-link reco-side-_41-使用seata管理分布式事务" data-v-b57cc07c>41, 使用Seata管理分布式事务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/springcloudalibaba/shopcms3/shopcms3.html#_42-测试分布式事务" class="sidebar-link reco-side-_42-测试分布式事务" data-v-b57cc07c>42, 测试分布式事务</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/devops/public/assets/js/app.ab309b1f.js" defer></script><script src="/devops/public/assets/js/106.7b430306.js" defer></script><script src="/devops/public/assets/js/1.774fca24.js" defer></script><script src="/devops/public/assets/js/103.9d419e8b.js" defer></script>
  </body>
</html>
