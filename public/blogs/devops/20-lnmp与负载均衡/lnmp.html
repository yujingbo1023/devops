<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>20-LNMP与负载均衡 | devops</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/devops/public/favicon.ico">
    <meta name="description" content="快来玩devops">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/devops/public/assets/css/0.styles.4a69f283.css" as="style"><link rel="preload" href="/devops/public/assets/js/app.09327a95.js" as="script"><link rel="preload" href="/devops/public/assets/js/109.5517edbe.js" as="script"><link rel="preload" href="/devops/public/assets/js/1.774fca24.js" as="script"><link rel="preload" href="/devops/public/assets/js/68.04dc8347.js" as="script"><link rel="prefetch" href="/devops/public/assets/js/10.2a2868a3.js"><link rel="prefetch" href="/devops/public/assets/js/100.63a9a68d.js"><link rel="prefetch" href="/devops/public/assets/js/101.87992e6e.js"><link rel="prefetch" href="/devops/public/assets/js/102.7ae50090.js"><link rel="prefetch" href="/devops/public/assets/js/103.2d0494f8.js"><link rel="prefetch" href="/devops/public/assets/js/104.c6b471fb.js"><link rel="prefetch" href="/devops/public/assets/js/105.155a3734.js"><link rel="prefetch" href="/devops/public/assets/js/106.240400ba.js"><link rel="prefetch" href="/devops/public/assets/js/107.1fc8d0bc.js"><link rel="prefetch" href="/devops/public/assets/js/108.31473c7f.js"><link rel="prefetch" href="/devops/public/assets/js/11.261bacb5.js"><link rel="prefetch" href="/devops/public/assets/js/110.7924b925.js"><link rel="prefetch" href="/devops/public/assets/js/111.3c36e902.js"><link rel="prefetch" href="/devops/public/assets/js/112.a3a09d4c.js"><link rel="prefetch" href="/devops/public/assets/js/113.d1c04e18.js"><link rel="prefetch" href="/devops/public/assets/js/114.aec23844.js"><link rel="prefetch" href="/devops/public/assets/js/115.f1131839.js"><link rel="prefetch" href="/devops/public/assets/js/116.3bd0f40e.js"><link rel="prefetch" href="/devops/public/assets/js/117.f97115f9.js"><link rel="prefetch" href="/devops/public/assets/js/118.b60e143a.js"><link rel="prefetch" href="/devops/public/assets/js/119.bfa1d7f5.js"><link rel="prefetch" href="/devops/public/assets/js/12.6548c321.js"><link rel="prefetch" href="/devops/public/assets/js/120.813c263c.js"><link rel="prefetch" href="/devops/public/assets/js/121.797a507d.js"><link rel="prefetch" href="/devops/public/assets/js/122.b27b9b7c.js"><link rel="prefetch" href="/devops/public/assets/js/123.b53789cd.js"><link rel="prefetch" href="/devops/public/assets/js/124.9a061b0f.js"><link rel="prefetch" href="/devops/public/assets/js/125.ef566394.js"><link rel="prefetch" href="/devops/public/assets/js/126.5ee3e900.js"><link rel="prefetch" href="/devops/public/assets/js/127.aaeed2c5.js"><link rel="prefetch" href="/devops/public/assets/js/128.69b9e967.js"><link rel="prefetch" href="/devops/public/assets/js/129.46f7a5fe.js"><link rel="prefetch" href="/devops/public/assets/js/13.7b550859.js"><link rel="prefetch" href="/devops/public/assets/js/130.52a369cf.js"><link rel="prefetch" href="/devops/public/assets/js/131.3f9b6424.js"><link rel="prefetch" href="/devops/public/assets/js/132.6b2cacb7.js"><link rel="prefetch" href="/devops/public/assets/js/133.0a88d1c9.js"><link rel="prefetch" href="/devops/public/assets/js/134.12c751e5.js"><link rel="prefetch" href="/devops/public/assets/js/135.e6f4f030.js"><link rel="prefetch" href="/devops/public/assets/js/136.140d550c.js"><link rel="prefetch" href="/devops/public/assets/js/137.e6593f2d.js"><link rel="prefetch" href="/devops/public/assets/js/138.673e3d4b.js"><link rel="prefetch" href="/devops/public/assets/js/139.ce894de1.js"><link rel="prefetch" href="/devops/public/assets/js/14.f5e53f77.js"><link rel="prefetch" href="/devops/public/assets/js/140.a6e27592.js"><link rel="prefetch" href="/devops/public/assets/js/141.37639667.js"><link rel="prefetch" href="/devops/public/assets/js/142.5ca8847c.js"><link rel="prefetch" href="/devops/public/assets/js/143.cfb16adf.js"><link rel="prefetch" href="/devops/public/assets/js/144.6ad857e6.js"><link rel="prefetch" href="/devops/public/assets/js/145.348aff20.js"><link rel="prefetch" href="/devops/public/assets/js/146.34b70b7e.js"><link rel="prefetch" href="/devops/public/assets/js/147.68908961.js"><link rel="prefetch" href="/devops/public/assets/js/148.d6fd09ea.js"><link rel="prefetch" href="/devops/public/assets/js/149.cd5846ce.js"><link rel="prefetch" href="/devops/public/assets/js/15.f134bd01.js"><link rel="prefetch" href="/devops/public/assets/js/150.d2f129af.js"><link rel="prefetch" href="/devops/public/assets/js/151.eca336da.js"><link rel="prefetch" href="/devops/public/assets/js/152.f0a47225.js"><link rel="prefetch" href="/devops/public/assets/js/153.23d0e73d.js"><link rel="prefetch" href="/devops/public/assets/js/154.1cdbaf86.js"><link rel="prefetch" href="/devops/public/assets/js/155.c089e401.js"><link rel="prefetch" href="/devops/public/assets/js/156.f6622b3c.js"><link rel="prefetch" href="/devops/public/assets/js/157.e837b626.js"><link rel="prefetch" href="/devops/public/assets/js/158.4e555143.js"><link rel="prefetch" href="/devops/public/assets/js/159.4cad5d5a.js"><link rel="prefetch" href="/devops/public/assets/js/16.d3089c5b.js"><link rel="prefetch" href="/devops/public/assets/js/160.38699f94.js"><link rel="prefetch" href="/devops/public/assets/js/161.d19a3af6.js"><link rel="prefetch" href="/devops/public/assets/js/162.cf74a347.js"><link rel="prefetch" href="/devops/public/assets/js/163.57fe96be.js"><link rel="prefetch" href="/devops/public/assets/js/164.ab85767b.js"><link rel="prefetch" href="/devops/public/assets/js/165.876fa558.js"><link rel="prefetch" href="/devops/public/assets/js/166.bac89f60.js"><link rel="prefetch" href="/devops/public/assets/js/167.a919f9c8.js"><link rel="prefetch" href="/devops/public/assets/js/168.4b4586f6.js"><link rel="prefetch" href="/devops/public/assets/js/169.b9f4fe94.js"><link rel="prefetch" href="/devops/public/assets/js/17.36c06dd6.js"><link rel="prefetch" href="/devops/public/assets/js/170.6ab4f95d.js"><link rel="prefetch" href="/devops/public/assets/js/171.1bd67eee.js"><link rel="prefetch" href="/devops/public/assets/js/172.caac6d23.js"><link rel="prefetch" href="/devops/public/assets/js/173.d68e78ea.js"><link rel="prefetch" href="/devops/public/assets/js/174.7870353f.js"><link rel="prefetch" href="/devops/public/assets/js/175.e6378bc9.js"><link rel="prefetch" href="/devops/public/assets/js/176.1a7ccc60.js"><link rel="prefetch" href="/devops/public/assets/js/177.dbded3fa.js"><link rel="prefetch" href="/devops/public/assets/js/178.cd2ae721.js"><link rel="prefetch" href="/devops/public/assets/js/179.e5a1e3ac.js"><link rel="prefetch" href="/devops/public/assets/js/18.3db8b924.js"><link rel="prefetch" href="/devops/public/assets/js/180.816a443b.js"><link rel="prefetch" href="/devops/public/assets/js/181.1fcbf826.js"><link rel="prefetch" href="/devops/public/assets/js/182.48ad0f51.js"><link rel="prefetch" href="/devops/public/assets/js/183.2512f0eb.js"><link rel="prefetch" href="/devops/public/assets/js/184.53edc000.js"><link rel="prefetch" href="/devops/public/assets/js/185.eb9b014a.js"><link rel="prefetch" href="/devops/public/assets/js/186.a1b7a6f4.js"><link rel="prefetch" href="/devops/public/assets/js/187.15170392.js"><link rel="prefetch" href="/devops/public/assets/js/188.eb4bbc5c.js"><link rel="prefetch" href="/devops/public/assets/js/189.d8431887.js"><link rel="prefetch" href="/devops/public/assets/js/19.6577be38.js"><link rel="prefetch" href="/devops/public/assets/js/190.9ea21eca.js"><link rel="prefetch" href="/devops/public/assets/js/191.cf94a3be.js"><link rel="prefetch" href="/devops/public/assets/js/192.bcefd9ed.js"><link rel="prefetch" href="/devops/public/assets/js/193.889aaae1.js"><link rel="prefetch" href="/devops/public/assets/js/194.14007d41.js"><link rel="prefetch" href="/devops/public/assets/js/195.94e385c4.js"><link rel="prefetch" href="/devops/public/assets/js/196.77f6642f.js"><link rel="prefetch" href="/devops/public/assets/js/197.913b2fd2.js"><link rel="prefetch" href="/devops/public/assets/js/198.e8fdfa28.js"><link rel="prefetch" href="/devops/public/assets/js/199.b1b5bf2b.js"><link rel="prefetch" href="/devops/public/assets/js/20.ac7c8ec8.js"><link rel="prefetch" href="/devops/public/assets/js/200.ae91c49c.js"><link rel="prefetch" href="/devops/public/assets/js/201.0a481308.js"><link rel="prefetch" href="/devops/public/assets/js/202.e8266e09.js"><link rel="prefetch" href="/devops/public/assets/js/203.2e3bb906.js"><link rel="prefetch" href="/devops/public/assets/js/204.36f15b18.js"><link rel="prefetch" href="/devops/public/assets/js/205.118bbfad.js"><link rel="prefetch" href="/devops/public/assets/js/206.64b66826.js"><link rel="prefetch" href="/devops/public/assets/js/207.018fbc3a.js"><link rel="prefetch" href="/devops/public/assets/js/208.1c55cfde.js"><link rel="prefetch" href="/devops/public/assets/js/209.ba921045.js"><link rel="prefetch" href="/devops/public/assets/js/21.33966913.js"><link rel="prefetch" href="/devops/public/assets/js/210.b20cb6b5.js"><link rel="prefetch" href="/devops/public/assets/js/211.cb1597f7.js"><link rel="prefetch" href="/devops/public/assets/js/212.4191bd94.js"><link rel="prefetch" href="/devops/public/assets/js/213.c324757a.js"><link rel="prefetch" href="/devops/public/assets/js/214.cc9292a7.js"><link rel="prefetch" href="/devops/public/assets/js/215.96bfbf79.js"><link rel="prefetch" href="/devops/public/assets/js/216.8d100aa4.js"><link rel="prefetch" href="/devops/public/assets/js/217.fd4b780f.js"><link rel="prefetch" href="/devops/public/assets/js/218.e568c369.js"><link rel="prefetch" href="/devops/public/assets/js/219.5b745edf.js"><link rel="prefetch" href="/devops/public/assets/js/22.d10ca68b.js"><link rel="prefetch" href="/devops/public/assets/js/220.21b5dbd4.js"><link rel="prefetch" href="/devops/public/assets/js/221.ba7bf73a.js"><link rel="prefetch" href="/devops/public/assets/js/222.d3eacd30.js"><link rel="prefetch" href="/devops/public/assets/js/223.a5b4b5a2.js"><link rel="prefetch" href="/devops/public/assets/js/224.5832d46e.js"><link rel="prefetch" href="/devops/public/assets/js/225.6f73f8e5.js"><link rel="prefetch" href="/devops/public/assets/js/23.a2bd04c8.js"><link rel="prefetch" href="/devops/public/assets/js/24.9ce81b65.js"><link rel="prefetch" href="/devops/public/assets/js/25.7b45ccd7.js"><link rel="prefetch" href="/devops/public/assets/js/26.b87224a0.js"><link rel="prefetch" href="/devops/public/assets/js/27.cdc71ed5.js"><link rel="prefetch" href="/devops/public/assets/js/28.b7f87506.js"><link rel="prefetch" href="/devops/public/assets/js/29.cd3e0897.js"><link rel="prefetch" href="/devops/public/assets/js/3.a4b42430.js"><link rel="prefetch" href="/devops/public/assets/js/30.ab9b8992.js"><link rel="prefetch" href="/devops/public/assets/js/31.177cb564.js"><link rel="prefetch" href="/devops/public/assets/js/32.8d1856a8.js"><link rel="prefetch" href="/devops/public/assets/js/33.e15e2a13.js"><link rel="prefetch" href="/devops/public/assets/js/34.aeed0df4.js"><link rel="prefetch" href="/devops/public/assets/js/35.4eb1601a.js"><link rel="prefetch" href="/devops/public/assets/js/36.1d598c1c.js"><link rel="prefetch" href="/devops/public/assets/js/37.8d56c4d5.js"><link rel="prefetch" href="/devops/public/assets/js/38.19b45483.js"><link rel="prefetch" href="/devops/public/assets/js/39.6ba315ed.js"><link rel="prefetch" href="/devops/public/assets/js/4.334a6285.js"><link rel="prefetch" href="/devops/public/assets/js/40.cdb22b81.js"><link rel="prefetch" href="/devops/public/assets/js/41.8522ab21.js"><link rel="prefetch" href="/devops/public/assets/js/42.7841c260.js"><link rel="prefetch" href="/devops/public/assets/js/43.76b9bbe5.js"><link rel="prefetch" href="/devops/public/assets/js/44.cc9bcb49.js"><link rel="prefetch" href="/devops/public/assets/js/45.30169a4e.js"><link rel="prefetch" href="/devops/public/assets/js/46.3a104973.js"><link rel="prefetch" href="/devops/public/assets/js/47.c27f540d.js"><link rel="prefetch" href="/devops/public/assets/js/48.0f371a19.js"><link rel="prefetch" href="/devops/public/assets/js/49.0621219c.js"><link rel="prefetch" href="/devops/public/assets/js/5.db4e5816.js"><link rel="prefetch" href="/devops/public/assets/js/50.5221e411.js"><link rel="prefetch" href="/devops/public/assets/js/51.2b92c92d.js"><link rel="prefetch" href="/devops/public/assets/js/52.d067eb33.js"><link rel="prefetch" href="/devops/public/assets/js/53.a860ea06.js"><link rel="prefetch" href="/devops/public/assets/js/54.f7c6fa19.js"><link rel="prefetch" href="/devops/public/assets/js/55.ec4eb850.js"><link rel="prefetch" href="/devops/public/assets/js/56.f8f25afc.js"><link rel="prefetch" href="/devops/public/assets/js/57.1879bd53.js"><link rel="prefetch" href="/devops/public/assets/js/58.af88e5b5.js"><link rel="prefetch" href="/devops/public/assets/js/59.a35d5bbb.js"><link rel="prefetch" href="/devops/public/assets/js/6.fe9e904b.js"><link rel="prefetch" href="/devops/public/assets/js/60.8d48b003.js"><link rel="prefetch" href="/devops/public/assets/js/61.86586f15.js"><link rel="prefetch" href="/devops/public/assets/js/62.466597d6.js"><link rel="prefetch" href="/devops/public/assets/js/63.6c85201a.js"><link rel="prefetch" href="/devops/public/assets/js/64.f784eff1.js"><link rel="prefetch" href="/devops/public/assets/js/65.819f2c55.js"><link rel="prefetch" href="/devops/public/assets/js/66.6a5b2e66.js"><link rel="prefetch" href="/devops/public/assets/js/67.dc8be05a.js"><link rel="prefetch" href="/devops/public/assets/js/69.43852061.js"><link rel="prefetch" href="/devops/public/assets/js/7.53819ddd.js"><link rel="prefetch" href="/devops/public/assets/js/70.0c3d81d9.js"><link rel="prefetch" href="/devops/public/assets/js/71.c1fe40ca.js"><link rel="prefetch" href="/devops/public/assets/js/72.2ff7bb57.js"><link rel="prefetch" href="/devops/public/assets/js/73.6e8caff8.js"><link rel="prefetch" href="/devops/public/assets/js/74.4436548c.js"><link rel="prefetch" href="/devops/public/assets/js/75.a0cc5cf8.js"><link rel="prefetch" href="/devops/public/assets/js/76.a739c437.js"><link rel="prefetch" href="/devops/public/assets/js/77.bc0fb70a.js"><link rel="prefetch" href="/devops/public/assets/js/78.f982335d.js"><link rel="prefetch" href="/devops/public/assets/js/79.e44193d0.js"><link rel="prefetch" href="/devops/public/assets/js/8.7ad6dcd0.js"><link rel="prefetch" href="/devops/public/assets/js/80.e2609ec8.js"><link rel="prefetch" href="/devops/public/assets/js/81.03155e3d.js"><link rel="prefetch" href="/devops/public/assets/js/82.a2b23349.js"><link rel="prefetch" href="/devops/public/assets/js/83.f8d12be4.js"><link rel="prefetch" href="/devops/public/assets/js/84.81367bed.js"><link rel="prefetch" href="/devops/public/assets/js/85.bef6baf9.js"><link rel="prefetch" href="/devops/public/assets/js/86.5ee1432a.js"><link rel="prefetch" href="/devops/public/assets/js/87.0fa4d5fc.js"><link rel="prefetch" href="/devops/public/assets/js/88.28f0b942.js"><link rel="prefetch" href="/devops/public/assets/js/89.667878c1.js"><link rel="prefetch" href="/devops/public/assets/js/9.ac9c7784.js"><link rel="prefetch" href="/devops/public/assets/js/90.072ecfbf.js"><link rel="prefetch" href="/devops/public/assets/js/91.c9aa0437.js"><link rel="prefetch" href="/devops/public/assets/js/92.01041f29.js"><link rel="prefetch" href="/devops/public/assets/js/93.d3af02a5.js"><link rel="prefetch" href="/devops/public/assets/js/94.03fda815.js"><link rel="prefetch" href="/devops/public/assets/js/95.fc4bf274.js"><link rel="prefetch" href="/devops/public/assets/js/96.2f7ee8d2.js"><link rel="prefetch" href="/devops/public/assets/js/97.074426e1.js"><link rel="prefetch" href="/devops/public/assets/js/98.f889c9bf.js"><link rel="prefetch" href="/devops/public/assets/js/99.f5a3ce51.js">
    <link rel="stylesheet" href="/devops/public/assets/css/0.styles.4a69f283.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>devops</h3> <p class="description" data-v-59e6cb88>快来玩devops</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devops/public/" class="home-link router-link-active"><img src="/devops/public/logo.png" alt="devops" class="logo"> <span class="site-name">devops</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/devops/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    devops
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>211</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>20-LNMP与负载均衡</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">20-LNMP与负载均衡</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>devops</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>devops</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="_1-lnmp搭建"><a href="#_1-lnmp搭建" class="header-anchor">#</a> 1，LNMP搭建</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>博客: 动态+静态 常用的网站
Linux系统 Nginx服务  MySQL服务  PHP服务 ------<span class="token operator">&gt;</span>LNMP架构
Linux系统 Nginx服务  MySQL服务  python服务     LNMP架构
Linux系统 Nginx服务  MySQL服务  Tomcat服务 java语言-------<span class="token operator">&gt;</span>LNMT


统一用户: 所有服务启动都使用www
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#groupadd -g666 www</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#useradd -u666 -g666 -M -s /sbin/nologin www</span>



安装部署Nginx
<span class="token number">1</span>.配置官方仓库<span class="token punctuation">(</span>之前做了，不用重复做了<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@linuxnc ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/yum.repos.d/nginx.repo </span>
<span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>nginx repo
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://nginx.org/packages/centos/7/<span class="token variable">$basearch</span>/
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token number">2</span>.安装Nginx服务<span class="token punctuation">(</span>之前做了，不用重复做了<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@linuxnc ~<span class="token punctuation">]</span><span class="token comment"># yum -y install nginx</span>

<span class="token number">3</span>.配置Nginx服务
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#sed -i '2s#nginx#www#g' /etc/nginx/nginx.conf</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#head -5 /etc/nginx/nginx.conf </span>

user  www<span class="token punctuation">;</span>
worker_processes  auto<span class="token punctuation">;</span>

error_log  /var/log/nginx/error.log notice<span class="token punctuation">;</span>


<span class="token number">4</span>.启动Nginx服务
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl start nginx</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable nginx</span>

查看nginx的启动用户，woker process一定是www用户
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#ps axu|grep nginx</span>
root       <span class="token number">60310</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span> <span class="token number">212412</span>   <span class="token number">744</span> pts/1    S+   <span class="token number">11</span>:25   <span class="token number">0</span>:00 <span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/nginx/access.log
root       <span class="token number">60490</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">22504</span>   <span class="token number">852</span> ?        Ss   <span class="token number">12</span>:01   <span class="token number">0</span>:00 nginx: master process /usr/sbin/nginx <span class="token parameter variable">-c</span> /etc/nginx/nginx.conf
www        <span class="token number">60491</span>  <span class="token number">0.0</span>  <span class="token number">0.4</span>  <span class="token number">33792</span>  <span class="token number">4184</span> ?        S    <span class="token number">12</span>:01   <span class="token number">0</span>:00 nginx: worker process



安装PHP服务
<span class="token number">1</span>.通过默认的麒麟仓库安装PHP7.2版本
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#yum -y install php php-bcmath php-cli php-common php-devel php-embedded php-fpm php-gd php-intl php-mbstring php-mysqlnd php-opcache php-pdo   php-process php-xml php-json</span>

<span class="token number">2</span>.修改启动用户
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#vim /etc/php-fpm.d/www.conf </span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#sed -n '24,26p' /etc/php-fpm.d/www.conf</span>
user <span class="token operator">=</span> www
<span class="token punctuation">;</span> RPM: Keep a group allowed to <span class="token function">write</span> <span class="token keyword">in</span> log dir.
group <span class="token operator">=</span> www

<span class="token number">3</span>.修改监听方式为端口
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#grep 9000 /etc/php-fpm.d/www.conf -n</span>
<span class="token number">38</span>:listen <span class="token operator">=</span> <span class="token number">127.0</span>.0.1:9000

<span class="token number">4</span>.启动php服务
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl start php-fpm</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable php-fpm</span>

<span class="token number">5</span>.检查服务端口
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#netstat -tnulp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:9000          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1322</span>/php-fpm: maste 
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:22              <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">798</span>/sshd: /usr/sbin 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::22                   :::*                    LISTEN      <span class="token number">798</span>/sshd: /usr/sbin 
udp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:323           <span class="token number">0.0</span>.0.0:*                           <span class="token number">745</span>/chronyd         
udp6       <span class="token number">0</span>      <span class="token number">0</span> ::1:323                 :::*                                <span class="token number">745</span>/chronyd     


安装数据库服务
通过默认的麒麟仓库安装数据库
<span class="token number">1</span>.安装数据库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#yum -y install mariadb-server</span>

<span class="token number">2</span>.启动数据库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl start mariadb</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable mariadb</span>

<span class="token number">3</span>.设置密码
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysqladmin password '123456Abc.com'</span>
<span class="token comment">#测试连接数据库</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p'123456Abc.com'</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">9</span>
Server version: <span class="token number">10.3</span>.39-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
+--------------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> quit    <span class="token comment"># quit退出数据库</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><h3 id="_2-配置nginx连接php服务"><a href="#_2-配置nginx连接php服务" class="header-anchor">#</a> 2，配置Nginx连接PHP服务</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>第一步: 修改Nginx配置
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">8</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">402</span> Aug <span class="token number">21</span> <span class="token number">10</span>:47 default.conf
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">402</span> Aug <span class="token number">21</span> <span class="token number">10</span>:36 php-fpm.conf.bak
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat default.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name php.malu.com<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                root /code<span class="token punctuation">;</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                root /code<span class="token punctuation">;</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
                include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



测试语法并重启Nginx服务
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>


第二步: 在代码目录写一个查看php本身信息的代码
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat /code/index.php</span>
<span class="token operator">&lt;</span>?php
        phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
?<span class="token operator">&gt;</span>

第三步: 浏览器访问测试
<span class="token number">10.0</span>.0.7
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>如果出现下面的显示，表示Nginx和php连接成功了：</p> <p><img src="/devops/public/assets/img/1724208517037.f24f35ad.png" alt="1724208517037"></p> <h3 id="_3-部署wordpress"><a href="#_3-部署wordpress" class="header-anchor">#</a> 3，部署wordpress</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>安装基础框架 Nginx+PHP+MySQL
<span class="token number">1</span>.创建wordpress的配置文件
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">12</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">402</span> Aug <span class="token number">21</span> <span class="token number">10</span>:47 default.conf
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">402</span> Aug <span class="token number">21</span> <span class="token number">10</span>:36 php-fpm.conf.bak
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">353</span> Aug <span class="token number">21</span> <span class="token number">10</span>:50 wordpress.conf
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#rm -rf default.conf </span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">8</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">402</span> Aug <span class="token number">21</span> <span class="token number">10</span>:36 php-fpm.conf.bak
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">353</span> Aug <span class="token number">21</span> <span class="token number">10</span>:50 wordpress.conf
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#rm -rf php-fpm.conf.bak </span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">4</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">353</span> Aug <span class="token number">21</span> <span class="token number">10</span>:50 wordpress.conf
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat wordpress.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>
        root /code/wp<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token number">2</span>.测试Nginx语法
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful

<span class="token number">3</span>.重启Nginx生效
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>


<span class="token number">4</span>.创建存放wordpress代码的目录
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mkdir -p /code/wp</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#cd /code/wp</span>


<span class="token number">5</span>.下载wordpress代码
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#wget https://cn.wordpress.org/wordpress-5.0.3-zh_CN.tar.gz</span>
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">10840</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">11098483</span> Jan <span class="token number">11</span>  <span class="token number">2019</span> wordpress-5.0.3-zh_CN.tar.gz
解压代码:
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#tar xf wordpress-5.0.3-zh_CN.tar.gz</span>
将代码移动到当前的目录
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#mv wordpress/* .</span>

<span class="token number">6</span>.windows做hosts解析
windows的hosts文件
<span class="token number">10.0</span>.0.7 www.wp.com

<span class="token number">7</span>.测试是否配置成功
<span class="token function">ping</span> www.wp.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>使用浏览器访问: www.wp.com</p> <p><img src="/devops/public/assets/img/1724048389645.54374890.png" alt="1724048389645"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建数据库wordpress
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;create database wordpress;&quot;</span>
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;show databases;&quot;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> wordpress          <span class="token operator">|</span>
+--------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/devops/public/assets/img/1724048456741.97589230.png" alt="1724048456741"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>信息使用的是Nginx的启动用户www的身份写入到代码目录/code/wp目录下的wp-config.php<span class="token punctuation">(</span>创建此文件<span class="token punctuation">)</span>
需要将/code/wp属主属组修改为www
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#chown -R www.www /code/wp/</span>

<span class="token punctuation">[</span>root@web01:code<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">4</span>
drwxr-xr-x <span class="token number">6</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">10</span>:53 wp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>修改后刷新页面:</p> <p><img src="/devops/public/assets/img/1724048481373.c03591be.png" alt="1724048481373"></p> <p><img src="/devops/public/assets/img/1724048505172.11f38e13.png" alt="1724048505172"></p> <p>写一篇文章：</p> <p><img src="/devops/public/assets/img/1724209496960.25e56204.png" alt="1724209496960"></p> <p><img src="/devops/public/assets/img/1724209513007.a82f9a9e.png" alt="1724209513007"></p> <p>看数据库：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@web01:code<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com </span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">48</span>
Server version: <span class="token number">10.3</span>.39-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> wordpress          <span class="token operator">|</span>
+--------------------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> use wordpress<span class="token punctuation">;</span>
Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names
You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>

Database changed
MariaDB <span class="token punctuation">[</span>wordpress<span class="token punctuation">]</span><span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+-----------------------+
<span class="token operator">|</span> Tables_in_wordpress   <span class="token operator">|</span>
+-----------------------+
<span class="token operator">|</span> wp_commentmeta        <span class="token operator">|</span>
<span class="token operator">|</span> wp_comments           <span class="token operator">|</span>
<span class="token operator">|</span> wp_links              <span class="token operator">|</span>
<span class="token operator">|</span> wp_options            <span class="token operator">|</span>
<span class="token operator">|</span> wp_postmeta           <span class="token operator">|</span>
<span class="token operator">|</span> wp_posts              <span class="token operator">|</span>
<span class="token operator">|</span> wp_term_relationships <span class="token operator">|</span>
<span class="token operator">|</span> wp_term_taxonomy      <span class="token operator">|</span>
<span class="token operator">|</span> wp_termmeta           <span class="token operator">|</span>
<span class="token operator">|</span> wp_terms              <span class="token operator">|</span>
<span class="token operator">|</span> wp_usermeta           <span class="token operator">|</span>
<span class="token operator">|</span> wp_users              <span class="token operator">|</span>
+-----------------------+
<span class="token number">12</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h3 id="_4-部署论坛业务"><a href="#_4-部署论坛业务" class="header-anchor">#</a> 4，部署论坛业务</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.修改Nginx配置
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat zh.conf</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.zh.com<span class="token punctuation">;</span>
        root /code/zh<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.测试配置
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

<span class="token number">3</span>.创建代码目录
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#mkdir /code/zh</span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cd /code/zh</span>

<span class="token number">4</span>.上传代码
微信群下载WeCenter_V3.6.2.zip
<span class="token punctuation">[</span>root@web01:zh<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">24648</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">25238972</span> Aug  <span class="token number">7</span> 09:28 WeCenter_V3.6.2.zip
解压代码:
<span class="token punctuation">[</span>root@web01:zh<span class="token punctuation">]</span><span class="token comment">#unzip WeCenter_V3.6.2.zip</span>

<span class="token number">5</span>.windows  hosts解析
<span class="token number">10.0</span>.0.7 www.wp.com www.zh.com

<span class="token number">6</span>.测试是否配置成功
<span class="token function">ping</span> www.zh.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>浏览器直接访问 www.zh.com</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>修改/code/zh属主属组
<span class="token punctuation">[</span>root@web01:zh<span class="token punctuation">]</span><span class="token comment">#chown -R www.www ../zh</span>

<span class="token punctuation">[</span>root@web01:code<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">8</span>
drwxr-xr-x  <span class="token number">6</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">10</span>:58 wp
drwxr-xr-x <span class="token number">14</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">11</span>:10 zh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/devops/public/assets/img/1724048605600.602bf2e3.png" alt="1724048605600"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建zh库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;create database zh;&quot;</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;show databases&quot;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> wordpress          <span class="token operator">|</span>
<span class="token operator">|</span> zh                 <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/devops/public/assets/img/1724048641903.741c11b5.png" alt="1724048641903"></p> <p><img src="/devops/public/assets/img/1724048650174.0f5befbf.png" alt="1724048650174"></p> <p>写一个问题：</p> <p><img src="/devops/public/assets/img/1724210177864.902ce004.png" alt="1724210177864"></p> <h3 id="_5-部署phpshe服务"><a href="#_5-部署phpshe服务" class="header-anchor">#</a> 5，部署phpshe服务</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.创建phpshe的nginx配置文件
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat phpshe.conf</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.she.com<span class="token punctuation">;</span>
        root /code/she<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">2</span>.检查语法并重启Nginx
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

<span class="token number">3</span>.创建代码目录
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#mkdir /code/she</span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cd /code/she</span>

<span class="token number">4</span>.上传代码并解压 
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">21356</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">21866674</span> Aug  <span class="token number">7</span> 09:58 phpshe.zip
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#unzip phpshe.zip</span>

<span class="token number">5</span>.修改目录属主属组www
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#chown -R www.www ../she</span>
<span class="token punctuation">[</span>root@web01:code<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">12</span>
drwxr-xr-x  <span class="token number">8</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">11</span>:19 she
drwxr-xr-x  <span class="token number">6</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">10</span>:58 wp
drwxr-xr-x <span class="token number">14</span> www www <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">11</span>:10 zh


<span class="token number">6</span>.windows hosts解析
<span class="token number">10.0</span>.0.7 www.wp.com www.zh.com www.she.com

<span class="token number">6</span>.测试是否配置成功
<span class="token function">ping</span> www.she.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>浏览器访问: www.she.com/install</p> <p><img src="/devops/public/assets/img/1724048718793.65208a7e.png" alt="1724048718793"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建she数据库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;create database she;&quot;</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com -e &quot;show databases;&quot;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> she                <span class="token operator">|</span>
<span class="token operator">|</span> wordpress          <span class="token operator">|</span>
<span class="token operator">|</span> zh                 <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>安装：</p> <p><img src="/devops/public/assets/img/1724210893444.e59dcc5d.png" alt="1724210893444"></p> <p>修改权限：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#chmod -R 777 ./data</span>
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#chmod 777 ./install</span>
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#chmod 777 ./config.php </span>
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">21420</span>
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">6357</span> Dec  <span class="token number">6</span>  <span class="token number">2021</span> admin.php
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">190</span> Oct  <span class="token number">5</span>  <span class="token number">2021</span> api.php
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">2877</span> Dec  <span class="token number">5</span>  <span class="token number">2021</span> common.php
<span class="token parameter variable">-rwxrwxrwx</span> <span class="token number">1</span> root root      <span class="token number">396</span> Dec <span class="token number">18</span>  <span class="token number">2021</span> config.php
drwxrwxrwx <span class="token number">7</span> root root       <span class="token number">72</span> Aug <span class="token number">21</span> <span class="token number">11</span>:25 data
-rw-r--r-- <span class="token number">1</span> root root     <span class="token number">9662</span> Apr <span class="token number">12</span>  <span class="token number">2015</span> favicon.ico
drwxr-xr-x <span class="token number">2</span> root root     <span class="token number">4096</span> Aug <span class="token number">21</span> <span class="token number">11</span>:25 hook
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">235</span> Dec  <span class="token number">4</span>  <span class="token number">2021</span> httpd.ini
drwxr-xr-x <span class="token number">8</span> root root       <span class="token number">85</span> Aug <span class="token number">21</span> <span class="token number">11</span>:25 include
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">940</span> Nov <span class="token number">19</span>  <span class="token number">2021</span> index.php
drwxrwxrwx <span class="token number">5</span> root root      <span class="token number">100</span> Aug <span class="token number">21</span> <span class="token number">11</span>:25 <span class="token function">install</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><img src="/devops/public/assets/img/1724210845520.6ba1424a.png" alt="1724210845520"></p> <p><img src="/devops/public/assets/img/1724048750278.19800d32.png" alt="1724048750278"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#rm -rf /code/she/install/</span>

访问phpshe的后台
www.she.com/admin.php

初始登录报错查看日志:
<span class="token function">cat</span> /var/log/nginx/error.log
<span class="token number">2024</span>/08/07 <span class="token number">10</span>:11:52 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">6012</span><span class="token comment">#6012: *30 FastCGI sent in stderr: &quot;PHP message: PHP Warning:  session_start(): open(/var/lib/php/session/sess_rhqvv7d40eou5vee44kl6lfbml, O_RDWR) failed: Permission denied (13) in /code/she/common.php on line 51</span>
修改/var/lib/php/session目录属主属组为www
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#chown www.www /var/lib/php/session/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>大家添加一个商品：</p> <p><img src="/devops/public/assets/img/1724212096567.ea38cb68.png" alt="1724212096567"></p> <p><img src="/devops/public/assets/img/1724212140808.fb008ddd.png" alt="1724212140808"></p> <h3 id="_6-拆分数据库"><a href="#_6-拆分数据库" class="header-anchor">#</a> 6，拆分数据库</h3> <p><img src="/devops/public/assets/img/1724048837758.303266c9.png" alt="1724048837758"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.克隆10.0.0.51    <span class="token number">172.16</span>.1.51    如果不会弄，看系统优化那一篇文章 

<span class="token number">2</span>.部署MySQL服务
安装:
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#yum -y install mariadb-server</span>
启动:
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#systemctl start mariadb</span>
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable mariadb</span>

<span class="token number">3</span>.web01导出数据库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mysqldump -uroot -p123456Abc.com -A &gt; web.sql</span>

<span class="token number">4</span>.将导出的数据传输到51服务器
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#scp web.sql 10.0.0.51:/root/</span>

<span class="token number">5</span>.在51服务器将数据写入到数据库
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot &lt; web.sql</span>
重启数据库
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#systemctl restart mariadb</span>
测试是否用密码登录
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">10</span>
Server version: <span class="token number">10.3</span>.39-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> quit
Bye



<span class="token number">6</span>.停止web01的数据库
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl stop mariadb</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl disable mariadb</span>


HTTP状态码: <span class="token number">500</span>数据库无法连接


数据库不允许远程通过root账号连接,所以我们在51服务器上创建普通账号。
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#mysql -uroot -p123456Abc.com</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">12</span>
Server version: <span class="token number">10.3</span>.39-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> grant all on  *.* to malu@<span class="token string">'%'</span> identified by <span class="token string">'123456Abc.com'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.001</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> quit

web01命令行测试是否可以使用malu用户远程连接数据库。
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#mysql -h 10.0.0.51 -umalu -p123456Abc.com</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">13</span>
Server version: <span class="token number">10.3</span>.39-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> quit     <span class="token comment"># 退出</span>

<span class="token number">7</span>.修改代码的数据库的IP指向 <span class="token number">172.16</span>.1.51
a.先找到配置数据库信息的文件。
<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#grep -r '123456Abc.com' ./*</span>
./wp-config.php:define<span class="token punctuation">(</span><span class="token string">'DB_PASSWORD'</span>, <span class="token string">'lzy123.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span>root@web01:wp<span class="token punctuation">]</span><span class="token comment">#sed -n '22,32p' wp-config.php</span>
/** WordPress数据库的名称 */
define<span class="token punctuation">(</span><span class="token string">'DB_NAME'</span>, <span class="token string">'wordpress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

/** MySQL数据库用户名 */
define<span class="token punctuation">(</span><span class="token string">'DB_USER'</span>, <span class="token string">'malu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

/** MySQL数据库密码 */
define<span class="token punctuation">(</span><span class="token string">'DB_PASSWORD'</span>, <span class="token string">'123456Abc.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

/** MySQL主机 */
define<span class="token punctuation">(</span><span class="token string">'DB_HOST'</span>, <span class="token string">'172.16.1.51'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


修改知乎数据库信息:
<span class="token punctuation">[</span>root@web01:zh<span class="token punctuation">]</span><span class="token comment">#cat system/config/database.php</span>
<span class="token operator">&lt;</span>?php

<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'charset'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'utf8mb4'</span><span class="token punctuation">;</span>
<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'prefix'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'aws_'</span><span class="token punctuation">;</span>
<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'driver'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'MySQLi'</span><span class="token punctuation">;</span>
<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'master'</span><span class="token punctuation">]</span> <span class="token operator">=</span> array <span class="token punctuation">(</span>
  <span class="token string">'charset'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'utf8mb4'</span>,
  <span class="token string">'host'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'172.16.1.51'</span>,
  <span class="token string">'username'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'malu'</span>,
  <span class="token string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'123456Abc.com'</span>,
  <span class="token string">'dbname'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'zh'</span>,
  <span class="token string">'port'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'3306'</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'slave'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">;</span>


修改phpshe数据库信息
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#cat config.php</span>
<span class="token operator">&lt;</span>?php
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'db_host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'172.16.1.51'</span><span class="token punctuation">;</span> //数据库主机地址
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'db_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'she'</span><span class="token punctuation">;</span> //数据库名称
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'db_user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'malu'</span><span class="token punctuation">;</span> //数据库用户名
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'db_pw'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'123456Abc.com'</span><span class="token punctuation">;</span> //数据库密码
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'db_coding'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'url_model'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'pathinfo_safe'</span><span class="token punctuation">;</span> //url模式,可选项<span class="token punctuation">(</span>pathinfo/pathinfo_safe/php<span class="token punctuation">)</span>
<span class="token variable">$pe</span><span class="token punctuation">[</span><span class="token string">'h5_host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> //手机版网址
define<span class="token punctuation">(</span><span class="token string">'dbpre'</span>,<span class="token string">'pe_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> //数据库表前缀
?<span class="token operator">&gt;</span>

<span class="token number">8</span>.浏览器访问测试
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p>拆分后的架构:</p> <p><img src="/devops/public/assets/img/1724048837758.303266c9.png" alt="1724048837758"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>麒麟重启所有网卡:
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#yum -y install network-scripts</span>

重启命令:
<span class="token punctuation">[</span>root@web01:she<span class="token punctuation">]</span><span class="token comment">#systemctl restart network.service</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_7-扩展web02"><a href="#_7-扩展web02" class="header-anchor">#</a> 7，扩展web02</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>配置两台web服务器：
  web01: <span class="token number">10.0</span>.0.7    <span class="token number">172.16</span>.1.7
  web02: <span class="token number">10.0</span>.0.8    <span class="token number">172.16</span>.1.8
  
<span class="token number">1</span>.克隆一台web02  

<span class="token number">2</span>.安装Nginx
<span class="token comment"># 配置nginx仓库</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#scp 172.16.1.7:/etc/yum.repos.d/nginx.repo /etc/yum.repos.d/</span>

<span class="token comment"># 安装Nginx服务</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#yum -y install nginx</span>

<span class="token number">3</span>.安装PHP
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#yum -y install php php-bcmath php-cli php-common php-devel php-embedded php-fpm php-gd php-intl php-mbstring php-mysqlnd php-opcache php-pdo   php-process php-xml php-json</span>

<span class="token number">4</span>.创建用户
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#groupadd -g666 www</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#useradd -u666 -g666 -M -s /sbin/nologin www</span>


<span class="token number">5</span>.同步Nginx和PHP的配置文件 web01有啥 web02也有啥。
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#rsync -avz --delete 172.16.1.7:/etc/nginx/ /etc/nginx/</span>
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful

同步PHP配置
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#scp 172.16.1.7:/etc/php-fpm.d/www.conf /etc/php-fpm.d/</span>

<span class="token number">6</span>.web01同步代码文件到web02
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#tar zcvf all.tar.gz /code</span>
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#scp all.tar.gz 172.16.1.8:/root/</span>

<span class="token number">7</span>.web02解压代码
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">108684</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">111291678</span> Aug  <span class="token number">8</span> <span class="token number">10</span>:09 all.tar.gz
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#tar xf all.tar.gz -C /</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#ll /code/</span>
total <span class="token number">16</span>
drwxr-xr-x  <span class="token number">7</span> www  www   <span class="token number">336</span> Aug  <span class="token number">7</span> <span class="token number">11</span>:45 she
drwxr-xr-x  <span class="token number">6</span> www  www  <span class="token number">4096</span> Aug  <span class="token number">7</span> <span class="token number">11</span>:41 wp
drwxr-xr-x <span class="token number">14</span> www  www  <span class="token number">4096</span> Aug  <span class="token number">7</span> 09:29 zh

<span class="token number">7</span>.检查配置并启动nginx和php服务
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#php-fpm -t</span>
<span class="token punctuation">[</span>08-Aug-2024 <span class="token number">10</span>:10:44<span class="token punctuation">]</span> NOTICE: configuration <span class="token function">file</span> /etc/php-fpm.conf <span class="token builtin class-name">test</span> is successful

<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#systemctl start nginx php-fpm</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable nginx php-fpm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>图示：</p> <p><img src="/devops/public/assets/img/1724225743063.bb8017fb.png" alt="1724225743063"></p> <p>总之，现在访问7，或8都可以访问到项目。</p> <h3 id="_8-配置nfs服务"><a href="#_8-配置nfs服务" class="header-anchor">#</a> 8，配置NFS服务</h3> <p><img src="/devops/public/assets/img/1724225814010.c709b5d6.png" alt="1724225814010"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>NFS服务
<span class="token number">1</span>.安装NFS服务
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nfs-utils

<span class="token number">2</span>.配置NFS服务
<span class="token function">vim</span> /etc/exports
/data/wp  <span class="token number">172.16</span>.1.0/24<span class="token punctuation">(</span>rw,sync,all_squash,anonuid<span class="token operator">=</span><span class="token number">666</span>,anongid<span class="token operator">=</span><span class="token number">666</span><span class="token punctuation">)</span>

<span class="token number">3</span>.创建必要的数据
<span class="token function">groupadd</span> <span class="token parameter variable">-g666</span> www
<span class="token function">useradd</span> <span class="token parameter variable">-u666</span> <span class="token parameter variable">-g666</span> <span class="token parameter variable">-M</span> <span class="token parameter variable">-s</span> /sbin/nologin www
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/wp
<span class="token function">chown</span> www.www /data/wp

<span class="token number">4</span>.启动NFS服务
systemctl start nfs
systemctl <span class="token builtin class-name">enable</span> nfs

配置挂载
<span class="token number">1</span>.将web上所有的图片推送到NFS
将最全的服务器上图片推送到NFS 目前web02最全
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#scp -r /code/wp/wp-content/uploads/2024/ 10.0.0.31:/data/wp/</span>
<span class="token punctuation">[</span>root@nfs:~<span class="token punctuation">]</span><span class="token comment">#chown -R www.www /data/wp/</span>

<span class="token number">2</span>.挂载nfs共享的目录到上传的目录
web01挂载:
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#showmount -e 172.16.1.31</span>
Export list <span class="token keyword">for</span> <span class="token number">172.16</span>.1.31:
/data/wp <span class="token number">172.16</span>.1.0/24

<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#mount -t nfs 172.16.1.31:/data/wp /code/wp/wp-content/uploads/</span>


WEB02挂载:
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#showmount -e 172.16.1.31</span>
Export list <span class="token keyword">for</span> <span class="token number">172.16</span>.1.31:
/data/wp <span class="token number">172.16</span>.1.0/24
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#mount -t nfs 172.16.1.31:/data/wp /code/wp/wp-content/uploads/</span>

默认访问博客项目：
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat wordpress.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span> default_server<span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>
        root /code/wp<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@web02-8:conf.d<span class="token punctuation">]</span><span class="token comment">#cat wordpress.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span>  default_server<span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>
        root /code/wp<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>浏览器测试：</p> <p><img src="/devops/public/assets/img/1724229902522.065c466c.png" alt="1724229902522"></p> <p><img src="/devops/public/assets/img/1724229920168.ae349a69.png" alt="1724229920168"></p> <p><img src="/devops/public/assets/img/1724230439101.1ab60472.png" alt="1724230439101"></p> <p><img src="/devops/public/assets/img/1724230459913.f10be0c0.png" alt="1724230459913"></p> <p><img src="/devops/public/assets/img/1724230714055.cf197625.png" alt="1724230714055"></p> <p><img src="/devops/public/assets/img/1724230701087.2c2637d7.png" alt="1724230701087"></p> <h3 id="_9-反向代理"><a href="#_9-反向代理" class="header-anchor">#</a> 9，反向代理</h3> <p>反向代理和正向代理：</p> <p><img src="/devops/public/assets/img/1724230924293.f96eb82a.png" alt="1724230924293"></p> <p>图示：</p> <p><img src="/devops/public/assets/img/1724231682537.14d33e94.png" alt="1724231682537"></p> <p>使用nginx配置反向代理：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.克隆一台LB01 <span class="token number">10.0</span>.0.5   <span class="token number">172.16</span>.1.5

<span class="token number">2</span>.安装Nginx
<span class="token punctuation">[</span>root@lb01-5:~<span class="token punctuation">]</span><span class="token comment">#scp 10.0.0.7:/etc/yum.repos.d/nginx.repo /etc/yum.repos.d/</span>
<span class="token punctuation">[</span>root@lb01-5:~<span class="token punctuation">]</span><span class="token comment">#yum -y install nginx</span>

<span class="token number">3</span>.配置Nginx 为反向代理
<span class="token punctuation">[</span>root@lb01-5:~<span class="token punctuation">]</span><span class="token comment">#cd /etc/nginx/conf.d/</span>
<span class="token punctuation">[</span>root@lb01-5:conf.d<span class="token punctuation">]</span><span class="token comment">#rm -rf default.conf</span>
<span class="token punctuation">[</span>root@lb01-5:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.wp.com<span class="token punctuation">;</span>
    
    location / <span class="token punctuation">{</span>
       proxy_pass http://172.16.1.7<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">4</span>.启动Nginx
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@lb01-5:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl start nginx</span>
<span class="token punctuation">[</span>root@lb01-5:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl enable nginx</span>

<span class="token number">5</span>.修改hosts解析到10.0.0.5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><img src="/devops/public/assets/img/1724231988610.217ef23d.png" alt="1724231988610"></p> <p>测试：</p> <p><img src="/devops/public/assets/img/1724234203296.e9a0b07f.png" alt="1724234203296"></p> <p>现在访问wp.com，它是先访问代理服务器，代理服务器，帮我们访问了7服务器，关键是7服务器上面有三套用业务，如下：</p> <p><img src="/devops/public/assets/img/1724549731600.a2f85a08.png" alt="1724549731600"></p> <p>原因是你配置了默认业务：</p> <p><img src="/devops/public/assets/img/1724549763475.7e1cff31.png" alt="1724549763475"></p> <p>如果没有配置呢？</p> <p><img src="/devops/public/assets/img/1724549806144.26c8ad97.png" alt="1724549806144"></p> <p>重启：</p> <p><img src="/devops/public/assets/img/1724549859667.25006a8c.png" alt="1724549859667"></p> <p>测试发现，访问的是商城业务：</p> <p><img src="/devops/public/assets/img/1724549874898.6dee8d87.png" alt="1724549874898"></p> <h3 id="_10-反向代理配置优化"><a href="#_10-反向代理配置优化" class="header-anchor">#</a> 10，反向代理配置优化</h3> <p><img src="/devops/public/assets/img/1724549991014.3236888c.png" alt="1724549991014"></p> <p>代理两个业务配置:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.wp.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    proxy_pass http://172.16.1.7<span class="token punctuation">;</span>
    proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>  <span class="token comment"># 携带头部信息  不能丢弃</span>
    proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>  <span class="token comment"># 携带版本  不能丢弃</span>
    proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span> <span class="token comment"># 不要记录代理的IP，携带真实的IP，不能丢弃，必须要配置</span>
    <span class="token comment"># nginx代理与后端服务器连接超时时间(代理连接超时)</span>
    proxy_connect_timeout <span class="token number">30</span><span class="token punctuation">;</span> <span class="token comment"># 道路不通 网络不通</span>
    <span class="token comment"># 后端服务器数据回传给nginx代理超时时间</span>
    proxy_send_timeout <span class="token number">60</span><span class="token punctuation">;</span> <span class="token comment"># 响应了请求，去拿水了</span>
    <span class="token comment"># nginx代理等待后端服务器的响应时间</span>
    proxy_read_timeout <span class="token number">60</span><span class="token punctuation">;</span> <span class="token comment"># 老板太忙了，老板响应时间，无响应，繁忙</span>

    <span class="token comment"># nginx会把后端返回的内容先放到缓冲区当中，然后再返回给客户端，边收边传，不是全部接收完再传给客户端</span>
    proxy_buffering on<span class="token punctuation">;</span>
    proxy_buffer_size 32k<span class="token punctuation">;</span> <span class="token comment"># 头部缓冲区</span>
    proxy_buffers <span class="token number">4</span> 128k<span class="token punctuation">;</span> <span class="token comment"># 内容主体缓冲区</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.zh.com<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
        proxy_pass http://10.0.0.7<span class="token punctuation">;</span>
        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        proxy_connect_timeout <span class="token number">30</span><span class="token punctuation">;</span>
        proxy_send_timeout <span class="token number">60</span><span class="token punctuation">;</span>
        proxy_read_timeout <span class="token number">60</span><span class="token punctuation">;</span>

        proxy_buffering on<span class="token punctuation">;</span>
        proxy_buffer_size 32k<span class="token punctuation">;</span>
        proxy_buffers <span class="token number">4</span> 128k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>把优化的配置抽离出去：</p> <p><img src="/devops/public/assets/img/1724551216677.a4372c19.png" alt="1724551216677"></p> <p>引入：</p> <p><img src="/devops/public/assets/img/1724551280422.71c25da6.png" alt="1724551280422"></p> <p>测试：</p> <p><img src="/devops/public/assets/img/1724551342640.18c26350.png" alt="1724551342640"></p> <p>总结，第1种搭建方案：</p> <p><img src="/devops/public/assets/img/1724508955267.737955bd.png" alt="1724508955267"></p> <p>第2种搭建方案：</p> <p><img src="/devops/public/assets/img/1724508996574.fa26531d.png" alt="1724508996574"></p> <p>大家在做上面的案例时，可能会遇到的问题：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.rsync同步注意目录加/和不加/的区别

<span class="token number">2</span>.安装wordpress过程中禁止使用IP安装,解析成域名安装
比如安装过程 <span class="token number">10.0</span>.0.7---<span class="token operator">&gt;</span>填写数据库信息---<span class="token operator">&gt;</span>写入数据库中
如果安装完成后再使用www.wp.com访问，不能访问页面乱码的问题。

<span class="token number">3</span>.挂载wordpress挂载uploads目录 在往下一级以时间命名
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#df -h</span>
Filesystem             Size  Used Avail Use% Mounted on
devtmpfs               459M     <span class="token number">0</span>  459M   <span class="token number">0</span>% /dev
tmpfs                  475M     <span class="token number">0</span>  475M   <span class="token number">0</span>% /dev/shm
tmpfs                  475M   31M  444M   <span class="token number">7</span>% /run
tmpfs                  475M     <span class="token number">0</span>  475M   <span class="token number">0</span>% /sys/fs/cgroup
/dev/mapper/klas-root   47G  <span class="token number">4</span>.5G   43G  <span class="token number">10</span>% /
tmpfs                  475M     <span class="token number">0</span>  475M   <span class="token number">0</span>% /tmp
/dev/sda1             1014M  169M  846M  <span class="token number">17</span>% /boot
<span class="token number">172.16</span>.1.31:/data/wp    47G  <span class="token number">3</span>.8G   44G   <span class="token number">8</span>% /code/wp/wp-content/uploads

<span class="token number">4</span>.访问域名的时候,浏览器默认将访问的http://www.wp.com ---修改成https://www.wp.com

<span class="token number">5</span>.排查缓存问题直接使用curl命令
在web服务器做hosts解析
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat /etc/hosts</span>
<span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="token number">10.0</span>.0.7  www.wp.com

<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#curl www.wp.com</span>


<span class="token number">6</span>.导出数据库vim检查过滤一下 有没有数据信息

<span class="token number">7</span>.会话的问题，目录权限问题
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment"># ll /var/lib/php/session/ -d</span>
drwxrwx--- <span class="token number">2</span> www www <span class="token number">279</span> Aug  <span class="token number">9</span> 08:45 /var/lib/php/session/

分享搭建过程中的一些错误。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_11-负载均衡介绍"><a href="#_11-负载均衡介绍" class="header-anchor">#</a> 11，负载均衡介绍</h3> <p>负载均衡是基于反向代理。</p> <p>为什么要使用负载均衡</p> <ul><li>当我们的<strong>Web</strong>服务器直接面向用户，往往要承载大量并发请求，单台服务器难以负荷，我使用多台<strong>Web</strong>服务器组成集群，前端使用<code>Nginx</code>负载均衡，将请求分散的打到我们的后端服务器集群中，实现负载的分发。那么会大大提升系统的吞吐率、请求性能、高容灾.</li> <li>往往我们接触的最多的是<code>SLB(Server Load Balance)</code>负载均衡，实现最多的也是<code>SLB</code>、那么<code>SLB</code>它的调度节点和服务节点通常是在一个地域里面。那么它在这个小的逻辑地域里面决定了他对部分服务的实时性、响应性是非常好的。</li> <li>所以说当海量用户请求过来以后，它同样是请求调度节点，调度节点将用户的请求转发给后端对应的服务节点，服务节点处理完请求后在转发给调度节点，调度节点最后响应给用户节点。这样也能实现一个均衡的作用，那么<strong>Nginx</strong>则是一个典型的<code>SLB</code></li></ul> <p><img src="/devops/public/assets/img/1724509969108.47280ad6.png" alt="1724509969108"></p> <p>负载均衡的叫法有很多：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>负载均衡
负载
Load Balance
LB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>公有云中叫法:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>SLB 阿里云负载均衡
QLB 青云负载均衡
CLB 腾讯云负载均衡
ULB ucloud负载均衡
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>常见的负载均衡的软件:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Nginx
Haproxy
LVS
F5<span class="token punctuation">(</span>硬件的<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>负载均衡能实现的应用场景一: 四层负载均衡</p> <ul><li>所谓四层负载均衡指的是<code>OSI</code>七层模型中的传输层，那么传输层<strong>Nginx</strong>已经能支持<strong>TCP/IP</strong>的控制，所以只需要对客户端的请求进行<strong>TCP/IP</strong>协议的包转发就可以实现负载均衡，那么它的好处是性能非常快、只需要底层进行应用处理，而不需要进行一些复杂的逻辑。</li></ul> <p><img src="/devops/public/assets/img/1724510199764.6fa9e756.png" alt="1724510199764"></p> <p>负载均衡能实现的应用场景二:七层负载均衡</p> <ul><li>七层负载均衡它是在应用层，那么它可以完成很多应用方面的协议请求，比如我们说的<strong>http</strong>应用的负载均衡，它可以实现<strong>http</strong>信息的改写、头信息的改写、安全应用规则控制、<strong>URL</strong>匹配规则控制、以及转发、<strong>rewrite</strong>等等的规则，所以在应用层的服务里面，我们可以做的内容就更多，那么<strong>Nginx</strong>则是一个典型的七层负载均衡<code>SLB</code></li></ul> <p><img src="/devops/public/assets/img/1724510229925.eff2bdb2.png" alt="1724510229925"></p> <p>四层负载均衡与七层负载均衡区别:</p> <ul><li>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。</li> <li>但七层负载均衡更贴近于服务，如:<strong>http</strong>协议就是七层协议，我们可以用<strong>Nginx</strong>可以作会话保持，<strong>URL</strong>路径规则匹配、<strong>head</strong>头改写等等，这些是四层负载均衡无法实现的。</li> <li><strong>注意：四层负载均衡不识别域名，七层负载均衡识别域名</strong></li></ul> <p>Nginx要实现负载均衡需要用到<code>proxy_pass</code>代理模块配置</p> <ul><li>Nginx负载均衡与<strong>Nginx</strong>代理不同地方在于，<strong>Nginx</strong>的一个<code>location</code>仅能代理一台服务器，而<strong>Nginx</strong>负载均衡则是将客户端请求代理转发至一组<strong>upstream</strong>虚拟服务池.</li></ul> <p><img src="/devops/public/assets/img/1724510315724.d23b7ade.png" alt="1724510315724"></p> <p>负载均衡配置：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>WEB01--<span class="token operator">&gt;</span>静态页面 www.lb.com 显示内容 web01<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
WEB02--<span class="token operator">&gt;</span>静态页面  www.lb.com 显示内容 web02<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
lb01---<span class="token operator">&gt;</span>负载均衡 转发到后端两台web服务器

WEB01配置静态页面
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat web01.conf</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    root /code<span class="token punctuation">;</span>
    index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#echo web01........... &gt; /code/index.html</span>

测试语法并重启nginx
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
systemnginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

hosts解析
<span class="token number">10.0</span>.0.7  www.lb.com

浏览器测试访问
www.lb.com
浏览器测试是否显示web01<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

WEB02配置静态页面
a<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#cat web02.conf</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    root /code<span class="token punctuation">;</span>
    index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#echo web02...... &gt; /code/index.html</span>

测试语法并重启
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

hosts解析
<span class="token number">10.0</span>.0.8 www.lb.com

浏览器测试是否显示web02<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>



负载均衡配置:
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    proxy_pass http://webs<span class="token punctuation">;</span>
    include proxy_params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

看web01的配置：
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat web01.conf </span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    root /code<span class="token punctuation">;</span>
    index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

看web02的配置：
<span class="token punctuation">[</span>root@web02-8:conf.d<span class="token punctuation">]</span><span class="token comment">#cat web02.conf </span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    root /code<span class="token punctuation">;</span>
    index index.html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

把博客的defalut_server也取消了：
<span class="token punctuation">[</span>root@web02-8:conf.d<span class="token punctuation">]</span><span class="token comment">#cat wordpress.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>
        root /code/wp<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat wordpress.conf </span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>
        root /code/wp<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


语法检测并重启服务
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

修改hosts指向到10.0.0.5
<span class="token number">10.0</span>.0.5 www.lb.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br></div></div><p>测试：
<img src="/devops/public/assets/img/1724556870349.4f16d416.png" alt="1724556870349"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@lb01-5:nginx<span class="token punctuation">]</span><span class="token comment">#cat proxy_params </span>
 proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
 proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
 proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
 proxy_connect_timeout <span class="token number">30</span><span class="token punctuation">;</span>
 proxy_send_timeout <span class="token number">60</span><span class="token punctuation">;</span>
 proxy_read_timeout <span class="token number">60</span><span class="token punctuation">;</span>

 proxy_buffering on<span class="token punctuation">;</span>
 proxy_buffer_size 32k<span class="token punctuation">;</span>
 proxy_buffers <span class="token number">4</span> 128k<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_12-之前的三个业务业务实现负载均衡"><a href="#_12-之前的三个业务业务实现负载均衡" class="header-anchor">#</a> 12，之前的三个业务业务实现负载均衡</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>配置wordpress和zh phpshe业务实现负载均衡

<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    proxy_pass http://webs<span class="token punctuation">;</span>
    include proxy_params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
        proxy_pass http://webs<span class="token punctuation">;</span>
        include proxy_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#vim proxy.conf </span>
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>配置Host解析：</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAzAAAACTCAYAAABRaPzGAAAap0lEQVR4nO3dsY6q2tvH8d95cxKqcxckE2MyDZ1XYDIFdtNNQmdns2M5xZTmNHZ2JNNNp8UkXIEdzSTGTMJd/Cuq8xYLFBEUFHVwvp9kiu0WWMISeVjPs/grjuP/BAAAAAAt8H+3bgAAAAAAVEUAAwAAAKA1CGAAAAAAtAYBDAAAAIDWIIABAAAA0BoEMAAAAABagwAGAAAAQGsQwAAAAABoDQIYAAAAAK1BAAMAAACgNQhgAAAAALQGAQwAAACA1iCAAQAAANAaBDAAAAAAWoMABgAAAEBrEMAAAAAAaI3GA5hgaKk3jdJ/yLKGCqotKMuyNKz05isoaE807f2sNuLnuGD/Tfvd5nt1A0224Ud/j4qO46WO7YXPeXWPWZ3jcpE+GU3VsyxZRX+HGpVZ7tDbgqEly+ppv8mRpr0a29ts9obfywN9x3xO6+bnDAC4pIYDmEBzX3p8sCVJ0feX5HRkN7uRX838OFUMCtEqHFtcw0/vZ85kpTiOd/4WcitdkPtuzc8VTdWzuho/Lna2t+q8nXzxf8v9Gwwtub6jycp8juWIX18A9+nvRtcWfetLjp6Tc2a0DqXHVwKYxkT6/rp1G3AZ5cfWHi0Vj67bmp/YBtRTfMyaOYdcuz/0Z7HiP1P1ul1Z64XiWX/vPY7nSb4vdzgo/P99kaYvY4XORKvc++3RUssjS19y/54m2bbzrCd+dAHcuWZHYKK1Qj3KDMCYk6nT4UwKADiTPdL7xJF8tzhVrPNHr54k/60gTaxIpHXYbBMBANfRQACTyR92fUm+XMuSZXU1DqVw3D07Fzeb02v+Dg/Pp7nJpfnMSf5w9q9uHnq+TWXL12l7vt379Tdmn2738eH9ms1pr9TeCvulyjpP3TeV+sgm9zvT73pTRTtvOb7eQ/v6UBvrpIaU5twnOftpu44e24r57ofaV7sv7G/oYH+46PeooX55bNunnKOqruPUbRX3obTv518PNMye73LHrM455Og+PFIjeFIfq8AevcqT5M+LV9ifLeQp1Phl95xQsjZ1HEnhhz5P+Xk6Yf+eet451l92th2O1bXK6n0A4D40EMDYGi2TPGUvk7+8msiRp0V8Ti6u+UF2/e164niliePLPVCM2R1rkwMcx7HiwXz7QxFN1ZsPdvOrPcl3q5/sfdfSW2eVaY95bffHqF7bg2G+3St15tsfYXu03GxLNfer71qaD+Jce3NtqLlfdte5MBcVrvmx3d83xRda7tdEq3R7C88EuxWvdL7eXvTxnGxnOUrSFKut99i+3mlj5b53utOO7Wntq9QXKqq2H8tV+h6d1S/LPp85T2RrBeI41uu6q95b1fyfqn34vG31B56kUB/ZK+zoUx+hJIVa73yHv/Wl8lHvqv2s2vmtXJN9rOBTmKDDn5fcSOhrtvCkcKyXoxu09fTsSAo17p7fvmP7t9Z5p+a5cWfbTrrsUpTAALhXDaaQmZSxtIBf0VrhmQX8wdCVL0eT1UzbDGVbo2XxXbZo+qJxKHmL3Im7P9MmxdkeaZnLd+7/mchRqPG/FX+hvUXmR9/W6H0i85uavUiu03Yz+YG810y7bY1mo2bqh7zF9vNv2pv7vHX3y846+/pjfrUlZ6L3vX2zewFm9o2nxTLz+fozLWqkf4R6zmynznqr7eu6fe/aTm5flb5QrQXn99kK36Pz+mXx5ys7T/RnsV4fq+UUVe3DZ2+rP5AnKcxGKtFaoRw5zu6+ij4/FMrR87kFEFWOy5Hlm+ljRWw9PB55S3IcwvG/R0dL7dFSq0kaxOyP5janznnnvHMjAPwGjQYw69BRevMvMNORnXEBXnTCT/Vlbkxmh/4jfX6EkjPRnyr1m5vFpup1x6qTCu0NchuwH/QoSV/fyY9f3bYnSu8qnqe0vYcc2S/5ddrJVYXz/FR4zLcXYOm+GSh/mGyTz7F7V7nE/nZqrvfgvj7x+F3N6e07qS8cckafPf49KlCzX+5/vsPnCTPicUzVvtbEtpLjmdnPwdyXnGe9Pjs7r0frsJEC7pOOS5Xlr8ikkvlyKwwbmdELM4qcpl9dbPrhSued886NAPAbnB3AbHN6XfnpXSzLkimHcWvXDWxXfCQdouPk3p+kVRwNmpI88fSvZvBSSd22p2kRSd701ebu37kgudB+yV+8JPtm2ze2f91x9S1uRvpqr7fCvq59/K7sEu2reHGa2cqV+mxD/XLz+ZLC7XNurlTuaw1sS+nx9GUGQMxFrvP8pP7Do6QvfUe7r//YrKHafaxIOtPWsdH9ZFS4rOC/4P2zJF1LMrWbzfbp6uedc8+NAPAbnB3AmLtXsRmG3+TemrtZ3iLN9Z3t3VG6jUjTnitfkpTNSU/uvt1MmvpjNDHxQT032C/e7nMXsn+VZkA9eb233tf34hr78ad+XxOX6sM59tOzHElf39F2qvonO0kvS9Izk4vfvcD+3lS+USXZo/ek/qbGDbT+LKnfrJaCVl2N78uV+hUAtFljKWTmmS/Jj0r0rS95ymcS1JLcuQ9Lxswjc2tTm9/rSuknyY+ft7hsgWPdtkva3AGMsz9yL9fJeb7WfpFqp6NcZr1H9vVJx++Kfkz7LtxnL9kvS/pJVOUhHnX78DnbkiT7Sc+OFH58Kvj8ULhJEzPpZZvXzz3ntkBa5zOplCec1t/4eqvTKe2RmY65cdXOO42fGwHgDjUUwJhh/U3ucwMF/Nvc76LCxaJc4TNqE4J5cpe3KXXbvrvsLB3RunXOc+P7RbpcDckp6y3b1+ccv62yvHVzEXaOZtrXnCv32bP65aF+ktSsnLWOprclbWbLCteaZ28UKelj6etXPeY3EAzVHYdyJu/Vg9nk2THh+EVzVU2tvPTDKI+cd25aXwcA7dBYAJMt4I/MdGRn52Jv5vTvZlMA0rQST4v87ESb9+emxAyGJg86uZO5U0gZTdVzL3CZXqvtgYa5RG1zFz1/RzWd9jPNh2/IFfeLlJlFqptL7QiGladRPn291fZ13b5XJE398d8yMxtFU70U5rPXO7ZNtO88VfvsGS7UL8v3XVcfFS9yq/bhJrYlpZNk+PL93SJ508fM69UeGnyhc8hFJc+9cX15i/pT8ptUslC+n//emfqq/WcKpTPHnZL6XLZ/K553Gj83lj0zCADaraEApq9ZJsXDHi0VN3IB1dds82yLtKCxq7EmWhXW1Zg7WwtvO5mAZVmy5oNc/UNmfd21Xi+SU1+n7X3NBvOdok3zHID9z7jN6z794Xv7rrlfZKbGjXPbS47TWf2m0nqr7uu6fa+kPauJnM2D5SxZL9J7kmO///Y6x7aB9p2lep893aX6ZV+zvX7S1fo11vK14nxZlftwA9uSNtMp7wWIaZBXY/rky5xDmpPWh1jZfv24OKMGxNaoMCfMfIc6b/mCefOsllNPRcX7t+L35VLnRgC4M3/FcfzfrRsBAAAAAFU0+BwYAAAAALgsAhgAAAAArUEAAwAAAKA1CGAAAAAAtAYBDAAAAIDWIIABAAAA0BoEMAAAAABagwAGAAAAQGsQwAAAAABojcYDmGBoqTeN0n/IsoYKmt7ImaJpr7Rd5v+s3b9h5p3BcP//9/6Of+a97fSmimq1/7Rld9fx847NjmRfD39KIwvakx6LH9NGAACAO9dwABNo7kuPD7YkKfr+kpyO7GY3crL0YrM7DovfEAzVHUuTVaw4Tv5WEzm+uw0S+rPt/+X/VhM5kpzJH/UPtCMYWrntLOSFY3UrBCLnLFtpH6B1gmG1oBkAAOAeNBvARN/6kqNOErFE61B6fLh9ABNN1bMsvehdcbzSxCl5n/1Hq3ipUbbB9kjvE0cKx/r3yBVi8O9YoTy9jg584mAo15e8RXY7fc0WnhSO9TI9EIacs2zVfYCWifT9des2AAAAXE/DAcxaoR5lBmDMhZXTuXn4ItkjLeNYy0OBhSTZdmGwZT89y5H09V0luJgdHn2Z+5I8DfJv6g/kSQo/PktHUs5ZtvI+AAAAAH6wBgKYSNNeUovh+pJ8uZYly+pqHErhuCvLytTFtFG01uGEq0jTN19yJvpzKHpJ75YXptXZ6jiSwnVJEHLOsvfHpE1VrzvaqxvKF60U1DbVrWvJt6ls+Tptz7d7v/7GfM+237uWf9cAAACOaCCAsTVamnqMhSc5k1WmHsTTIqkPafOdfzPysa3t2X/DvxqHkvc6OpIuF2kdqiStztbDoyR9qXig55xl70mgoWXJ9bd9y6TE+XKtnvav3U2AvVfbNJhvg4Foqt58sFPPtPAk3y1aXzHftfTWWWXaY17bDWLqtX2/3mmlznxb62SPlpl0wPv4rgEAABzTYAqZGSHYXORHa4U/qID/VNG0J9fXgdGVqqMvSmqETm3IGcvekWDoypejySqbqmdrtFzIU6jxy+5kBtH0xQSXi1xtU3+mWboCe6TlbPfg9f9M5CjU+FjhU8pbZAIHW6N3M6GDP98uX6/tZkIMea+ZdtsazY4FyQAAAPet0QBmHW4L+AMzHVmrL7bMHfBQkqfFsuTCMRl9cZ6fWv1Z26Hooj7V18AUAulzEwVE+vwIqwWXWdFUve74SNrgLi9fmGQ/yAyKfSdBSd22J/w5s4sBAABknB3AbHP0XfkKNe6aPHxTDuNWfi7Kj5LM2JWOvKzi8sL8tLD+4MxjqfSi9qB0EoQGl70XyShU2cQQdic3tVr0qY/StLssk9q1qTWpGbxUUrftaV1TUttCXQsAAIBxdgBj8vBjrSZOcrGfPJtEkrdIc/cPz8z1owTDzQWsM1kpLht5kaRoqjdfkjeo9/k2d+V3VlZtOtxzlkWBSNOeK1Pl5Ow+X+em7UpTy4y7mAwDAACgAY2lkO088yX61lfRdL8/XTRVzwy7aLI6XgwdfX4oVEH6UKk0VahotrCkSL80GDpn2TuRjEKF65J52swsB9tRqL00rqKFklEab6E4/wygJtVtuySpr1kumArHL5UnFgAAALhHDQUwZgRgcyHf0gJ+8yDKgoLvQkl9Rc1ArT/wJPma53PqgrnMYE75ys5Z9j4kQZz/VnARn9aYZIO4A7UlxyT7tDl127677Cwd5VSokhgIAADgV2gsgMkW8EdmOrKWBTDpc1aqFnwnox6lgVr6fJzc9Lj9P8kUu9m6oEBD8xTMZGasCyx7J/qzZMaubnYfpGlgnhb52cQ278/tj2Bopji2n/Rspgvbrm8zEnfLtgca5h4kY0Zp8gGzrSfzAfYDWwAAgDv0dzOr6WsWZyaGHS0VN7PiK0oCEo3VtcYl7/G0SOt50qLs2rOPmefmPAwtudb2ItmZrBQfHfY5Z9l70dcsXqnT6+7sA1N/VVSvZEYvBkNLbtfS5sh6C8UzKa01WVtuZn2eFvFCc8ttfBSmetv7mg2Gsiz3yPske/SuyUdXY9eSmXdixbNgAADA3forjuP/bt0IAAAAAKiiwefAAAAAAMBlEcAAAAAAaA0CGAAAAACtQQADAAAAoDUIYIAr++eff27dBAAAgNYigAEAAADQGgQwAAAAAFqDAAYAAABAaxDAAAAAAGiNxgOYYGipN43Sf8iyhgqa3siVRNNeq9t/UcFQlmVp+FN2TkF7zPH7QW0EAADA2RoOYALNfenxwZYkRd9fktOR3exGLi698O2Ow1s3BS0XDC2CYAAAgAY1G8BE3/qSo04SsUTrUHp8aE8AE03Vsyy96F1xvNLEuXWD0G6Rvr9u3QYAAID70nAAs1aoR5kBGHPx5nRaE75I9kjLONZy1KI2AwAAAL9IAwFMpGnPkmVZslxfki/XsmRZXY1DKRx3ZVmZupirCzS08mk8Ra+hKSZtKvt3eD+nKXubv3zRSlLfkv2rW9eSb1PZ8nXanm/3fv2N+Q5svxO3/B4AAADchwYCGFujZaw4jrXwJGeyUhzHilcTOfK0iM3/MarxG5jA0PW3x92k4vlyrZ72r91N8NsdS5NV+v5Y8WC+DQaiqXrzwfb/kn7mu0XrK+a7lt46q0x7zGu7QUy9tgfDfLtX6synSt9mj5aZNES+BwAAAE1pMIXMpIylBfyK1gp/RAF/X7M4VhzP1D/4Gs4VDF35cjRZZferrdFyIU+hxi/bC3xJiqYvGoeSt1hq57q+P9MsXYE90nK2e5T6fyZyFGr8b8VhGG+RCRxsjd4nciT588yYXK22m8kq5L1m2m1rNBv9gP4OAABw3xoNYNbhtoA/MNORcUH3axRd1Kf6GniSwg99bqKASJ8foeRM9KdOFBlN1euOVWd+OG+Q24D9oEdJ+vpOgpK6bU/4c1IQAQAAruzsAGZbB+DKV6hx1+T6m3IYt1INBO5A9K0vlU/aYHdyU7pFn/oIVSHITeuVkr+awUslddsuW+YlU9tCXQsAAMD1nB3AmFz/WKuJIzkTreJYcbyQJ8lbpPUBpGrhFJGmPVe+JMnJ1JuY/nU7aWqZcfuJKgAAAH6PxlLIdp75En3rS57ymTu4Y0laVrguvoiP1qG0mWJbBWlcRQslozTeQnG8LEjvakjdtkva1lFlA5mXyhMLAAAA4DQNBTCmgH9Ta/BjCvhxPUmtiP9WcBGf1pgMdiZSKK0tOSaYJ6MyTanb9t1lZ+kIpEKVxEAAAABoSGMBTLaAPzLTkf2QAIbnwFxLf5bM2NXN7tc0DczTIj+b2Ob9uWmKg6GZ4th+0rOZLmy7vmiqntts+FK/7YGGuQfJmFGa/KijrSfzATSnowEAADTi72ZW09cszkw+O1oqbmbFaJW+ZvFKnV5XrpUJMpyJVnHRFMNm9GIwtOR2LY3Tl72F4pmU1pqsLTezPk+LeKG55TY+ClO97X3NBkNZlnvkfZI9etfko6uxa8mXeU4SAAAATvdXHMf/3boRwG/yzz//6H//+9+tmwEAANBKDT4HBgAAAAAuiwAGAAAAQGsQwAAAAABoDQIYAAAAAK1BET8AAACA1mAEBgAAAEBrEMAAAAAAaA0CGAAAAACtQQADAAAAoDUIYAAAAAC0BgEMAAAAgNYggAEAAADQGgQwAAAAAFqDAAYAAABAaxDAAAAAAGgNAhgAAAAArUEAAwAAAKA1CGAAAAAAtAYBDAAAAIDWIIABAAAA0BoEMAAAAABagwAGAAAAQGsQwAAAAABoDQIYAAAAAK1BAAMAAACgNQhgAAAAALQGAQwAAACA1iCAAQAAANAaBDAAAAAAWoMABgAAAEBrEMAAAAAAaA0CGAAAAACtQQADAAAAoDUuEsBE054sa6jg4P9b27/eVFGtdV932WBo7S63+Sv/jHcpGMqyLA2D/dd606pHAQAAADhdowFMGiB0x2Hpe4Khpe5YmqxixXGsOF7IC8fqVggmbrWsJMmZaBWny6Z/M/WrLAsAAACgEc0EMNFUPcvSi94VxytNnJL3BUO5vuQtlhrZ6Yt9zRaeFI71cugu/q2WVaTvrwP/DQAAAOBqmglg7JGWcazlNjooFMx9SZ4G+WGL/kCepPDjs3Q05FbLAgAAAPg5rljEn4xkOB3thzm2Oo6kcF0SSNxqWbP8OpT0+FCwfD2mlqan3QGfSNNe0euBhpYlaxhcfbkzPuBZNUJ7NUoFbdmvRyreRrquYbC/TLrastfrfeT2HtOz1pWtffqFxx0AANzOVQOY8kDA1sOjJH3puzCSuNWyzeoPPEmhPj4zG4s+9RFKUqh1tg3Rt0zcZV99uVOE466st06mTmghT77cvQvhIuaiebdGKVY8mGcuLs0FtOt7Wmy2sdLEObwN37U0H2TbZF6zLEtvnVVmPZLvVmnrrjYf0ybW9VuPOwAAuJ3rBTDJBVCrls0u77s7d21PmnUrTVnLXhlGa4Vy5DiSP9/eCo4+PxTK0fOTff3lTuFMtFqOMkFiX7PVRI5Cjf89fIs7mr5oHOZrlCT1Z5olaX/B0JUvR5NVduIEW6PlQp5CjV9KJmPwFpt1SH39SQu0nIneNxuzNXo3bd25mK+izce0iXX91uMOAABuhufAHJPU92RnH1tNHHPnucYUzkZfA0+SP9+kvwRzX3Ke9frs7LwerUPJeZa5Xrz2cvU5z0/7I1z2k56d3e3vi/T5EUrORH9Kp3QLZMqYXrVfZpV8xvBDRdegXq7wyTZDbsXtVe5ivpI2H9Pz13XwuH99H0zNbPdxBwAAt3K9AMZ+0OPRNz3qoejq4lbLlrBHS60mToUZzAqW7TiSfJmb2+YCzXl+Uv/hUdtUtu3r9o2Wq+uxeOcnKXoHpClLh2qMjqRCmc94pkr9pGTRFh/Tc9d18Lgfqi27g+MOAABu4/ojMIV3ZStOVXyrZQvYT88y9f81A5hkua/vKLlAy6YGJaksyYVb9uLw2ss143dMQd3mY3qZ/vE7jjsAALiNKwYwacpH0V3ZpNDeG5Q8GPJWyx5Xu+g9Sa8JPz4VfH4ozKUGbV7PT/t87eVq+iqcBSHZv4UzwKXtS+6AH0o3St5TFixGZpaGWqNojWrzMT1zXb/6uAMAgJu46giMmfUoTVfJCObytZ+3/hOWLWOKmk8ZtbD19OxI4VrzdbiTQmN3Mq/vBVXXXq6ewmfpJPv3cBrT4VqGnff4bwWzRaV1Eue1/zxtPqbnret3H3cAAHAL100h6/9Jpi3NPsMh0ND1M7MGlTyH4lbLBsO951JE0566ZvqkzExH1ZmCYl++vxs8mXQe83rRyM71lit7FsgB4Vjd7H6Kpuq5fm7Wp+L19mfJjFLd/X2frnL7nuwxjDTtufLlaXHKgWhQm4/pqW2Q9OuPOwAAuL4r18DYGi1jLTxf7mZKYldfk5Xioxcit1pWe1Mob55bcerFUzJ9rUpSg1Q29e21l6vBmay0UGY/dccKvYXinSl2y/Q1i2MtvFDjbuYhg/PBzlS4s83zP9L3dDXWRKt4dvu78G0+pmes69cfdwAAcHV/xXH8360bAaBlgqEs15czWWm5P8cxAADAxfAcGAAAAACtQQADAAAAoDUIYAAAAAC0BjUwAAAAAFqDERgAAAAArUEAAwAAAKA1CGAAAAAAtAYBDAAAAIDWIIABAAAA0BoEMAAAAABagwAGAAAAQGsQwAAAAABoDQIYAAAAAK1BAAMAAACgNQhgAAAAALQGAQwAAACA1iCAAQAAANAaBDAAAAAAWoMABgAAAEBr/D+h8NDPWDwzogAAAABJRU5ErkJggg==" alt="1724556985907"></p> <p>测试，大家使用postman测试，只会发一个请求。</p> <p><img src="/devops/public/assets/img/1724557743509.5c3955cf.png" alt="1724557743509"></p> <h3 id="_13-负载均衡问题"><a href="#_13-负载均衡问题" class="header-anchor">#</a> 13，负载均衡问题</h3> <p>负载均衡问题</p> <ul><li>默认Nginx负载机制，如果后端Nginx服务挂掉则不会继续访问。如果后端是php或者数据库服务挂掉，还是会继续访问后端服务器，会导致用户访问的时候，数据库无法进行响应，导致用户体验不好。增加一个配置,除Nginx以外的服务挂掉,自动访问下一个web服务器</li></ul> <p>把其中一台的nginx停止了：</p> <p><img src="/devops/public/assets/img/1724557877984.143b541c.png" alt="1724557877984"></p> <p>再去访问wp.com，此时只会走web02，把web01的nginx关了，后面只有web02提供服务了：</p> <p><img src="/devops/public/assets/img/1724557966071.67c172f0.png" alt="1724557966071"></p> <p>先把web01的nginx开启，如果是php服务或数据库服务挂了：</p> <p><img src="/devops/public/assets/img/1724558052272.938544cd.png" alt="1724558052272"></p> <p>测试：</p> <p><img src="/devops/public/assets/img/1724559319673.d4829d06.png" alt="1724559319673"></p> <p><img src="/devops/public/assets/img/1724559329503.7d3e2d1e.png" alt="1724559329503"></p> <p>配置：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.lb.com<span class="token punctuation">;</span>

    location / <span class="token punctuation">{</span>
    proxy_pass http://webs<span class="token punctuation">;</span>
    include proxy_params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.wp.com<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
        proxy_pass http://webs<span class="token punctuation">;</span>
        include proxy_params<span class="token punctuation">;</span>
        proxy_next_upstream error <span class="token function">timeout</span> http_500 http_502 http_503 http_504<span class="token punctuation">;</span>      <span class="token comment"># 如果用户访问的页面出现 500 502 503 504错误则自动访问下一个服务器。</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>配置后，再次测试：</p> <p><img src="/devops/public/assets/img/1724559412354.40ad0b49.png" alt="1724559412354"></p> <h3 id="_14-负载均衡调度算法"><a href="#_14-负载均衡调度算法" class="header-anchor">#</a> 14，负载均衡调度算法</h3> <p>Nginx负载均衡调度算法</p> <table><thead><tr><th><strong>调度算法</strong></th> <th><strong>概述</strong></th></tr></thead> <tbody><tr><td>轮询</td> <td>按时间顺序逐一分配到不同的后端服务器(默认)</td></tr> <tr><td>weight</td> <td>加权轮询,weight值越大,分配到的访问几率越高</td></tr> <tr><td>ip_hash</td> <td>每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器</td></tr> <tr><td>url_hash</td> <td>按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器</td></tr> <tr><td>least_conn</td> <td>最少链接数,那个机器链接数少就分发</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.如何实现的负载均衡
<span class="token number">2</span>.负载均衡的调度算法
    rr轮训      默认的
    weight     加权轮循
    ip_hash    ip哈希
    url_hash   url哈希
    least_conn 最少链接数


rr轮询配置方式
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


加权轮询配置方式:
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>   <span class="token comment"># 配置每次多处理5次请求</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

配置ip哈希: 如果客户端都走相同代理, 会导致某一台服务器连接过多。具体配置不能和weight一起使用。
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
    ip_hash<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

面试题: 以上三种算法的区别
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_15-后端服务器状态"><a href="#_15-后端服务器状态" class="header-anchor">#</a> 15，后端服务器状态</h3> <p>Nginx后端服务器状态：</p> <table><thead><tr><th><strong>状态</strong></th> <th><strong>概述</strong></th></tr></thead> <tbody><tr><td>down</td> <td>当前的server暂时不参与负载均衡</td></tr> <tr><td>backup</td> <td>预留的备份服务器</td></tr> <tr><td>max_fails</td> <td>允许请求失败的次数（了解）</td></tr> <tr><td>fail_timeout</td> <td>经过max_fails失败后, 服务暂停时间（了解）</td></tr> <tr><td>max_conns</td> <td>限制最大的接收连接数（了解）</td></tr></tbody></table> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>upstream webs <span class="token punctuation">{</span>
        <span class="token comment"># down相当于加上注释</span>
        <span class="token comment"># server 10.0.0.30 down; # 不参与负载的调度 一般用于停机维护</span>
        server <span class="token number">10.0</span>.0.20<span class="token punctuation">;</span>
        server <span class="token number">10.0</span>.0.10<span class="token punctuation">;</span>
        server <span class="token number">10.0</span>.0.9<span class="token punctuation">;</span>
        server <span class="token number">10.0</span>.0.8 backup<span class="token punctuation">;</span> <span class="token comment"># 类似备胎 其他服务器都挂掉后，10.0.0.8才进入负载的调度</span>
        server <span class="token number">10.0</span>.0.8 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_16-负载均衡健康检查-nginx的编译安装"><a href="#_16-负载均衡健康检查-nginx的编译安装" class="header-anchor">#</a> 16，负载均衡健康检查（Nginx的编译安装）</h3> <p>Nginx负载均衡健康检查（了解）</p> <ul><li>在Nginx官方模块提供的模块中，没有对负载均衡后端节点的健康检查模块，但可以使用第三方模块。
<code>nginx_upstream_check_module</code>来检测后端服务的健康状态。</li></ul> <p>下面的配置只看一下就行了：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@lb01 conf.d<span class="token punctuation">]</span><span class="token comment"># cat proxy_web.conf</span>
upstream web <span class="token punctuation">{</span>
    server <span class="token number">172.16</span>.1.7:80 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
    server <span class="token number">172.16</span>.1.8:80 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
    check <span class="token assign-left variable">interval</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token assign-left variable">rise</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fall</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token assign-left variable">type</span><span class="token operator">=</span>tcp<span class="token punctuation">;</span>
    <span class="token comment">#interval  检测间隔时间，单位为毫秒</span>
    <span class="token comment">#rise      表示请求2次正常，标记此后端的状态为up</span>
    <span class="token comment">#fall      表示请求3次失败，标记此后端的状态为down</span>
    <span class="token comment">#type      类型为tcp</span>
    <span class="token comment">#timeout   超时时间，单位为毫秒</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.zh.com<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
        proxy_pass http://web<span class="token punctuation">;</span>
        include proxy_params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location /upstream_check <span class="token punctuation">{</span>
        check_status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># nginx -V 会发现没有check这个模块</span>
<span class="token punctuation">[</span>root@lb01-5:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -V</span>
nginx version: nginx/1.26.1
built by gcc <span class="token number">4.8</span>.5 <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span>.5-44<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> 
built with OpenSSL <span class="token number">1.0</span>.2k-fips  <span class="token number">26</span> Jan <span class="token number">2017</span> <span class="token punctuation">(</span>running with OpenSSL <span class="token number">1.0</span>.2o-fips  <span class="token number">27</span> Mar <span class="token number">2018</span><span class="token punctuation">)</span>
TLS SNI support enabled
configure arguments: <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/etc/nginx --sbin-path<span class="token operator">=</span>/usr/sbin/nginx --modules-path<span class="token operator">=</span>/usr/lib64/nginx/modules --conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf --error-log-path<span class="token operator">=</span>/var/log/nginx/error.log --http-log-path<span class="token operator">=</span>/var/log/nginx/access.log --pid-path<span class="token operator">=</span>/var/run/nginx.pid --lock-path<span class="token operator">=</span>/var/run/nginx.lock --http-client-body-temp-path<span class="token operator">=</span>/var/cache/nginx/client_temp --http-proxy-temp-path<span class="token operator">=</span>/var/cache/nginx/proxy_temp --http-fastcgi-temp-path<span class="token operator">=</span>/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path<span class="token operator">=</span>/var/cache/nginx/uwsgi_temp --http-scgi-temp-path<span class="token operator">=</span>/var/cache/nginx/scgi_temp <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt<span class="token operator">=</span><span class="token string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC'</span> --with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-z,relro -Wl,-z,now -pie'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>什么情况使用编译安装:
特点: 自定义安装位置
     自定义模块（nginx_upstream_check_module）

编译安装步骤:
<span class="token number">1</span>.安装依赖
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel patch</span>

<span class="token number">2</span>.下载nginx源码包<span class="token punctuation">(</span>下载是和我们当前使用的对应的版本<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#nginx -v                  (之前使用yum安装的)</span>
nginx version: nginx/1.26.1

<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#wget http://nginx.org/download/nginx-1.26.1.tar.gz</span>

解压代码:
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#tar xf nginx-1.26.1.tar.gz </span>
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#ll</span>
total <span class="token number">1216</span>
drwxr-xr-x <span class="token number">8</span>  <span class="token number">502</span> games     <span class="token number">158</span> May <span class="token number">29</span> <span class="token number">22</span>:30 nginx-1.26.1



<span class="token number">3</span>.下载第三方健康状态检查模块
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip</span>
解压代码
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#unzip master.zip</span>
total <span class="token number">1396</span>
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">177080</span> Aug  <span class="token number">9</span> <span class="token number">11</span>:19 master.zip
drwxr-xr-x <span class="token number">8</span>  <span class="token number">502</span> games     <span class="token number">158</span> May <span class="token number">29</span> <span class="token number">22</span>:30 nginx-1.26.1
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1244738</span> May <span class="token number">29</span> <span class="token number">22</span>:30 nginx-1.26.1.tar.gz
drwxr-xr-x <span class="token number">6</span> root root     <span class="token number">4096</span> Nov  <span class="token number">6</span>  <span class="token number">2022</span> nginx_upstream_check_module-master


<span class="token number">4</span>.打补丁
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#cd nginx-1.26.1/</span>
<span class="token punctuation">[</span>root@lb01:nginx-1.26.1<span class="token punctuation">]</span><span class="token comment">#patch -p1 &lt;../nginx_upstream_check_module-master/check_1.20.1+.patch</span>

<span class="token number">4</span>.重新配置nginx
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#cd nginx-1.26.1/</span>
./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/etc/nginx --sbin-path<span class="token operator">=</span>/usr/sbin/nginx --modules-path<span class="token operator">=</span>/usr/lib64/nginx/modules --conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf --error-log-path<span class="token operator">=</span>/var/log/nginx/error.log --http-log-path<span class="token operator">=</span>/var/log/nginx/access.log --pid-path<span class="token operator">=</span>/var/run/nginx.pid --lock-path<span class="token operator">=</span>/var/run/nginx.lock --http-client-body-temp-path<span class="token operator">=</span>/var/cache/nginx/client_temp --http-proxy-temp-path<span class="token operator">=</span>/var/cache/nginx/proxy_temp --http-fastcgi-temp-path<span class="token operator">=</span>/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path<span class="token operator">=</span>/var/cache/nginx/uwsgi_temp --http-scgi-temp-path<span class="token operator">=</span>/var/cache/nginx/scgi_temp <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --add-module<span class="token operator">=</span>/root/nginx_upstream_check_module-master --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt<span class="token operator">=</span><span class="token string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC'</span> --with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-z,relro -Wl,-z,now -pie'</span>

<span class="token number">5</span>.编译并安装
<span class="token punctuation">[</span>root@lb01:nginx-1.26.1<span class="token punctuation">]</span><span class="token comment">#make &amp;&amp; make install</span>

查看编译后的结果:
<span class="token punctuation">[</span>root@lb01:~<span class="token punctuation">]</span><span class="token comment">#nginx -V</span>
nginx version: nginx/1.26.1
built by gcc <span class="token number">7.3</span>.0 <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> 
built with OpenSSL <span class="token number">1.1</span>.1f  <span class="token number">31</span> Mar <span class="token number">2020</span>
TLS SNI support enabled
configure arguments: <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/etc/nginx --sbin-path<span class="token operator">=</span>/usr/sbin/nginx --modules-path<span class="token operator">=</span>/usr/lib64/nginx/modules --conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf --error-log-path<span class="token operator">=</span>/var/log/nginx/error.log --http-log-path<span class="token operator">=</span>/var/log/nginx/access.log --pid-path<span class="token operator">=</span>/var/run/nginx.pid --lock-path<span class="token operator">=</span>/var/run/nginx.lock --http-client-body-temp-path<span class="token operator">=</span>/var/cache/nginx/client_temp --http-proxy-temp-path<span class="token operator">=</span>/var/cache/nginx/proxy_temp --http-fastcgi-temp-path<span class="token operator">=</span>/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path<span class="token operator">=</span>/var/cache/nginx/uwsgi_temp --http-scgi-temp-path<span class="token operator">=</span>/var/cache/nginx/scgi_temp <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --add-module<span class="token operator">=</span>/root/nginx_upstream_check_module-master --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt<span class="token operator">=</span><span class="token string">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC'</span> --with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-z,relro -Wl,-z,now -pie'</span>



<span class="token number">6</span>.使用模块
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat up.conf </span>
upstream web <span class="token punctuation">{</span>
    server <span class="token number">10.0</span>.0.7 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
    server <span class="token number">10.0</span>.0.8 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>
    check <span class="token assign-left variable">interval</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token assign-left variable">rise</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">fall</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">timeout</span><span class="token operator">=</span><span class="token number">1000</span> <span class="token assign-left variable">type</span><span class="token operator">=</span>tcp<span class="token punctuation">;</span>
    <span class="token comment">#interval  检测间隔时间，单位为毫秒</span>
    <span class="token comment">#rise      表示请求2次正常，标记此后端的状态为up</span>
    <span class="token comment">#fall      表示请求3次失败，标记此后端的状态为down</span>
    <span class="token comment">#type      类型为tcp</span>
    <span class="token comment">#timeout   超时时间，单位为毫秒</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name www.zh.com<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
        proxy_pass http://web<span class="token punctuation">;</span>
        include proxy_params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location /upstream_check <span class="token punctuation">{</span>
        check_status<span class="token punctuation">;</span>               <span class="token comment"># 使用的新增加的模块</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
检查语法并重启
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
重启Nginx服务
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>
浏览器访问测试:
<span class="token number">10.0</span>.0.5 www.zh.com

浏览器访问：www.zh.com/upstream_check
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1724569887285.bd880efd.png" alt="1724569887285"></p> <h3 id="_17-负载均衡会话保持"><a href="#_17-负载均衡会话保持" class="header-anchor">#</a> 17，负载均衡会话保持</h3> <p>负载均衡会话保持:</p> <ul><li>phpmyadmin业务通过页面管理数据库，phpmyadmin业务会将会话保存到自己本地磁盘。</li></ul> <p>在解决负载均衡绘画问题，我们需要了解<code>session</code>和<code>cookie</code>的区别。</p> <ul><li>浏览器端存的是<code>cookie</code>每次浏览器发请求到服务端时，报文头是会自动添加<code>cookie</code>信息的。</li> <li>服务端会查询用户的<code>cookie</code>作为key去存储里找对应的value(session)</li> <li>同意域名下的网站的<code>cookie</code>都是一样的，所以无论几台服务器，无论请求分配到哪一台服务器上同一用户的<code>cookie</code>是不变的。也就是说<code>cookie</code>对应的<code>session</code>也是唯一的。所以，这里只要保证多台业务服务器访问同一个共享存储服务器（NFS，MySQL，memcache，redis，file）就行了。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>phpmyadmin业务通过页面管理数据库，phpmyadmin业务会将会话保存到自己本地磁盘。
<span class="token number">1</span>.web01部署phpmyadmin业务
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat admin.conf</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.admin.com<span class="token punctuation">;</span>
        root /code/admin<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

语法测试并重启
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>


部署代码
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#mkdir /code/admin</span>
<span class="token punctuation">[</span>root@web01:conf.d<span class="token punctuation">]</span><span class="token comment">#cd /code/admin</span>

<span class="token punctuation">[</span>root@web01:admin<span class="token punctuation">]</span><span class="token comment"># wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip</span>

解压代码:
<span class="token punctuation">[</span>root@web01:admin<span class="token punctuation">]</span><span class="token comment">#unzip phpMyAdmin-4.8.4-all-languages.zip</span>
<span class="token punctuation">[</span>root@web01:admin<span class="token punctuation">]</span><span class="token comment">#mv phpMyAdmin-4.8.4-all-languages/* .</span>

配置代码连接数据库IP地址
<span class="token punctuation">[</span>root@web01:admin<span class="token punctuation">]</span><span class="token comment">#cp config.sample.inc.php config.inc.php</span>
<span class="token punctuation">[</span>root@web01:admin<span class="token punctuation">]</span><span class="token comment">#grep -n 172 config.inc.php</span>
<span class="token number">31</span>:<span class="token variable">$cfg</span><span class="token punctuation">[</span><span class="token string">'Servers'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'172.16.1.51'</span><span class="token punctuation">;</span>

hosts解析
<span class="token number">10.0</span>.0.7 www.admin.com
测试web01访问www.admin.com



查看session
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>测试web01上面的admin项目：</p> <p><img src="/devops/public/assets/img/1724570937116.a274d82f.png" alt="1724570937116"></p> <p><img src="/devops/public/assets/img/1724570980668.0c216037.png" alt="1724570980668"></p> <p><img src="/devops/public/assets/img/1724571036986.96f37c34.png" alt="1724571036986"></p> <p><img src="/devops/public/assets/img/1724571077996.876adebe.png" alt="1724571077996"></p> <p>尝试把session_id删除：</p> <p><img src="/devops/public/assets/img/1724571116696.c2664dba.png" alt="1724571116696"></p> <p><img src="/devops/public/assets/img/1724571155222.e46f1864.png" alt="1724571155222"></p> <p><img src="/devops/public/assets/img/1724571238459.63a84730.png" alt="1724571238459"></p> <p>查看session:</p> <p><img src="/devops/public/assets/img/1724571535509.79e8fa6c.png" alt="1724571535509"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">2</span>.web02部署phpmyadmin业务
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#cat admin.conf</span>
server <span class="token punctuation">{</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name www.admin.com<span class="token punctuation">;</span>
        root /code/admin<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                index index.php index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location ~ <span class="token punctuation">\</span>.php$ <span class="token punctuation">{</span>
                fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
                fastcgi_param SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
		include fastcgi_params<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

将web01的代码目录拷贝到web02
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#scp -r 172.16.1.7:/code/admin /code/</span>

语法测试并重启
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@web02:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#chown -R www.www /var/lib/php/session</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#ll -d /var/lib/php/session</span>
drwxrwx--- <span class="token number">2</span> www www <span class="token number">6</span> Feb <span class="token number">23</span> <span class="token number">16</span>:03 /var/lib/php/session



修改hosts
<span class="token number">10.0</span>.0.8 www.admin.com

浏览器访问登录 www.admin.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1724571631410.8418a197.png" alt="1724571631410"></p> <p><img src="/devops/public/assets/img/1724571640413.fbaa44a1.png" alt="1724571640413"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">3</span>.phpmyadmin接入负载均衡
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#cat proxy.conf </span>
upstream webs <span class="token punctuation">{</span>
	server <span class="token number">10.0</span>.0.7<span class="token punctuation">;</span>
	server <span class="token number">10.0</span>.0.8<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
	listen <span class="token number">80</span><span class="token punctuation">;</span>
	server_name www.admin.com<span class="token punctuation">;</span>

	location / <span class="token punctuation">{</span>
	proxy_pass http://webs<span class="token punctuation">;</span>
	include proxy_params<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

语法测试并重启
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#nginx -t</span>
nginx: the configuration <span class="token function">file</span> /etc/nginx/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /etc/nginx/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>root@lb01:conf.d<span class="token punctuation">]</span><span class="token comment">#systemctl restart nginx</span>

修改hosts指向负载
<span class="token number">10.0</span>.0.5  www.admin.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1724571806366.0dc7819c.png" alt="1724571806366"></p> <p><img src="/devops/public/assets/img/1724571843007.d460156d.png" alt="1724571843007"></p> <p>使用redis存储web01和web02的会话信息，相当共享会话，把会话信息存储到redis中。前面三个业务是存储到了mysql中。现在的存储到redis。在真实开发，通常我们也是把会话信息存储到redis中。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">4</span>.安装部署redis服务
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#yum -y install redis</span>
修改redis监听 增加172.16.1.51
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#grep 172.16.1.51 /etc/redis.conf -n</span>
<span class="token number">69</span>:bind <span class="token number">127.0</span>.0.1 <span class="token number">172.16</span>.1.51

启动redis
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#systemctl start redis</span>
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#systemctl enable redis</span>

检查服务端口
<span class="token punctuation">[</span>root@db01:~<span class="token punctuation">]</span><span class="token comment">#netstat -tnulp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">172.16</span>.1.51:6379        <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">13968</span>/redis-server  
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:6379          <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">13968</span>/redis-server  
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:22              <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">824</span>/sshd: /usr/sbin 
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3306                 :::*                    LISTEN      <span class="token number">4058</span>/mysqld   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">5</span>.修改php配置将会话写入redis服务
web01修改:
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#vim /etc/php.ini</span>
<span class="token number">1222</span> session.save_handler <span class="token operator">=</span> redis
<span class="token number">1255</span> session.save_path <span class="token operator">=</span> <span class="token string">&quot;tcp://172.16.1.51:6379&quot;</span>

PHP安装redis插件
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc glibc gcc-c++ pcre-devel openssl-devel patch
第一步: 下载redis源码包
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment"># wget http://pecl.php.net/get/redis-4.0.1.tgz</span>
第二步： 解压代码
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment"># tar xf redis-4.0.1.tgz </span>
第三步： 配置
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#cd redis-4.0.1/</span>
<span class="token punctuation">[</span>root@web01:redis-4.0.1<span class="token punctuation">]</span><span class="token comment"># phpize</span>
<span class="token punctuation">[</span>root@web01:redis-4.0.1<span class="token punctuation">]</span><span class="token comment">#./configure</span>
第四步： 编译安装
<span class="token punctuation">[</span>root@web01:redis-4.0.1<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
第五步： 开启redis插件功能，配置文件增加以下一行内容
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#grep redis.so /etc/php.ini  -n</span>
<span class="token number">1357</span>:extension<span class="token operator">=</span>redis.so
第六步： 重启服务
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl restart php-fpm</span>


将/etc/php-fpm.d/www.conf中以下两行内内容注释 前面加上<span class="token punctuation">;</span>
<span class="token number">431</span> <span class="token punctuation">;</span>php_value<span class="token punctuation">[</span>session.save_handler<span class="token punctuation">]</span> <span class="token operator">=</span> files
<span class="token number">432</span> <span class="token punctuation">;</span>php_value<span class="token punctuation">[</span>session.save_path<span class="token punctuation">]</span>    <span class="token operator">=</span> /var/lib/php/session

完成后重启php-fpm
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl restart php-fpm</span>

WEB02修改:
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#rsync -avz --delete 172.16.1.7:/etc/php.ini /etc/php.ini</span>
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#rsync -avz --delete 172.16.1.7:/etc/php-fpm.d/www.conf  /etc/php-fpm.d/www.conf</span>
重启php-fpm
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#systemctl restart php-fpm</span>

PHP安装redis插件
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc glibc gcc-c++ pcre-devel openssl-devel patch
第一步: 下载redis源码包
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment"># wget http://pecl.php.net/get/redis-4.0.1.tgz</span>
第二步： 解压代码
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment"># tar xf redis-4.0.1.tgz </span>
第三步： 配置
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#cd redis-4.0.1/</span>
<span class="token punctuation">[</span>root@web02:redis-4.0.1<span class="token punctuation">]</span><span class="token comment"># phpize</span>
<span class="token punctuation">[</span>root@web02:redis-4.0.1<span class="token punctuation">]</span><span class="token comment">#./configure</span>
第四步： 编译安装
<span class="token punctuation">[</span>root@web02:redis-4.0.1<span class="token punctuation">]</span><span class="token comment"># make &amp;&amp; make install</span>
第五步： 开启redis插件功能，配置文件增加以下一行内容
<span class="token punctuation">[</span>root@web02:~<span class="token punctuation">]</span><span class="token comment">#grep redis.so /etc/php.ini  -n</span>
<span class="token number">1357</span>:extension<span class="token operator">=</span>redis.so
第六步： 重启服务
<span class="token punctuation">[</span>root@web01:~<span class="token punctuation">]</span><span class="token comment">#systemctl restart php-fpm</span>

hosts解析
<span class="token number">10.0</span>.0.5 www.admin.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>测试：</p> <p><img src="/devops/public/assets/img/1724573561158.a6127c15.png" alt="1724573561158"></p> <p><img src="/devops/public/assets/img/1724573656058.98463fba.png" alt="1724573656058"></p> <p>使用一个软件连接到redis上, redis-cli 就可以连接上去:</p> <p><img src="/devops/public/assets/img/1724574015507.d1e56905.png" alt="1724574015507"></p> <p>面试题: 说一下如何实现的负载均衡</p> <p><img src="/devops/public/assets/img/1724510315724.d23b7ade.png" alt="1724510315724"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.使用的proxy_pass模块
2.通过proxy_pass模块转发给upstream模块定义的地址池
3.使用的是默认的rr轮训算法分发到后端的服务器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/26/2024, 9:15:52 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_1-lnmp搭建" class="sidebar-link reco-side-_1-lnmp搭建" data-v-b57cc07c>1，LNMP搭建</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_2-配置nginx连接php服务" class="sidebar-link reco-side-_2-配置nginx连接php服务" data-v-b57cc07c>2，配置Nginx连接PHP服务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_3-部署wordpress" class="sidebar-link reco-side-_3-部署wordpress" data-v-b57cc07c>3，部署wordpress</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_4-部署论坛业务" class="sidebar-link reco-side-_4-部署论坛业务" data-v-b57cc07c>4，部署论坛业务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_5-部署phpshe服务" class="sidebar-link reco-side-_5-部署phpshe服务" data-v-b57cc07c>5，部署phpshe服务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_6-拆分数据库" class="sidebar-link reco-side-_6-拆分数据库" data-v-b57cc07c>6，拆分数据库</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_7-扩展web02" class="sidebar-link reco-side-_7-扩展web02" data-v-b57cc07c>7，扩展web02</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_8-配置nfs服务" class="sidebar-link reco-side-_8-配置nfs服务" data-v-b57cc07c>8，配置NFS服务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_9-反向代理" class="sidebar-link reco-side-_9-反向代理" data-v-b57cc07c>9，反向代理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_10-反向代理配置优化" class="sidebar-link reco-side-_10-反向代理配置优化" data-v-b57cc07c>10，反向代理配置优化</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_11-负载均衡介绍" class="sidebar-link reco-side-_11-负载均衡介绍" data-v-b57cc07c>11，负载均衡介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_12-之前的三个业务业务实现负载均衡" class="sidebar-link reco-side-_12-之前的三个业务业务实现负载均衡" data-v-b57cc07c>12，之前的三个业务业务实现负载均衡</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_13-负载均衡问题" class="sidebar-link reco-side-_13-负载均衡问题" data-v-b57cc07c>13，负载均衡问题</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_14-负载均衡调度算法" class="sidebar-link reco-side-_14-负载均衡调度算法" data-v-b57cc07c>14，负载均衡调度算法</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_15-后端服务器状态" class="sidebar-link reco-side-_15-后端服务器状态" data-v-b57cc07c>15，后端服务器状态</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_16-负载均衡健康检查-nginx的编译安装" class="sidebar-link reco-side-_16-负载均衡健康检查-nginx的编译安装" data-v-b57cc07c>16，负载均衡健康检查（Nginx的编译安装）</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/20-lnmp%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/lnmp.html#_17-负载均衡会话保持" class="sidebar-link reco-side-_17-负载均衡会话保持" data-v-b57cc07c>17，负载均衡会话保持</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/devops/public/assets/js/app.09327a95.js" defer></script><script src="/devops/public/assets/js/109.5517edbe.js" defer></script><script src="/devops/public/assets/js/1.774fca24.js" defer></script><script src="/devops/public/assets/js/68.04dc8347.js" defer></script>
  </body>
</html>
