<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>44-mysql | devops</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/devops/public/favicon.ico">
    <meta name="description" content="快来玩devops">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/devops/public/assets/css/0.styles.4a69f283.css" as="style"><link rel="preload" href="/devops/public/assets/js/app.28103306.js" as="script"><link rel="preload" href="/devops/public/assets/js/113.27412706.js" as="script"><link rel="preload" href="/devops/public/assets/js/1.774fca24.js" as="script"><link rel="preload" href="/devops/public/assets/js/91.3ba21402.js" as="script"><link rel="prefetch" href="/devops/public/assets/js/10.2355f1cd.js"><link rel="prefetch" href="/devops/public/assets/js/100.f6ad0e9e.js"><link rel="prefetch" href="/devops/public/assets/js/101.696507e5.js"><link rel="prefetch" href="/devops/public/assets/js/102.b067b5e3.js"><link rel="prefetch" href="/devops/public/assets/js/103.f22a09d5.js"><link rel="prefetch" href="/devops/public/assets/js/104.9de19c42.js"><link rel="prefetch" href="/devops/public/assets/js/105.33ffcab9.js"><link rel="prefetch" href="/devops/public/assets/js/106.49d07509.js"><link rel="prefetch" href="/devops/public/assets/js/107.460cd233.js"><link rel="prefetch" href="/devops/public/assets/js/108.c99be344.js"><link rel="prefetch" href="/devops/public/assets/js/109.00c119c5.js"><link rel="prefetch" href="/devops/public/assets/js/11.49eaa678.js"><link rel="prefetch" href="/devops/public/assets/js/110.d421651e.js"><link rel="prefetch" href="/devops/public/assets/js/111.f6c7ca5a.js"><link rel="prefetch" href="/devops/public/assets/js/112.8393443a.js"><link rel="prefetch" href="/devops/public/assets/js/114.a275d4cd.js"><link rel="prefetch" href="/devops/public/assets/js/115.d817c533.js"><link rel="prefetch" href="/devops/public/assets/js/116.e22157b8.js"><link rel="prefetch" href="/devops/public/assets/js/117.23109c42.js"><link rel="prefetch" href="/devops/public/assets/js/118.51a3bcc9.js"><link rel="prefetch" href="/devops/public/assets/js/119.46ee73e9.js"><link rel="prefetch" href="/devops/public/assets/js/12.14ab8645.js"><link rel="prefetch" href="/devops/public/assets/js/120.32d72bca.js"><link rel="prefetch" href="/devops/public/assets/js/121.7a2ae156.js"><link rel="prefetch" href="/devops/public/assets/js/122.7f1313de.js"><link rel="prefetch" href="/devops/public/assets/js/123.ea1da4b9.js"><link rel="prefetch" href="/devops/public/assets/js/124.94b5d60e.js"><link rel="prefetch" href="/devops/public/assets/js/125.d541725c.js"><link rel="prefetch" href="/devops/public/assets/js/126.8c67bb8b.js"><link rel="prefetch" href="/devops/public/assets/js/127.6ad0a226.js"><link rel="prefetch" href="/devops/public/assets/js/128.af28bf34.js"><link rel="prefetch" href="/devops/public/assets/js/129.24f46b00.js"><link rel="prefetch" href="/devops/public/assets/js/13.ea00228f.js"><link rel="prefetch" href="/devops/public/assets/js/130.f3603eed.js"><link rel="prefetch" href="/devops/public/assets/js/131.2acc4a62.js"><link rel="prefetch" href="/devops/public/assets/js/132.e83c37e0.js"><link rel="prefetch" href="/devops/public/assets/js/133.e846519a.js"><link rel="prefetch" href="/devops/public/assets/js/134.72f0cd52.js"><link rel="prefetch" href="/devops/public/assets/js/135.cc9bc693.js"><link rel="prefetch" href="/devops/public/assets/js/136.3486f2c1.js"><link rel="prefetch" href="/devops/public/assets/js/137.1967d170.js"><link rel="prefetch" href="/devops/public/assets/js/138.2c0f075b.js"><link rel="prefetch" href="/devops/public/assets/js/139.df9ef210.js"><link rel="prefetch" href="/devops/public/assets/js/14.d1af91f2.js"><link rel="prefetch" href="/devops/public/assets/js/140.43cb38b1.js"><link rel="prefetch" href="/devops/public/assets/js/141.389976c7.js"><link rel="prefetch" href="/devops/public/assets/js/142.c701d474.js"><link rel="prefetch" href="/devops/public/assets/js/143.1f89bcd4.js"><link rel="prefetch" href="/devops/public/assets/js/144.2403d734.js"><link rel="prefetch" href="/devops/public/assets/js/145.9ca6a379.js"><link rel="prefetch" href="/devops/public/assets/js/146.4d96a855.js"><link rel="prefetch" href="/devops/public/assets/js/147.96e83382.js"><link rel="prefetch" href="/devops/public/assets/js/148.725e9e0f.js"><link rel="prefetch" href="/devops/public/assets/js/149.ea7e7ea0.js"><link rel="prefetch" href="/devops/public/assets/js/15.9cd50001.js"><link rel="prefetch" href="/devops/public/assets/js/150.44cb5023.js"><link rel="prefetch" href="/devops/public/assets/js/151.162ba89e.js"><link rel="prefetch" href="/devops/public/assets/js/152.253ffdc6.js"><link rel="prefetch" href="/devops/public/assets/js/153.95e5600c.js"><link rel="prefetch" href="/devops/public/assets/js/154.e843df76.js"><link rel="prefetch" href="/devops/public/assets/js/155.017651a0.js"><link rel="prefetch" href="/devops/public/assets/js/156.bc5f1afa.js"><link rel="prefetch" href="/devops/public/assets/js/157.62750ef9.js"><link rel="prefetch" href="/devops/public/assets/js/158.12816d9c.js"><link rel="prefetch" href="/devops/public/assets/js/159.f65aefd6.js"><link rel="prefetch" href="/devops/public/assets/js/16.83cc8599.js"><link rel="prefetch" href="/devops/public/assets/js/160.9e3b870f.js"><link rel="prefetch" href="/devops/public/assets/js/161.2ffb8829.js"><link rel="prefetch" href="/devops/public/assets/js/162.fc902af3.js"><link rel="prefetch" href="/devops/public/assets/js/163.1ce261a1.js"><link rel="prefetch" href="/devops/public/assets/js/164.cadd6c0c.js"><link rel="prefetch" href="/devops/public/assets/js/165.2fe27746.js"><link rel="prefetch" href="/devops/public/assets/js/166.ed3f8d80.js"><link rel="prefetch" href="/devops/public/assets/js/167.bbf5336a.js"><link rel="prefetch" href="/devops/public/assets/js/168.5d3efa55.js"><link rel="prefetch" href="/devops/public/assets/js/169.46ed82e1.js"><link rel="prefetch" href="/devops/public/assets/js/17.8fd55213.js"><link rel="prefetch" href="/devops/public/assets/js/170.1a4a0c1c.js"><link rel="prefetch" href="/devops/public/assets/js/171.a57bf822.js"><link rel="prefetch" href="/devops/public/assets/js/172.633217bd.js"><link rel="prefetch" href="/devops/public/assets/js/173.74d13a35.js"><link rel="prefetch" href="/devops/public/assets/js/174.b5151bd8.js"><link rel="prefetch" href="/devops/public/assets/js/175.5949328a.js"><link rel="prefetch" href="/devops/public/assets/js/176.8303daa5.js"><link rel="prefetch" href="/devops/public/assets/js/177.5326bd43.js"><link rel="prefetch" href="/devops/public/assets/js/178.dbcd16c1.js"><link rel="prefetch" href="/devops/public/assets/js/179.9faebe0a.js"><link rel="prefetch" href="/devops/public/assets/js/18.f7755189.js"><link rel="prefetch" href="/devops/public/assets/js/180.b7a0d0b5.js"><link rel="prefetch" href="/devops/public/assets/js/181.260afac6.js"><link rel="prefetch" href="/devops/public/assets/js/182.1e595cd4.js"><link rel="prefetch" href="/devops/public/assets/js/183.45cdd476.js"><link rel="prefetch" href="/devops/public/assets/js/184.865dc281.js"><link rel="prefetch" href="/devops/public/assets/js/185.98829410.js"><link rel="prefetch" href="/devops/public/assets/js/186.51261003.js"><link rel="prefetch" href="/devops/public/assets/js/187.a4404287.js"><link rel="prefetch" href="/devops/public/assets/js/188.37b0a7c9.js"><link rel="prefetch" href="/devops/public/assets/js/189.4382a87a.js"><link rel="prefetch" href="/devops/public/assets/js/19.c220b742.js"><link rel="prefetch" href="/devops/public/assets/js/190.1925bc24.js"><link rel="prefetch" href="/devops/public/assets/js/191.8a1eb7e8.js"><link rel="prefetch" href="/devops/public/assets/js/192.36d8fb17.js"><link rel="prefetch" href="/devops/public/assets/js/193.a98e0b8b.js"><link rel="prefetch" href="/devops/public/assets/js/194.b2f3bf84.js"><link rel="prefetch" href="/devops/public/assets/js/195.12b566f1.js"><link rel="prefetch" href="/devops/public/assets/js/196.32ac678b.js"><link rel="prefetch" href="/devops/public/assets/js/197.c70372ce.js"><link rel="prefetch" href="/devops/public/assets/js/198.3586e37a.js"><link rel="prefetch" href="/devops/public/assets/js/199.df982d34.js"><link rel="prefetch" href="/devops/public/assets/js/20.7c8e3974.js"><link rel="prefetch" href="/devops/public/assets/js/200.7bff5ecf.js"><link rel="prefetch" href="/devops/public/assets/js/201.a8731abd.js"><link rel="prefetch" href="/devops/public/assets/js/202.be8d4c67.js"><link rel="prefetch" href="/devops/public/assets/js/203.ed1472c6.js"><link rel="prefetch" href="/devops/public/assets/js/204.83a209a0.js"><link rel="prefetch" href="/devops/public/assets/js/205.6bc65ce5.js"><link rel="prefetch" href="/devops/public/assets/js/206.d42a440a.js"><link rel="prefetch" href="/devops/public/assets/js/207.5682e689.js"><link rel="prefetch" href="/devops/public/assets/js/208.70ce056c.js"><link rel="prefetch" href="/devops/public/assets/js/209.b4c5fab9.js"><link rel="prefetch" href="/devops/public/assets/js/21.b3f26af0.js"><link rel="prefetch" href="/devops/public/assets/js/210.38087e85.js"><link rel="prefetch" href="/devops/public/assets/js/211.072c21ab.js"><link rel="prefetch" href="/devops/public/assets/js/212.2691eba4.js"><link rel="prefetch" href="/devops/public/assets/js/213.89f4c1a6.js"><link rel="prefetch" href="/devops/public/assets/js/214.4492965c.js"><link rel="prefetch" href="/devops/public/assets/js/215.51bee7ff.js"><link rel="prefetch" href="/devops/public/assets/js/216.06470828.js"><link rel="prefetch" href="/devops/public/assets/js/217.97da850c.js"><link rel="prefetch" href="/devops/public/assets/js/218.8226ce81.js"><link rel="prefetch" href="/devops/public/assets/js/219.a3d3a8b7.js"><link rel="prefetch" href="/devops/public/assets/js/22.8eb1c9a5.js"><link rel="prefetch" href="/devops/public/assets/js/220.5c213c5e.js"><link rel="prefetch" href="/devops/public/assets/js/221.e27b300a.js"><link rel="prefetch" href="/devops/public/assets/js/222.f2770cd1.js"><link rel="prefetch" href="/devops/public/assets/js/223.a4d46cb3.js"><link rel="prefetch" href="/devops/public/assets/js/224.297a3dae.js"><link rel="prefetch" href="/devops/public/assets/js/225.3979b123.js"><link rel="prefetch" href="/devops/public/assets/js/226.d96c6a5c.js"><link rel="prefetch" href="/devops/public/assets/js/227.9b79ae08.js"><link rel="prefetch" href="/devops/public/assets/js/228.6a349a94.js"><link rel="prefetch" href="/devops/public/assets/js/229.de0ac89d.js"><link rel="prefetch" href="/devops/public/assets/js/23.d515c36e.js"><link rel="prefetch" href="/devops/public/assets/js/230.a295e140.js"><link rel="prefetch" href="/devops/public/assets/js/231.af32101a.js"><link rel="prefetch" href="/devops/public/assets/js/232.931da4dd.js"><link rel="prefetch" href="/devops/public/assets/js/233.92cd47fc.js"><link rel="prefetch" href="/devops/public/assets/js/234.5461e0e7.js"><link rel="prefetch" href="/devops/public/assets/js/235.e183c848.js"><link rel="prefetch" href="/devops/public/assets/js/236.9d0b81bd.js"><link rel="prefetch" href="/devops/public/assets/js/237.10575201.js"><link rel="prefetch" href="/devops/public/assets/js/238.629c6ef5.js"><link rel="prefetch" href="/devops/public/assets/js/239.728d2233.js"><link rel="prefetch" href="/devops/public/assets/js/24.aae5de0f.js"><link rel="prefetch" href="/devops/public/assets/js/240.c89f2e19.js"><link rel="prefetch" href="/devops/public/assets/js/241.aaf7a490.js"><link rel="prefetch" href="/devops/public/assets/js/242.42e74e3b.js"><link rel="prefetch" href="/devops/public/assets/js/243.348491db.js"><link rel="prefetch" href="/devops/public/assets/js/244.7c6b55ef.js"><link rel="prefetch" href="/devops/public/assets/js/245.284fd7a7.js"><link rel="prefetch" href="/devops/public/assets/js/246.f241fbe1.js"><link rel="prefetch" href="/devops/public/assets/js/247.71a82174.js"><link rel="prefetch" href="/devops/public/assets/js/248.de8fd46b.js"><link rel="prefetch" href="/devops/public/assets/js/249.cfd9f7ee.js"><link rel="prefetch" href="/devops/public/assets/js/25.ccef8efa.js"><link rel="prefetch" href="/devops/public/assets/js/250.070d8f99.js"><link rel="prefetch" href="/devops/public/assets/js/251.ff5a3213.js"><link rel="prefetch" href="/devops/public/assets/js/252.71ad4337.js"><link rel="prefetch" href="/devops/public/assets/js/253.01dc528c.js"><link rel="prefetch" href="/devops/public/assets/js/254.c5a65e3c.js"><link rel="prefetch" href="/devops/public/assets/js/255.067efc7b.js"><link rel="prefetch" href="/devops/public/assets/js/256.ce2d0b8b.js"><link rel="prefetch" href="/devops/public/assets/js/257.20223d0c.js"><link rel="prefetch" href="/devops/public/assets/js/258.7ef6f1fe.js"><link rel="prefetch" href="/devops/public/assets/js/259.a575f284.js"><link rel="prefetch" href="/devops/public/assets/js/26.68aa115c.js"><link rel="prefetch" href="/devops/public/assets/js/260.2522ddff.js"><link rel="prefetch" href="/devops/public/assets/js/261.604f6c39.js"><link rel="prefetch" href="/devops/public/assets/js/262.5aa7f981.js"><link rel="prefetch" href="/devops/public/assets/js/27.34f21c4e.js"><link rel="prefetch" href="/devops/public/assets/js/28.63e3c7ed.js"><link rel="prefetch" href="/devops/public/assets/js/29.4dcf32ae.js"><link rel="prefetch" href="/devops/public/assets/js/3.1f995075.js"><link rel="prefetch" href="/devops/public/assets/js/30.555e38ca.js"><link rel="prefetch" href="/devops/public/assets/js/31.d20ee572.js"><link rel="prefetch" href="/devops/public/assets/js/32.aa5f769f.js"><link rel="prefetch" href="/devops/public/assets/js/33.c0a126d4.js"><link rel="prefetch" href="/devops/public/assets/js/34.b8bf6708.js"><link rel="prefetch" href="/devops/public/assets/js/35.72f57892.js"><link rel="prefetch" href="/devops/public/assets/js/36.3cfa22c9.js"><link rel="prefetch" href="/devops/public/assets/js/37.9e0408d5.js"><link rel="prefetch" href="/devops/public/assets/js/38.b4c21835.js"><link rel="prefetch" href="/devops/public/assets/js/39.249a89e3.js"><link rel="prefetch" href="/devops/public/assets/js/4.d5f85984.js"><link rel="prefetch" href="/devops/public/assets/js/40.df24eade.js"><link rel="prefetch" href="/devops/public/assets/js/41.6be3bb48.js"><link rel="prefetch" href="/devops/public/assets/js/42.6e85a506.js"><link rel="prefetch" href="/devops/public/assets/js/43.c224e7e3.js"><link rel="prefetch" href="/devops/public/assets/js/44.1f3cdf42.js"><link rel="prefetch" href="/devops/public/assets/js/45.a75144ab.js"><link rel="prefetch" href="/devops/public/assets/js/46.111de9cb.js"><link rel="prefetch" href="/devops/public/assets/js/47.3243468c.js"><link rel="prefetch" href="/devops/public/assets/js/48.93797012.js"><link rel="prefetch" href="/devops/public/assets/js/49.7741937d.js"><link rel="prefetch" href="/devops/public/assets/js/5.67912e83.js"><link rel="prefetch" href="/devops/public/assets/js/50.2e3a4856.js"><link rel="prefetch" href="/devops/public/assets/js/51.91c7ab0b.js"><link rel="prefetch" href="/devops/public/assets/js/52.523c6cf5.js"><link rel="prefetch" href="/devops/public/assets/js/53.a7dfae93.js"><link rel="prefetch" href="/devops/public/assets/js/54.59203b12.js"><link rel="prefetch" href="/devops/public/assets/js/55.74329901.js"><link rel="prefetch" href="/devops/public/assets/js/56.1996c141.js"><link rel="prefetch" href="/devops/public/assets/js/57.fc3d7ab9.js"><link rel="prefetch" href="/devops/public/assets/js/58.bd7669d5.js"><link rel="prefetch" href="/devops/public/assets/js/59.c7e3bfd9.js"><link rel="prefetch" href="/devops/public/assets/js/6.e5b9a373.js"><link rel="prefetch" href="/devops/public/assets/js/60.47feb7c7.js"><link rel="prefetch" href="/devops/public/assets/js/61.079bee3b.js"><link rel="prefetch" href="/devops/public/assets/js/62.ed89b89f.js"><link rel="prefetch" href="/devops/public/assets/js/63.ecbe0ddb.js"><link rel="prefetch" href="/devops/public/assets/js/64.8c902dc0.js"><link rel="prefetch" href="/devops/public/assets/js/65.bd801b87.js"><link rel="prefetch" href="/devops/public/assets/js/66.3aa1baf4.js"><link rel="prefetch" href="/devops/public/assets/js/67.ce9e4215.js"><link rel="prefetch" href="/devops/public/assets/js/68.0ef01c0d.js"><link rel="prefetch" href="/devops/public/assets/js/69.50255698.js"><link rel="prefetch" href="/devops/public/assets/js/7.bd5195c6.js"><link rel="prefetch" href="/devops/public/assets/js/70.ec7e3c94.js"><link rel="prefetch" href="/devops/public/assets/js/71.1fb290ee.js"><link rel="prefetch" href="/devops/public/assets/js/72.a69d84fd.js"><link rel="prefetch" href="/devops/public/assets/js/73.838f9b5b.js"><link rel="prefetch" href="/devops/public/assets/js/74.6fb338b5.js"><link rel="prefetch" href="/devops/public/assets/js/75.aeb2efd1.js"><link rel="prefetch" href="/devops/public/assets/js/76.0a40be39.js"><link rel="prefetch" href="/devops/public/assets/js/77.4e488482.js"><link rel="prefetch" href="/devops/public/assets/js/78.414d49ea.js"><link rel="prefetch" href="/devops/public/assets/js/79.a6c4c7d4.js"><link rel="prefetch" href="/devops/public/assets/js/8.81a25c23.js"><link rel="prefetch" href="/devops/public/assets/js/80.aa59f21d.js"><link rel="prefetch" href="/devops/public/assets/js/81.5b323446.js"><link rel="prefetch" href="/devops/public/assets/js/82.3fe79c96.js"><link rel="prefetch" href="/devops/public/assets/js/83.faa97aa3.js"><link rel="prefetch" href="/devops/public/assets/js/84.a8a5d302.js"><link rel="prefetch" href="/devops/public/assets/js/85.062fcead.js"><link rel="prefetch" href="/devops/public/assets/js/86.e2133d81.js"><link rel="prefetch" href="/devops/public/assets/js/87.567674c0.js"><link rel="prefetch" href="/devops/public/assets/js/88.c9492539.js"><link rel="prefetch" href="/devops/public/assets/js/89.a9968527.js"><link rel="prefetch" href="/devops/public/assets/js/9.6229eb26.js"><link rel="prefetch" href="/devops/public/assets/js/90.c29cc326.js"><link rel="prefetch" href="/devops/public/assets/js/92.bffa7852.js"><link rel="prefetch" href="/devops/public/assets/js/93.13eab358.js"><link rel="prefetch" href="/devops/public/assets/js/94.972947a7.js"><link rel="prefetch" href="/devops/public/assets/js/95.ad1ea305.js"><link rel="prefetch" href="/devops/public/assets/js/96.5e49571c.js"><link rel="prefetch" href="/devops/public/assets/js/97.e921b547.js"><link rel="prefetch" href="/devops/public/assets/js/98.99620795.js"><link rel="prefetch" href="/devops/public/assets/js/99.c9e8f53c.js">
    <link rel="stylesheet" href="/devops/public/assets/css/0.styles.4a69f283.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>devops</h3> <p class="description" data-v-59e6cb88>快来玩devops</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devops/public/" class="home-link router-link-active"><img src="/devops/public/logo.png" alt="devops" class="logo"> <span class="site-name">devops</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/devops/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    devops
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>238</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/devops/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      devops
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/devops/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/devops/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/devops/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>44-mysql</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>devops</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">44-mysql</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>devops</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>devops</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="一-数据库概述"><a href="#一-数据库概述" class="header-anchor">#</a> 一，数据库概述</h2> <p>数据库学习方法：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库学习方法：
01 进行课程中的积极互动
02 每天完成课程知识总结（思维导图）
03 掌握每天课程练习操作（课上练习）
04 每天多人进行知识复述（原理知识-数据主从如何构建 数据库高可用切换原理 数据库SQL命令执行逻辑  数据库服务体系结构）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>随着互联网的蓬勃发展，开源数据库逐渐流行到普遍。由于具有免费、配置简单、稳定性好、性能优良等优点；</p> <p>开源数据库在中低端应用中占据了很大的市场份额，而MySQL正是开源数据库中的杰出代表。</p> <h3 id="_1-说明"><a href="#_1-说明" class="header-anchor">#</a> 1. 说明</h3> <p><strong>数据信息到底什么？</strong></p> <table><thead><tr><th>序号</th> <th>识别数据方式</th> <th>数据信息</th></tr></thead> <tbody><tr><td>01</td> <td>人类识别数据</td> <td>账号 密码 图片 视频 数字 文字 特殊符号 地址链接...</td></tr> <tr><td>02</td> <td>电脑识别数据</td> <td>二进制数值信息</td></tr></tbody></table> <p><strong>为什么需要学习数据库服务？</strong></p> <ul><li>静态访问：没有和后端交互的过程 -- 没有互动过程</li> <li>动态访问：具有和后端加护的过程 -- 具有互动过程 -- 引用了数据库服务</li></ul> <p><strong>数据如何进行存储？</strong></p> <p>可以利用专业的软件程序，将相关的人类识别的数据，转换为电脑可以识别的二进制信息进行存储</p> <p>其中一些重要的且核心的数据信息，比如网站中的账号和密码数据信息，需要保证数据存储的安全性，提供更大的存储空间，便于管理；</p> <p>因此，专门管理企业核心数据信息软件应运而生，数据库管理系统程序（软件-DBMS）</p> <ul><li>最核心数据信息存储：RDBMS-关系型数据库进行存储</li> <li>次核心数据信息存储：NoSQL-非关系型数据库进行存储</li> <li>分布型数据信息存储：DDBMS-分布式数据库进行存储（NewSQL）</li></ul> <p>常见数据库管理系统程序排名：https://db-engines.com/en/ranking</p> <p><strong>数据库实现数据存储过程方式？-- 存储到磁盘中 读取数据从磁盘</strong></p> <ul><li>系统环境 -- 数据库管理系统 -- DBMS(接收用户数据 -- 二进制 -- 磁盘)</li> <li>存储结构 -- 库信息（根据业务）-- 表信息（用户表 装备表） -- 字段（用户名 密码 用户手机号 账户信息）</li></ul> <h3 id="_2-概念介绍"><a href="#_2-概念介绍" class="header-anchor">#</a> 2. 概念介绍</h3> <p>数据库（database DB）,是一种存储数据的仓库，在实际应用过程具有如下特征：</p> <ul><li>数据库是根据数据结构组织、存储和管理数据的；</li> <li>数据库能够长期、高效的管理和存储数据；</li> <li>数据库的目的就是能够存储（写）和提供（读）数据</li></ul> <h3 id="_3-数据库分类"><a href="#_3-数据库分类" class="header-anchor">#</a> 3. 数据库分类</h3> <p>数据库分为三个大的类型：(随着互联网发展的产品类型)</p> <ul><li><strong>关系型数据库：</strong>（属于数据整合时代）</li></ul> <p>把复杂的数据结构归结为简单的二元关系（RDBMS），即二维表格形式（二维表）；会注重数据存储的持久性，但存储效率低；</p> <p>此类型数据库服务，类似于excel表格的存储数据方式，多采用SQL语言方式进行操作管理；</p> <p>关系型数据库四层结构信息：</p> <table><thead><tr><th>序号</th> <th>数据库结构</th> <th>描述说明</th></tr></thead> <tbody><tr><td>01</td> <td>数据库管理系统（DBMS）</td> <td>进行数据存储应用管理的操作环境或命令</td></tr> <tr><td>02</td> <td>数据库（DB）</td> <td>数据存储的承载环境</td></tr> <tr><td>03</td> <td>数据表（Table）</td> <td>数据关系的构建环境</td></tr> <tr><td>04</td> <td>数据字段（Field）</td> <td>实际数据信息展现形式</td></tr></tbody></table> <p>常见的关系数据库应用程序：</p> <table><thead><tr><th>序号</th> <th>数据库程序</th> <th>应用说明</th></tr></thead> <tbody><tr><td>01</td> <td>MySQL</td> <td>互联网公司应用最广泛</td></tr> <tr><td>02</td> <td>Mariadb</td> <td>企业场景应用较少（20%），主要用于教学环境较多</td></tr> <tr><td>03</td> <td>Oracle</td> <td>传统企业和部分国企应用较多，但也逐步被国产数据库替代</td></tr> <tr><td>04</td> <td>SQLserver</td> <td>适合windows server系统环境部署的数据库服务，属于微软公司发布的数据库服务</td></tr> <tr><td>05</td> <td>PostgreSQL</td> <td>适合于海量数据信息存储，对于金融行业数据信息分析能力将强</td></tr></tbody></table> <blockquote><p>说明：关系型数据库的极致追求：数据存储的安全性，但是在某种程度会损失数据存储和读取的性能。</p></blockquote> <ul><li><strong>非关系型数据库：</strong>（属于数据拆分时代）</li></ul> <p>没有具体模型的数据结构，英文简称NoSQL（Not Only SQL），意为&quot;不仅仅是SQL&quot;，比较注重数据读取的效率；</p> <p>利用NoSQL数据库主要处理高并发应用的场景，以及海量数据存储应用的场景</p> <p>常见的非关系数据库应用程序：</p> <table><thead><tr><th>序号</th> <th>数据库程序</th> <th>应用说明</th></tr></thead> <tbody><tr><td>01</td> <td>Redis</td> <td>可以利用内存存储数据，也可以采用磁盘存储数据，数据常见展示形式为key-value形式</td></tr> <tr><td>02</td> <td>Memcache</td> <td>可以利用内存存储数据，也可以采用磁盘存储数据，数据常见展示形式为key-value形式</td></tr> <tr><td>03</td> <td>Mongodb</td> <td>属于面向文档数据存储的数据库</td></tr> <tr><td>04</td> <td>ES</td> <td>主要用于做日志数据的收集与检索的数据库（ELK ELFK）</td></tr></tbody></table> <blockquote><p>说明：非关系型数据库的极致追求：数据存储的高效性，但是在某种程序会牺牲数据存储的安全性。</p></blockquote> <ul><li><strong>企业新型数据库：</strong>（属于业务整合时代）</li></ul> <p>属于近些年，由国人研发设计出的数据库服务，可以满足很多国内高并发量网站数据存储和读取业务的需求；</p> <p>常见的新型数据库应用程序：</p> <table><thead><tr><th>序号</th> <th>数据库程序</th> <th>应用说明</th></tr></thead> <tbody><tr><td>01</td> <td>TiDB</td> <td>开源分布式关系型数据库，是一款同时支持在线事务处理与在线分析处理的融合型分布式数据库产品</td></tr> <tr><td>02</td> <td>OceanBase</td> <td>是由蚂蚁集团完全自主研发的国产原生分布式数据库，兼顾分布式架构的扩展性与集中式架构的性能优势</td></tr> <tr><td>03</td> <td>PolarXDB</td> <td>是由阿里巴巴自主研发的云原生分布式数据库，是一款基于云架构理念分布式数据库产品，专注海量数据处理</td></tr> <tr><td>04</td> <td>RDS/TDSQL</td> <td>阿里云/腾讯云平台基于SaaS云计算服务环境构建的数据库产品（PolarXDB TDSQL TiDB）</td></tr></tbody></table> <p>数据信息来源参考：https://www.modb.pro/dbRank</p> <p>数据信息来源参考：https://db-engines.com/en/ranking</p> <p>数据信息来源参考：https://www.itdks.com/</p> <p>数据库服务企业应用类型？</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>01 关系型数据库（行和列）          
   代表性服务：mysql* mariadb oracle（高级数据库课程）pg SQLserver access <span class="token punctuation">..</span><span class="token punctuation">..</span>
   功能作用：可以将数据合理化永久存储（磁盘中）

02 非关系数据库（键key和值values） 
   代表性服务：redis* mongodb* memcache Elasticsearch（日志型数据）过滤Logstash 展示 Kibana <span class="token punctuation">..</span>. 
   功能作用：可以将数据高效存储和读取（内存中/磁盘中）
   https://db-engines.com/en/ranking

03 分布型数据库（兼容了关系型+非关系型数据库特定） 
   代表性服务：OB<span class="token punctuation">(</span>OceanBase-蚂蚁金服<span class="token punctuation">)</span> PingCAP-TiDB 华为Guess Base
   功能作用：可以合理化存储数据，并且也可以高效存储/调取数据
   学习分布式数据：看官方网站教学视频
   https://www.modb.pro/dbRank
   https://cn.pingcap.com/courses-catalog/category/dba/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_4-版本"><a href="#_4-版本" class="header-anchor">#</a> 4. 版本</h3> <p>根据本课程安排，主要会介绍讲解关系型数据库中的 MySQL 数据库服务，也是业界比较知名和流行的开源数据库产品；</p> <p>因此，需要关注下MySQL软件程序的版本应用（产品线），以及同类型相关的数据库服务产品。</p> <table><thead><tr><th>序号</th> <th>厂商信息</th> <th>数据库服务</th></tr></thead> <tbody><tr><td>01</td> <td>Oracle（官方）</td> <td>Oracle/ MySQL（5.6 5.7* 8.0）</td></tr> <tr><td>02</td> <td>MariaDB</td> <td>MariaDB Server（从5.5+之后，10.0+版本有自己的一些架构特性）</td></tr> <tr><td>03</td> <td>Percona</td> <td>Percona Server</td></tr></tbody></table> <p>MySQL企业应用的版本分析：</p> <table><thead><tr><th>序号</th> <th>大版本应用</th> <th>小版本应用</th></tr></thead> <tbody><tr><td>01</td> <td>MySQL 5.6</td> <td>5.6.36 5.6.38 5.6.40 5.6.46 （GA 6-12月）<br>2021 01月 常规/扩展服务全部停止</td></tr> <tr><td>02</td> <td>MySQL 5.7 （应用更加广泛）</td> <td>5.7.20 5.7.22 5.7.24 5.7.26 ..5.7.40（GA最新双数版本）<br>2023 10月 常规/扩展服务全部停止</td></tr> <tr><td>03</td> <td>MySQL 8.0 （属于最新版本）</td> <td>8.0.11 8.0.17+ 8.0.18 8.0.26 8.0.32 （GA最新双数版本）</td></tr></tbody></table> <p>MySQL企业应用的发布版本：</p> <ul><li>C：表示为社区版本，属于开源免费版本</li> <li>E：表示为企业版本，属于开源盈利版本</li></ul> <h3 id="_5-优势特点"><a href="#_5-优势特点" class="header-anchor">#</a> 5. 优势特点</h3> <ul><li>MySQL数据库服务性能卓越，服务稳定，很少出现异常宕机的情况；</li> <li>MySQL数据库服务是开放源代码且无版权制约，自主性强，且使用成本低；</li> <li>MySQL数据库服务使用历史悠久，社区及用户非常活跃，遇到问题可以获取大量帮助；</li> <li>MySQL数据库服务软件体积小，安装使用简单，并且易于维护管理，安装及维护成本低；</li> <li>MySQL数据库服务业界口碑好，使得企业无需考虑就能直接使用；</li> <li>MySQL数据库服务架构应用广泛，可以用于构建LAMP LNMP LNMT等流行web架构；</li> <li>MySQL数据库服务支持多种操作系统，提供多种API接口，支持多种开发语言利用驱动接口调用；</li></ul> <h2 id="二-安装"><a href="#二-安装" class="header-anchor">#</a> 二，安装</h2> <p>Oracle公司的MySQL版本分社区版和企业版两种，企业版比社区版功能强，但要付费，通常使用社区版即可满足一般要求；</p> <p>Linux平台上的MySQL版本主要分两类：</p> <p>类型一：Oracle Linux、Red Hat、CentOS和Ferdora平台上的MySQL版本；</p> <p>类型二：Ubuntu和Debian平台上的MySQL版本</p> <h3 id="_1-安装方式"><a href="#_1-安装方式" class="header-anchor">#</a> 1. 安装方式</h3> <p>mysql安装环境：</p> <p><img src="/devops/public/assets/img/1728392877275.85878cb8.png" alt="1728392877275"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>虚拟主机用户名：root 密码：123456
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在Linux系统中常见的部署安装方式：</p> <p>MySQL安装方式有多种，常用的有软件仓库（YUM源或APT源）安装，RPM或DEB包安装、二进制文件安装、源码编译安装；</p> <ul><li>Oracle Linux、Red Hat、CentOS和Ferdora平台支持方式：yum源安装、rpm包安装、二进制文件安装、源码编译安装；</li> <li>Ubuntu和Debian平台支持方式：apt源安装、deb包安装、二进制文件安装、源码编译安装</li></ul> <table><thead><tr><th>序号</th> <th>安装方式</th> <th>特征说明</th></tr></thead> <tbody><tr><td>01</td> <td>采用二进制方式安装</td> <td>直接解压缩二进制程序包，进行简单的配置和初始化操作即可</td></tr> <tr><td>02</td> <td>采用rpm包方式安装</td> <td>需要从官方网站下载rpm程序包，并且需要考虑系统环境的兼容性，解决软件程序包依赖</td></tr> <tr><td>03</td> <td>采用yum源方式安装</td> <td>需要根据官方网站说明，配置yum下载的仓库源信息，在联网情况下进行安装部署</td></tr> <tr><td>04</td> <td>采用源码包方式安装</td> <td>需要从官方网站下载源码程序包，并且需要解决程序包依赖问题，以及需要采用编译安装</td></tr></tbody></table> <blockquote><p>说明：本次课程主要围绕数据库服务的应用和管理进行讲解，所以选择二进制包安装方式，使安装过程更加简单和规范。</p></blockquote> <p>MySQL数据库服务安装方式：（二进制包安装）</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>安装方式一：yum/apt-get 	可以解决软件依赖关系（配置好下载源）
安装方式二：rpm包安装      需要提前在软件包，离线安装软件
安装方式三：源码编译安装	可以定制化安装软件，离线安装软件
安装方式四：二进制包安装  	可以快速部署数据库,	离线安装软件    讲解安装过程
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-下载"><a href="#_2-下载" class="header-anchor">#</a> 2. 下载</h3> <p>利用官方网址获取数据库软件程序：https://www.mysql.com/</p> <p>选择官网网站的 <code>DOWNLOADS</code> 进行数据库软件程序下载选择；</p> <p><img src="/devops/public/assets/img/1728394502479.d68a78c9.png" alt="1728394502479"></p> <p>在数据库官方下载页面中，选择 <code>MySQL Community (GPL) Downloads</code> 链接，进行数据库程序社区版下载；</p> <p><img src="/devops/public/assets/img/1728394518273.8084b5a0.png" alt="1728394518273"></p> <p>进入数据库程序的社区版下载页面后，会看到社区版数据库服务的多种安装场景，本课程选择<code>MySQL Community Server</code>方式安装</p> <p>官方最新版下载页面：</p> <p><img src="/devops/public/assets/img/1728394549940.fee437c3.png" alt="1728394549940"></p> <p>官方历史版下载页面：（本次课程讲解选择历史相对稳定版本进行安装部署）</p> <p><img src="/devops/public/assets/img/1728394565185.3b2b34b2.png" alt="1728394565185"></p> <p>进入到社区版服务器安装场景界面，需要选择数据库服务的安装部署环境和需要下载的程序具体版本信息；</p> <p><img src="/devops/public/assets/img/1728394581571.0ddd4c86.png" alt="1728394581571"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql       <span class="token parameter variable">-8.4.2</span>    <span class="token parameter variable">-linux</span>     <span class="token parameter variable">-glibc2.17</span>  <span class="token parameter variable">-x86_64</span>    .tar.xz
数据库名称   版本号   系统信息   内核信息   架构信息   压缩包
统一使用/下载版本：mysql-8.0.32-linux-glibc2.12-x86_64.tar.xz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_3-安装过程"><a href="#_3-安装过程" class="header-anchor">#</a> 3. 安装过程</h3> <ul><li><strong>不同系统环境数据库服务安装方式-Linux</strong></li></ul> <p>部署安装MySQL数据库服务程序：</p> <p><u>步骤一：MySQL数据库服务安装环境准备</u></p> <p>确认操作系统数据库服务安装环境</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>1）确认系统是否可以连网/可以远程控制
[root@db-01 ~]# ping www.baidu.com
PING www.a.shifen.com (39.156.66.18) 56(84) bytes of data.
64 bytes from 39.156.66.18 (39.156.66.18): icmp_seq=1 ttl=128 time=17.9 ms
64 bytes from 39.156.66.18 (39.156.66.18): icmp_seq=2 ttl=128 time=17.4 ms


2）修改系统主机名称/设置名称和地址解析(可选)
[root@db-01 ~]# hostnamectl set-hostname DB-01      
[root@db-01 ~]# echo &quot;10.0.0.51 DB-01&quot; &gt;&gt;/etc/hosts

3）关闭系统安全功能
[root@db-01 ~]# systemctl stop firewalld
[root@db-01 ~]# systemctl disable firewalld
[root@db-01 ~]# setenforce 0
[root@db-01 ~]# sed -i '7s#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config 


4）清理系统中的数据库服务
[root@db-01 ~]# rpm -qa|grep mariadb
mariadb-libs-5.5.68-1.el7.x86_64
[root@db-01 ~]# yum remove -y `rpm -qa|grep mariadb`

5) 安装mysql依赖软件
[root@db-01 ~]# curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
[root@db-01 ~]# curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
[root@db-01 ~]# yum install -y libaio-devel
[root@db-01 ~]# yum install -y lrzsz tree vim wget net-tools

6）创建服务用户与存储数据目录
[root@db-01 ~]# useradd mysql -M -s /sbin/nologin
[root@db-01 ~]# mkdir -p /data/3306/data &amp;&amp; chown mysql.mysql /data/3306/data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><u>步骤二：MySQL数据库程序解压安装过程</u></p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>解压安装数据库软件程序
[root@db-01 local]# cd /usr/local/
[root@db-01 local]# pwd
/usr/local


[root@db-01 local]# tar xvf mysql-8.0.32-linux-glibc2.12-x86_64.tar.xz

[root@db-01 local]# ln -s mysql-8.0.32-linux-glibc2.12-x86_64 mysql    --重要目录bin，存放数据库的命令信息（mysql mysqladmin mysqldump ...)

[root@db-01 local]# vim /etc/profile
export PATH=&quot;$PATH:/usr/local/mysql/bin&quot;           -- 保存配置信息

[root@db-01 local]# source /etc/profile            -- 加载最新环境变量配置

[root@db-01 local]# mysql -V          -- 可以看到数据库版本信息，表示数据库安装完毕
mysql  Ver 8.0.32 for Linux on x86_64 (MySQL Community Server - GPL)

编写数据库服务配置文件,默认是没有my.cnf的，需要创建。下面的内容先不要管。
cat &gt; /etc/my.cnf &lt;&lt;eof
[mysql]
socket=/tmp/mysql.sock
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
eof

---------------- 大家copy上面的命令就行。
[root@db-01 local]# cat /etc/my.cnf 
[mysql]
socket=/tmp/mysql.sock
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><blockquote><p>说明：以上操作步骤只是保证了数据库服务的软件程序部分安装完毕，在系统中可以识别数据库程序。</p></blockquote> <p><u>步骤三：MySQL数据库程序生成初始数据</u>：（8.0版本数据库）</p> <p>数据库初始化命令应用解读：</p> <table><thead><tr><th>核心程序命令</th> <th>初始化核心参数</th> <th>数据管理用户</th> <th>数据存储路径</th> <th>数据存放目录</th></tr></thead> <tbody><tr><td>mysqld</td> <td>--initialize-insecure</td> <td>--user=mysql</td> <td>--basedir=/usr/local/mysql</td> <td>--datadir=/data/3306/data</td></tr></tbody></table> <p>数据库初始化方式分为两种：</p> <ul><li><strong>实现数据库不安全初始化：</strong></li></ul> <p>采用不安全初始化数据库，稍后运行启动数据库程序，在管理员登录访问过程无需密码信息即可登录；</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>实现数据库安全初始化：</strong></li></ul> <p>采用安全初始化数据库，将会生成临时密码（12位密码 需要满足4种复杂度），必须在首次登录数据库时改掉，才能正常管理数据库；</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用安全模式初始化数据库后，需要利用临时密码登录数据库服务，并设置管理员用户密码信息；</p> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>mysql &gt; alter user root@'localhost' identified by '123456';
-- 如果不修改设置管理员用户密码，使用临时密码只是能登录数据库，但是无法管理数据库
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>数据库初始化不同版本差异：</p> <table><thead><tr><th>版本信息</th> <th>命令信息</th> <th>初始化操作参数</th> <th>备注说明</th></tr></thead> <tbody><tr><td>5.5 5.6</td> <td>mysql_install_db</td> <td></td> <td>初始化的命令不一致，参数相同（无管理员密码）</td></tr> <tr><td>5.7 8.0</td> <td>mysqld</td> <td>--initialize-insecure</td> <td>表示不安全方式初始化（无管理员密码）</td></tr> <tr><td></td> <td></td> <td>--initialize</td> <td>表示安全方式初始化（有随机默认管理员密码）</td></tr></tbody></table> <p>数据库初始化命令实践操作：</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>数据库服务初始化操作（创建默认数据库中数据信息）
mysql 8.0 5.7 数据库服务 
mysqld --initialize-insecure  --user=mysql  --datadir=/data/3306/data  --basedir=/usr/local/mysql 
-- 进行不安全初始化，不会创建root用户临时密码（root用户可以免密登录）

2024-10-08T03:56:46.159721Z 0 [System] [MY-013169] [Server] /usr/local/mysql-8.0.32-linux-glibc2.12-x86_64/bin/mysqld (mysqld 8.0.32) initializing of server in progress as process 2090
2024-10-08T03:56:46.184294Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2024-10-08T03:56:47.034991Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
2024-10-08T03:56:48.696529Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.
-- 没有看到初始化中的错误或失败信息，表示初始化成功（不安全）


初始化常见问题：
1）依赖软件没有正确安装
yum install -y libaio-devel
[报错信息]：
mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory
[解决方法]：
yum install -y libaio-devel

2）系统数据目录或用户没有创建
[报错信息]：
[ERROR] [MY-010124] [Server] Fatal error: Can't change to run as user 'mysql' ;  Please check that the user exists!
[解决方法]：
useradd mysql -M -s /sbin/nologin 
mkdir -p /data/3306/data &amp;&amp; chown mysql.mysql /data/3306/data

3）系统配置文件信息编写正确
PS：
01 执行初始化命令和参数信息输入正确
02 若初始化有问题，需要将数据目录内容清空，再重新初始化


mysqld --initialize --user=mysql  --datadir=/data/3306/data  --basedir=/usr/local/mysql 
-- 进行安全初始化，会创建root用户临时密码（root用户需要使用密码登录），登录上还要修改密码（root用户没有管理权）

A temporary password is generated for root@localhost: 71Z00yLoRU(r



mysql 5.5 5.6 数据库服务 
mysql_install_db --user=mysql  --datadir=/data/3306/data  --basedir=/usr/local/mysql 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><blockquote><p>说明：数据库服务初始化的过程，是用于让数据库服务创建出一些默认的数据信息，以及识别存储数据目录信息</p></blockquote> <p><u>步骤四：MySQL数据库程序脚本运行启动</u>：</p> <p>在数据库程序目录中找到启动脚本文件，并将脚本文件复制到指定目录中；</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>数据库启动关闭管理
方式一：利用脚本文件启动关闭
功能作用：可以默认实现数据单实例启动过程
[root@db-01 local]# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>利用启动脚本文件，运行启动数据库服务；</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>[root@db-01 local]# /etc/init.d/mysql.server start
Starting MySQL.Logging to '/data/3306/data/db-01.err'.
... SUCCESS!

[root@db-01 local]# ps -ef|grep mysql
root       2386      1  0 15:07 pts/0    00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --datadir=/data/3306/data --pid-file=/data/3306/data/db-01.pid
-- 以上进程称为数据库主进程 -- 管理进程
mysql      2525   2386 15 15:07 pts/0    00:00:03 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/data/3306/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --log-error=db-01.err --pid-file=/data/3306/data/db-01.pid --socket=/tmp/mysql.sock
-- 以上进程称为数据库子进程 -- 工作进程


[root@db-01 local]# netstat -lntup|grep 3306
tcp6       0      0 :::3306                 :::*                    LISTEN      2525/mysqld         
tcp6       0      0 :::33060                :::*                    LISTEN      2525/mysqld 

我的mysql临时密码：z&amp;cpuo&lt;f/8oU
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>启动和关闭数据库方式一：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># cp /usr/local/mysql/support-files/mysql.server /etc/init.d/</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server start</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># netstat -lntup|grep 3306</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server restart</span>

<span class="token comment"># 通过脚本主启动，关闭的话，也通过脚本关闭</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server stop</span>

<span class="token comment"># 如果启动失败了</span>
数据库服务启动异常，排查思路：
01：查看错误日志信息（<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># cat db-01.err）</span>
<span class="token number">2024</span>-10-08T07:33:55.126820Z <span class="token number">1</span> <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> <span class="token punctuation">[</span>MY-012271<span class="token punctuation">]</span> <span class="token punctuation">[</span>InnoDB<span class="token punctuation">]</span> The innodb_system data <span class="token function">file</span> <span class="token string">'ibdata1'</span> must be writable

02：查看配置文件信息（看不到日志文件）
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>启动和关闭数据库方式二：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>关闭数据库服务
/etc/init.d/mysql.server stop

方式二：利用命令文件启动关闭，它会自动找我们写的配置
功能作用：可以默认实现数据多实例启动过程
mysqld <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql  <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data  --pid-file<span class="token operator">=</span>/var/run/mysqld/mysqld.pid  <span class="token parameter variable">--socket</span><span class="token operator">=</span>/var/run/mysqld/mysqld.sock  <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span>  --log-error<span class="token operator">=</span>/var/log/mysql/error.log  --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0

mysqld -- 执行mysqld命令，可以运行数据库工作进程 
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysqld --plugin-dir=/usr/local/mysql/lib/plugin &amp;</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysqld &amp;</span>

<span class="token comment">#测试是否开启</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
mysql      <span class="token number">2945</span>   <span class="token number">1759</span>  <span class="token number">6</span> <span class="token number">15</span>:06 pts/0    00:00:01 mysqld
root       <span class="token number">2993</span>   <span class="token number">1759</span>  <span class="token number">0</span> <span class="token number">15</span>:06 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto mysql
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># netstat -tnulp|grep 3306</span>
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::33060                :::*                    LISTEN      <span class="token number">2945</span>/mysqld         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3306                 :::*                    LISTEN      <span class="token number">2945</span>/mysqld         
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p</span>


通过命令启动的，通过kill关闭服务：
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
mysql      <span class="token number">2945</span>   <span class="token number">1759</span>  <span class="token number">2</span> <span class="token number">15</span>:06 pts/0    00:00:03 mysqld
root       <span class="token number">2999</span>   <span class="token number">1759</span>  <span class="token number">0</span> <span class="token number">15</span>:08 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto mysql
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># kill 2945</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># 2024-10-22T07:08:36.793457Z 0 [System] [MY-013172] [Server] Received SHUTDOWN from user &lt;via user signal&gt;. Shutting down mysqld (Version: 8.0.32).</span>
<span class="token number">2024</span>-10-22T07:08:37.836045Z <span class="token number">0</span> <span class="token punctuation">[</span>System<span class="token punctuation">]</span> <span class="token punctuation">[</span>MY-010910<span class="token punctuation">]</span> <span class="token punctuation">[</span>Server<span class="token punctuation">]</span> /usr/local/mysql-8.0.32-linux-glibc2.12-x86_64/bin/mysqld: Shutdown complete <span class="token punctuation">(</span>mysqld <span class="token number">8.0</span>.32<span class="token punctuation">)</span>  MySQL Community Server - GPL.

<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>+  Done                    mysqld
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p</span>
Enter password: 
ERROR <span class="token number">2002</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: Can<span class="token string">'t connect to local MySQL server through socket '</span>/tmp/mysql.sock' <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 也可以通过pkill</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
mysql      <span class="token number">3001</span>   <span class="token number">1759</span> <span class="token number">10</span> <span class="token number">15</span>:09 pts/0    00:00:01 mysqld
root       <span class="token number">3048</span>   <span class="token number">1759</span>  <span class="token number">0</span> <span class="token number">15</span>:10 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto mysql
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># pkill mysql</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
root       <span class="token number">3053</span>   <span class="token number">1759</span>  <span class="token number">0</span> <span class="token number">15</span>:10 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto mysql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>启动和关闭数据库方式三：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysqld_safe -- 执行mysqld_safe命令，可以运行数据库管理进程（顺带mysqld进程运行）
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysqld_safe &amp;</span>

关闭服务：
<span class="token function">kill</span>
<span class="token function">pkill</span> mysql
/etc/init.d/mysql.server stop 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>启动和关闭数据库方式四：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl 
方法一：编写mysql.service文件，被systemctl命令加载（systemctl daemon-reload）

<span class="token function">vim</span> /etc/systemd/system/mysql.service  --- 直接调用脚本文件
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>MySQL Server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">Group</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/mysql/support-files/mysql.server start
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/local/mysql/support-files/mysql.server stop
<span class="token assign-left variable">ExecReStart</span><span class="token operator">=</span>/usr/local/mysql/support-files/mysql.server restart
<span class="token assign-left variable">RemainAfterExit</span><span class="token operator">=</span>yes

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

------------------------------------

<span class="token function">vim</span> /etc/systemd/system/mysql.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>MySQL Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:mysqld<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>http://dev.mysql.com/doc/refman/en/using-systemd.html
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>syslog.target

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">Group</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/mysql/bin/mysqld --defaults-file<span class="token operator">=</span>/etc/my.cnf
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">5000</span>

------------------------------------
被systemctl命令加载（systemctl daemon-reload）
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># systemctl start mysql</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># ps -ef|grep mysql</span>
mysql      <span class="token number">3627</span>      <span class="token number">1</span> <span class="token number">15</span> <span class="token number">15</span>:20 ?        00:00:01 /usr/local/mysql/bin/mysqld --defaults-file<span class="token operator">=</span>/etc/my.cnf
root       <span class="token number">3674</span>   <span class="token number">1759</span>  <span class="token number">0</span> <span class="token number">15</span>:20 pts/0    00:00:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto mysql
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># systemctl stop mysql</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysql</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># systemctl status mysql</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>启动和关闭数据库方式五（了解）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>不想编写mysql.service，也可以利用如下的方式加载脚本

利用systemctl命令加载数据库脚本文件（/etc/init.d/mysql.server）
systemctl <span class="token builtin class-name">enable</span> mysql.server
systemctl start mysql.server 
systemctl status mysql.server -- /etc/rc.d/init.d/mysql.server --  Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span>
systemctl stop mysql.server 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如何实现数据库脚本文件随系统自动运行</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db-01 system<span class="token punctuation">]</span><span class="token comment"># tail -2 /etc/rc.local </span>
/etc/init.d/mysql.server start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="三-基础管理"><a href="#三-基础管理" class="header-anchor">#</a> 三，基础管理</h2> <h3 id="_1-密码管理"><a href="#_1-密码管理" class="header-anchor">#</a> 1. 密码管理</h3> <p><strong>方式一：数据库服务密码设置</strong></p> <p>给mysql配置登陆密码，并使用新密码进行登录数据库</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>设置密码：<span class="token punctuation">(</span>没有密码可以设置密码）
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysqladmin -uroot password &quot;123456&quot;</span>

mysql<span class="token operator">&gt;</span> alter user root@<span class="token string">'localhost'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>root@db-01 system<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>方式二：数据库服务密码修改</strong></p> <p>给mysql修改登陆密码，并使用新密码进行登录数据库</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysqladmin -uroot -p123456 password 'malu123456'</span>

mysql<span class="token operator">&gt;</span> alter user root@<span class="token string">'localhost'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>方式三：数据库服务密码重置</strong></p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>重置密码: (不知道原有密码-root 如何修改密码信息)
步骤一：需要关闭数据库服务(企业中需要有通知)
/etc/init.d/mysql.server stop 

步骤二：采用安全模式启动数据库（免密登录）
mysqld --skip-grant-tables --skip-networking &amp;
--skip-grant-tables：跳过授权表启动数据库，可以免密登录（不加载磁盘中的mysql.user）
--skip-networking：  跳过网络服务功能，数据库服务启动后关闭端口信息   （避免服务远程访问 -- 免密访问 -- 不安全）
步骤三：修改数据库管理员密码
mysql&gt; flush privileges;  -- 可以加载mysql.user表，从磁盘加载到内存
mysql&gt; alter user root@'localhost' identified by '123';
步骤四：重新正常启动数据库服务
mysql&gt; shutdown;  关闭数据库服务 
[root@db-01 ~]# /etc/init.d/mysql.server start
步骤五：重新登录数据库测试密码信息
[root@db-01 ~]# mysql -uroot -p12345678
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="/devops/public/assets/img/1728560860635.e25f7093.png" alt="1728560860635"></p> <h3 id="_2-用户管理"><a href="#_2-用户管理" class="header-anchor">#</a> 2. 用户管理</h3> <p>在数据库服务中，也是有用户知识概念的，类似系统中的用户管理应用，主要利用用户管理知识，可以实现：</p> <ul><li>用户登录数据库服务系统中（实现数据库服务登录）</li> <li>用户管理数据库服务中对象（实现数据库对象管理）</li></ul> <p><strong>01 创建数据库服务用户信息</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建用户：
语法：create user <span class="token string">&quot;用户名&quot;</span>@<span class="token string">&quot;连接用户白名单信息(地址 域名)&quot;</span>  identified by <span class="token string">&quot;密码信息&quot;</span><span class="token punctuation">;</span>

连接用户白名单信息<span class="token punctuation">(</span>地址 域名<span class="token punctuation">)</span>?
数据库服务访问方式：
- 本地访问（在数据库所在的系统中访问数据库） 
- 远程访问（在其他服务器系统中连接当前数据库服务）
用户白名单信息，表示指定只允许什么方式的客户端进行连接
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-mysql line-numbers-mode"><pre class="language-text"><code>本地访问设置：
mysql&gt; create user 'jiahua'@'127.0.0.1' identified by '123';
Query OK, 0 rows affected (0.01 sec)

mysql&gt; select user,host from mysql.user;
mysql&gt; select user,host from mysql.user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| jiahua           | 127.0.0.1 |
| mysql.infoschema | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
| root             | localhost |
+------------------+-----------+

mysql&gt; create user 'jiahua'@'localhost' identified by '123';
Query OK, 0 rows affected (0.01 sec)

mysql&gt; select user,host from mysql.user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| jiahua           | 127.0.0.1 |
| jiahua           | localhost |
| mysql.infoschema | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
| root             | localhost |
+------------------+-----------+
6 rows in set (0.00 sec)

再次使用jiahua去连接：  连接成功
[root@db-01 ~]# mysql -ujiahua -p123

在mysql的核心配置文件中可以配置禁止返回DNS解析：
[root@db-01 ~]# cat /etc/my.cnf 
[mysql]
socket=/tmp/mysql.sock
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
skip-name-resolve
[root@db-01 ~]# systemctl restart mysql


删除mysql数据库中user表中jiahua对应的localhost,使用root进入
[root@db-01 ~]# mysql -uroot -p12345678
mysql&gt; use mysql
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; delete from user where user='jiahua' and host='localhost';
Query OK, 1 row affected (0.00 sec)

mysql&gt; select user,host from user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| jiahua           | 127.0.0.1 |
| mysql.infoschema | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
| root             | localhost |
+------------------+-----------+
5 rows in set (0.00 sec)

# 退出去再连，使用jiahua用户
[root@db-01 ~]# mysql -ujiahua -p123
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>远程访问设置：
create user <span class="token string">'songyan'</span>@<span class="token string">'10.0.0.%'</span>  identified by <span class="token string">&quot;123&quot;</span><span class="token punctuation">;</span>    -- 只允许10.0.0.0/24网段内的主机进行访问 （10.0.0.1~10.0.0.254）
设置A类网段：10.%           /8   
设置B类网段：172.16.%       /16
设置C类网段：192.168.10.%   /24   

使用root用户登录进入，然后再创建songyan用户
mysql<span class="token operator">&gt;</span> create user <span class="token string">'songyan'</span>@<span class="token string">'10.0.0.%'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

使用web01测试：
<span class="token punctuation">[</span>root@web01:scripts<span class="token punctuation">]</span><span class="token comment">#mysql -usongyan -p123 -h10.0.0.51</span>
使用web02测试：
<span class="token punctuation">[</span>root@web02:scripts<span class="token punctuation">]</span><span class="token comment">#mysql -usongyan -p123 -h10.0.0.51</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>create user <span class="token string">'songyan'</span>@<span class="token string">'10.0.0.7'</span> identified by <span class="token string">&quot;123&quot;</span><span class="token punctuation">;</span>    -- 只允许10.0.0.7主机进行访问
create user <span class="token string">'songyan'</span>@<span class="token string">'web01.com'</span> identified by <span class="token string">&quot;123&quot;</span><span class="token punctuation">;</span>
<span class="token function">vim</span> /etc/hosts 
<span class="token number">10.0</span>.0.7  web01.com 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>现在的Mysql用户：
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> songyan          <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>
<span class="token operator">|</span> jiahua           <span class="token operator">|</span> <span class="token number">127.0</span>.0.1 <span class="token operator">|</span>
<span class="token operator">|</span> mysql.infoschema <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.session    <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.sys        <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> root             <span class="token operator">|</span> localhost <span class="token operator">|</span>
+------------------+-----------+
<span class="token number">6</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

再创建两个用户：
mysql<span class="token operator">&gt;</span> create user yujin@<span class="token string">'10.0.0.7'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> create user wangcai@<span class="token string">'10.0.0.8'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> songyan          <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>
<span class="token operator">|</span> yujin            <span class="token operator">|</span> <span class="token number">10.0</span>.0.7  <span class="token operator">|</span>
<span class="token operator">|</span> wangcai          <span class="token operator">|</span> <span class="token number">10.0</span>.0.8  <span class="token operator">|</span>
<span class="token operator">|</span> jiahua           <span class="token operator">|</span> <span class="token number">127.0</span>.0.1 <span class="token operator">|</span>
<span class="token operator">|</span> mysql.infoschema <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.session    <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.sys        <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> root             <span class="token operator">|</span> localhost <span class="token operator">|</span>
+------------------+-----------+

注意：如果用户信息搞错了，不存在修改用户，如果搞错了，保能删掉，重新添加。

刚创建的用户没有什么权限：
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysql -ujiahua -p123</span>
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
+--------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> create database test01<span class="token punctuation">;</span>
ERROR <span class="token number">1044</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Access denied <span class="token keyword">for</span> user <span class="token string">'jiahua'</span>@<span class="token string">'localhost'</span> to database <span class="token string">'test01'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>删除用户：
drop user <span class="token string">&quot;用户名&quot;</span>@<span class="token string">&quot;连接用户白名单信息(地址 域名)&quot;</span>

mysql<span class="token operator">&gt;</span> drop user yujin@<span class="token string">'10.0.0.7'</span><span class="token punctuation">;</span>
delete from mysql.user where 删除用户条件信息<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> delete from mysql.user where <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'wangcai'</span> and <span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token string">'10.0.0.8'</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> songyan          <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>
<span class="token operator">|</span> jiahua           <span class="token operator">|</span> <span class="token number">127.0</span>.0.1 <span class="token operator">|</span>
<span class="token operator">|</span> mysql.infoschema <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.session    <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.sys        <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> root             <span class="token operator">|</span> localhost <span class="token operator">|</span>
+------------------+-----------+
<span class="token number">6</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_3-权限管理"><a href="#_3-权限管理" class="header-anchor">#</a> 3. 权限管理</h3> <p>在数据库服务中，权限管理可以用于针对不同的用户，限制登录管理数据库服务用户的操作行为，也可以区分不同用户的操作能力；</p> <p>数据库服务权限实际应用过程中，和在操作系统权限中对用户进行权限设置，也是有区别的；</p> <ul><li>操作系统权限是作用于文件上的，限制某个用户对系统中数据文件的操作；</li> <li>数据库权限是作用在用户上的，或者角色（相当于系统的用户组）上的，限制执行某些操作命令；</li></ul> <p>数据库服务常见的权限管理定义设置：</p> <p>数据库服务中可以授权的所有权限信息查看</p> <div class="language-tiki wiki line-numbers-mode"><pre class="language-text"><code>MySQL&gt; show privileges;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出展示的信息表示内容：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Privilege -- 数据库所有权限
Context   -- 权限控制的对象
Comment   -- 对权限解释说明
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th>序号</th> <th>输出列</th> <th>解释说明</th></tr></thead> <tbody><tr><td>01</td> <td>Privilege</td> <td>表示可以授权的所有权限信息展示</td></tr> <tr><td>02</td> <td>Context</td> <td>表示设置的权限可以对数据库服务哪些资源进行操作</td></tr> <tr><td>03</td> <td>Comment</td> <td>对相应的权限功能进行简单解释说明</td></tr></tbody></table> <p>核心重要授权权限总结：</p> <ul><li>Alter  |  Tables(表)  | To alter the table（ 修改表信息（属性信息-结构 字符集 引擎 索引 数据类型））</li> <li>Create | Databases,Tables,Indexes（库 表 索引） | To create new databases and tables （可以拥有创建新库 新表 - 表中索引创建）</li> <li>Create user | Server Admin（具有服务管理能力）|To create new users (创建新用户)</li> <li>Delete | Tables(表) | To delete existing rows   （删除表数据信息权利）</li> <li>Drop | Databases,Tables（ 库 表 ）| To drop databases, tables, and views   （删除数据库 删除表 删除视图）</li> <li>Index | Tables（表） | To create or drop indexes    （ 在表中可以创建或删除索引信息）</li> <li>Insert | Tables（表） | To insert data into tables   （插入/添加表数据信息权利）</li> <li>Select  |  Tables（表）   | To retrieve rows from table  （查看表中数据权限 ）</li> <li>Show databases  |  Server Admin（具有服务管理能力 ）   | To see all databases with SHOW DATABASES  （可以查看所有数据库信息）</li> <li>Update  | Tables（表）   |  To update existing rows（修改表数据信息权利）</li> <li>Usage  |  Server Admin（具有服务管理能力 ）   | No privileges - allow connect only （数据库服务登录权利（默认权限））</li> <li>Grant option  | Databases,Tables,Functions,Procedures（库 表 函数 存储过程）   | To give to other users those privileges you possess （可以给别人进行授权的权利  ）</li></ul> <table><thead><tr><th>序号</th> <th>权限</th> <th>授权资源</th> <th>解释说明</th></tr></thead> <tbody><tr><td>01</td> <td>Select</td> <td>Tables</td> <td>可以对表进行操作，查询表中数据信息</td></tr> <tr><td>02</td> <td>Insert</td> <td>Tables</td> <td>可以对表进行操作，插入表中数据信息</td></tr> <tr><td>03</td> <td>Update</td> <td>Tables</td> <td>可以对表进行操作，修改表中数据信息</td></tr> <tr><td>04</td> <td>Delete</td> <td>Tables</td> <td>可以对表进行操作，删除表中数据信息</td></tr> <tr><td>05</td> <td>Alter</td> <td>Tables</td> <td>可以对表进行操作，修改表中结构信息（元数据-属性）</td></tr> <tr><td>06</td> <td>Index</td> <td>Tables</td> <td>可以对表进行操作，删除或创建表中的索引信息</td></tr> <tr><td>07</td> <td>Create</td> <td>Databases,Tables</td> <td>可以对表和库进行操作，用于创建数据库和表信息</td></tr> <tr><td>08</td> <td>Drop</td> <td>Databases,Tables</td> <td>可以对表和库进行操作，用于删除数据库和表信息</td></tr></tbody></table> <blockquote><p>说明：all privileges（all）包含查看的所有权限信息，但是唯独缺了Grant option，不能授权用户，此权限只能给root@local用户</p></blockquote> <p>对于网站业务管理数据库需要的权利：select insert update delete （增删改查 -- CRUD）</p> <p>权限设置：必须使用roo用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>grant priv_type<span class="token punctuation">(</span>权限信息<span class="token punctuation">)</span>  ON 权限管理对象（库 表 -- *.*） to 用户信息（用户名@<span class="token string">'白名单信息'</span>）<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> grant Show databases on *.* to jiahua@<span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> grant Create  on *.* to jiahua@<span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>

使用jiahua登录：
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysql -ujiahua -p123 -h127.0.0.1</span>
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
+--------------------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> create database test01<span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">|</span> test01             <span class="token operator">|</span>
+--------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>mysql中三个特殊权限：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>all privileges -- 设置所有权限,几乎和root权限一样，但是给别人授权的权限是没有的
mysql<span class="token operator">&gt;</span> create user jiahua@<span class="token string">'127.0.0.1'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> grant all on *.* to jiahua@<span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>

grant option   -- 设置给别的用户设置权限的权限
grant all on *.* to jiahua@<span class="token string">'10.0.0.%'</span> with grant option<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Usage          -- 数据库服务登录权利（默认权限）

查看权限：
方式一：执行show grants 命令查看权限
mysql<span class="token operator">&gt;</span> show grants <span class="token keyword">for</span> jiahua@<span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
+-------------------------------------------------------------+
<span class="token operator">|</span> Grants <span class="token keyword">for</span> jiahua@127.0.0.1                                 <span class="token operator">|</span>
+-------------------------------------------------------------+
<span class="token operator">|</span> GRANT CREATE, SHOW DATABASES ON *.* TO <span class="token variable"><span class="token variable">`</span>jiahua<span class="token variable">`</span></span>@<span class="token variable"><span class="token variable">`</span><span class="token number">127.0</span>.0.1<span class="token variable">`</span></span> <span class="token operator">|</span>
+-------------------------------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


方式二：获取授权表信息--获取权限
mysql.user           ：全局授权信息  授权对象是所有库所有表
mysql.db             ：局部授权信息  授权对象是指定的数据库
mysql.tables_priv    ：局部授权信息  授权独享是指定的数据表
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>模拟操作：
步骤一：准备环境
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p12345678</span>
ysql<span class="token operator">&gt;</span> create database jdsc<span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> use jdsc<span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> create table t1<span class="token punctuation">(</span>id int<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>


步骤二：创建用户信息
mysql<span class="token operator">&gt;</span> create user test01@<span class="token string">'%'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> create user test02@<span class="token string">'%'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> create user test03@<span class="token string">'%'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>


步骤三：进行用户授权
grant select,insert,update on *.* to test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
grant select,insert on jdsc.* to test02@<span class="token string">'%'</span><span class="token punctuation">;</span>
grant <span class="token keyword">select</span> on jdsc.t1 to test03@<span class="token string">'%'</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> * from mysql.user where <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'test01'</span><span class="token punctuation">\</span>G
<span class="token keyword">select</span> * from mysql.db where <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'test02'</span><span class="token punctuation">\</span>G
<span class="token keyword">select</span> * from mysql.tables_priv where <span class="token assign-left variable">user</span><span class="token operator">=</span><span class="token string">'test03'</span><span class="token punctuation">\</span>G
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>回收权限：
revoke 回收的权限 on 回收权限对象（库名.表名）from 用户信息（用户名@<span class="token string">'白名单信息'</span>）<span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> show grants <span class="token keyword">for</span> test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
+-----------------------------------------------------+
<span class="token operator">|</span> Grants <span class="token keyword">for</span> test01@%                                 <span class="token operator">|</span>
+-----------------------------------------------------+
<span class="token operator">|</span> GRANT SELECT, INSERT, UPDATE ON *.* TO <span class="token variable"><span class="token variable">`</span>test01<span class="token variable">`</span></span>@<span class="token variable"><span class="token variable">`</span>%<span class="token variable">`</span></span> <span class="token operator">|</span>
+-----------------------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> revoke insert,update on *.* from test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


mysql<span class="token operator">&gt;</span> grant insert on jdsc.t1 to test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show grants <span class="token keyword">for</span> test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
+----------------------------------------------+
<span class="token operator">|</span> Grants <span class="token keyword">for</span> test01@%                          <span class="token operator">|</span>
+----------------------------------------------+
<span class="token operator">|</span> GRANT SELECT, INSERT ON *.* TO <span class="token variable"><span class="token variable">`</span>test01<span class="token variable">`</span></span>@<span class="token variable"><span class="token variable">`</span>%<span class="token variable">`</span></span>  <span class="token operator">|</span>
<span class="token operator">|</span> GRANT INSERT ON <span class="token variable"><span class="token variable">`</span>jdsc<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>t1<span class="token variable">`</span></span> TO <span class="token variable"><span class="token variable">`</span>test01<span class="token variable">`</span></span>@<span class="token variable"><span class="token variable">`</span>%<span class="token variable">`</span></span> <span class="token operator">|</span>
+----------------------------------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> revoke insert on jdsc.t1 from test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> show grants <span class="token keyword">for</span> test01@<span class="token string">'%'</span><span class="token punctuation">;</span>
+---------------------------------------------+
<span class="token operator">|</span> Grants <span class="token keyword">for</span> test01@%                         <span class="token operator">|</span>
+---------------------------------------------+
<span class="token operator">|</span> GRANT SELECT, INSERT ON *.* TO <span class="token variable"><span class="token variable">`</span>test01<span class="token variable">`</span></span>@<span class="token variable"><span class="token variable">`</span>%<span class="token variable">`</span></span> <span class="token operator">|</span>
+---------------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_4-连接管理"><a href="#_4-连接管理" class="header-anchor">#</a> 4. 连接管理</h3> <p>数据库服务进行本地连接是有局限性--RDS（系统环境）</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>三种实现远程登录方式：
01 基于MySQL程序的客户端命令
mysql      -- 用于连接登录数据库
mysqladmin -- 用于远程管理数据库（设置密码 管理服务运行状态）
mysqldump  -- 用于远程备份数据库

mysql/mysqladmin/mysqldump -u用户信息 -p密码信息 -h数据库服务地址 -P端口信息
PS：需要部署数据库程序，必须熟悉数据库服务的管理命令
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>02 基于第三方的数据库远程工具
dbeaver   -- 官方链接：https://dbeaver.io/                  免费
workbench -- 官方链接: https://www.mysql.com                免费
navicat   -- 官方链接：https://www.navicat.com              付费
sqlyog    -- 官方链接：https://webyog.com/product/sqlyog/   付费


创建一个root2用户，拥有root的权限，然后使用sqlyog去连接。
mysql<span class="token operator">&gt;</span> create user <span class="token string">'root2'</span>@<span class="token string">'%'</span> identified by <span class="token string">'12345678'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
mysql<span class="token operator">&gt;</span> grant all on *.* to root2@<span class="token string">'%'</span> with grant option<span class="token punctuation">;</span>

创建用户，指定老的加密方式
mysql<span class="token operator">&gt;</span> create user <span class="token string">'root3'</span>@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'12345678'</span><span class="token punctuation">;</span>

利用sqlyog连接报错，连接失败：
原因：因为连接的数据库服务是MySQL <span class="token number">8.0</span> 最新版本数据库
      最新版本数据库密码加密方式变更了
早期版本：密码加密方式-- mysql_native_password  -- 密文信息容易被破解（弱口令密码）
最新版本：密码加密方式-- caching_sha2_password 

客户端                                                        服务端
连接时--用户名（明文比较） 密码<span class="token punctuation">(</span>密文<span class="token punctuation">)</span>                        用户信息 密码信息（密文）
加密方式--mysql_native_password                               caching_sha2_password
加密方式--caching_sha2_password                               mysql_native_password   

<span class="token keyword">select</span> user,host,authentication_string,plugin from mysql.user<span class="token punctuation">\</span>G                 --- 查看用户信息和用户密码，以及加密方式
alter user root2@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'12345678'</span><span class="token punctuation">;</span>   --- 修改密码加密方式
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>03 利用连接驱动程序配合程序语言代码
<span class="token operator">|</span> 01   <span class="token operator">|</span> python <span class="token operator">|</span> 连接数据库驱动-pymysql  <span class="token operator">|</span>
<span class="token operator">|</span> 02   <span class="token operator">|</span> golang <span class="token operator">|</span> 连接数据库驱动-gomysql  <span class="token operator">|</span>
<span class="token operator">|</span> 03   <span class="token operator">|</span> <span class="token function">java</span>   <span class="token operator">|</span> 连接数据库驱动-jar      <span class="token operator">|</span>
<span class="token operator">|</span> 04   <span class="token operator">|</span> php    <span class="token operator">|</span> 连接数据库驱动-phpmysql <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库服务无法进行远程连接，需要进行排查错误：
步骤一：确认网络连通性
<span class="token function">ping</span> 数据库服务器地址 / telnet/nc/nmap 数据库服务器端口
PS：确认网络硬件设备配置 路由器 交换机 防火墙
步骤二：确认服务端配置
是否创建了用户信息和密码信息 白名单信息是否正确
<span class="token keyword">select</span> user,host from mysql.user<span class="token punctuation">;</span>  xiaoQ 
步骤三：确认客户端配置 
用户信息 密码信息（密码的加密方式）-h服务端地址 -P服务端端口
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_5-配置管理"><a href="#_5-配置管理" class="header-anchor">#</a> 5. 配置管理</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库配置文件加载方式：
方式一：MySQL数据库服务有默认加载配置文件信息：
/etc/my.cnf -<span class="token operator">&gt;</span> /etc/mysql/my.cnf -<span class="token operator">&gt;</span> /usr/local/mysql/etc/my.cnf -<span class="token operator">&gt;</span> ~/.my.cnf
方式二：MySQL数据库服务可以手工指定加载配置信息：
mysqld_safe --defaults-file<span class="token operator">=</span>/data/my.cnf <span class="token operator">&amp;</span>
mysqld --defaults-file<span class="token operator">=</span>/data/my.cnf  <span class="token operator">&amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库配置文件编写方法：
客户端标签：<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span> <span class="token punctuation">[</span>mysqladmin<span class="token punctuation">]</span> <span class="token punctuation">[</span>mysqldump<span class="token punctuation">]</span>    <span class="token punctuation">[</span>client<span class="token punctuation">]</span>--全局标签
标签下面会配置客户端的配置信息，可以简化客户端命令参数操作，可以和服务端建立连接
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock

mysql <span class="token parameter variable">--help</span>  -- 显示所有的客户端标签配置项

------------------------------------
客户端标签的配置：
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token number">12345678</span>
default-character-set<span class="token operator">=</span>utf8mb4
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
skip-name-resolve
character-set-server<span class="token operator">=</span>utf8mb4
------------------------------------
配置 <span class="token punctuation">[</span>mysqladmin<span class="token punctuation">]</span>标签 
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token number">12345678</span>
default-character-set<span class="token operator">=</span>utf8mb4
<span class="token punctuation">[</span>mysqladmin<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
skip-name-resolve
character-set-server<span class="token operator">=</span>utf8mb4

<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysqladmin -uroot -p12345678 password '123456'</span>
mysqladmin: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
mysqladmin: connect to server at <span class="token string">'localhost'</span> failed
error: <span class="token string">'Can'</span>t connect to <span class="token builtin class-name">local</span> MySQL server through socket <span class="token string">'/tmp/mysql.sock'</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token string">'
Check that mysqld is running and that the socket: '</span>/tmp/mysql.sock<span class="token string">' exists!

修改：
[root@db-01 ~]# cat /etc/my.cnf 
[mysql]
socket=/tmp/mysql80.sock
user=root
password=12345678
default-character-set=utf8mb4
[mysqladmin]
socket=/tmp/mysql80.sock
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql80.sock
skip-name-resolve
character-set-server=utf8mb4

[root@db-01 ~]# mysqladmin -uroot -p12345678 password '</span><span class="token number">123456</span>'
mysqladmin: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
Warning: Since password will be sent to server <span class="token keyword">in</span> plain text, use ssl connection to ensure password safety.
------------------------------------
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>root
<span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token number">12345678</span>
default-character-set<span class="token operator">=</span>utf8mb4
<span class="token punctuation">[</span>mysqladmin<span class="token punctuation">]</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
skip-name-resolve
character-set-server<span class="token operator">=</span>utf8mb4
------------------------------------

服务端标签：<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span> <span class="token punctuation">[</span>mysqld_safe<span class="token punctuation">]</span>              <span class="token punctuation">[</span>server<span class="token punctuation">]</span>--全局标签
标签下面会配置客户端的配置信息，可以永久激活服务端某些功能
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql                 --- 指定数据库服务进程用户
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql   --- 加载的程序目录信息
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data    --- 加载数据库数据目录
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock     --- 实现数据库本地连接
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3307</span>                  --- 修改数据库服务默认端口
<span class="token assign-left variable">super_read_only</span><span class="token operator">=</span>on         --- 设置管理员管理数据库只读操作

mysqld <span class="token parameter variable">--help</span> <span class="token parameter variable">--verbose</span>

----------------------------------
配置如下：
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
default-character-set<span class="token operator">=</span>utf8mb4
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql80.sock
skip-name-resolve
character-set-server<span class="token operator">=</span>utf8mb4

----------------------------------
客户端和服务端建立本地连接，需要配合正确socket信息：
方式一：客户端连接指定-S信息
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql80.sock

如果不指定，需要在客户端标签下面配置
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql01.sock
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><h3 id="_6-多实例"><a href="#_6-多实例" class="header-anchor">#</a> 6. 多实例</h3> <p><img src="/devops/public/assets/img/1729642012062.1c8a85b5.png" alt="1729642012062"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>什么是数据库实例：
功能应用方面：在一个系统环境中，运行启动多个数据库服务的进程
资源利用方面：一个程序运行之后，程序运行的后的进程以及程序加载数据信息独占内存资源
               MySQL实例 <span class="token operator">=</span> mysqld + master thread监控管理 + 具体干活的thread + 预分配的内存结构`
               
多个数据库服务实例信息中存储的数据库信息是相互隔离和独立的，并且利用数据库服务多实例可以实现测试与分布式架构需求；企业数据库服务多实例应用架构设计：（主要用于支持多套业务场景）


构建多实例功能：
<span class="token number">1</span>）可以节省硬件成本
<span class="token number">2</span>）可以保证服务稳定
<span class="token number">3</span>）可以便于监控管理
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/devops/public/assets/img/1729642202182.4c75f8fa.png" alt="1729642202182"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>如何搭建数据库多实例（同版本多实例  不同版本多实例）
步骤一：下载数据库服务程序
mysql <span class="token number">8.0</span>  mysql-8.0.32-linux-glibc2.12-x86_64.tar.xz
mysql <span class="token number">5.7</span>  mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz
mysql <span class="token number">5.6</span>  mysql-5.6.48-linux-glibc2.12-x86_64.tar.gz

步骤二：安装数据库服务程序
mysql <span class="token number">8.0</span> 省略
mysql <span class="token number">5.7</span> 
<span class="token function">tar</span> xf mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz 
<span class="token function">ln</span> <span class="token parameter variable">-s</span> mysql-5.7.30-linux-glibc2.12-x86_64 mysql57

mysql <span class="token number">5.6</span>
<span class="token function">tar</span> xf mysql-5.6.48-linux-glibc2.12-x86_64.tar.gz
<span class="token function">ln</span> <span class="token parameter variable">-s</span> mysql-5.6.48-linux-glibc2.12-x86_64 mysql56

步骤三：构建多实例环境（4不同-数据目录 配置文件 端口 socket）
创建不同的存储目录
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/3306/data <span class="token operator">&amp;&amp;</span> <span class="token function">chown</span> mysql.mysql /data/3306/data
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/3357/data <span class="token operator">&amp;&amp;</span> <span class="token function">chown</span> mysql.mysql /data/3357/data
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/3356/data <span class="token operator">&amp;&amp;</span> <span class="token function">chown</span> mysql.mysql /data/3356/data

创建不同的配置文件，配置文件中端口不同 socket信息不同
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/data/3306/my.cnf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[client]
socket=/tmp/mysql.sock
[mysqld]
port=3306
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/data/3357/my.cnf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mysqld]
port=3357
user=mysql
basedir=/usr/local/mysql57
datadir=/data/3357/data
socket=/tmp/mysql57.sock
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/data/3356/my.cnf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mysqld]
port=3356
user=mysql
basedir=/usr/local/mysql56
datadir=/data/3356/data
socket=/tmp/mysql56.sock
EOF</span>

步骤四：进行数据库服务初始化过程
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /data/3306/data/*
<span class="token function">mv</span> /etc/my.cnf /tmp/
mysqld --initialize-insecure <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql 

<span class="token builtin class-name">echo</span> <span class="token variable">$?</span>

/usr/local/mysql57/bin/mysqld  --initialize-insecure <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3357/data <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql57 

<span class="token builtin class-name">echo</span> <span class="token variable">$?</span>

/usr/local/mysql56/scripts/mysql_install_db <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3356/data <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql56

<span class="token builtin class-name">echo</span> <span class="token variable">$?</span>

步骤五：启动多实例环境数据库服务
命令方式启动：mysqld mysqld_safe systemctl 

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/etc/systemd/system/mysql80.service<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=mysql
Group=mysql
ExecStart=/usr/local/mysql/bin/mysqld --defaults-file=/data/3306/my.cnf
LimitNOFILE=5000
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/etc/systemd/system/mysql57.service<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=mysql
Group=mysql
ExecStart=/usr/local/mysql57/bin/mysqld --defaults-file=/data/3357/my.cnf
LimitNOFILE=5000
EOF</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span>/etc/systemd/system/mysql56.service<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=mysql
Group=mysql
ExecStart=/usr/local/mysql56/bin/mysqld --defaults-file=/data/3356/my.cnf
LimitNOFILE=5000
EOF</span>

<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># systemctl start mysql80</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># systemctl start mysql57</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># systemctl start mysql56</span>
<span class="token punctuation">[</span>root@db-01 local<span class="token punctuation">]</span><span class="token comment"># netstat -lntup|grep mysql</span>
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3356                 :::*                    LISTEN      <span class="token number">4756</span>/mysqld         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3357                 :::*                    LISTEN      <span class="token number">4722</span>/mysqld         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::33060                :::*                    LISTEN      <span class="token number">4670</span>/mysqld         
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::3306                 :::*                    LISTEN      <span class="token number">4670</span>/mysqld   


多实例本地连接登录
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-S</span> /tmp/mysql57.sock
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-S</span> /tmp/mysql56.sock

-----------------------------------------
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysqladmin -uroot password &quot;123456&quot;</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456 -S /tmp/mysql.sock</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># /usr/local/mysql57/bin/mysqladmin -uroot password &quot;123456&quot; -S /tmp/mysql57.sock</span>
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># /usr/local/mysql56/bin/mysqladmin -uroot password &quot;123456&quot; -S /tmp/mysql56.sock</span>

再去连接时，就需要密码了。
-----------------------------------------

创建一个root2用户，拥有root的权限，然后使用sqlyog去连接。
mysql<span class="token operator">&gt;</span> create user <span class="token string">'root2'</span>@<span class="token string">'%'</span> identified by <span class="token string">'12345678'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
mysql<span class="token operator">&gt;</span> grant all on *.* to root2@<span class="token string">'%'</span> with grant option<span class="token punctuation">;</span>

-----------------------------------------
远程连接登录
mysql <span class="token parameter variable">-uroot2</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-h10.0.0.51</span> <span class="token parameter variable">-P3306</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br></div></div><h2 id="四-sql"><a href="#四-sql" class="header-anchor">#</a> 四，SQL</h2> <h3 id="_1-语句分类"><a href="#_1-语句分类" class="header-anchor">#</a> 1. 语句分类</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>SQL语句 - 英文全称为Structured Query Language，中文意思是结构化查询语言（属于编程语言）；
在使用SQL语句时，也会用到几种常用的标准：SQL <span class="token number">89</span>  SQL <span class="token number">92</span>（命令语法过于繁琐，不便于阅读）  SQL <span class="token number">99</span> （命令语法简洁 便于阅读）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- DDL Data Definition Language（数据定义语言）<span class="token punctuation">(</span>慎用-损坏数据 影响业务<span class="token punctuation">)</span>

- 概念介绍：负责管理数据库的基础数据（不会对表的内容修改），比如增删库、增删表、增删索引、增删用户等；
- 涉及语句： CREATE（创建）、ALTER（修改）、DROP（删除）`等；

关注人群：
- 运维人员和开发人员都要熟悉。

相关具体的DDL负责的操作行为，可以执行以下命令进行查看：
mysql<span class="token operator">&gt;</span> ? Data Definition<span class="token punctuation">;</span>
-- 查看获取DDL语言的操作行为
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- DCL Data Control Language（数据控制语言）
- 概念介绍： 主要用来定义访问权限和安全级别

涉及语句：
<span class="token variable"><span class="token variable">`</span>GRANT（用户授权）、REVOKE（权限回收）、COMMIT（提交）、ROLLBACK（回滚）<span class="token variable">`</span></span>
关注人群：
- 运维人员需要熟练,开发也需要了解 
相关具体的DCL负责的操作行为，可以执行以下命令进行查看：

mysql<span class="token operator">&gt;</span> ? Account Management
-- 查看获取DCL语言的操作行为
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- DML Data Manipulation Language（数据操作语言）（慎用-数据损坏-备份信息做恢复）
概念介绍：
主要针对数据库里的表里的数据进行操作，用来定义数据库记录（数据）；
涉及语句：
<span class="token variable"><span class="token variable">`</span>SELECT（查）、INSERT（增）、DELETE（删）、UPDATE（改）<span class="token variable">`</span></span>
关注人群：
开发人员要熟练，运维人员熟悉即可
相关具体的DML负责的操作行为，可以执行以下命令进行查看：
mysql<span class="token operator">&gt;</span> ? Data Manipulation
-- 查看获取DML语言的操作行为
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- DQL Data Query Language（数据查询语言）**
- 概念介绍：主要用来查询记录（数据）

- 涉及语句：SELECT（查）
	基本结构是由SELECT子句，FROM子句，WHERE子句组成的查询块
关注人群：
- 运维人员和开发人员都要熟悉。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-字符设置"><a href="#_2-字符设置" class="header-anchor">#</a> 2. 字符设置</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>设置字符集作用：避免表中中文数据出现乱码（5.6 <span class="token number">5.7</span>）  
设置修改字符集：
永久修改：
<span class="token function">vim</span> /etc/my.cnf 
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
character-set-server<span class="token operator">=</span>utf8mb4    -- 修改旧版本数据库服务（5.7 <span class="token number">5.6</span> <span class="token number">5.5</span> <span class="token number">8.0</span>）
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
default-character-set<span class="token operator">=</span>utf8mb4   -- 修改新版本数据库服务（8.0）
<span class="token comment"># 修改了配置文件后，重启mysql</span>
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysql</span>

临时修改：
mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> global <span class="token assign-left variable">character_set_server</span><span class="token operator">=</span><span class="token string">'utf8mb3'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


如果已经出现乱码信息，如何处理：utf8
步骤一：需要进行数据库备份（逻辑备份）
mysqldump 
步骤二：将数据库字符集进行修改
永久修改/临时修改
步骤三：需要删除库或者表信息
步骤四：创建数据库或者数据表
步骤五：恢复迁移数据

utf8mb3：最多存储3字节长度字符                 	张-3字节
utf8mb4：最多存储4字节长度字符（表情字符emoji） 	张-4字节
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_3-数据类型"><a href="#_3-数据类型" class="header-anchor">#</a> 3. 数据类型</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建数据表时,需要指定数据类型；
功能作用：
01 保证数据存储的合理性
02 保证数据存储占用磁盘的合理性
03 保证数据检索的效率

数据库中常见数据类型：
https://m.php.cn/article/460317.html
整数类型：
tinyint<span class="token punctuation">(</span>m<span class="token punctuation">)</span>		<span class="token number">1</span>个字节  范围<span class="token punctuation">(</span>-128~127      <span class="token number">0</span>-255<span class="token punctuation">)</span>          00000000 <span class="token number">2</span>的8次方  <span class="token number">256</span>
smallint<span class="token punctuation">(</span>m<span class="token punctuation">)</span>		<span class="token number">2</span>个字节  范围<span class="token punctuation">(</span>-32768~32767  <span class="token number">0</span>-65535<span class="token punctuation">)</span>                 <span class="token number">2</span>的16次方
mediumint<span class="token punctuation">(</span>m<span class="token punctuation">)</span>	<span class="token number">3</span>个字节  范围<span class="token punctuation">(</span>-8388608~8388607<span class="token punctuation">)</span>
int<span class="token punctuation">(</span>m<span class="token punctuation">)</span>	        <span class="token number">4</span>个字节  范围<span class="token punctuation">(</span>-2147483648~2147483647<span class="token punctuation">)</span>
bigint<span class="token punctuation">(</span>m<span class="token punctuation">)</span>	    <span class="token number">8</span>个字节  范围<span class="token punctuation">(</span>+-9.22*10的18次方<span class="token punctuation">)</span>

小数类型：
float<span class="token punctuation">(</span>m,d<span class="token punctuation">)</span>      单精度浮点型    <span class="token number">8</span>位精度<span class="token punctuation">(</span><span class="token number">4</span>字节<span class="token punctuation">)</span>     m总个数，d小数位

字符串类型：
char<span class="token punctuation">(</span>n<span class="token punctuation">)</span>	        固定长度，最多255个字符   
varchar<span class="token punctuation">(</span>n<span class="token punctuation">)</span>	    变长长度，最多65535个字符
tinytext	    可变长度，最多255个字符
text	        可变长度，最多65535个字符
mediumtext	    可变长度，最多2的24次方-1个字符
longtext	    可变长度，最多2的32次方-1个字符

定长字符：根据数据类型的定义，占用固定存储空间；
变长字符：根据具体数据的内容，灵活占用存储空间；

时间类型：
<span class="token function">date</span>	    日期 <span class="token string">'2008-12-2'</span>
<span class="token function">time</span>	    时间 <span class="token string">'12:25:36'</span>
datetime	日期时间 <span class="token string">'2008-12-2 22:06:44'</span>
timestamp	显示时间戳信息

特殊数据类型：
enum<span class="token punctuation">(</span><span class="token punctuation">)</span>      枚举类型
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_4-约束"><a href="#_4-约束" class="header-anchor">#</a> 4. 约束</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据表的约束信息：（对表中写入的数据做限制）
主键约束：（pk）   限制写的数据不能为空 不能重复（索引列--目录）
唯一约束：（uk）   限制写的数据不能重复
非空约束：（nn）   限制写的数据不能为空
外键约束：（fk）   限制表和表之间的关联操作

主键--主表<span class="token punctuation">(</span>父表<span class="token punctuation">)</span>
create table class<span class="token punctuation">(</span>
<span class="token function">id</span> int primary key auto_increment,                       
name varchar<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> not null comment <span class="token string">&quot;班级名字，不能为空&quot;</span>,
room varchar<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> comment <span class="token string">'教室：允许为空'</span>
<span class="token punctuation">)</span> charset utf8<span class="token punctuation">;</span>

外键--附表<span class="token punctuation">(</span>子表<span class="token punctuation">)</span>
create table student<span class="token punctuation">(</span>
<span class="token function">id</span> int primary key auto_increment,
number char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> not null unique comment <span class="token string">&quot;学号：不能重复&quot;</span>,   
name varchar<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> not null comment <span class="token string">&quot;姓名&quot;</span>,
c_id int,                                                   
foreign key<span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> references class<span class="token punctuation">(</span>id<span class="token punctuation">)</span> 
<span class="token punctuation">)</span> charset utf8<span class="token punctuation">;</span>

外键约束一：当主表没有进行数据录入时，子表不能先录入数据；
mysql<span class="token operator">&gt;</span> insert into student values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'20249601'</span>,<span class="token string">'李明'</span>,<span class="token string">'96'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR <span class="token number">1452</span> <span class="token punctuation">(</span><span class="token number">23000</span><span class="token punctuation">)</span>: Cannot <span class="token function">add</span> or update a child row: a foreign key constraint fails <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>new_schema<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span>, CONSTRAINT <span class="token variable"><span class="token variable">`</span>student_ibfk_1<span class="token variable">`</span></span> FOREIGN KEY <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>c_id<span class="token variable">`</span></span><span class="token punctuation">)</span> REFERENCES <span class="token variable"><span class="token variable">`</span>class<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">))</span>
外键约束二：当子表中数据没有删除时，不能先删除主表中数据<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> insert into student values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'20249601'</span>,<span class="token string">'李明'</span>,<span class="token string">'96'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR <span class="token number">1452</span> <span class="token punctuation">(</span><span class="token number">23000</span><span class="token punctuation">)</span>: Cannot <span class="token function">add</span> or update a child row: a foreign key constraint fails <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>new_schema<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span>, CONSTRAINT <span class="token variable"><span class="token variable">`</span>student_ibfk_1<span class="token variable">`</span></span> FOREIGN KEY <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>c_id<span class="token variable">`</span></span><span class="token punctuation">)</span> REFERENCES <span class="token variable"><span class="token variable">`</span>class<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">))</span>


数据表的属性信息：<span class="token punctuation">(</span>便于管理数据表 对约束信息的补充<span class="token punctuation">)</span>
default         -- 可以填充默认值信息   insert into new_table <span class="token punctuation">(</span>id,name<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">6</span>,<span class="token string">'xiaoD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
auto_increment  -- 可以实现主键列信息自动排序自增 <span class="token punctuation">(</span>保证了主键列的唯一和非空特性 以及可以便于做索引列使用<span class="token punctuation">)</span>
comment         -- 注释信息（便于属于业务环境）
unsigned        -- 进行非负设置（对整数类型数据做补充）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_5-模式概念"><a href="#_5-模式概念" class="header-anchor">#</a> 5. 模式概念</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>保证录入数据符合常识

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@sql_mode<span class="token punctuation">;</span>
+-----------------------------------------------------------------------------------------------------------------------+
<span class="token operator">|</span> @@sql_mode                                                                                                            <span class="token operator">|</span>
+-----------------------------------------------------------------------------------------------------------------------+
<span class="token operator">|</span> ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION <span class="token operator">|</span>
+-----------------------------------------------------------------------------------------------------------------------+

ONLY_FULL_GROUP_BY            --- 禁止一行信息对应多行信息显示输出（在表进行分组处理时）
STRICT_TRANS_TABLES           --- 录入的数据信息，超过数据类型的限制后，会自动录入失败
NO_ZERO_IN_DATE,NO_ZERO_DATE  --- 录入的日期信息，不可能出现0000-00-00 
ERROR_FOR_DIVISION_BY_ZERO    --- 当出现数值运算，不能出现除数为0的运算  

错误案例：低版本数据库服务数据迁移高版本数据库时，迁移失败；
低版本数据库中，sql_mode配置信息更简单；
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@sql_mode<span class="token punctuation">;</span>
+------------------------+
<span class="token operator">|</span> @@sql_mode             <span class="token operator">|</span>
+------------------------+
<span class="token operator">|</span> NO_ENGINE_SUBSTITUTION <span class="token operator">|</span>
+------------------------+

学生表：学生出生信息 0000-00-00

将低版本数据迁移到高版本数据库中（逻辑迁移）  -- 调整为物理迁移
insert into student values <span class="token punctuation">(</span>0000-00-00<span class="token punctuation">)</span>  ---<span class="token operator">&gt;</span> mysql <span class="token number">8.0</span> 执行 报错

解决问题：将高版本数据库服务的sql_mode功能关闭，在进行数据迁移；
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">sql_mode</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_6-ddl-库-表"><a href="#_6-ddl-库-表" class="header-anchor">#</a> 6. DDL 库 表</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>利用数据库帮助信息，获取命令使用方法：
help/？ 命令信息

Syntax:
CREATE <span class="token punctuation">{</span>DATABASE <span class="token operator">|</span> SCHEMA<span class="token punctuation">}</span> <span class="token punctuation">[</span>IF NOT EXISTS<span class="token punctuation">]</span> db_name <span class="token punctuation">[</span>create_specification<span class="token punctuation">]</span> <span class="token punctuation">..</span>.

<span class="token punctuation">{</span><span class="token punctuation">}</span> 				-- 可挑选的内容（必须有一个选择）
<span class="token punctuation">[</span><span class="token punctuation">]</span> 				-- 可选设置
大写  			-- 必须要写正确的指令信息
小写  			-- 是用户可以自定义（不要定义一些关键字符）
结尾的中括号 	-- 补充设置信息 

create_specification:
    <span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span> CHARACTER SET <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> charset_name
  <span class="token operator">|</span> <span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span> COLLATE <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> collation_name



数据库相关操作语句：
创建：
mysql <span class="token operator">&gt;</span> create database malu<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> create schema malu<span class="token punctuation">;</span>
-- 创建新的数据库
mysql <span class="token operator">&gt;</span> create database malu character <span class="token builtin class-name">set</span> utf8mb4<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> create database malu charset utf8 collate utf8_general_mysql500_ci<span class="token punctuation">;</span>

查看：
mysql <span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
-- 查看所有数据库信息
mysql <span class="token operator">&gt;</span> show databases like <span class="token string">'%jd%'</span><span class="token punctuation">;</span>
-- 检索查看指定的数据库信息
mysql <span class="token operator">&gt;</span> show create database malu<span class="token punctuation">;</span>
-- 查看创建库的语句信息

修改：
mysql <span class="token operator">&gt;</span> alter database <span class="token builtin class-name">test</span> charset utf8mb4<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> alter database <span class="token builtin class-name">test</span> charset utf8 collate utf8_general_mysql500_ci<span class="token punctuation">;</span>
-- 修改数据库服务字符集编码信息与字符编码排序规则信息

删除：（慎用）
mysql <span class="token operator">&gt;</span> drop database <span class="token builtin class-name">test</span><span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> drop schema	<span class="token builtin class-name">test</span><span class="token punctuation">;</span>
-- 删除数据库信息（在生产环境一定慎用）

切换：
mysql <span class="token operator">&gt;</span> use jdsc              -- <span class="token builtin class-name">cd</span> 目录
-- 在已有数据库之间进行切换
mysql <span class="token operator">&gt;</span> <span class="token keyword">select</span> database<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     -- <span class="token builtin class-name">pwd</span>
-- 调用函数信息，获取切换后的数据库名称


数据表相关操作语句：
创建：
CREATE TABLE student <span class="token punctuation">(</span>
  <span class="token function">id</span> int NOT NULL COMMENT <span class="token string">'学号信息'</span>,
  name varchar<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'学生名'</span>,
  age tinyint unsigned NOT NULL COMMENT <span class="token string">'学生年龄'</span>,
  gender enum<span class="token punctuation">(</span><span class="token string">'M'</span>,<span class="token string">'F'</span>,<span class="token string">'N'</span><span class="token punctuation">)</span> NOT NULL DEFAULT <span class="token string">'N'</span> COMMENT <span class="token string">'学生性别'</span>,
  PRIMARY KEY <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token assign-left variable">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci <span class="token assign-left variable">COMMENT</span><span class="token operator">=</span><span class="token string">'学生表'</span> <span class="token punctuation">;</span>
PS：数据库引擎 innnodb <span class="token assign-left variable">myisam</span><span class="token operator">==</span>操作系统中的文件系统 ext4 xfs fat32 ntfs

查看： 
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show tables like <span class="token string">'%xiao%'</span><span class="token punctuation">;</span>
-- 查看数据表信息是否存在
mysql<span class="token operator">&gt;</span> desc student<span class="token punctuation">;</span>   -- ll
+--------+-------------------+------+-----+---------+-------+
<span class="token operator">|</span> Field  <span class="token operator">|</span> Type              <span class="token operator">|</span> Null <span class="token operator">|</span> Key <span class="token operator">|</span> Default <span class="token operator">|</span> Extra <span class="token operator">|</span>
+--------+-------------------+------+-----+---------+-------+
<span class="token operator">|</span> <span class="token function">id</span>     <span class="token operator">|</span> int               <span class="token operator">|</span> NO   <span class="token operator">|</span> PRI <span class="token operator">|</span> NULL    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> name   <span class="token operator">|</span> varchar<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span>       <span class="token operator">|</span> NO   <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> age    <span class="token operator">|</span> tinyint unsigned  <span class="token operator">|</span> NO   <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> gender <span class="token operator">|</span> enum<span class="token punctuation">(</span><span class="token string">'M'</span>,<span class="token string">'F'</span>,<span class="token string">'N'</span><span class="token punctuation">)</span> <span class="token operator">|</span> NO   <span class="token operator">|</span>     <span class="token operator">|</span> N       <span class="token operator">|</span>       <span class="token operator">|</span>
+--------+-------------------+------+-----+---------+-------+
-- 查看表结构信息
mysql<span class="token operator">&gt;</span> show create table student<span class="token punctuation">;</span>
<span class="token operator">|</span> student <span class="token operator">|</span> CREATE TABLE <span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span> <span class="token punctuation">(</span>
  <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> int NOT NULL COMMENT <span class="token string">'学号信息'</span>,
  <span class="token variable"><span class="token variable">`</span>name<span class="token variable">`</span></span> varchar<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'学生名'</span>,
  <span class="token variable"><span class="token variable">`</span>age<span class="token variable">`</span></span> tinyint unsigned NOT NULL COMMENT <span class="token string">'学生年龄'</span>,
  <span class="token variable"><span class="token variable">`</span>gender<span class="token variable">`</span></span> enum<span class="token punctuation">(</span><span class="token string">'M'</span>,<span class="token string">'F'</span>,<span class="token string">'N'</span><span class="token punctuation">)</span> NOT NULL DEFAULT <span class="token string">'N'</span> COMMENT <span class="token string">'学生性别'</span>,
  PRIMARY KEY <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token assign-left variable">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci <span class="token assign-left variable">COMMENT</span><span class="token operator">=</span><span class="token string">'学生表'</span>   
-- 查看数据表创建过程


修改： 
mysql <span class="token operator">&gt;</span> <span class="token function">rename</span> table student to student02<span class="token punctuation">;</span>
或者
mysql <span class="token operator">&gt;</span> alter table student02 <span class="token function">rename</span> student<span class="token punctuation">;</span>
-- 修改表名称

mysql <span class="token operator">&gt;</span> alter table stu1 charset utf8mb4<span class="token punctuation">;</span>
-- 修改表字符集

<span class="token comment"># 添加字段：</span>
alter table student <span class="token function">add</span> <span class="token function">column</span> telno char<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> not null unique key comment <span class="token string">'手机号'</span><span class="token punctuation">;</span>
-- 添加字段到最后一列
alter table student <span class="token function">add</span> <span class="token function">column</span> wechat varchar<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> not null unique key comment <span class="token string">'微信号'</span> after name<span class="token punctuation">;</span>
-- 插入字段到指定列之后
alter table student <span class="token function">add</span> <span class="token function">column</span> sid int not null unique key comment <span class="token string">'学号'</span> first<span class="token punctuation">;</span>
-- 添加字段到首行

<span class="token comment"># 删除字段：</span>
alter table student drop <span class="token function">column</span> sid<span class="token punctuation">;</span>

<span class="token comment"># 修改字段：修改字段名称 修改字段数据类型 修改字段约束和属性</span>
ALTER TABLE <span class="token variable"><span class="token variable">`</span>xiaoA<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span>  CHANGE COLUMN <span class="token variable"><span class="token variable">`</span>telno<span class="token variable">`</span></span> <span class="token variable"><span class="token variable">`</span>mobilenum<span class="token variable">`</span></span> CHAR<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL unique key COMMENT <span class="token string">'手机号'</span> <span class="token punctuation">;</span>
-- 修改名称

ALTER TABLE <span class="token variable"><span class="token variable">`</span>xiaoA<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span>  CHANGE COLUMN mobilenum VARCHAR<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> NOT NULL unique key COMMENT <span class="token string">'手机号'</span> <span class="token punctuation">;</span>
-- 修改数据类型

ALTER TABLE <span class="token variable"><span class="token variable">`</span>xiaoA<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span>  CHANGE COLUMN <span class="token variable"><span class="token variable">`</span>mobilenum<span class="token variable">`</span></span> VARCHAR<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token string">'110'</span> COMMENT <span class="token string">'手机号'</span> <span class="token punctuation">;</span>
-- 修改字段约束属性信息
-- 修改表的字段信息

删除：
删除表中数据：
delete from student<span class="token punctuation">;</span>
truncate table student<span class="token punctuation">;</span>

删除数据表： 
mysql<span class="token operator">&gt;</span> drop table student<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br></div></div><h3 id="_7-dml"><a href="#_7-dml" class="header-anchor">#</a> 7. DML</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>增：insert 

插入数据标准写法
insert into student<span class="token punctuation">(</span>表名<span class="token punctuation">)</span> <span class="token punctuation">(</span>列名01,列名02,列名03<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>  values <span class="token punctuation">(</span>数值01,数据值02,数值03,<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span><span class="token punctuation">;</span>

插入数据简化写法（不用填写列值信息--自增列 空值列 默认值列）
insert into student<span class="token punctuation">(</span>表名<span class="token punctuation">)</span> <span class="token punctuation">(</span>必须填写的列信息<span class="token punctuation">)</span> values <span class="token punctuation">(</span>必须填写的列值<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into student<span class="token punctuation">(</span>表名<span class="token punctuation">)</span> values <span class="token punctuation">(</span>数值01,数据值02,数值03,<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>

批量插入数据
insert into student<span class="token punctuation">(</span>表名<span class="token punctuation">)</span> values <span class="token punctuation">(</span>数值01,数据值02,数值03,<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>,<span class="token punctuation">(</span>数值01,数据值02,数值03,<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span>,<span class="token punctuation">(</span>数值01,数据值02,数值03,<span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">..</span>


创建数据库：
create database test01<span class="token punctuation">;</span>

切换数据库：
use test01<span class="token punctuation">;</span>

创建表的：
CREATE TABLE student <span class="token punctuation">(</span>
  <span class="token function">id</span> int NOT NULL COMMENT <span class="token string">'学号信息'</span>,
  name varchar<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'学生名'</span>,
  age tinyint unsigned NOT NULL COMMENT <span class="token string">'学生年龄'</span>,
  gender enum<span class="token punctuation">(</span><span class="token string">'M'</span>,<span class="token string">'F'</span>,<span class="token string">'N'</span><span class="token punctuation">)</span> NOT NULL DEFAULT <span class="token string">'N'</span> COMMENT <span class="token string">'学生性别'</span>,
  PRIMARY KEY <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token assign-left variable">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci <span class="token assign-left variable">COMMENT</span><span class="token operator">=</span><span class="token string">'学生表'</span> <span class="token punctuation">;</span>

插入数据：
insert into student values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'jiahua'</span>,22,<span class="token string">'M'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">'songyan'</span>,23,<span class="token string">'M'</span><span class="token punctuation">)</span>,<span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">'yujin'</span>,23,<span class="token string">'M'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from student<span class="token punctuation">;</span>
+----+---------+-----+--------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name    <span class="token operator">|</span> age <span class="token operator">|</span> gender <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> jiahua  <span class="token operator">|</span>  <span class="token number">22</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> songyan <span class="token operator">|</span>  <span class="token number">23</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> yujin   <span class="token operator">|</span>  <span class="token number">23</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>删: delete <span class="token punctuation">(</span>小心<span class="token punctuation">)</span>
delete from 表名 where 删除数据条件（唯一的）<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> delete from student where <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'jiahua'</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from student<span class="token punctuation">;</span>
+----+---------+-----+--------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name    <span class="token operator">|</span> age <span class="token operator">|</span> gender <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> songyan <span class="token operator">|</span>  <span class="token number">23</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> yujin   <span class="token operator">|</span>  <span class="token number">23</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>改: update <span class="token punctuation">(</span>小心<span class="token punctuation">)</span> 
update 表名 <span class="token builtin class-name">set</span> 修改的列<span class="token operator">=</span><span class="token string">'修改值'</span> where 修改数据条件（唯一的）<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> update student <span class="token builtin class-name">set</span> <span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">24</span> where <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'yujin'</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
Rows matched: <span class="token number">1</span>  Changed: <span class="token number">1</span>  Warnings: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from student<span class="token punctuation">;</span>
+----+---------+-----+--------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name    <span class="token operator">|</span> age <span class="token operator">|</span> gender <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> songyan <span class="token operator">|</span>  <span class="token number">23</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> yujin   <span class="token operator">|</span>  <span class="token number">24</span> <span class="token operator">|</span> M      <span class="token operator">|</span>
+----+---------+-----+--------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_8-规范"><a href="#_8-规范" class="header-anchor">#</a> 8.规范</h3> <p>数据定义语句定义数据库规范说明：</p> <ul><li>创建数据库名称规范：要和业务有关，不要有大写字母（为了多平台兼容），不要数字开头，不要含有系统关键字信息；</li> <li>创建数据库明确字符：创建数据库时明确（显示）的设置字符集信息，为了避免跨平台兼容性与不同版本兼容性问题；</li> <li>删除数据库操作慎用：在对数据库进行删除操作时，一定要经过严格审计后再进行操作，并且数据库普通用户不能有drop权限；</li></ul> <p>数据定义语句定义数据表规范说明：</p> <ul><li>创建数据表名称规范：要和业务有关（含库前缀），不要有大写字母，不要数字开头，不要含有系统关键字信息，名称不要太长；</li> <li>创建数据表属性规范：属性信息显示设置，引擎选择InnoDB，字符集选择utf8/utf8mb4，表信息添加注释；</li> <li>创建数据列属性规范：名称要有意义，不要含有系统关键字信息，名称不要太长；</li> <li>创建数据类型的规范：数据类型选择合适的、足够的、简短的；</li> <li>创建数据约束的规范：每个表中必须都要有主键，最好是和业务无关列，实现自增功能，建议每个列都非空（避免索引失效）/加注释</li> <li>删除数据表操作规范：对于普通用户不能具有删表操作，需要操作删表时需要严格审核 drop alter</li> <li>修改数据表结构规范：在数据库8.0之前，修改数据表结构需要在业务不繁忙时进行，否则会产生严重的锁</li></ul> <h3 id="_9-dql"><a href="#_9-dql" class="header-anchor">#</a> 9.DQL</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 01 获取数据库服务配置信息<span class="token punctuation">(</span>变量信息<span class="token punctuation">)</span>
数据库中存在两种类型的变量：
功能变量：可以修改调整数据库服务功能设置
https://dev.mysql.com/doc/refman/8.4/en/dynindex-sysvar.html<span class="token comment">#sysvar-index-L</span>
状态变量：可以获取数据库服务运行状态信息 
https://dev.mysql.com/doc/refman/8.4/en/dynindex-statvar.html

查看变量方法：
show variables like <span class="token string">'%变量名%'</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'log_bin'</span><span class="token punctuation">;</span>
+---------------+-------+
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> Value <span class="token operator">|</span>
+---------------+-------+
<span class="token operator">|</span> log_bin       <span class="token operator">|</span> ON    <span class="token operator">|</span>
+---------------+-------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span>
+---------------------------------+------------------------------+
<span class="token operator">|</span> Variable_name                   <span class="token operator">|</span> Value                        <span class="token operator">|</span>
+---------------------------------+------------------------------+
<span class="token operator">|</span> log_bin                         <span class="token operator">|</span> ON                           <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_basename                <span class="token operator">|</span> /data/3306/data/binlog       <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_index                   <span class="token operator">|</span> /data/3306/data/binlog.index <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_trust_function_creators <span class="token operator">|</span> OFF                          <span class="token operator">|</span>
<span class="token operator">|</span> log_bin_use_v1_row_events       <span class="token operator">|</span> OFF                          <span class="token operator">|</span>
<span class="token operator">|</span> sql_log_bin                     <span class="token operator">|</span> ON                           <span class="token operator">|</span>
+---------------------------------+------------------------------+
<span class="token number">6</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@log_bin<span class="token punctuation">;</span>
+-----------+
<span class="token operator">|</span> @@log_bin <span class="token operator">|</span>
+-----------+
<span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>
+-----------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


<span class="token keyword">select</span> @@log_bin_index<span class="token punctuation">;</span>

<span class="token keyword">select</span> @@port<span class="token punctuation">;</span>
<span class="token keyword">select</span> @@socket<span class="token punctuation">;</span>
<span class="token keyword">select</span> @@innodb_flush_log_at_trx_commit<span class="token punctuation">;</span> （功能变量-影响数据存储安全性-双一配置）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>如何设置功能变量：
永久设置：（数据库服务重启依然生效 不会立即生效）
<span class="token function">vim</span> /etc/my.cnf 
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
变量信息<span class="token operator">=</span>变量值
<span class="token assign-left variable">innodb_flush_log_at_trx_commit</span><span class="token operator">=</span><span class="token number">2</span>

临时设置：<span class="token punctuation">(</span>数据库服务重启失效 立即临时生效<span class="token punctuation">)</span>
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">innodb_flush_log_at_trx_commit</span><span class="token operator">=</span><span class="token number">2</span>  -- 全局级别临时设置（会话断开依然生效 会影响所有用户） 环境变量 -- /etc/profile /etc/bashrc
<span class="token builtin class-name">set</span> session <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                   -- 会话级别临时设置（会话断开失效 会影响当前用户） 环境变量 -- ~/.bashrc ~.bash_profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 02 调取数据库服务函数信息
数据库函数信息：
https://dev.mysql.com/doc/refman/8.4/en/dynindex-function.html

<span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sum<span class="token punctuation">(</span><span class="token punctuation">)</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span> avg<span class="token punctuation">(</span><span class="token punctuation">)</span> max<span class="token punctuation">(</span><span class="token punctuation">)</span> min<span class="token punctuation">(</span><span class="token punctuation">)</span> group_concat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> root2            <span class="token operator">|</span> %         <span class="token operator">|</span>
<span class="token operator">|</span> mysql.infoschema <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.session    <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.sys        <span class="token operator">|</span> localhost <span class="token operator">|</span>
<span class="token operator">|</span> root             <span class="token operator">|</span> localhost <span class="token operator">|</span>
+------------------+-----------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> concat<span class="token punctuation">(</span>user,<span class="token string">'@'</span>,host<span class="token punctuation">)</span> from mysql.user<span class="token punctuation">;</span>
+----------------------------+
<span class="token operator">|</span> concat<span class="token punctuation">(</span>user,<span class="token string">'@'</span>,host<span class="token punctuation">)</span>      <span class="token operator">|</span>
+----------------------------+
<span class="token operator">|</span> root2@%                    <span class="token operator">|</span>
<span class="token operator">|</span> mysql.infoschema@localhost <span class="token operator">|</span>
<span class="token operator">|</span> mysql.session@localhost    <span class="token operator">|</span>
<span class="token operator">|</span> mysql.sys@localhost        <span class="token operator">|</span>
<span class="token operator">|</span> root@localhost             <span class="token operator">|</span>
+----------------------------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 03 获取数据表中数据信息
单表数据信息查看：select + from + where + group by + having + order by + limit<span class="token punctuation">;</span>

创建测试数据：
https://dev.mysql.com/doc/index-other.html
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456 -S /tmp/mysql.sock &lt;world.sql   -- 导入测试数据</span>

mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">|</span> test01             <span class="token operator">|</span>
<span class="token operator">|</span> world              <span class="token operator">|</span>
+--------------------+
<span class="token number">6</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> use world<span class="token punctuation">;</span>
Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names
You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>

Database changed
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+-----------------+
<span class="token operator">|</span> Tables_in_world <span class="token operator">|</span>
+-----------------+
<span class="token operator">|</span> city            <span class="token operator">|</span>
<span class="token operator">|</span> country         <span class="token operator">|</span>
<span class="token operator">|</span> countrylanguage <span class="token operator">|</span>
+-----------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span><span class="token punctuation">)</span> 基础查看数据方法
<span class="token keyword">select</span> * from 表<span class="token punctuation">;</span>                    -- 企业中小心使用
<span class="token keyword">select</span> 字段名01,字段名02 from 表名<span class="token punctuation">;</span>

<span class="token keyword">select</span> + from + where<span class="token punctuation">;</span>
方式一：定义等值条件信息进行数据查询
<span class="token comment"># 查询中国的所有城市信息，中国代码信息 ”CHN”</span>
<span class="token keyword">select</span> name from city where <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span>
<span class="token comment"># 查询中国的所有城市信息，只关注城市名称和人口数量列信息</span>
<span class="token keyword">select</span> name,population FROM city WHERE <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span>

方式二：定义区间条件信息进行数据查询
<span class="token operator">&gt;</span> <span class="token operator">&lt;</span> <span class="token operator">&gt;=</span> <span class="token operator">&lt;=</span> <span class="token operator">&lt;&gt;</span>/<span class="token operator">!=</span>
<span class="token comment"># 查询大于700万人的所有城市信息</span>
<span class="token keyword">select</span> name,countrycode,population from city where population<span class="token operator">&gt;</span><span class="token number">7000000</span><span class="token punctuation">;</span>
<span class="token comment"># 查询小于等于1000人的所有城市信息</span>
SELECT * FROM city WHERE population<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>

SELECT * FROM city WHERE population<span class="token operator">&lt;=</span><span class="token number">1000</span> and <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>方式三：定义逻辑条件信息进行数据查询
and -- 并且关系 先进行一次过滤，然后在过滤之后的数据中再次进行过滤
or  -- 或者关系 在数据表中过滤指定信息后，重新在数据表再次过滤新的信息，最后将多次信息做合并
<span class="token comment"># 查询中国境内，大于520万人口的城市信息</span>
SELECT * FROM city WHERE <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> and population<span class="token operator">&gt;</span><span class="token number">5200000</span><span class="token punctuation">;</span>

<span class="token comment"># 查询中国和美国的所有城市 </span>
SELECT * FROM city WHERE <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> OR <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span>

<span class="token comment"># 查询人口数在100w到200w之间的城市信息</span>
mysql<span class="token operator">&gt;</span> SELECT * FROM city WHERE population<span class="token operator">&gt;=</span><span class="token number">1000000</span> and population<span class="token operator">&lt;=</span><span class="token number">2000000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>方式四：定义模糊条件信息进行数据查询（like）（小心使用--全表查询--FULLTEXT-索引）
<span class="token comment"># 查询国家代号是CH开头的城市信息</span>
SELECT * FROM city WHERE countrycode LIKE <span class="token string">'CH%'</span><span class="token punctuation">;</span>

<span class="token comment"># 查询国家代号含US内容的城市信息</span>
SELECT * FROM city WHERE countrycode LIKE <span class="token string">'%US%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>方式五：特殊查询条件组合进行数据查询（配合in， not in， between and ）
<span class="token comment"># 查询中国和美国的所有城市 </span>
SELECT * FROM city WHERE countrycode <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span>,<span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
SELECT * FROM city WHERE <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> OR <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'USA'</span>

<span class="token comment"># 查询世界上的所有城市信息，但排除中国和美国的城市不查询</span>
SELECT * FROM city WHERE countrycode not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span>,<span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查询人口数量在50w-100w之间的城市信息</span>
SELECT * FROM city WHERE population between <span class="token number">500000</span> and <span class="token number">10000000</span><span class="token punctuation">;</span>
SELECT * FROM city WHERE population<span class="token operator">&gt;=</span><span class="token number">500000</span> and population<span class="token operator">&lt;=</span><span class="token number">10000000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#方式六：查询数据信息取消重复信息(distinct)</span>
SELECT distinct District,CountryCode FROM city WHERE <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>方式七：查询数据信息为空的内容
<span class="token keyword">select</span> * from city where population is null<span class="token punctuation">;</span>
<span class="token keyword">select</span> * from city where population is not null<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">2</span><span class="token punctuation">)</span> 分组查看数据信息 <span class="token keyword">select</span> + from + where +  group by 

group by 分组列
<span class="token number">1</span>）将分组列的信息进行排序
<span class="token number">2</span>）将分组列的信息进行合并

对数据进行做分析处理--聚合函数
count<span class="token punctuation">(</span><span class="token punctuation">)</span>   -- 统计函数
sum<span class="token punctuation">(</span><span class="token punctuation">)</span>     -- 求和函数
avg<span class="token punctuation">(</span><span class="token punctuation">)</span>     -- 求平均值
max<span class="token punctuation">(</span><span class="token punctuation">)</span>     -- 求最大值
mix<span class="token punctuation">(</span><span class="token punctuation">)</span>     -- 求最小值
group_concat -- 将多行信息拼接为一行

<span class="token comment"># 查询统计每个国家的人口总数</span>
分组查询题目解题思路：
步骤一：确认是否需要进行分组查询数据（需求中 -- 每个 各个）
步骤二：确认进行分组查询的列信息    （countrycode）
<span class="token keyword">select</span> * from city group by countrycode<span class="token punctuation">;</span>
步骤三：根据需求将指定列信息做聚合处理 sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> 
<span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from city group by countrycode<span class="token punctuation">;</span>

<span class="token comment"># 查询中国每个省份中城市数量;</span>
步骤一：是否需要进行分组处理 group by 
步骤二：根据哪个列进行分组   group by District 
步骤三：如何进行聚合处理     count<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token keyword">select</span>  District,count<span class="token punctuation">(</span>name<span class="token punctuation">)</span> from city where <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> group by District<span class="token punctuation">;</span>

<span class="token comment"># 查询中国每个省份中城市数量,并且显示每个省份的城市名称;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span>  District,count<span class="token punctuation">(</span>name<span class="token punctuation">)</span>,name from city where <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> group by District<span class="token punctuation">;</span>
ERROR <span class="token number">1055</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Expression <span class="token comment">#3 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'world.city.Name' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by</span>
分组过程会首先进行排序，然后将排序的列进行合并~
<span class="token keyword">select</span>  District,count<span class="token punctuation">(</span>name<span class="token punctuation">)</span>, group_concat<span class="token punctuation">(</span>name<span class="token punctuation">)</span> from city where <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> group by District<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">3</span><span class="token punctuation">)</span> 分组过滤数据信息 having 
where ：过滤数据信息  根据原有表中数据进行过滤
having：过滤数据信息  根据分组聚合之后数据过滤

过滤中国每个省份中，城市数量超过20的省份信息
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> District,count<span class="token punctuation">(</span>name<span class="token punctuation">)</span> from city where <span class="token assign-left variable">countrycode</span><span class="token operator">=</span><span class="token string">'CHN'</span> group by District having count<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">;</span>
+--------------+-------------+
<span class="token operator">|</span> District     <span class="token operator">|</span> count<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span>
+--------------+-------------+
<span class="token operator">|</span> Hubei        <span class="token operator">|</span>          <span class="token number">22</span> <span class="token operator">|</span>
<span class="token operator">|</span> Heilongjiang <span class="token operator">|</span>          <span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">|</span> Liaoning     <span class="token operator">|</span>          <span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">|</span> Sichuan      <span class="token operator">|</span>          <span class="token number">21</span> <span class="token operator">|</span>
<span class="token operator">|</span> Jiangsu      <span class="token operator">|</span>          <span class="token number">25</span> <span class="token operator">|</span>
<span class="token operator">|</span> Shandong     <span class="token operator">|</span>          <span class="token number">32</span> <span class="token operator">|</span>
+--------------+-------------+
<span class="token number">6</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 查询统计每个国家的人口总数，只显示人口数量超过1个亿的信息</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">100000000</span><span class="token punctuation">;</span>
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">4</span><span class="token punctuation">)</span> 数据信息排序显示 order by 
<span class="token comment"># 查询统计每个国家的人口总数，只显示人口数量超过5千万的信息，并且按照国家人口总数排序显示</span>
<span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token punctuation">;</span>
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> MEX         <span class="token operator">|</span>        <span class="token number">59752521</span> <span class="token operator">|</span>
<span class="token operator">|</span> RUS         <span class="token operator">|</span>        <span class="token number">69150700</span> <span class="token operator">|</span>
<span class="token operator">|</span> JPN         <span class="token operator">|</span>        <span class="token number">77965107</span> <span class="token operator">|</span>
<span class="token operator">|</span> USA         <span class="token operator">|</span>        <span class="token number">78625774</span> <span class="token operator">|</span>
<span class="token operator">|</span> BRA         <span class="token operator">|</span>        <span class="token number">85876862</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">7</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span>  <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc<span class="token punctuation">;</span>
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
<span class="token operator">|</span> BRA         <span class="token operator">|</span>        <span class="token number">85876862</span> <span class="token operator">|</span>
<span class="token operator">|</span> USA         <span class="token operator">|</span>        <span class="token number">78625774</span> <span class="token operator">|</span>
<span class="token operator">|</span> JPN         <span class="token operator">|</span>        <span class="token number">77965107</span> <span class="token operator">|</span>
<span class="token operator">|</span> RUS         <span class="token operator">|</span>        <span class="token number">69150700</span> <span class="token operator">|</span>
<span class="token operator">|</span> MEX         <span class="token operator">|</span>        <span class="token number">59752521</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">7</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

ascending order   -- asc  --升序
descending order  -- desc --降序
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">5</span><span class="token punctuation">)</span> 数据信息截取处理 -- limit 
<span class="token comment"># 查询统计每个国家的人口总数，只显示人口数量超过5千万的信息，并且按照国家人口总数从大到小排序，只显示前三名</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from world.city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc limit <span class="token number">3</span><span class="token punctuation">;</span>
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
<span class="token operator">|</span> BRA         <span class="token operator">|</span>        <span class="token number">85876862</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from world.city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc limit <span class="token number">0,3</span><span class="token punctuation">;</span> 
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
<span class="token operator">|</span> BRA         <span class="token operator">|</span>        <span class="token number">85876862</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
limit n,m         -- n表示从第几行开始截取，m向下截取几行

mysql<span class="token operator">&gt;</span>  <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from world.city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc limit <span class="token number">3</span> offset <span class="token number">0</span><span class="token punctuation">;</span>
+-------------+-----------------+
<span class="token operator">|</span> countrycode <span class="token operator">|</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token operator">|</span> CHN         <span class="token operator">|</span>       <span class="token number">175953614</span> <span class="token operator">|</span>
<span class="token operator">|</span> IND         <span class="token operator">|</span>       <span class="token number">123298526</span> <span class="token operator">|</span>
<span class="token operator">|</span> BRA         <span class="token operator">|</span>        <span class="token number">85876862</span> <span class="token operator">|</span>
+-------------+-----------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
limit m offset n  -- n表示从第几行开始截取，m向下截取几行

<span class="token comment"># 查询统计每个国家的人口总数，只显示人口数量超过5千万的信息，并且按照国家人口总数从大到小排序，只显示三~五名</span>
mysql <span class="token operator">&gt;</span> <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from world.city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc limit <span class="token number">2,3</span><span class="token punctuation">;</span>
或者
mysql <span class="token operator">&gt;</span> <span class="token keyword">select</span> countrycode,sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> from world.city group by countrycode having sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">50000000</span> order by sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span> desc limit <span class="token number">3</span> offset <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>删除表时，使用的drop delete truncate命令有什么区别；
<span class="token operator">|</span> 区别分析 	<span class="token operator">|</span> drop table stu<span class="token punctuation">;</span>        <span class="token operator">|</span> truncate table stu<span class="token punctuation">;</span>          <span class="token operator">|</span> delete from stu<span class="token punctuation">;</span>     
<span class="token operator">|</span> 功能效果 <span class="token operator">|</span> 删除表结构+数据        <span class="token operator">|</span> 删除表数据（释放空间）      	<span class="token operator">|</span> 删除表数据（标记删除） 
<span class="token operator">|</span> 删除逻辑 <span class="token operator">|</span> 彻底删除               <span class="token operator">|</span> 物理删除（段区页层面删除）   <span class="token operator">|</span> 逻辑删除（逐行删除）   
<span class="token operator">|</span> 删除效率 <span class="token operator">|</span> 效率快（和数据量无关） <span class="token operator">|</span> 效率快（和数据量无关）       <span class="token operator">|</span> 效率慢（和数据量有关） 
<span class="token operator">|</span> 自增影响 <span class="token operator">|</span> 新增自增序列           <span class="token operator">|</span> 重置自增序列（释放高水位线） <span class="token operator">|</span> 延续自增序列         

PS：以上删除命令都要慎用；后续会讲解相关恢复数据方法（备份数据恢复 数据闪回 主从延时恢复 利用日志文件恢复 独立表空间文件恢复）  

02：删除表中数据时，磁盘资源是否会释放，删除后不能释放，如何处理；
drop table table_name 
立刻释放磁盘空间，不管是Innodb和MyISAM <span class="token punctuation">;</span>  500G  <span class="token number">1</span>

truncate table table_name 
立刻释放磁盘空间，不管是 Innodb和MyISAM 。ll <span class="token parameter variable">-h</span> 表.ibd
truncate table其实有点类似于drop table 然后creat,只不过这个create table 的过程做了优化，比如表结构文件之前已经有了等等。
所以速度上应该是接近drop table的速度<span class="token punctuation">;</span>

delete from table_name
删除表的全部数据,对于MyISAM会立刻释放磁盘空间,InnoDB不会释放磁盘空间<span class="token punctuation">;</span>  ll <span class="token parameter variable">-h</span> 表.ibd

delete from table_name where xxx
带条件的删除, 不管是innodb还是MyISAM都不会释放磁盘空间<span class="token punctuation">;</span>

如何释放磁盘空间
delete操作以后使用optimize table table_name会立刻释放磁盘空间。不管是innodb还是myisam 。
所以要想达到释放磁盘空间的目的，delete以后执行optimize table 操作。
PS: delete from表以后虽然未释放磁盘空间，但是下次插入数据的时候，仍然可以使用这部分空间。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>03：单表查询时，用到的关键字优先顺序 （select+from+where+group by+having+order by+limit） （面试题）
MySQL SELECT查询语句的执行优先级从高到低如下：
·  from     ：在查询数据信息时，会先根据from语句调取表信息
· （）		：括号中的子查询首先执行。 
·  JOIN		：如果有JOIN子句，则先执行JOIN操作。
·  ON		：如果有JOIN子句，则ON子句的条件会被首先执行。
·  WHERE	：WHERE子句的条件执行顺序是先从左到右，然后根据逻辑顺序（如AND和OR）执行。
·  GROUP BY	：如果有GROUP BY子句，会在WHERE子句之后执行，对结果集进行分组。
·  HAVING	：如果有GROUP BY子句，HAVING子句会在GROUP BY之后执行，用于筛选分组。
·  SELECT	：最后执行SELECT子句，选取特定的列。
·  DISTINCT	：如果有DISTINCT子句，会在SELECT之后执行，去除重复的行。
·  ORDER BY	：如果有ORDER BY子句，会在其他子句之后执行，对最终结果进行排序。
·  LIMIT	：如果有LIMIT子句，最后执行LIMIT来限制输出结果的数量。

from -<span class="token operator">&gt;</span> where -<span class="token operator">&gt;</span> group by -<span class="token operator">&gt;</span> having -<span class="token operator">&gt;</span> <span class="token keyword">select</span> -<span class="token operator">&gt;</span> distinct -<span class="token operator">&gt;</span> order by -<span class="token operator">&gt;</span> limit 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>01 数据库服务查询语句（DQL 查询数据）
单表数据查询：select+from+where+gourp by+having+order by +limit 
多表数据查询：横向拼接（inner <span class="token function">join</span> on/left <span class="token function">join</span> on/right <span class="token function">join</span> on）  纵向拼接（union/union all） 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>多表查询方法（连表查询）
创建多表测试数据：
<span class="token comment"># 创建多表查询所需模拟数据库和数据表信息</span>
CREATE DATABASE school CHARSET utf8<span class="token punctuation">;</span>
USE school<span class="token punctuation">;</span>

CREATE TABLE student <span class="token punctuation">(</span>
    sno INT NOT NULL PRIMARY KEY AUTO_INCREMENT COMMENT <span class="token string">'学号'</span>,
    sname VARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'姓名'</span>,
    sage TINYINT UNSIGNED NOT NULL COMMENT <span class="token string">'年龄'</span>,
    ssex ENUM<span class="token punctuation">(</span><span class="token string">'f'</span>,<span class="token string">'m'</span><span class="token punctuation">)</span> NOT NULL DEFAULT <span class="token string">'m'</span> COMMENT <span class="token string">'性别'</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>INNODB <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

CREATE TABLE course <span class="token punctuation">(</span>
    cno INT NOT NULL PRIMARY KEY COMMENT <span class="token string">'课程编号'</span>,
    cname VARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'课程名字'</span>,
    tno INT NOT NULL COMMENT <span class="token string">'教师编号'</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>INNODB <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

CREATE TABLE sc <span class="token punctuation">(</span>
    sno INT NOT NULL COMMENT <span class="token string">'学号'</span>,
    cno INT NOT NULL COMMENT <span class="token string">'课程编号'</span>,
    score INT NOT NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token string">'成绩'</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>INNODB <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

CREATE TABLE teacher <span class="token punctuation">(</span>
    tno INT NOT NULL PRIMARY KEY COMMENT <span class="token string">'教师编号'</span>,
    tname VARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT NULL COMMENT <span class="token string">'教师名字'</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>INNODB <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+------------------+
<span class="token operator">|</span> Tables_in_school <span class="token operator">|</span>
+------------------+
<span class="token operator">|</span> course           <span class="token operator">|</span>
<span class="token operator">|</span> sc               <span class="token operator">|</span>
<span class="token operator">|</span> student          <span class="token operator">|</span>
<span class="token operator">|</span> teacher          <span class="token operator">|</span>
+------------------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 在数据库与数据表中插入模拟数据</span>
INSERT INTO student<span class="token punctuation">(</span>sno,sname,sage,ssex<span class="token punctuation">)</span>
VALUES
<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'zhang3'</span>,18,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">'zhang4'</span>,18,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">'li4'</span>,18,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4</span>,<span class="token string">'wang5'</span>,19,<span class="token string">'f'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">5</span>,<span class="token string">'zh4'</span>,18,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">6</span>,<span class="token string">'zhao4'</span>,18,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">7</span>,<span class="token string">'ma6'</span>,19,<span class="token string">'f'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">8</span>,<span class="token string">'malu'</span>,20,<span class="token string">'m'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">9</span>,<span class="token string">'malu2'</span>,20,<span class="token string">'f'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">10</span>,<span class="token string">'oldp'</span>,25,<span class="token string">'m'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO teacher<span class="token punctuation">(</span>tno,tname<span class="token punctuation">)</span>
VALUES
<span class="token punctuation">(</span><span class="token number">101</span>,<span class="token string">'malu'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'xiaoQ'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">103</span>,<span class="token string">'xiaoA'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">104</span>,<span class="token string">'xiaoB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO course<span class="token punctuation">(</span>cno,cname,tno<span class="token punctuation">)</span>
VALUES
<span class="token punctuation">(</span><span class="token number">1001</span>,<span class="token string">'linux'</span>,101<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1002</span>,<span class="token string">'python'</span>,102<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1003</span>,<span class="token string">'mysql'</span>,103<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1004</span>,<span class="token string">'go'</span>,105<span class="token punctuation">)</span><span class="token punctuation">;</span>

INSERT INTO sc<span class="token punctuation">(</span>sno,cno,score<span class="token punctuation">)</span>
VALUES
<span class="token punctuation">(</span><span class="token number">1,1001</span>,80<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1,1002</span>,59<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">2,1002</span>,90<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">2,1003</span>,100<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3,1001</span>,99<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3,1003</span>,40<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4,1001</span>,79<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4,1002</span>,61<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4,1003</span>,99<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">5,1003</span>,40<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">6,1001</span>,89<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">6,1003</span>,77<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">7,1001</span>,67<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">7,1003</span>,82<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">8,1001</span>,70<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">9,1003</span>,80<span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">10,1003</span>,96<span class="token punctuation">)</span><span class="token punctuation">;</span>

SELECT * FROM student<span class="token punctuation">;</span>
SELECT * FROM teacher<span class="token punctuation">;</span>
SELECT * FROM course<span class="token punctuation">;</span>
SELECT * FROM sc<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 笛卡尔乘积方式  没什么用，里面有很多的无效数据。
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher,course<span class="token punctuation">;</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token number">16</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher<span class="token punctuation">;</span>
+-----+-------+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span>
+-----+-------+
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span>
+-----+-------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from course<span class="token punctuation">;</span>
+------+--------+-----+
<span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+------+--------+-----+
<span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
+------+--------+-----+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 内连接方式查询（***）
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher,course where <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>     -- 旧的SQL语句写法
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher inner <span class="token function">join</span> course on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span> -- 新的SQL语句写法（*）

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher,course where <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher inner <span class="token function">join</span> course on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
+-----+-------+------+--------+-----+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 外连接方式查询
左外连接：在应用外连接时，并且使用了左外连接，会将左表作为主表（驱动表），右表成为子表（被驱动表），连表查询时，主表信息都会调取，子表中只会调取和主表有关联得数据
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher left <span class="token function">join</span> course on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>
+-----+-------+------+--------+------+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno  <span class="token operator">|</span>
+-----+-------+------+--------+------+
<span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span>  <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span>  <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span>  <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">104</span> <span class="token operator">|</span> xiaoB <span class="token operator">|</span> NULL <span class="token operator">|</span> NULL   <span class="token operator">|</span> NULL <span class="token operator">|</span>
+-----+-------+------+--------+------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


右外连接：在应用外连接时，并且使用了右外连接，会将右表作为主表（驱动表），左表成为子表（被驱动表），连表查询时，主表信息都会调取，子表中只会调取和主表有关联得数据
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher right <span class="token function">join</span> course on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from teacher right <span class="token function">join</span> course on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno<span class="token punctuation">;</span>
+------+-------+------+--------+-----+
<span class="token operator">|</span> tno  <span class="token operator">|</span> tname <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+------+-------+------+--------+-----+
<span class="token operator">|</span>  <span class="token number">101</span> <span class="token operator">|</span> malu  <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span> NULL <span class="token operator">|</span> NULL  <span class="token operator">|</span> <span class="token number">1004</span> <span class="token operator">|</span> go     <span class="token operator">|</span> <span class="token number">105</span> <span class="token operator">|</span>
+------+-------+------+--------+-----+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>解题思路：
步骤一：需要根据业务表信息创建ER模型
步骤二：根据问题需求确认需要调取的表  
步骤三：将多个表信息进行拼接处理   
<span class="token keyword">select</span> * from 表1,表2,<span class="token punctuation">..</span>. where 表1.列<span class="token operator">=</span>表2.列 and 表2.列<span class="token operator">=</span>表3.列 and <span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token keyword">select</span> * from 表1 <span class="token function">join</span> 表2 on 表1.列<span class="token operator">=</span>表2.列 <span class="token function">join</span> 表3 on 表2.列<span class="token operator">=</span>表3.列 <span class="token function">join</span> <span class="token punctuation">..</span> on <span class="token punctuation">..</span> <span class="token function">join</span> <span class="token punctuation">..</span> on <span class="token punctuation">..</span>.
步骤四：对拼接后的大表<span class="token punctuation">(</span>单表<span class="token punctuation">)</span>进行数据处理
where + group by + having + order by + limit 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/devops/public/assets/img/1729668903225.21965c9a.png" alt="1729668903225"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>01 统计zhang3，学习了几门课？  
所需表信息：  student sc course 
将表进行拼接：
<span class="token keyword">select</span> * from student 
<span class="token function">join</span> sc
on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno 
<span class="token function">join</span> course 
on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno<span class="token punctuation">;</span>  

+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> sage <span class="token operator">|</span> ssex <span class="token operator">|</span> sno <span class="token operator">|</span> cno  <span class="token operator">|</span> score <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">80</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span>    <span class="token number">59</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> zhang4 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span>    <span class="token number">90</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> zhang4 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>   <span class="token number">100</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> li4    <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">99</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> li4    <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> wang5  <span class="token operator">|</span>   <span class="token number">19</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">79</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> wang5  <span class="token operator">|</span>   <span class="token number">19</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span>    <span class="token number">61</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> wang5  <span class="token operator">|</span>   <span class="token number">19</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">99</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">5</span> <span class="token operator">|</span> zh4    <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">5</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span> zhao4  <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">89</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span> zhao4  <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">6</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">77</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span> ma6    <span class="token operator">|</span>   <span class="token number">19</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">67</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span> ma6    <span class="token operator">|</span>   <span class="token number">19</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">7</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">82</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">8</span> <span class="token operator">|</span> malu   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">8</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">70</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">9</span> <span class="token operator">|</span> malu2  <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> f    <span class="token operator">|</span>   <span class="token number">9</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">80</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">10</span> <span class="token operator">|</span> oldp   <span class="token operator">|</span>   <span class="token number">25</span> <span class="token operator">|</span> m    <span class="token operator">|</span>  <span class="token number">10</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span>    <span class="token number">96</span> <span class="token operator">|</span> <span class="token number">1003</span> <span class="token operator">|</span> mysql  <span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span>
+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token number">17</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

基于大表（单表）查询数据： 
<span class="token keyword">select</span> * from student 
<span class="token function">join</span> sc
on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno 
<span class="token function">join</span> course 
on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
where <span class="token assign-left variable">student.sname</span><span class="token operator">=</span><span class="token string">'zhang3'</span><span class="token punctuation">;</span>
+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> sage <span class="token operator">|</span> ssex <span class="token operator">|</span> sno <span class="token operator">|</span> cno  <span class="token operator">|</span> score <span class="token operator">|</span> cno  <span class="token operator">|</span> cname  <span class="token operator">|</span> tno <span class="token operator">|</span>
+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span>    <span class="token number">80</span> <span class="token operator">|</span> <span class="token number">1001</span> <span class="token operator">|</span> linux  <span class="token operator">|</span> <span class="token number">101</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>   <span class="token number">18</span> <span class="token operator">|</span> m    <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span>    <span class="token number">59</span> <span class="token operator">|</span> <span class="token number">1002</span> <span class="token operator">|</span> python <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span>
+-----+--------+------+------+-----+------+-------+------+--------+-----+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> student.sno,student.sname, count<span class="token punctuation">(</span>course.cno<span class="token punctuation">)</span> from student 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> sc
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> course 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
    -<span class="token operator">&gt;</span> where <span class="token assign-left variable">student.sname</span><span class="token operator">=</span><span class="token string">'zhang3'</span>
    -<span class="token operator">&gt;</span> group by student.sno<span class="token punctuation">;</span>
+-----+--------+-------------------+
<span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> count<span class="token punctuation">(</span>course.cno<span class="token punctuation">)</span> <span class="token operator">|</span>
+-----+--------+-------------------+
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>                 <span class="token number">2</span> <span class="token operator">|</span>
+-----+--------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


02 查询zhang3，学习的课程名称有哪些？
<span class="token keyword">select</span> student.sno,student.sname,group_concat<span class="token punctuation">(</span>course.cname<span class="token punctuation">)</span> from student 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno 
<span class="token function">join</span> course 
on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
where <span class="token assign-left variable">student.sname</span><span class="token operator">=</span><span class="token string">'zhang3'</span>
group by student.sno<span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> student.sno,student.sname,group_concat<span class="token punctuation">(</span>course.cname<span class="token punctuation">)</span> from student 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> sc 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> course 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
    -<span class="token operator">&gt;</span> where <span class="token assign-left variable">student.sname</span><span class="token operator">=</span><span class="token string">'zhang3'</span>
    -<span class="token operator">&gt;</span> group by student.sno<span class="token punctuation">;</span>
+-----+--------+----------------------------+
<span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> group_concat<span class="token punctuation">(</span>course.cname<span class="token punctuation">)</span> <span class="token operator">|</span>
+-----+--------+----------------------------+
<span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span> linux,python               <span class="token operator">|</span>
+-----+--------+----------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>03 查询xiaoA老师教的学生名？

teacher course sc student 

<span class="token keyword">select</span> teacher.tno,teacher.tname,group_concat<span class="token punctuation">(</span>student.sname<span class="token punctuation">)</span> from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where <span class="token assign-left variable">teacher.tname</span><span class="token operator">=</span><span class="token string">'xiaoA'</span>
group by teacher.tno<span class="token punctuation">;</span> 

04 查询xiaoA老师教课程的平均分数？
teacher  course  sc
<span class="token keyword">select</span> teacher.tno,teacher.tname,course.cname,avg<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span> from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
where <span class="token assign-left variable">teacher.tname</span><span class="token operator">=</span><span class="token string">'xiaoA'</span>
group by teacher.tno,course.cname<span class="token punctuation">;</span>

05 每位老师所教课程的平均分，并按平均分排序？
teacher  course  sc
<span class="token keyword">select</span> teacher.tno,teacher.tname,course.cname,avg<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span> from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
group by teacher.tno,course.cname
order by avg<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span><span class="token punctuation">;</span>

06 查询xiaoA老师教的不及格的学生姓名？
<span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where <span class="token assign-left variable">teacher.tname</span><span class="token operator">=</span><span class="token string">'xiaoA'</span> and sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>

07 查询所有老师所教学生不及格的信息？
<span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where  sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>表查询别名功能：
表别名：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where  sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>

--------------------------------

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
    -<span class="token operator">&gt;</span> <span class="token function">join</span> course 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> sc 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
    -<span class="token operator">&gt;</span> <span class="token function">join</span> student 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
    -<span class="token operator">&gt;</span> where  sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>
+-----+-------+-----+--------+-------+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> score <span class="token operator">|</span>
+-----+-------+-----+--------+-------+
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>    <span class="token number">59</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> li4    <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">5</span> <span class="token operator">|</span> zh4    <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
+-----+-------+-----+--------+-------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

--------------------------------

<span class="token keyword">select</span>  a.tno,a.tname,d.sno,d.sname,c.score 
from teacher a
<span class="token function">join</span> course b
on <span class="token assign-left variable">a.tno</span><span class="token operator">=</span>b.tno 
<span class="token function">join</span> sc  c 
on <span class="token assign-left variable">b.cno</span><span class="token operator">=</span>c.cno
<span class="token function">join</span> student d
on <span class="token assign-left variable">c.sno</span><span class="token operator">=</span>d.sno
where  c.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span>  a.tno,a.tname,d.sno,d.sname,c.score 
    -<span class="token operator">&gt;</span> from teacher a
    -<span class="token operator">&gt;</span> <span class="token function">join</span> course b
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">a.tno</span><span class="token operator">=</span>b.tno 
    -<span class="token operator">&gt;</span> <span class="token function">join</span> sc  c 
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">b.cno</span><span class="token operator">=</span>c.cno
    -<span class="token operator">&gt;</span> <span class="token function">join</span> student d
    -<span class="token operator">&gt;</span> on <span class="token assign-left variable">c.sno</span><span class="token operator">=</span>d.sno
    -<span class="token operator">&gt;</span> where  c.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>
+-----+-------+-----+--------+-------+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> score <span class="token operator">|</span>
+-----+-------+-----+--------+-------+
<span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> xiaoQ <span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> zhang3 <span class="token operator">|</span>    <span class="token number">59</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> li4    <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">5</span> <span class="token operator">|</span> zh4    <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
+-----+-------+-----+--------+-------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>列别名：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">select</span>  a.tno as <span class="token string">'老师编号'</span>,a.tname as <span class="token string">'老师名字'</span>,d.sno as <span class="token string">'学号'</span>,d.sname as <span class="token string">'学生名'</span>,c.score as <span class="token string">'学生成绩'</span>
from teacher a
<span class="token function">join</span> course b  
on <span class="token assign-left variable">a.tno</span><span class="token operator">=</span>b.tno 
<span class="token function">join</span> sc c
on <span class="token assign-left variable">b.cno</span><span class="token operator">=</span>c.cno
<span class="token function">join</span> student d 
on <span class="token assign-left variable">c.sno</span><span class="token operator">=</span>d.sno
where  c.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>

+--------------+--------------+--------+-----------+--------------+
<span class="token operator">|</span> 老师编号     <span class="token operator">|</span> 老师名字     <span class="token operator">|</span> 学号   <span class="token operator">|</span> 学生名    <span class="token operator">|</span> 学生成绩     <span class="token operator">|</span>
+--------------+--------------+--------+-----------+--------------+
<span class="token operator">|</span>          <span class="token number">102</span> <span class="token operator">|</span> xiaoQ        <span class="token operator">|</span>      <span class="token number">1</span> <span class="token operator">|</span> zhang3    <span class="token operator">|</span>           <span class="token number">59</span> <span class="token operator">|</span>
<span class="token operator">|</span>          <span class="token number">103</span> <span class="token operator">|</span> xiaoA        <span class="token operator">|</span>      <span class="token number">3</span> <span class="token operator">|</span> li4       <span class="token operator">|</span>           <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">|</span>          <span class="token number">103</span> <span class="token operator">|</span> xiaoA        <span class="token operator">|</span>      <span class="token number">5</span> <span class="token operator">|</span> zh4       <span class="token operator">|</span>           <span class="token number">40</span> <span class="token operator">|</span>
+--------------+--------------+--------+-----------+--------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>补充：连表查询方式</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>横向拼接多个表：调取数据从多个不同表 笛卡尔乘积  内连接 外连接 
纵向拼接多个表：将多个历史数据表或者相同的数据表数据做整合

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from student2023 union <span class="token keyword">select</span> * from student2024<span class="token punctuation">;</span>       -- 拼接后的数据会自动去重
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from student2023 union all <span class="token keyword">select</span> * from student2024<span class="token punctuation">;</span>   -- 拼接后的数据不会自动去重
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>练习题目：
01 连表查询题目 
01 查询平均成绩大于60分的同学的学号和平均成绩
02 查询所有同学的学号，姓名。选课数，总成绩
03 查询各科成绩最高和最低的分，以如下形式显示：课程ID，最高分，最低分
04 统计各位老师，所教课程的及格率
05 查询每门课程被选修的学生数
06 查询出只选修了一门课程的全部学生的学号和姓名
07 查询选修课程门数超过1门的学生信息
08 统计每门课程：优秀（85分以上），良好（70-85），一般（60-70），不及格（小于60）的学生列表
09 查询平均成绩大于85的所有学生的学号、姓名和平均成绩

- 查询平均成绩大于60分的同学的学号和平均成绩
- 查询所有同学的学号，姓名。选课数，总成绩
  ****** 
  student course sc
  
  <span class="token keyword">select</span> * from student
  <span class="token function">join</span> sc 
  on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno
  <span class="token function">join</span> course 
  on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
  
  <span class="token keyword">select</span> student.sno,student.sname,group_concat<span class="token punctuation">(</span>course.cname<span class="token punctuation">)</span>,count<span class="token punctuation">(</span>course.cno<span class="token punctuation">)</span>,sum<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span> from student
  <span class="token function">join</span> sc 
  on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno
  <span class="token function">join</span> course 
  on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
  group by student.sno<span class="token punctuation">;</span>
  
  
- 查询各科成绩最高和最低的分，以如下形式显示：课程ID，最高分，最低分
  ******
  <span class="token keyword">select</span> * from course 
  <span class="token function">join</span> sc 
  on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno<span class="token punctuation">;</span>
  
  <span class="token keyword">select</span> course.cno,course.cname,max<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span>,min<span class="token punctuation">(</span>sc.score<span class="token punctuation">)</span> from course 
  <span class="token function">join</span> sc 
  on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
  group by course.cno<span class="token punctuation">;</span>
  
  
- 统计各位老师，所教课程的及格率
  ******
  分组 根据teacher.tno,course.cno 
  <span class="token number">101</span> malu  Linux    zha3    <span class="token number">70</span>
              Linux    li4     <span class="token number">60</span>
			  Linux    w5      <span class="token number">40</span>
			  
              python   zha3 
			  python   li4 
			  python   w5
			  
  <span class="token number">102</span> malu  mysql 
              go 
  <span class="token number">103</span> xiaoA   Linux 
  <span class="token number">104</span> xiaoB   python 
  
  及格率 总人数 <span class="token number">3</span>  成绩<span class="token operator">&gt;=</span><span class="token number">60</span>人数 <span class="token number">2</span>  <span class="token number">2</span>/3<span class="token operator">=</span><span class="token number">0.0677234234</span>  <span class="token number">0.06</span>  <span class="token number">6</span>%  ***
  
  <span class="token keyword">select</span> teacher.tname,course.cname,concat<span class="token punctuation">(</span>floor<span class="token punctuation">(</span>count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>/count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>*100<span class="token punctuation">)</span>,<span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span> 
  from teacher  
  <span class="token function">join</span> course 
  on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno  
  <span class="token function">join</span> 
  sc 
  on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno  
  group by teacher.tno,course.cno<span class="token punctuation">;</span>
  
  <span class="token keyword">select</span> teacher.tname as 讲师名,course.cname as 课程名,concat<span class="token punctuation">(</span>floor<span class="token punctuation">(</span>count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>/count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>*100<span class="token punctuation">)</span>,<span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span> as 课程及格率
  from teacher  
  <span class="token function">join</span> course 
  on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno  
  <span class="token function">join</span> 
  sc 
  on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno  
  group by teacher.tno,course.cno<span class="token punctuation">;</span>
  
  concat<span class="token punctuation">(</span>floor<span class="token punctuation">(</span>count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>/count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>*100<span class="token punctuation">)</span>,<span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span>
  
  <span class="token keyword">case</span> when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end        内存  <span class="token number">1</span>  <span class="token number">1</span>
  SQL语言 -- 流程控制语句 （判断语句 循环语句）
  <span class="token keyword">case</span> when 条件 <span class="token keyword">then</span> 操作信息 end 

  count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>  内存中有几个1 <span class="token operator">==</span> 有几个及格学生 <span class="token number">2</span>
  
  count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>  参与指定老师所讲解课程人数     <span class="token number">3</span>
  
  count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>/count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>  及格率 -- <span class="token punctuation">(</span>count<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token number">1</span> end<span class="token punctuation">)</span>/count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>*100<span class="token punctuation">)</span>
  
  
- 查询每门课程被选修的学生数
- 查询出只选修了一门课程的全部学生的学号和姓名
- 查询选修课程门数超过1门的学生信息

- 统计每门课程：优秀（85分以上），良好（70-85），一般（60-70），不及格（小于60）的学生列表
  ******
  group by course.cno 
  
  Linux   zh3  <span class="token number">90</span>
  Linux   li4  <span class="token number">95</span>
  Linux   w5   <span class="token number">92</span>
  Linux   z6   <span class="token number">40</span>  
 
  python  zh3  <span class="token number">90</span>
  python  li4  <span class="token number">80</span>
  python  w5   <span class="token number">70</span>
  python  z6   <span class="token number">40</span>  
  
  
  课程   优秀  良好  一般  不及格 
  Linux  zh3    li4   w5     z6
  
  
  利用判断语句创建 优秀 良好 一般 不及格 
  
  <span class="token keyword">select</span> course.cname as 课程名,
  group_concat<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">85</span> <span class="token keyword">then</span> student.sname end<span class="token punctuation">)</span> as 优秀,
  group_concat<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">70</span> and sc.score<span class="token operator">&lt;</span><span class="token number">85</span> <span class="token keyword">then</span> student.sname end<span class="token punctuation">)</span> as 良好,
  group_concat<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;=</span><span class="token number">60</span> and sc.score<span class="token operator">&lt;</span><span class="token number">70</span> <span class="token keyword">then</span> student.sname end<span class="token punctuation">)</span> as 一般,
  group_concat<span class="token punctuation">(</span>case when sc.score<span class="token operator">&lt;</span><span class="token number">60</span> <span class="token keyword">then</span> student.sname end<span class="token punctuation">)</span> as 不及格
  from student
  <span class="token function">join</span> sc on <span class="token assign-left variable">student.sno</span><span class="token operator">=</span>sc.sno
  <span class="token function">join</span> course on <span class="token assign-left variable">sc.cno</span><span class="token operator">=</span>course.cno
  group by course.cno<span class="token punctuation">;</span>
  
  Linux    group_concat<span class="token punctuation">(</span>case when sc.score<span class="token operator">&gt;</span><span class="token number">85</span> <span class="token keyword">then</span> student.sname end<span class="token punctuation">)</span> as 优秀     <span class="token number">1</span> <span class="token number">1</span> <span class="token number">1</span>
            zh3 li4 w5 
                                                              

- 查询平均成绩大于85的所有学生的学号、姓名和平均成绩

https://www.cnblogs.com/malu-heqing/articles/16868031.html

<span class="token keyword">select</span> course.cname 课程名, 
    group_concat<span class="token punctuation">(</span>distinct stu1.sname<span class="token punctuation">)</span> 良好, 
	group_concat<span class="token punctuation">(</span>distinct stu2.sname<span class="token punctuation">)</span> 一般, 
	group_concat<span class="token punctuation">(</span>distinct stu3.sname<span class="token punctuation">)</span> 不及格, 
	group_concat<span class="token punctuation">(</span> distinct stu4.sname<span class="token punctuation">)</span> 优秀 
	from course 
	left <span class="token function">join</span> sc sc1 on course.cno <span class="token operator">=</span> sc1.cno and sc1.score <span class="token operator">&gt;=</span><span class="token number">70</span> and sc1.score <span class="token operator">&lt;</span><span class="token number">85</span>
	left <span class="token function">join</span> sc sc2 on course.cno <span class="token operator">=</span> sc2.cno and sc2.score <span class="token operator">&gt;=</span><span class="token number">60</span> and sc2.score <span class="token operator">&lt;</span><span class="token number">70</span>
	left <span class="token function">join</span> sc sc3 on course.cno <span class="token operator">=</span> sc3.cno and sc3.score <span class="token operator">&lt;</span> <span class="token number">60</span>
	left <span class="token function">join</span> sc sc4 on course.cno <span class="token operator">=</span> sc4.cno and sc4.score <span class="token operator">&gt;=</span><span class="token number">85</span>
	left <span class="token function">join</span> student stu1 on stu1.sno <span class="token operator">=</span> sc1.sno 
	left <span class="token function">join</span> student stu2 on stu2.sno <span class="token operator">=</span> sc2.sno 
	left <span class="token function">join</span> student stu3 on stu3.sno <span class="token operator">=</span> sc3.sno 
	left <span class="token function">join</span> student stu4 on stu4.sno <span class="token operator">=</span> sc4.sno 
	group by course.cname<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br></div></div><h3 id="_10-子查询"><a href="#_10-子查询" class="header-anchor">#</a> 10.子查询</h3> <p>参考：https://yujingbo1023.github.io/devops/public/blogs/javabase/mysql/mysql.html</p> <h3 id="_11-查询元数据-了解"><a href="#_11-查询元数据-了解" class="header-anchor">#</a> 11.查询元数据(了解)</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>元（meta）一般会被翻译成中文是”关于<span class="token punctuation">..</span>.的<span class="token punctuation">..</span>.”，元数据（meta data）等价于data about data，表示关于数据的数据；

<span class="token function">cat</span>   /etc/hosts --- 数据信息（block）
ll <span class="token parameter variable">-i</span> /etc/hosts --- 属性信息（inode）

<span class="token keyword">select</span> +from+where <span class="token punctuation">..</span>.  查看表中数据信息
select/show   查看数据库属性信息--元数据（库/表名称 库/表字符集 表引擎 表数据字段 数据类型 约束属性 索引信息 <span class="token punctuation">..</span>.） 

三种方式可以查看元数据：
方式一：利用show  命令可以查看元数据 show 对象信息（命令信息）
方式二：利用select命令可以查看元数据 <span class="token keyword">select</span> 视图表信息
方式三：利用代码函数信息获取数据库的元数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>元数据获取方式一：利用命令获取（show）
查询数据库服务中的所有数据库信息（数据库名称-元数据）
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> school             <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
<span class="token operator">|</span> test01             <span class="token operator">|</span>
<span class="token operator">|</span> world              <span class="token operator">|</span>
+--------------------+
<span class="token number">7</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


查询数据库服务中的相应数据表信息（数据表名称-元数据）
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show tables from mysql<span class="token punctuation">;</span>

查询数据库服务中的建库语句信息 （建库语句参数-元数据 建库语句就是DDL语句，定义建立数据库的属性信息）
mysql<span class="token operator">&gt;</span> show create database school<span class="token punctuation">;</span>

查询数据库服务中的建表语句信息 （建表语句参数-元数据 建表语句就是DDL语句，定义建立数据表的属性信息）
mysql<span class="token operator">&gt;</span> show create table student<span class="token punctuation">;</span>

查询数据库服务中的数据表的结构（数据表的列定义信息-元数据）
mysql<span class="token operator">&gt;</span> desc student<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show columns from student<span class="token punctuation">;</span>

查看数据库服务中的具体数据库表的状态信息（属于单库或单表查询）
mysql<span class="token operator">&gt;</span> show table status from world like <span class="token string">'city'</span> <span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
           Name: city                 -- 数据表名称信息
         Engine: InnoDB           -- 使用的数据库引擎信息
        Version: <span class="token number">10</span>
     Row_format: Dynamic
           Rows: <span class="token number">4046</span>                -- 数据表的行数信息
 Avg_row_length: <span class="token number">101</span>         -- 平均行长度
    Data_length: <span class="token number">409600</span>       
Max_data_length: <span class="token number">0</span>
   Index_length: <span class="token number">114688</span>      -- 索引长度信息
      Data_free: <span class="token number">0</span>
 Auto_increment: <span class="token number">4080</span>       -- 自增列的值计数
    Create_time: <span class="token number">2022</span>-11-04 09:13:27   -- 数据表创建时间
    Update_time: NULL
     Check_time: NULL
      Collation: utf8mb4_0900_ai_ci      -- 校对规则信息
       Checksum: NULL
 Create_options: 
        Comment: 
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查询数据库服务中的相应数据表的索引情况（了解即可）
mysql<span class="token operator">&gt;</span> show index from world.city<span class="token punctuation">;</span>

查询数据库服务中的用户权限属性配置信息
mysql<span class="token operator">&gt;</span> show grants <span class="token keyword">for</span> root@<span class="token string">'localhost'</span><span class="token punctuation">;</span>

查询数据库服务的系统状态信息，表示当前数据库的所有连接情况
mysql<span class="token operator">&gt;</span> show <span class="token punctuation">[</span>full<span class="token punctuation">]</span> processlist<span class="token punctuation">;</span>

查询数据库服务的所有配置信息
mysql<span class="token operator">&gt;</span> show variables<span class="token punctuation">;</span> 
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%xx%'</span><span class="token punctuation">;</span>


mysql<span class="token operator">&gt;</span> show status<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show status like <span class="token string">'%lock%'</span><span class="token punctuation">;</span> 
-- 查询数据库服务的系统整体状态，表示当前数据库服务运行的即时状态情况

mysql<span class="token operator">&gt;</span> show binary logs<span class="token punctuation">;</span>
-- 查询数据库服务的所有二进制日志信息（binlog日志）

mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
-- 查询数据库服务正在使用的二进制日志

mysql<span class="token operator">&gt;</span> show binlog events <span class="token keyword">in</span> <span class="token string">'binlog.000009'</span><span class="token punctuation">;</span>
-- 查询数据库服务具体二进制日志内容事件信息

mysql<span class="token operator">&gt;</span> show engine innodb status <span class="token punctuation">\</span>G
-- 查询数据库服务存储引擎相关信息

mysql<span class="token operator">&gt;</span> show slave hosts<span class="token punctuation">;</span>
-- 在数据库服务主库查看从库信息

mysql<span class="token operator">&gt;</span> show slave status<span class="token punctuation">;</span>
-- 查询数据库服务主从状态信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>元数据获取方式二：利用库中视图获取元数据

什么是视图表信息；-- 给复杂查询数据命令设置一个别名

<span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where <span class="token assign-left variable">teacher.tname</span><span class="token operator">=</span><span class="token string">'xiaoA'</span> and sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>

create view t1 as <span class="token keyword">select</span>  teacher.tno,teacher.tname,student.sno,student.sname,sc.score from teacher
<span class="token function">join</span> course 
on <span class="token assign-left variable">teacher.tno</span><span class="token operator">=</span>course.tno 
<span class="token function">join</span> sc 
on <span class="token assign-left variable">course.cno</span><span class="token operator">=</span>sc.cno
<span class="token function">join</span> student 
on <span class="token assign-left variable">sc.sno</span><span class="token operator">=</span>student.sno
where <span class="token assign-left variable">teacher.tname</span><span class="token operator">=</span><span class="token string">'xiaoA'</span> and sc.score<span class="token operator">&lt;</span><span class="token number">60</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+------------------+
<span class="token operator">|</span> Tables_in_school <span class="token operator">|</span>
+------------------+
<span class="token operator">|</span> course           <span class="token operator">|</span>
<span class="token operator">|</span> sc               <span class="token operator">|</span>
<span class="token operator">|</span> student          <span class="token operator">|</span>
<span class="token operator">|</span> t1               <span class="token operator">|</span>
<span class="token operator">|</span> teacher          <span class="token operator">|</span>
+------------------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from t1<span class="token punctuation">;</span>
+-----+-------+-----+-------+-------+
<span class="token operator">|</span> tno <span class="token operator">|</span> tname <span class="token operator">|</span> sno <span class="token operator">|</span> sname <span class="token operator">|</span> score <span class="token operator">|</span>
+-----+-------+-----+-------+-------+
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> li4   <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">103</span> <span class="token operator">|</span> xiaoA <span class="token operator">|</span>   <span class="token number">5</span> <span class="token operator">|</span> zh4   <span class="token operator">|</span>    <span class="token number">40</span> <span class="token operator">|</span>
+-----+-------+-----+-------+-------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>information_schema -- 视图库 存储的表--视图表 

视图表查看需求01：
<span class="token comment"># 统计数据库资产信息（数据资产），获取每个库中表的个数和名称信息（业务相关）</span>

<span class="token keyword">select</span> table_schema,count<span class="token punctuation">(</span>*<span class="token punctuation">)</span>,group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> 
group by table_schema<span class="token punctuation">;</span>

+--------------+----------+------------------------------+
<span class="token operator">|</span> TABLE_SCHEMA <span class="token operator">|</span> count<span class="token punctuation">(</span>*<span class="token punctuation">)</span> <span class="token operator">|</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span>     <span class="token operator">|</span>
+--------------+----------+------------------------------+
<span class="token operator">|</span> school       <span class="token operator">|</span>        <span class="token number">5</span> <span class="token operator">|</span> student,course,sc,teacher,t1 <span class="token operator">|</span>
<span class="token operator">|</span> test01       <span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> student                      <span class="token operator">|</span>
<span class="token operator">|</span> world        <span class="token operator">|</span>        <span class="token number">3</span> <span class="token operator">|</span> city,country,countrylanguage <span class="token operator">|</span>
+--------------+----------+------------------------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>视图表查看需求02：
<span class="token comment"># 统计数据库资产信息（数据资产），获取每个数据库数据占用磁盘空间 </span>
<span class="token keyword">select</span> table_schema,sum<span class="token punctuation">(</span>table_rows*avg_row_length+index_length<span class="token punctuation">)</span>/1024/1024/1024 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> 
group by table_schema<span class="token punctuation">;</span>
+--------------+------------------------------------------------------------+
<span class="token operator">|</span> TABLE_SCHEMA <span class="token operator">|</span> sum<span class="token punctuation">(</span>table_rows*avg_row_length+index_length<span class="token punctuation">)</span>/1024/1024/1024 <span class="token operator">|</span>
+--------------+------------------------------------------------------------+
<span class="token operator">|</span> test01       <span class="token operator">|</span>                                             <span class="token number">0.000015258789</span> <span class="token operator">|</span>
<span class="token operator">|</span> world        <span class="token operator">|</span>                                             <span class="token number">0.000745772384</span> <span class="token operator">|</span>
<span class="token operator">|</span> school       <span class="token operator">|</span>                                             <span class="token number">0.000061019324</span> <span class="token operator">|</span>
+--------------+------------------------------------------------------------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>视图表查看需求03：
<span class="token comment"># 统计数据库资产信息（数据资产），获取具有碎片信息的表</span>
<span class="token keyword">select</span> table_schema,table_name,data_free 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and data_free <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token punctuation">;</span>

xiaoA  t1  <span class="token number">60</span>
xiaoB  t2  <span class="token number">20</span>
xiaoC  t3  <span class="token number">10</span>

xiaoA表                  磁盘 
存储01行数据   ----  磁道--扇区存储数据  
磁盘中存储或读取数据，最优方案是顺序存储和连续读取 --- 顺序IO
磁盘中存储或读取数据，最差方案是随机存储和随机读取 --- 随机IO

可以对已经是innodb存储引擎的表做操作，实现整理碎片功能
alter table xiaoA.t1 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>

对碎片表数据进行批量整理
<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">&quot;alter table &quot;</span>,table_schema,<span class="token string">&quot;.&quot;</span>,table_name,<span class="token string">&quot; engine=innodb;&quot;</span><span class="token punctuation">)</span> 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and data_free <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token punctuation">;</span>

alter table xiaoA.t1  <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table xiaoB.t2  <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table xiaoC.t3  <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 统计数据库资产信息（数据资产），获取数据库中非innodb表信息 myisam -- 不支持并发访问的行锁机制</span>
<span class="token keyword">select</span> table_schema,table_name,engine 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and engine<span class="token operator">!=</span><span class="token string">'innodb'</span><span class="token punctuation">;</span>

创建非innodb数据表：
create table t1 <span class="token punctuation">(</span>id int<span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>myisam<span class="token punctuation">;</span>
create table t2 <span class="token punctuation">(</span>id int<span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>myisam<span class="token punctuation">;</span>
create table t3 <span class="token punctuation">(</span>id int<span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>myisam<span class="token punctuation">;</span>

<span class="token keyword">select</span> table_schema,table_name,engine 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and engine<span class="token operator">!=</span><span class="token string">'innodb'</span><span class="token punctuation">;</span>
+--------------+------------+--------+
<span class="token operator">|</span> TABLE_SCHEMA <span class="token operator">|</span> TABLE_NAME <span class="token operator">|</span> ENGINE <span class="token operator">|</span>
+--------------+------------+--------+
<span class="token operator">|</span> test01       <span class="token operator">|</span> t1         <span class="token operator">|</span> MyISAM <span class="token operator">|</span>
<span class="token operator">|</span> test01       <span class="token operator">|</span> t2         <span class="token operator">|</span> MyISAM <span class="token operator">|</span>
<span class="token operator">|</span> test01       <span class="token operator">|</span> t3         <span class="token operator">|</span> MyISAM <span class="token operator">|</span>
+--------------+------------+--------+

alter table test01.t1 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table test01.t2 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table test01.t3 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>

<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">&quot;alter table &quot;</span>,table_schema,<span class="token string">&quot;.&quot;</span>,table_name,<span class="token string">&quot; engine=innodb;&quot;</span><span class="token punctuation">)</span> 
from information_schema.tables 
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and  engine <span class="token operator">!=</span><span class="token string">'innodb'</span> into outfile <span class="token string">'/tmp/alter.sql'</span><span class="token punctuation">;</span>

执行上面的命令报错了，如下
ERROR <span class="token number">1290</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: The MySQL server is running with the --secure-file-priv option so it cannot execute this statement

解决：
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /data/3306/my.cnf </span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">secure_file_priv</span><span class="token operator">=</span>/tmp/    新添加的


<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart mysql80</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">&quot;alter table &quot;</span>,table_schema,<span class="token string">&quot;.&quot;</span>,table_name,<span class="token string">&quot; engine=innodb;&quot;</span><span class="token punctuation">)</span> 
    -<span class="token operator">&gt;</span> from information_schema.tables 
    -<span class="token operator">&gt;</span> where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and  engine <span class="token operator">!=</span><span class="token string">'innodb'</span> into outfile <span class="token string">'/tmp/alter.sql'</span><span class="token punctuation">;</span> 
Query OK, <span class="token number">3</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/alter.sql </span>
alter table test01.t1 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table test01.t2 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
alter table test01.t3 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">source</span> /tmp/alter.sql
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  Warnings: <span class="token number">0</span>

Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  Warnings: <span class="token number">0</span>

Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  Warnings: <span class="token number">0</span>

再查看：
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> table_schema,table_name,engine 
    -<span class="token operator">&gt;</span> from information_schema.tables 
    -<span class="token operator">&gt;</span> where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span>,<span class="token string">'sys'</span>,<span class="token string">'performance_schema'</span>,<span class="token string">'information_schema'</span><span class="token punctuation">)</span> and engine<span class="token operator">!=</span><span class="token string">'innodb'</span><span class="token punctuation">;</span>
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> desc information_schema.tables<span class="token punctuation">;</span>
tables视图表列信息说明：
table_rows      -- 表信息中有多少数据行
avg_row_length  -- 平均每行占用磁盘空间大小
index_length    -- 索引占用磁盘空间大小
data_free       -- 当数值为0时，表示数据表中没有碎片信息；当数值<span class="token operator">&gt;</span><span class="token number">0</span>, 表示数据表中存在碎片
engine          -- 显示数据表引擎信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_12-体系结构"><a href="#_12-体系结构" class="header-anchor">#</a> 12. 体系结构</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>基础体系结构：
逻辑结构 -- 
库信息：库名称 库字符集
表信息：表名称 表字符集 表结构字段 表数据类型 表约束属性 表数据信息

物理结构 -- 
系统数据目录中 含有子目录 文件信息 
库信息 -- 库目录
表信息 -- 库目录/表文件.ibd  <span class="token punctuation">(</span>xiaoA.frm-保存表结构信息 xiaoA.ibd--保存表中数据信息<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@db-01 school<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">448</span>
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">114688</span> Oct <span class="token number">23</span> <span class="token number">15</span>:22 course.ibd
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">114688</span> Oct <span class="token number">23</span> <span class="token number">15</span>:22 sc.ibd
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">114688</span> Oct <span class="token number">23</span> <span class="token number">15</span>:21 student.ibd
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">114688</span> Oct <span class="token number">23</span> <span class="token number">15</span>:22 teacher.ibd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>进阶体系结构：
增删改查语句 -- 查询语句执行逻辑过程
<span class="token keyword">select</span> * from  word where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

客户端：（本地连接-sock套接字文件  远程连接-tcp/ip 地址/端口）
01 客户端命令信息：mysql mysqladmin mysqldump 
02 第三方远程工具：xxxx
03 程序驱动信息：程序代码

服务端：（mysqld服务端进程）
服务层：连接器 分析器 优化器 执行器  -- 处于客户端发送的语句信息
	- 连接器：负责和客户端建立会话连接（验证用户 密码 端口 地址）-- 创建会话线程
           show processlist<span class="token punctuation">;</span>
		   --skip-grant-tables --skip-networking 
    - 分析器：检查语法 语义（语句类型） 信息，并且判断操作对象是否存在
    - 优化器：选择什么方式进行数据调取 （全表扫描 利用索引--选择代价低的方案 CPU MEM IO）
    - 执行器: 根据优化器选择好的执行方案，进行语句执行（进行权限判断），语句执行后会获取数据读取数据的位置 
引擎层：
	存储数据线程（write） 调取数据线程（read）     -- 从磁盘调取或存储数据
	引擎层不能直接管理磁  CPU--磁盘<span class="token punctuation">(</span>01磁道01扇区<span class="token punctuation">)</span>
	引擎要调取数据  CPU --<span class="token operator">&gt;</span> 磁盘
	引擎结构  -- 磁盘结构 对应关系
	段（表文件） -  区（连续64page-1M） - 页<span class="token punctuation">(</span>16kb-4block-16个扇区<span class="token punctuation">)</span>   --- 扇区/block
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="/devops/public/assets/img/1729675748351.bb7a2e09.png" alt="1729675748351"></p> <h2 id="五-事务"><a href="#五-事务" class="header-anchor">#</a> 五，事务</h2> <h3 id="_1-acid"><a href="#_1-acid" class="header-anchor">#</a> 1，ACID</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 数据库事务机制特性：（ACID特性）

A（atomicity-原子性）：
在数据库中进行事务操作时，一个事务中的所有操作语句要么都成功，要么都失败；
银行转账：账户A（100-50）   ---    账户B（50-100）
update 账户表 <span class="token builtin class-name">set</span> A账户钱<span class="token operator">=</span><span class="token number">50</span>  where A账户<span class="token punctuation">;</span>  
update 账户表 <span class="token builtin class-name">set</span> B账户钱<span class="token operator">=</span><span class="token number">100</span> where B账户<span class="token punctuation">;</span>
以上两个操作合在一起称为一个事务操作

C（consistency-一致性）
在数据库运行过程中，如果数据库出现异常停止故障，必须保证数据库恢复后，数据库中的数据信息要保证和数据库故障前一致

I <span class="token punctuation">(</span>isolation-隔离性<span class="token punctuation">)</span>  如何控制并发操作
在数据库服务运行过程中，会大量客户端并发访问数据库，保证并行访问操作数据信息或者读取数据信息的隔离性
学生表--手机号
管理员A--手机号-110
管理员B--手机号-120

D（durability-持久性） 
在数据库运行过程中，在数据库中写入的所有数据信息必须保存到磁盘中；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_2-事务的生命周期"><a href="#_2-事务的生命周期" class="header-anchor">#</a> 2，事务的生命周期</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 数据库事务生命周期
begin<span class="token punctuation">;</span>start transaction  --- 表示事务开始
操作语句信息  <span class="token number">1000</span>条
commit<span class="token punctuation">;</span>    -- 操作完毕结束事务（所有操作信息写入磁盘）
rollback<span class="token punctuation">;</span>  -- 终止事务操作过程（将内存中所有操作释放）

PS：事务生成周期扩展说明
<span class="token number">1</span>）当一个事务中，出现大量的DML语句操作情况，就会将此事务称为大事务
   https://blog.csdn.net/m0_63331248/article/details/140543917
<span class="token number">2</span>）在事务生命周期中，如果执行DDL或者DCL操作，事务会自动提交，不能进行回滚
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_3-事务的提交方式"><a href="#_3-事务的提交方式" class="header-anchor">#</a> 3，事务的提交方式</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 数据库事务提交方式

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@autocommit<span class="token punctuation">;</span>
+--------------+
<span class="token operator">|</span> @@autocommit <span class="token operator">|</span>
+--------------+
<span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>
+--------------+
查询到的结果是1 则表示自动提交，结果是0表示手动提交。当然也可以通过下面语句修改提交方式


<span class="token comment"># 临时关闭事务自动提交功能，配置调整后，重新登录mysql数据库生效，重新mysql服务就不生效</span>
mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> global <span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment"># 永久关闭事务自动提交功能，重新启动mysql数据库生效</span>
<span class="token comment"># vim /etc/my.cnf</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token number">1</span>）自动提交方式
<span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">1</span>  <span class="token operator">==</span> 默认参数变量设置为1，表示开启事务自动提交功能
				 每执行一条DML语句，都会在语句后自动执行commit
<span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token operator">==</span> 表示关闭事务自动提交功能，会造成所有DML语句操作失效<span class="token operator">=</span>自动回滚

<span class="token number">2</span>）手动提交方式
begin<span class="token punctuation">..</span>.commit<span class="token punctuation">;</span>

<span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">1</span>
好处：可以保证用户执行完DML语句后，进行自动提交，保证数据信息可以存储到磁盘
坏处：无法实现事务操作的原子性

<span class="token assign-left variable">autocommit</span><span class="token operator">=</span><span class="token number">0</span>
好处：可以实现事务操作的原子性
坏处：需要每次DML语句操作后，手动执行提交命令（否则可能出现DML操作回滚情况，有时也有可能出现大事务操作）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> use test01<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> create table t1<span class="token punctuation">(</span>id int<span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> insert into t1 values<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> insert into t1 values<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> insert into t1 values<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from t1<span class="token punctuation">;</span>
+------+
<span class="token operator">|</span> <span class="token function">id</span>   <span class="token operator">|</span>
+------+
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>
+------+
<span class="token number">3</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456</span>
mysql<span class="token operator">&gt;</span> use test01<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_4-事务隔离机制"><a href="#_4-事务隔离机制" class="header-anchor">#</a> 4，事务隔离机制</h3> <p>隔离级别不同：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>RU: 并发读取数据 或者 并发写入数据 性能最强~ 
RC/RR: 
SR: 并发读取数据 或者 并发写入数据 性能最弱~ 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/devops/public/assets/img/1729735785685.930bf7ed.png" alt="1729735785685"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>有4种隔离级别 （transaction_isolation）
类型一：RU（READ-UNCOMMITTED 表示读未提交）
无法处理脏读  不可重复读 幻读问题

类型二：RC（READ-COMMITTED   表示读已提交）
可以处理脏读问题  无法处理 不可重复读 幻读问题

类型三：RR（REPEATABLE-READ  表示可重复读）
可以处理脏读问题  不可重复读 幻读问题（MVCC机制）

类型四：SR（SERIALIZABLE     串行化隔离机制）
可以处理脏读问题  不可重复读 幻读问题（锁机制）

查看默认的事务隔离级别：
SELECT @@transaction_isolation<span class="token punctuation">;</span>
+-------------------------+
<span class="token operator">|</span> @@transaction_isolation <span class="token operator">|</span>
+-------------------------+
<span class="token operator">|</span> REPEATABLE-READ         <span class="token operator">|</span>
+-------------------------+


名词解释：
脏页：从磁盘中加载到内存中的数据，对数据页做了改动后，但是还没有进行存储时，就将此类数据页称为脏页

并行读取数据的三种问题：
脏读问题： 可以看到内存中变化修改的数据页，但时此数据页并没有存储到磁盘中
不可重复读问题：在对数据库信息多次查询时，每次查询的结果都不一致
幻读问题：      在进行插入数据信息，造成会话之前数据量不一致的情况
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><img src="/devops/public/assets/img/1729736184865.ea2d5391.png" alt="1729736184865"></p> <p><img src="/devops/public/assets/img/1729736319682.5ad00348.png" alt="1729736319682"></p> <p><img src="/devops/public/assets/img/1729736423973.e0f16f19.png" alt="1729736423973"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> use test01<span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> create table t1 <span class="token punctuation">(</span>
    <span class="token function">id</span> int not null primary key auto_increment,
    a int not null,
    b varchar<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> not null,
    c varchar<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> not null
<span class="token punctuation">)</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf8mb4 <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>

alter table t1 <span class="token function">add</span> index idx<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> begin<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> insert into t1<span class="token punctuation">(</span>a,b,c<span class="token punctuation">)</span>
values
<span class="token punctuation">(</span><span class="token number">5</span>,<span class="token string">'a'</span>,<span class="token string">'aa'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">7</span>,<span class="token string">'c'</span>,<span class="token string">'ab'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">10</span>,<span class="token string">'d'</span>,<span class="token string">'ae'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">13</span>,<span class="token string">'g'</span>,<span class="token string">'ag'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">14</span>,<span class="token string">'h'</span>,<span class="token string">'at'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">16</span>,<span class="token string">'i'</span>,<span class="token string">'au'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">20</span>,<span class="token string">'j'</span>,<span class="token string">'av'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">22</span>,<span class="token string">'k'</span>,<span class="token string">'aw'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">25</span>,<span class="token string">'l'</span>,<span class="token string">'ax'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">27</span>,<span class="token string">'o'</span>,<span class="token string">'ay'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">31</span>,<span class="token string">'p'</span>,<span class="token string">'az'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">50</span>,<span class="token string">'x'</span>,<span class="token string">'aze'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">60</span>,<span class="token string">'y'</span>,<span class="token string">'azb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> commit<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>操作演示：类型一-RU
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">transaction_isolation</span><span class="token operator">=</span><span class="token string">'READ-UNCOMMITTED'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/devops/public/assets/img/1729737022394.c2fa7c81.png" alt="1729737022394"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>脏读问题： 需要开启两个数据库连接会话（会话A 会话B）
会话A   修改数据信息 update t1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">20</span> where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
会话B   查看数据信息 看到会话A的操作信息

不可重复读：
会话A   多次修改表中数据信息  update t1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">20</span> where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span> 需要将改动操作提交 commit 
会话B   查看统计数据          <span class="token keyword">select</span> avg<span class="token punctuation">(</span>a<span class="token punctuation">)</span> from t1<span class="token punctuation">;</span>  每次统计信息不一致

幻读问题：
会话A   根据区间范围数据进行调整，最后提交操作查看数据信息，会发现异常情况  update t1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">b</span><span class="token operator">=</span><span class="token string">'P4'</span> where a<span class="token operator">&gt;</span><span class="token number">30</span><span class="token punctuation">;</span>
会话B   在相应的区间范围内查询数据信息                                        insert into t1 values <span class="token punctuation">(</span><span class="token number">14,35</span>,<span class="token string">'P2'</span>,<span class="token string">'cdf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>操作演示：类型二-RC（MVCC） 
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">transaction_isolation</span><span class="token operator">=</span><span class="token string">'READ-COMMITTED'</span><span class="token punctuation">;</span>

脏读问题： 需要开启两个数据库连接会话（会话A 会话B）
会话A   修改数据信息 update t1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">a</span><span class="token operator">=</span><span class="token number">20</span> where <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
会话B   查看数据信息 看到会话A的操作信息
PS：RC级别下不会出现脏读情况，但是不可重复和幻读情况依然存在；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>操作演示：类型三-RR（MVCC） 
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">transaction_isolation</span><span class="token operator">=</span><span class="token string">'REPEATABLE-READ'</span><span class="token punctuation">;</span>
PS：RR级别下不会出现脏读 不可重复读 以及幻读问题

为什么RR,可以避免脏读，不可重复读，幻读问题，底层靠的是MVCC。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>操作演示：类型四-SR（利用表锁机制 实现事务操作串行化 r-r 共享 r-w 互斥 w-rw 互斥） 
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">transaction_isolation</span><span class="token operator">=</span><span class="token string">'SERIALIZABLE'</span><span class="token punctuation">;</span>
PS：SR级别下不会出现脏读 不可重复读 以及幻读问题
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_5-mvcc"><a href="#_5-mvcc" class="header-anchor">#</a> 5，MVCC</h3> <p><strong>MVCC技术引入说明：</strong></p> <p>根据之前的事务隔离级别，可以等到以下结论信息：</p> <p>对于RR级别在innodb引擎下，可以实现解决不可重复读和幻读等相关问题，需要使用Innodb引擎中的MVCC机制；</p> <p><img src="/devops/public/assets/img/1729742375742.f1be2852.png" alt="1729742375742"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>名词解释： 
undo  ：记录回滚数据信息的  
版本链：多次数据信息形成版本链存储
快照读：select命令读取数据
当前读：insert update delete 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>假设一个数据库服务中，出现了以下4个并发事务操作信息：</p> <p><img src="/devops/public/assets/img/1729742549881.28f756e9.png" alt="1729742549881"></p> <p>RR隔离级别查看信息：select 01 查看信息为张三；select 02 查看信息为张三；</p> <p>RC隔离级别查看信息：select 01 查看信息为张三；select 02 查看信息为张小三；</p> <blockquote><p>说明：RC级别下出现”不可重复读情况”，RR级别下实现了”可重复读情况</p></blockquote> <p>为什么在MySQL数据库中，应用Innodb存储引擎时，两种不同的隔离级别（RR/RC）会出现不同的读取结果？</p> <p>这就需要了解MVCC的工作原理机制，其中首先需要掌握undo log的链接表机制（版本链）：</p> <p><img src="/devops/public/assets/img/1729742664311.908309a2.png" alt="1729742664311"></p> <p>了解完什么是undo log版本链相关知识后，那么版本链和MVCC有什么关系呢，下面需要再了解一个新的知识”Read View”；</p> <p>ReadView是”<code>快照读</code>”SQL执行时MVCC提取数据的依据；</p> <ul><li><p><code>快照读</code>就是最普通的select查询SQL语句；(应用MVCC读取数据)</p></li> <li><p><code>当前读</code>指代执行下列语句时进行数据读取的方式；（应用next key lock锁进制读取数据）</p> <p>insert、update、delete、select...for update、select...lock in share mode</p></li></ul> <p>ReadView是一个数据结构，包含4个组成字段：</p> <table><thead><tr><th>字段</th> <th>结构</th> <th>解释说明</th></tr></thead> <tbody><tr><td>01</td> <td>m_ids</td> <td>当前活跃的事务编号集合，即没有提交的事务编号汇总</td></tr> <tr><td>02</td> <td>min_trx_id</td> <td>最小活跃事务编号</td></tr> <tr><td>03</td> <td>max_trx_id</td> <td>预分配事务编号，当前最大事务编号+1</td></tr> <tr><td>04</td> <td>creator_trx_id</td> <td>readview创建者的事务编号</td></tr></tbody></table> <p><strong>场景01：读已提交（RC）-在每一次执行快照读时生成新的readview</strong></p> <p>生成的readview数据结构信息如下：</p> <p><img src="/devops/public/assets/img/1729742863988.047c049c.png" alt="1729742863988"></p> <p><strong>第一次数据读取过程分析：（RC级别下的第一次readview信息读取）</strong></p> <p><img src="/devops/public/assets/img/1729742903942.c907aa45.png" alt="1729742903942"></p> <p>版本链数据访问规则：</p> <ul><li>判断当前版本链中数据镜像事务trx_id = creator_trx_id(4)</li></ul> <p>若成立说明数据就是自己这个事务更改的，可以访问；</p> <ul><li>判断当前版本链中数据镜像事务trx_id &lt; min_trx_id(2)</li></ul> <p>若成立说明数据已经提交了，可以访问</p> <ul><li>判断当前版本链中数据镜像事务trx_id &gt; max_trx_id(5)</li></ul> <p>若成立说明该事务是在readview生成以后才开启的，不允许访问数据</p> <ul><li>判断当前版本链中数据镜像事务min_trx_id&lt;=trx_id&lt;=max_trx_id(5)</li></ul> <p>若成立需要在m_ids事务集合中进行对比，当前事务trx_id若未出现在集合中，则代表数据已经提交了，可以访问</p> <blockquote><p>结论：因此根据以上的版本链数据访问规则，readview可以读取到事务trx_id=1提交的数据，即数据”张三”；</p></blockquote> <p><strong>第二次数据读取过程分析：（RC级别下的第二次readview信息读取）</strong></p> <p><img src="/devops/public/assets/img/1729743025937.d909fa8e.png" alt="1729743025937"></p> <p>版本链数据访问规则：</p> <ul><li>判断当前版本链中数据镜像事务trx_id = creator_trx_id(4)</li></ul> <p>若成立说明数据就是自己这个事务更改的，可以访问；</p> <ul><li>判断当前版本链中数据镜像事务trx_id &lt; min_trx_id(2)</li></ul> <p>若成立说明数据已经提交了，可以访问</p> <ul><li>判断当前版本链中数据镜像事务trx_id &gt; max_trx_id(5)</li></ul> <p>若成立说明该事务是在readview生成以后才开启的，不允许访问数据</p> <ul><li>判断当前版本链中数据镜像事务 min_trx_id&lt;=trx_id&lt;=max_trx_id(5)</li></ul> <p>若成立需要在m_ids事务集合中进行对比，当前事务trx_id若未出现在集合中，则代表数据已经提交了，可以访问</p> <blockquote><p>结论：因此根据以上的版本链数据访问规则，readview可以读取到事务trx_id=1提交的数据，即数据”张小三”；</p></blockquote> <p><strong>场景02：可重复读（RR）-仅在第一次执行快照读时生成readview，后续快照读复用（但有例外情况）</strong></p> <p>生成的readview数据结构信息如下：</p> <p><img src="/devops/public/assets/img/1729743050278.41e84437.png" alt="1729743050278"></p> <p><strong>第一次数据读取过程分析：（RR级别下的第一次readview信息读取）</strong></p> <p><img src="/devops/public/assets/img/1729743062924.d0b210c6.png" alt="1729743062924"></p> <p>版本链数据访问规则：</p> <ul><li>判断当前版本链中数据镜像事务trx_id = creator_trx_id(4)</li></ul> <p>若成立说明数据就是自己这个事务更改的，可以访问；</p> <ul><li>判断当前版本链中数据镜像事务trx_id &lt; min_trx_id(2)</li></ul> <p>若成立说明数据已经提交了，可以访问</p> <ul><li>判断当前版本链中数据镜像事务trx_id &gt; max_trx_id(5)</li></ul> <p>若成立说明该事务是在readview生成以后才开启的，不允许访问数据</p> <ul><li>判断当前版本链中数据镜像事务 min_trx_id&lt;=trx_id&lt;=max_trx_id(5)</li></ul> <p>若成立需要在m_ids事务集合中进行对比，当前事务trx_id若未出现在集合中，则代表数据已经提交了，可以访问</p> <blockquote><p>结论：因此根据以上的版本链数据访问规则，readview可以读取到事务trx_id=1提交的数据，即数据”张三”；</p></blockquote> <p><strong>第二次数据读取过程分析：（RR级别下的第二次readview信息读取）</strong></p> <p>由于RR级别下，会复用第一次读的readview信息，所以读取的的数据是一致的，从而实现了可重复读情况；</p> <blockquote><p>结论：因此根据以上的版本链数据访问规则，readview可以读取到事务trx_id=1提交的数据，即数据”张三”；</p></blockquote> <p>RR级别下使用MVCC可以解决幻读问题吗？</p> <p>可以解决，但不能完全解决；</p> <p>因为在MVCC机制中，并不是采用锁的机制，完全的对事务数据操作进行了隔离，而是采用版本控制的方式，变相的解决了幻读问题；</p> <p>对于RR隔离级别中，由于连续多次快照读，ReadView会产生复用情况，所以在两个快照读之间，就算其他事务产生了数据变化；</p> <p>对于当前事务来说，变化的数据信息都是不可见的，所以没有幻读问题；</p> <p>但是会有一种特例情况：当两次快照读之间存在当前读，ReadView会重新生成，导致产生幻读；</p> <p><img src="/devops/public/assets/img/1729743109681.7c19c8eb.png" alt="1729743109681"></p> <p>对于隔离级别而言，只有RC和RR级别可以使用到MVCC机制的，实现一种快照读机制，而RU和SR级别是不会使用到MVCC机制的；</p> <ul><li>RC：应用MVCC的快照读机制，是基于语句级别的；<code>（不可重复读 ture）</code></li></ul> <p>在事务期间，执行每个查询语句的时候，都会检查MVCC版本（快照列表），获取最新的已提交事务的快照；</p> <ul><li>RR：应用MVCC的快照读机制，是基于事务级别的；<code>（不可重复读 false）</code></li></ul> <p>在事务期间，执行首条查询语句的时候，就会生成MVCC版本（相应快照），将会一直读取此快照数据信息，直到事务生命周期结束；</p> <p>以上的RR隔离级别利用MVCC的快照读机制，又称为一致性快照读；</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MVCC读取数据机制：
利用MVCC机制中的 版本链 和 快照读事务信息，配合读取数据的规则情况；
可以实现RC级别会出现不可重复读情况
可以实现RR级别会出现可重复读情况
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_6-隔离机制应用的锁"><a href="#_6-隔离机制应用的锁" class="header-anchor">#</a> 6，隔离机制应用的锁</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库事务隔离机制应用的锁有什么？（读-脏读 不可重复读 幻读  写-锁）

基础锁应用：行锁应用
<span class="token number">1</span>）记录锁（RU RC RR） wlock -- wlock （互斥）
<span class="token number">2</span>）间隙锁（RR）
   update t1 <span class="token builtin class-name">set</span> <span class="token assign-left variable">b</span><span class="token operator">=</span><span class="token string">'P5'</span> where a<span class="token operator">&gt;</span><span class="token number">30</span>  <span class="token punctuation">(</span><span class="token number">31</span> <span class="token number">35</span> <span class="token number">40</span> <span class="token number">50</span> <span class="token number">60</span><span class="token punctuation">)</span>  A会话
   insert into t1 values <span class="token punctuation">(</span><span class="token number">15,36</span>,<span class="token string">'P2'</span>,xxx<span class="token punctuation">)</span>             B会话
<span class="token number">3</span><span class="token punctuation">)</span> 记录锁+间隙锁<span class="token operator">=</span>下一键锁/邻键锁 （RR）
https://www.cnblogs.com/hsjz-xinyuan/p/18456634


特殊锁应用：表锁应用（意向锁 IS IX）
共享锁（乐观锁）：多个事务生成的表锁信息可以共存（读-读共享  读-写共享）
独占锁（悲观锁）：多个事务生成的表锁信息不能共存（写-读互斥  写-写互斥）
https://blog.csdn.net/mymic/article/details/136622113
https://yujingbo1023.github.io/devops/public/blogs/ssm/05.html


根据隔离级别不同：
RU: 并发读取数据 或者 并发写入数据 性能最强~ 
RC/RR<span class="token punctuation">(</span>间隙锁<span class="token punctuation">)</span>
SR: 并发读取数据 或者 并发写入数据 性能最弱~ 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="六-索引"><a href="#六-索引" class="header-anchor">#</a> 六，索引</h2> <h3 id="_1-什么是索引"><a href="#_1-什么是索引" class="header-anchor">#</a> 1，什么是索引</h3> <p>参考：https://yujingbo1023.github.io/devops/public/blogs/javabase/mysql/mysql.html</p> <p>参考：https://blog.csdn.net/jupangMZ/article/details/142723162</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>可以简单理解：数据库索引相当于书的目录，可以借助索引有针对的查看相应数据的信息，避免了全盘检索带来的工作量；
可以有多种索引的设置方法；主键索引 普通索引 唯一索引 前缀索引 联合索引 外键索引
如何利用索引快速调取数据；索引调取数据模型/算法

玩游戏 --- 猜奖品
<span class="token number">100</span>个盒子   一个盒子奖品  -- 最快速得到   可以和老师进行沟通；

方案一： 一个一个找奖品：遍历查询数据 
方法二：小于<span class="token operator">=</span><span class="token number">50</span>盒子里 -- 有  小于<span class="token operator">=</span><span class="token number">25</span>盒子里 -- 有  小于<span class="token operator">=</span><span class="token number">13</span>盒子里 - 有  二叉树/二分法（查询数据不均衡）
方案三：100个盒子分组  每个5个盒子一组       B（blance）+TREE结构（查询数据效率 查询任何数据都）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="/devops/public/assets/img/1729688230665.f9e9adf2.png" alt="1729688230665"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>假如查询值等于10的数据。查询路径磁盘块10-<span class="token operator">&gt;</span>磁盘块20-<span class="token operator">&gt;</span>磁盘块31。
第一次磁盘IO：将磁盘块1加载到内存中，在内存中从头遍历比较，1<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span><span class="token number">15</span>，走左路，到磁盘寻址磁盘块2。
第二次磁盘IO：将磁盘块2加载到内存中，在内存中从头遍历比较，<span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span><span class="token number">10</span>，到磁盘中寻址定位到磁盘块5。
第三次磁盘IO：将磁盘块5加载到内存中，在内存中从头遍历比较，10<span class="token operator">=</span><span class="token number">10</span>，找到10，取出data；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/devops/public/assets/img/1729689020788.e13d4295.png" alt="1729689020788"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>B（blance）+TREE结构：
- 页节点 存储数据 和 索引信息 
- 支节点 索引范围 指针信息 可以有多个 
- 根节点 索引范围 指针信息 只能有一个
+ 表示页节点之间可以有双向指针，可以便于进行数据的范围查询

B+Tree结构应用方法：
如何进行数据等值查询 
如何进行数据范围查询
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>聚簇索引的构建方式：</p> <ul><li>数据表创建时，显示的构建了主键信息（pk），主键（pk）就是聚簇索引；</li> <li>数据表创建时，没有显示的构建主键信息时，会将第一个不为空的UK的列做为聚簇索引；</li> <li>数据表创建时，以上条件都不符合时，生成一个6字节的隐藏列作为聚簇索引；</li></ul> <p>结合下图信息，可以看出聚簇索引组织存储数据过程与加速查询过程原理：</p> <p><img src="/devops/public/assets/img/1729740455169.36fe843e.png" alt="1729740455169"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>以上图信息为例，若显示创建ID列为pk自增列：
① 按照ID逻辑顺序，在同一个区中连续的数据页上，有序存储数据行；
② 数据行所在的数据页，作为聚簇索引的叶子节点（叶子节点就是所有数据行）；
③ 叶子节点构建完后，可以构建no-left（支节点），用于保存的是leaf节点中的ID范围和指针信息；
④ 支节点构建完后，可以构建root（根节点），用于保存的是no-leaf节点中的ID范围和指针信息；
⑤ 并且leaf节点和no-leaf相邻数据页之间都具有双向指针，从而加速数据的范围查找；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>辅助索引的构建方式：</p> <ul><li>数据表创建时，显示的构建了一般索引信息（mul），一般索引信息（mul）就是辅助索引；</li> <li>数据表创建时，没有显示的构建一般索引信息时，在查询检索指定数据信息，会进行全表扫描查找数据；</li></ul> <p>结合下图信息，可以看出辅助索引组织存储数据过程与加速查询过程原理：</p> <p><img src="/devops/public/assets/img/1729740882306.1419d35c.png" alt="1729740882306"></p> <h3 id="_2-索引crud"><a href="#_2-索引crud" class="header-anchor">#</a> 2，索引CRUD</h3> <p>看之前的mysql课件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建索引：
如何创建索引：
<span class="token number">1</span>）主键索引创建
mysql<span class="token operator">&gt;</span> create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,primary key <span class="token punctuation">(</span>column<span class="token punctuation">))</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> ALTER TABLE <span class="token variable"><span class="token variable">`</span>table_name<span class="token variable">`</span></span> ADD PRIMARY KEY <span class="token punctuation">(</span> <span class="token variable"><span class="token variable">`</span><span class="token function">column</span><span class="token variable">`</span></span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
-- 主键索引是一种特殊的唯一索引，一个表中只能有一个主键，不允许有空值
说明：
- 数据表创建时，显示的构建了主键信息（pk），主键（pk）就是聚簇索引；
- 数据表创建时，没有显示的构建主键信息时，会将第一个不为空的UK的列做为聚簇索引；
- 数据表创建时，以上条件都不符合时，生成一个6字节的隐藏列作为聚簇索引；

<span class="token number">2</span>）普通索引创建（某个业务列有唯一特性）
mysql<span class="token operator">&gt;</span> create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,index index_name<span class="token punctuation">(</span>column<span class="token punctuation">)</span>
mysql<span class="token operator">&gt;</span> alter table table_name <span class="token function">add</span> index idx_name<span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>
说明：
- 数据表创建时，显示的构建了一般索引信息（mul），一般索引信息（mul）就是辅助索引；
- 数据表创建时，没有显示的构建一般索引信息时，在查询检索指定数据信息，会进行全表扫描查找数据；


<span class="token number">3</span>）唯一索引创建
mysql<span class="token operator">&gt;</span> create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,unique index index_name<span class="token punctuation">(</span>column<span class="token punctuation">))</span>
mysql<span class="token operator">&gt;</span> alter table table_name <span class="token function">add</span> unique index idx_name<span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>

普通索引创建 vs 唯一索引创建
企业应用如果严格限制数据的唯一性，需要设置唯一索引，但是在录入数据时，会消耗的系统CPU 内存 IO会多一些；
企业应用如果没有限制数据的唯一性，可以设置普通索引，在进行数据录入时，不会消耗额外CPU 内存 IO资源

<span class="token number">4</span><span class="token punctuation">)</span> 联合索引创建
mysql<span class="token operator">&gt;</span> create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,index index_name<span class="token punctuation">(</span>column01,column02,column03<span class="token punctuation">..</span><span class="token punctuation">)</span>
mysql<span class="token operator">&gt;</span> alter table table_name <span class="token function">add</span> index idx_name<span class="token punctuation">(</span>column01,column02,column03<span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token number">5</span>）创建前缀索引
create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,index index_name<span class="token punctuation">(</span>column<span class="token punctuation">(</span>length<span class="token punctuation">))</span>          -- 普通索引前缀
create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,unique index index_name<span class="token punctuation">(</span>column<span class="token punctuation">(</span>length<span class="token punctuation">))</span><span class="token punctuation">)</span>  -- 唯一索引前缀
create table table_name <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span>,index index_name<span class="token punctuation">(</span>column01<span class="token punctuation">(</span>length<span class="token punctuation">)</span>,column02<span class="token punctuation">(</span>length<span class="token punctuation">)</span>,column03<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">)</span>   -- 联合索引前缀
PS：设置前缀索引，可以避免索引数结构层次过高，导致查询数据IO消耗增加


查看索引创建情况：
SHOW INDEX FROM table_name <span class="token punctuation">[</span>FROM db_name<span class="token punctuation">]</span> <span class="token punctuation">[</span>WHERE condition<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Table: city              -- 查询索引的表信息            
   Non_unique: <span class="token number">0</span>                 -- 对应索引是否是唯一特性（0--主键/唯一键 <span class="token number">1</span>-没有唯一性）     
     Key_name: PRIMARY           -- 显示索引名称（列名称）                            		        ***
 Seq_in_index: <span class="token number">1</span>                 -- 在进行联合索引设置时，会区分联合索引顺序 ？？？               ***
  Column_name: ID                -- 显示索引列名称                                         		 	***
    Collation: A                 -- 索引排序规则（A--升序 D--降序）
  Cardinality: <span class="token number">4104</span>              -- 索引选择度显示（数据自动评估索引列的重复值情况） 
                                    索引选择度-低--重复内容多  索引选择度-高--重复内容少
     Sub_part: NULL              -- 显示索引前缀信息                                               ***
       Packed: NULL              -- 索引是否被压缩。如果索引未被压缩，该列的值为NULL
         Null:                   -- 列是否允许包含NULL值
   Index_type: BTREE             -- 索引应用算法类型（默认BTREE-B+TREE）
      Comment: 
Index_comment: 
      Visible: YES               -- 索引是否处于可用状态                                           *** 
   Expression: NULL


如何删除索引信息：
alter table city drop index idx_na_di_po<span class="token punctuation">;</span>

禁用索引功能：
alter table city drop index idx_na_di_po<span class="token punctuation">;</span>

alter table city drop index idx_na_di_po<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show index from city<span class="token punctuation">;</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token operator">|</span> Table <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name    <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> Null <span class="token operator">|</span> Index_type <span class="token operator">|</span> Comment <span class="token operator">|</span> Index_comment <span class="token operator">|</span> Visible <span class="token operator">|</span> Expression <span class="token operator">|</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> PRIMARY     <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> ID          <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">4104</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span> A         <span class="token operator">|</span>         <span class="token number">232</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_na_coun <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> Name        <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">3999</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_na_coun <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">4057</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> alter table city alter index idx_na_coun inVisible<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  Warnings: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> show index from city<span class="token punctuation">;</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token operator">|</span> Table <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name    <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> Null <span class="token operator">|</span> Index_type <span class="token operator">|</span> Comment <span class="token operator">|</span> Index_comment <span class="token operator">|</span> Visible <span class="token operator">|</span> Expression <span class="token operator">|</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> PRIMARY     <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> ID          <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">4104</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span> A         <span class="token operator">|</span>         <span class="token number">232</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> YES     <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_na_coun <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> Name        <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">3999</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> NO      <span class="token operator">|</span> NULL       <span class="token operator">|</span>
<span class="token operator">|</span> city  <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_na_coun <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> CountryCode <span class="token operator">|</span> A         <span class="token operator">|</span>        <span class="token number">4057</span> <span class="token operator">|</span>     NULL <span class="token operator">|</span>   NULL <span class="token operator">|</span>      <span class="token operator">|</span> BTREE      <span class="token operator">|</span>         <span class="token operator">|</span>               <span class="token operator">|</span> NO      <span class="token operator">|</span> NULL       <span class="token operator">|</span>
+-------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

应用：批量修改表数据信息，或批量删除数据信息，批量添加数据信息；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>索引应用效果演示：（压力测试）
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token operator">&lt;</span> t100w.sql

--defaults-file<span class="token operator">=</span><span class="token string">&quot;/tmp/mysql.sock&quot;</span>

mysqlslap <span class="token parameter variable">--concurrency</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">--iterations</span><span class="token operator">=</span><span class="token number">1</span> --create-schema<span class="token operator">=</span><span class="token string">'malu'</span> <span class="token parameter variable">--query</span><span class="token operator">=</span><span class="token string">&quot;select * from malu.t100w where k2='VWlm'&quot;</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb --number-of-queries<span class="token operator">=</span><span class="token number">2000</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-h10.0.0.51</span> <span class="token parameter variable">-P3306</span> <span class="token parameter variable">-verbose</span>
-- <span class="token assign-left variable">concurrency</span><span class="token operator">=</span><span class="token number">100</span>  模拟同时100会话连接；
-- <span class="token assign-left variable">iterations</span><span class="token operator">=</span><span class="token number">1</span>     测试执行的迭代次数，代表要在不同并发环境下，各自运行测试多少次    
-- create-schema<span class="token operator">=</span><span class="token string">'test'</span>  指定操作的数据库信息；
-- <span class="token assign-left variable">query</span><span class="token operator">=</span><span class="token string">&quot;select * from test.100w where k2='780P'&quot;</span>  指定压测过程具体执行了什么语句操作
-- number-of-queries<span class="token operator">=</span><span class="token number">2000</span> 指定一共做了多少次查询，总的测试查询次数<span class="token punctuation">(</span>并发客户数×每客户查询次数<span class="token punctuation">)</span>

alter table malu.t100w <span class="token function">add</span> index idx_k2<span class="token punctuation">(</span>k2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-索引创建原则"><a href="#_4-索引创建原则" class="header-anchor">#</a> 4，索引创建原则</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>传统的查询方法是按照表的顺序遍历查询的，无论查询几条数据，MySQL需要从头开始遍历表，直到找到该数据；

创建索引后，MySQL一般通过BTREE算法生成一个索引文件，在查询数据库时，首先找到索引文件并遍历索引记录；

在其中找到对应的键后就可以获取对应值的数据，查询效率会提高很多；

然后，使用索引是有代价的，索引设计得不合理，或者缺少索引都会对数据库和应用程序的性能造成影响；

高效的索引对于良好性能的获取非常重要，因此，只要遵循创建索引的有效原则建立索引，才能真正达到事半功倍的效果；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>01 创建索引要有专人完成</strong></p> <ul><li>索引由DBA或表的拥有者负责创建和撤销，其他用户不能随意操作；</li> <li>索引由系统自动选择，或由用户打开，用户可执行重建索引操作；</li></ul> <p><strong>02 是否创建索引取决于表的数据量</strong></p> <ul><li><p>基本表中的记录的数据量越多，记录越长，越有必要创建索引。创建索引后，查询速度的提升效果会很明显；</p> <p>要避免对经常更新的表创建过多的索引，索引中的列也要尽可能少；</p></li> <li><p>数据量小的表最好不要使用索引，由于数据较少，查询花费的时间可能比遍历索引的时间还要短，创建索引可能不会产生优化效果</p> <p>对经常用于查询的字段应该创建索引，但要避免添加不必要的字段；</p></li> <li><p>索引要根据数据查询或数据处理的要求确定是否创建，对于查询频率高，实时性要求高的数据一定要建立索引</p></li></ul> <p><strong>03 索引数据量要适度</strong></p> <ul><li><p>索引文件占用文件目录和存储空间，因此索引过多会加重系统负担；</p></li> <li><p>索引需要自身维护，当基本表的数据增加、删除或修改时，索引也会进行调整和更新，索引文件也要随之变化，以保持与基本表一致；</p></li> <li><p>索引过多会影响数据增、删、改的速度；</p> <p>索引并非越多越好，一张表中如果有大量的索引，不仅占用磁盘空间，而且还会影响insert、delete、update等操作的性能；</p></li></ul> <p><strong>04 避免使用索引的情况</strong></p> <ul><li>包含太多重复值的字段；</li> <li>查询中很少被引用的字段；</li> <li>值特别长的字段；</li> <li>查询返回率很高的字段；</li> <li>具有很多NULL值的字段；</li> <li>需要经常增、删、改的字段；</li> <li>记录较少的表；</li> <li>需要频繁、大批量进行数据更新的基本表；</li></ul> <p><strong>辅助索引检索数据产生回表问题分析：</strong>（回表次数越少越高）</p> <p>产生问题：</p> <p>① 在回表过程中，有可能会出现多次的回表，从而造成磁盘IOPS的升高；（因为是随机IO操作过程）</p> <p>② 在回表过程中，有可能会出现多次的回表，从而造成磁盘IO量的增加；</p> <p>解决方法：</p> <p>① 可以建立联合索引，调整查询条件，使辅助索引过滤出更精细主键ID信息，从而减少回表查询的次数；</p> <p>② 可以控制查询信息，实现覆盖索引，辅助索引完全覆盖查询结果；</p> <p>③ 优化器算法做调整？？？(MRR-多路读功能 ICP-索引下推功能 )</p> <p><strong>构建索引树高度问题分析：</strong>（索引树高度越低越好）</p> <p>影响索引树高度因素：</p> <p>① 数据行数量会对高度产生影响；（3层BTREE -- 可以实现一般2000万行数据索引的存储-20~30列表）</p> <p>解决方法：可以拆分表 拆分库 或者实现分布式存储；</p> <p>② 索引字段长度过大会对高度产生影响；</p> <p>解决方法：利用前缀索引解决问题</p> <p>③ 数据类型设定会对高度产生影响；</p> <p>解决方法：列定义时，选择简短合适的数据类型</p> <h3 id="_5-索引相关面试题"><a href="#_5-索引相关面试题" class="header-anchor">#</a> 5，索引相关面试题</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>02 数据库执行原理题目
MySQL 中的数据排序是怎么实现的？
详细描述一条 SQL 语句在 MySQL 中的执行过程。
MySQL 的索引类型有哪些？
MySQL InnoDB 引擎中的聚簇索引和非聚簇索引有什么区别？
MySQL 中的回表是什么？
请详细描述 MySQL 的 B+ 树中查询数据的全过程
为什么 MySQL 选择使用 B+ 树作为索引结构？
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>排序过程中
- 如果排序字段命中索引，则利用索引排序；
- 如果排序字段没命中索引，则利用文件排序；
  文件排序中，如果数据量少则在内存中排序，具体会使用单路排序或者双路排序；
  文件排序中，如果数据量大则在磁盘文件进行外部排序，一般使用归并排序；

详细描述一条 SQL 语句在 MySQL 中的执行过程。
- 先通过连接器校验权限；
- 利用分析器进行SQL语句的词法分析和语法分析，构建解析树；
- 使用优化器选择合适的索引和表连接顺序，最终选择一个最佳的执行计划
- 利用执行器，调用引擎层查询数据，返回结果集给客户端

MySQL 的索引类型有哪些？
从数据结构角度看：
- B+TREE索引；
- 哈希索引；
- 倒排索引（Full-Text）
- R-Tree索引；<span class="token punctuation">(</span>多维空间树<span class="token punctuation">)</span>

从InnoDB B+Tree索引树角度看：
- 聚簇索引（clustered index）；
- 辅助索引（non-clustered index）

从索引性质的角度看：
- 普通索引（二级索引/辅助索引）
- 主键索引
- 联合索引
- 唯一索引
- 全文索引
- 空间索引


MySQL InnoDB 引擎中的聚簇索引和非聚簇索引有什么区别？
聚簇索引： 
- 索引叶子节点存储的是数据行，可以直接访问完整数据；
- 每个表只能有一个聚簇索引，通常是主键索引，适合范围查询和排序；
非聚簇索引（辅助索引）
- 索引叶子节点存储的是数据行的主键和对应的索引列，需通过主键才能访问完整的数据行；
- 一个表可以有多个非聚簇索引（辅助索引），适用于快速查找特定列的数据；

MySQL 中的回表是什么？
是指在使用二级索引（辅助索引）作为条件进行查询时，由于二级索引中只能存储了索引字段的值，和对应的主键值；
无法得到其他数据，如果要查询数据行中的其他数据，需要根据主键去聚簇索引查找实际的数据行，这个过程被称为回表；

请详细描述 MySQL 的 B+ 树中查询数据的全过程
- 数据从根节点找起，根据键值的大小确定左子树还是右子树，从上到下最中定位到叶子节点；
- 叶子节点存储事假的数据行记录，但是一页有16kb大小，存储的数据行不止一条；
- 叶子节点中数据行以组的形式划分，利用页目录结构，通过二分查找可以定位到对应的组；
- 定位组后，利用链表遍历就可以找到对应的数据行；


为什么 MySQL 选择使用 B+ 树作为索引结构？
- 查找数据性能高效（因为查找任意数据消耗IO均衡）
- 数的高度增长不会过快，使得查询磁盘I/O次数减少；
- 范围查询能力强（基于BTREE结构的双向指针）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h2 id="七-存储引擎"><a href="#七-存储引擎" class="header-anchor">#</a> 七，存储引擎</h2> <h3 id="_1-存储引擎介绍"><a href="#_1-存储引擎介绍" class="header-anchor">#</a> 1，存储引擎介绍</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>存储引擎就是数据库服务中的文件系统，用户可以根据应用的需要选择如何存储和索引数据，是否使用事务等；

存储引擎作用：（磁盘管理器 -- 引擎）
<span class="token number">1</span>）可以利用数据库存储引擎，去管理磁盘调取或存储数据；
<span class="token number">2</span>）可以将磁盘调取数据和内存进行交互，可以将内存中修改或添加的数据存储到磁盘中
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在各种版本的数据库服务中，是有多种存储引擎可以应用的，以MySQL数据库服务为例，可以使用命令查看可以应用存储引擎：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show engines<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在数据库服务领域，大部分场景下都会使用innodb存储引擎，是因为innodb存储引擎具有一定优秀特性：</p> <table><thead><tr><th>序号</th> <th>特性</th> <th>解释说明</th></tr></thead> <tbody><tr><td>01</td> <td>数据访问特性</td> <td>支持多版本并发控制特性(MVCC)，支持行级锁控制并发</td></tr> <tr><td>02</td> <td>数据索引特性</td> <td>支持聚簇索引（MyISAM没有）/辅助索引特性，可以组织存储数据和优化查询(IOT)</td></tr> <tr><td>03</td> <td>数据事务特性</td> <td>支持事务概念特性，可以实现数据的安全保证</td></tr> <tr><td>04</td> <td>数据缓冲特性</td> <td>支持多缓冲区功能，自适应hash索引(AHI)</td></tr> <tr><td>05</td> <td>数据迁移特性</td> <td>支持复制数据中的高级功能特性，支持数据备份恢复的热备</td></tr> <tr><td>06</td> <td>服务自愈特性</td> <td>支持自动故障恢复(CR-Crash Recovery)</td></tr> <tr><td>07</td> <td>数据存储特性</td> <td>支持数据双写机制(Double write) 数据存储有关的安全机制</td></tr></tbody></table> <p><img src="/devops/public/assets/img/1729751104610.f144dd43.png" alt="1729751104610"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>如果在面试环节中，面试官询问你：
- InnoDB核心特性有哪些，以及与MyISAM存储引擎之间的区别：
- InnoBD支持：事务、mvcc、聚簇索引、外键、缓冲区、AHI、DW；MyISAM均不支持
- InnoDB支持：行级锁，MyISAM只支持表级锁；
- InnoDB支持：数据热备，可以保证业务正常运行，对业务影响低，MyISAM只支持温备份，需要锁表备份；
- InnoDB支持：支持CR自动故障恢复，宕机自动恢复，数据安全和一致性可以得到保证；MyISAM不支持，宕机可能丢失当前数据；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 查看数据库可用存储引擎</span>
mysql<span class="token operator">&gt;</span> show engines<span class="token punctuation">;</span>

<span class="token comment"># 查看数据库默认存储引擎</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@default_storage_engine<span class="token punctuation">;</span>
+----------------------------------+
<span class="token operator">|</span> @@default_storage_engine <span class="token operator">|</span>
+----------------------------------+
<span class="token operator">|</span> InnoDB                                    <span class="token operator">|</span>
+----------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库存储引擎设置：
default_storage_engine  -- 用于设置存储引擎的变量（默认全局设置）
临时设置：set global <span class="token assign-left variable">default_storage_engine</span><span class="token operator">=</span>xxx<span class="token punctuation">;</span>
永久设置：default_storage_engine<span class="token operator">=</span>InnoDB （写入到配置文件, 重启数据库服务生效）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建表时设置存储引擎</span>
mysql <span class="token operator">&gt;</span> create table xxx <span class="token punctuation">(</span>id int<span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment"># 修改表示设置存储引擎</span>
mysql <span class="token operator">&gt;</span> alter table world.xxx <span class="token assign-left variable">engine</span><span class="token operator">=</span>myisam<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> alter table world.xxx <span class="token assign-left variable">engine</span><span class="token operator">=</span>innodb<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 查看建表语句获取存储引擎信息</span>
mysql <span class="token operator">&gt;</span> show create table city<span class="token punctuation">;</span>

<span class="token comment"># 查看information_schema数据库获取存储引擎信息</span>
mysql <span class="token operator">&gt;</span> <span class="token keyword">select</span> table_schema,table_name,engine from information_schema.tables where table_schema not in<span class="token punctuation">(</span><span class="token string">'sys'</span>,<span class="token string">'mysql'</span>,<span class="token string">'information_schema'</span>,<span class="token string">'performance_schema'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#1.查询所有非InnoDB引擎信息</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> table_schema,table_name ,engine from information_schema.tables
where table_schema not in<span class="token punctuation">(</span><span class="token string">'sys'</span>,<span class="token string">'mysql'</span>,<span class="token string">'information_schema'</span>,<span class="token string">'performance_schema'</span><span class="token punctuation">)</span>
and engine <span class="token operator">!=</span><span class="token string">'innodb'</span><span class="token punctuation">;</span>

<span class="token comment">#2.拼接成alter table oldboy.stu engine=myisam;样子</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">&quot;alter table &quot;</span>,table_schema,<span class="token string">&quot;.&quot;</span>,table_name,<span class="token string">&quot; engine=innodb;&quot;</span><span class="token punctuation">)</span>
from information_schema.tables
where table_schema not <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'sys'</span>,<span class="token string">'mysql'</span>,<span class="token string">'information_schema'</span>,<span class="token string">'performance_schema'</span><span class="token punctuation">)</span>
and engine <span class="token operator">!=</span><span class="token string">'innodb'</span> into outfile <span class="token string">'/tmp/a.sql'</span><span class="token punctuation">;</span>

<span class="token comment">#3.提前在my.cnf中加如下参数,重启,否则不让导出文件</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">secure_file_priv</span><span class="token operator">=</span>/tmp ˁ 增加此行

<span class="token comment">#执行修改</span>
<span class="token builtin class-name">source</span> /tmp/a.sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-存储引擎结构"><a href="#_2-存储引擎结构" class="header-anchor">#</a> 2，存储引擎结构</h3> <p>对于InnoDB存储引擎来说，数据时存储在磁盘上，而执行引擎想要操作数据，必须先将磁盘的数据加载到内存中才能操作；</p> <p>当数据从磁盘中取出后，缓存内存中，下次查询同样的数据的时候，直接从内存中读取，这样大大提高了查询性能；</p> <p>数据库服务存储引擎结构的介绍，可以依据官方图示参考说明：https://dev.mysql.com/doc/refman/8.0/en/innodb-architecture.html</p> <p><img src="/devops/public/assets/img/1729747958352.a1fb9e57.png" alt="1729747958352"></p> <p>5.7和8.0的体系结构图：</p> <p><img src="/devops/public/assets/img/1729761226578.6f665dad.png" alt="1729761226578"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>存储引擎结构分为两个部分：内存部分 / 磁盘部分（表空间数据  日志文件数据）
- https://i-blog.csdnimg.cn/blog_migrate/8614947f681ca10b477df210288ab68d.png

数据库存储引擎结构：
InnoDB On-Disk Structures 	（磁盘结构）
Tablespaces（表空间信息）-- oracle
什么是表空间 -- LVM （实现弹性扩容或缩容磁盘空间）  

<span class="token number">1</span>）共享表空间文件：（ibdata1）
存储信息：change buffer （临时缓冲数据） 
配置信息：
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@innodb_data_file_path<span class="token punctuation">;</span>   -- 可以扩容共享表空间文件<span class="token punctuation">(</span>应用较少<span class="token punctuation">)</span>   
+-------------------------+
<span class="token operator">|</span> @@innodb_data_file_path <span class="token operator">|</span>
+-------------------------+
<span class="token operator">|</span> ibdata1:12M:autoextend  <span class="token operator">|</span>
+-------------------------+

<span class="token function">vim</span> /etc/my.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">innodb_data_file_path</span><span class="token operator">=</span>ibdata1:12M<span class="token punctuation">;</span>/data02/ibdata2:100M<span class="token punctuation">;</span><span class="token number">10.0</span>.0.53:/data03/ibdata3:100M:autoextend

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@innodb_autoextend_increment<span class="token punctuation">;</span>  --- 可以默认扩容多少存储空间
+-------------------------------+
<span class="token operator">|</span> @@innodb_autoextend_increment <span class="token operator">|</span>
+-------------------------------+
<span class="token operator">|</span>                            <span class="token number">64</span> <span class="token operator">|</span>
+-------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>ibdata共享表空间在各个版本之间的作用区别：</p> <table><thead><tr><th>数据库版本</th> <th>存储数据</th> <th>解释说明</th></tr></thead> <tbody><tr><td>MySQL 5.5版本</td> <td>系统相关数据</td> <td>全局数据字典信息(表基本结构信息、状态系统参数、属性)、undo回滚日志(记录撤销操作);<br>Double write buffer信息、临时表信息、changer buffer</td></tr> <tr><td></td> <td>用户相关数据</td> <td>业务表数据行、表的索引数据均统一存储在ibdata1中，实现集中管理<br>数据表中数据清理后，ibdata1也不会释放磁盘空间</td></tr> <tr><td>MySQL 5.6版本</td> <td>系统相关数据</td> <td>全局数据字典信息(表基本结构信息、状态系统参数、属性)、undo回滚日志(记录撤销操作);<br>Double write buffer信息、临时表信息、changer buffer</td></tr> <tr><td></td> <td>用户相关数据</td> <td><code>共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理)</code></td></tr> <tr><td>MySQL 5.7版本</td> <td>系统相关数据</td> <td>全局数据字典信息 undo回滚日志 Double write buffer信息、changer buffer<br><code>临时表信息被独立出来了，undo也可以设定为独立</code></td></tr> <tr><td></td> <td>用户相关数据</td> <td>共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理)</td></tr> <tr><td>MySQL 8.0.11</td> <td>系统相关数据</td> <td>Double write buffer信息、changer buffer<br><code>undo回滚日志信息被独立出来了，数据字典信息也不再集中存储管理了</code></td></tr> <tr><td></td> <td>用户相关数据</td> <td>共享表空间只存储系统数据，用户相关数据被独立管理了(独立表空间管理)</td></tr> <tr><td>MySQL 8.0.20</td> <td>系统相关数据</td> <td>changer buffer<br><code>Double write buffer信息被独立出来了</code></td></tr></tbody></table> <h3 id="_3-数据恢复"><a href="#_3-数据恢复" class="header-anchor">#</a> 3，数据恢复</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>----------------------------- mysql80上面操作
锁定源端t100w表（FTWRL）
<span class="token punctuation">[</span>root@db-01 school<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456</span>
mysql<span class="token operator">&gt;</span> use malu<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+----------------+
<span class="token operator">|</span> Tables_in_malu <span class="token operator">|</span>
+----------------+
<span class="token operator">|</span> t100w          <span class="token operator">|</span>
+----------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 解锁：mysql&gt; unlock tables;</span>
mysql<span class="token operator">&gt;</span> flush tables malu.t100w with <span class="token builtin class-name">read</span> lock<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment"># 找到你的表结构</span>
mysql<span class="token operator">&gt;</span> show create table malu.t100w<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
Create Table: CREATE TABLE <span class="token variable"><span class="token variable">`</span>t100w<span class="token variable">`</span></span> <span class="token punctuation">(</span>
  <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> int DEFAULT NULL,
  <span class="token variable"><span class="token variable">`</span>num<span class="token variable">`</span></span> int DEFAULT NULL,
  <span class="token variable"><span class="token variable">`</span>k1<span class="token variable">`</span></span> char<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> DEFAULT NULL,
  <span class="token variable"><span class="token variable">`</span>k2<span class="token variable">`</span></span> char<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> DEFAULT NULL,
  <span class="token variable"><span class="token variable">`</span>dt<span class="token variable">`</span></span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY <span class="token variable"><span class="token variable">`</span>idx_k2<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>k2<span class="token variable">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token assign-left variable">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci

------------------------------- mysql57上面操作
mysql<span class="token operator">&gt;</span> create database malu <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> use malu<span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> CREATE TABLE <span class="token variable"><span class="token variable">`</span>t100w<span class="token variable">`</span></span> <span class="token punctuation">(</span>
    -<span class="token operator">&gt;</span>   <span class="token variable"><span class="token variable">`</span><span class="token function">id</span><span class="token variable">`</span></span> int DEFAULT NULL,
    -<span class="token operator">&gt;</span>   <span class="token variable"><span class="token variable">`</span>num<span class="token variable">`</span></span> int DEFAULT NULL,
    -<span class="token operator">&gt;</span>   <span class="token variable"><span class="token variable">`</span>k1<span class="token variable">`</span></span> char<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> DEFAULT NULL,
    -<span class="token operator">&gt;</span>   <span class="token variable"><span class="token variable">`</span>k2<span class="token variable">`</span></span> char<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> DEFAULT NULL,
    -<span class="token operator">&gt;</span>   <span class="token variable"><span class="token variable">`</span>dt<span class="token variable">`</span></span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    -<span class="token operator">&gt;</span>   KEY <span class="token variable"><span class="token variable">`</span>idx_k2<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>k2<span class="token variable">`</span></span><span class="token punctuation">)</span>
    -<span class="token operator">&gt;</span> <span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB DEFAULT <span class="token assign-left variable">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

------------------------------- mysql57上面操作
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/data/3357/data
<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># cd malu/</span>
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">128</span>
-rw-r-----. <span class="token number">1</span> mysql mysql     <span class="token number">67</span> Oct <span class="token number">24</span> <span class="token number">18</span>:20 db.opt
-rw-r-----. <span class="token number">1</span> mysql mysql   <span class="token number">8662</span> Oct <span class="token number">24</span> <span class="token number">18</span>:21 t100w.frm
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">114688</span> Oct <span class="token number">24</span> <span class="token number">18</span>:21 t100w.ibd

mysql<span class="token operator">&gt;</span> alter table malu.t100w discard tablespace<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># pwd;</span>
/data/3357/data/malu
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">16</span>
-rw-r-----. <span class="token number">1</span> mysql mysql   <span class="token number">67</span> Oct <span class="token number">24</span> <span class="token number">18</span>:20 db.opt
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">8662</span> Oct <span class="token number">24</span> <span class="token number">18</span>:21 t100w.frm

<span class="token comment"># 不能直接在物理层面去删除ibd文件   不能使用rm -rf去删除ibd</span>

------------------------------- 
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># cp /data/3306/data/malu/t100w.ibd /data/3357/data/malu/</span>
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># ll -d /data/3357/data/malu/t100w.ibd </span>
-rw-r-----. <span class="token number">1</span> root root <span class="token number">79691776</span> Oct <span class="token number">24</span> <span class="token number">18</span>:25 /data/3357/data/malu/t100w.ibd
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># chown -R mysql.mysql /data/3357/</span>
<span class="token punctuation">[</span>root@db-01 malu<span class="token punctuation">]</span><span class="token comment"># ll -d /data/3357/data/malu/t100w.ibd </span>
-rw-r-----. <span class="token number">1</span> mysql mysql <span class="token number">79691776</span> Oct <span class="token number">24</span> <span class="token number">18</span>:25 /data/3357/data/malu/t100w.ibd

------------------------------- mysql57上面操作
<span class="token comment">#导入表空间,并检查恢复结果</span>
mysql<span class="token operator">&gt;</span> alter table malu.t100w <span class="token function">import</span> tablespace<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> count<span class="token punctuation">(</span>*<span class="token punctuation">)</span> from malu.t100w<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>表空间数据迁移成功条件：
<span class="token number">1</span>.有表的ibd数据文件。
<span class="token number">2</span>.有表的表结构语句。
<span class="token number">3</span>.数据库版本不要变化。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="八-备份与恢复"><a href="#八-备份与恢复" class="header-anchor">#</a> 八，备份与恢复</h2> <h3 id="_1-备份概述"><a href="#_1-备份概述" class="header-anchor">#</a> 1，备份概述</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库备份恢复方式：
方式一：逻辑方式备份恢复：
优点：可以灵活的对数据进行备份与恢复（分库 分表）,想对哪个库，哪个表进行备份，都可以。
缺点：备份数据与恢复数据效率慢（<span class="token operator">&gt;</span>50G <span class="token number">40</span>分钟 恢复时间<span class="token operator">=</span><span class="token number">3</span>-5备份时间）
备份和恢复逻辑：
备份逻辑：将数据库中所有数据信息转换成SQL语句 （库-create database 表-create table 行-insert ）进行保存
恢复逻辑：将备份文件中SQL语句重新执行 

实现逻辑备份方法：
<span class="token number">1</span>）利用mysqldump命令可以实现逻辑备份
<span class="token number">2</span>）实现主从同步数据

-------------------------------------------

方式二：物理方式备份恢复：
优点：备份数据与恢复数据效率快（<span class="token operator">&gt;</span>50G <span class="token number">20</span>分钟）
缺点：不能灵活的对数据进行备份与恢复（所有库备份）
备份和恢复逻辑：
备份逻辑：是将数据库数据目录中的文件信息进行备份
恢复逻辑：是将备份目录中的数据迁移会原有数据目录

实现物理备份方法：
<span class="token number">1</span>）利用cp/scp命令迁移数据目录中数据信息 	（必须停止数据库服务）
<span class="token number">2</span>）利用第三方软件xbk（Percona XtraBackup）	（在备份数据时不用停止服务 恢复数据需要停止服务）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_2-逻辑备份与恢复"><a href="#_2-逻辑备份与恢复" class="header-anchor">#</a> 2，逻辑备份与恢复</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库如何实现逻辑备份：mysqldump命令
- 基础备份方式（全备 分库 分表）

数据库数据全备：
本地备份：
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock  <span class="token parameter variable">-A</span> <span class="token operator">&gt;</span>/tmp/all.sql<span class="token punctuation">;</span>

备份警告信息：
Warning: 
A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. 
在进行数据库备份时，数据库服务开启了GTID功能
If you don't want to restore GTIDs, pass --set-gtid-purged<span class="token operator">=</span>OFF. To <span class="token function">make</span> a complete dump, pass --all-databases <span class="token parameter variable">--triggers</span> <span class="token parameter variable">--routines</span> --events. 
如果想关闭警告信息，可以设置--set-gtid-purged<span class="token operator">=</span>OFF，取消警告信息显示

Warning: 
A dump from a server that has GTIDs enabled will by default include the GTIDs of all transactions, even those that were executed during its extraction and might not be represented <span class="token keyword">in</span> the dumped data. 
This might result <span class="token keyword">in</span> an inconsistent data dump. 
在进行数据库备份时，数据库服务开启了GTID功能
In order to ensure a consistent backup of the database, pass --single-transaction or --lock-all-tables or --master-data. 
确保数据备份的一致性，建议添加-single-transaction  --lock-all-tables   --master-data

添加一个参数，--set-gtid-purged<span class="token operator">=</span>OFF，就没有警告了
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock  <span class="token parameter variable">-A</span> --set-gtid-purged<span class="token operator">=</span>OFF<span class="token operator">&gt;</span>/tmp/all.sql<span class="token punctuation">;</span>

----------------------------

恢复数据： 
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token operator">&lt;</span>/tmp/all.sql<span class="token punctuation">;</span>
或
<span class="token builtin class-name">source</span>  <span class="token operator">&lt;</span>/tmp/all.sql<span class="token punctuation">;</span>
PS: 全备数据信息，主要应用于迁移数据，或者有数据库被误删除情况
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库数据分库备份:
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span>  <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token parameter variable">-B</span> school --set-gtid-purged<span class="token operator">=</span>OFF<span class="token operator">&gt;</span>/tmp/school.sql

恢复数据： 
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token operator">&lt;</span>/tmp/school.sql<span class="token punctuation">;</span>
<span class="token builtin class-name">source</span>  <span class="token operator">&lt;</span>/tmp/school.sql<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库数据分表备份：
mysqldump <span class="token parameter variable">-uroot</span>  <span class="token parameter variable">-S</span> /tmp/mysql.sock  school  student  --set-gtid-purged<span class="token operator">=</span>OFF<span class="token operator">&gt;</span>/tmp/school_student.sql 

恢复数据：
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock school <span class="token operator">&lt;</span>/tmp/school_student.sql 
或
use school
<span class="token builtin class-name">source</span>  <span class="token operator">&lt;</span>/tmp/school_student.sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-mysqldump的参数"><a href="#_3-mysqldump的参数" class="header-anchor">#</a> 3，mysqldump的参数</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysqldump常用参数总结：
-A, --all-databases   Dump all the databases. This will be same as <span class="token parameter variable">--databases</span>
                      所有数据库进行全备
-B, <span class="token parameter variable">--databases</span>       Dump several databases. Note the difference <span class="token keyword">in</span> usage<span class="token punctuation">;</span>	
                      实现分库备份操作	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 进阶备份方式（主从同步） 
--master-data（--source-data）
可以记录数据备份后，最后保存结束的位置点信息（binlog文件 和 position 位置点信息）
加上以上参数进行备份，在备份文件中就会出现以上内容信息
CHANGE MASTER TO <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'binlog.000004'</span>, <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">157</span><span class="token punctuation">;</span> 从库恢复了数据全备数据（all02.sql）-- mysql-bin.000022 <span class="token number">157</span>

mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock  <span class="token parameter variable">-A</span> --master-data<span class="token operator">=</span><span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>/tmp/all2.sql<span class="token punctuation">;</span>

-----------------------------------

--single-transaction
  早期版本数据库进行mysqldump备份数据时，需要将数据库进行锁定备份，从而确保一致性（--lock-all-tables）
  新版数据库中，利用以上参数信息，可以实现基于快照数据进行备份
  
  统计班级学生人数，下课进行统计，禁止所有同学离开班级 -- 下课的前1分钟 -- 手机拍照 -- 根据照片统计人数
  
-----------------------------------
  
添加上面的参数后：
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock  --source-data<span class="token operator">=</span><span class="token number">2</span>  --single-transaction  <span class="token parameter variable">-A</span> <span class="token operator">&gt;</span>/tmp/all.sql        -- 本地备份 

在10.0.0.54上执行： <span class="token number">54</span>是一个备份服务器，51，52，53都可以把数据备份到54上。
需要先把这个10.0.0.51_data文件夹创建出来
<span class="token punctuation">[</span>root@db02 <span class="token number">3306</span><span class="token punctuation">]</span><span class="token comment"># mysqldump -uroot2 -p123456 -h10.0.0.51 -P3306  --source-data=2  --single-transaction  -A &gt;/10.0.0.51_data/all123.sql  -- 远程备份</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-R, <span class="token parameter variable">--routines</span>      Dump stored routines <span class="token punctuation">(</span>functions and procedures<span class="token punctuation">)</span>
                    将数据库服务存储过程进行备份，存储过程<span class="token operator">==</span>在数据库中已经写好的功能脚本  
-E, <span class="token parameter variable">--events</span>        Dump events
                    将数据库的事件信息进行备份；数据库事件信息<span class="token operator">=</span>类似定时任务
<span class="token parameter variable">--triggers</span>          Dump triggers <span class="token keyword">for</span> each dumped table
                    将数据库触发器信息做备份，根据设置触发器信息可以完成一些操作动作

PS：以上参数信息，可以用于数据库迁移备份数据		
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-h10.0.0.51</span> <span class="token parameter variable">-P3306</span>   --source-data<span class="token operator">=</span><span class="token number">2</span>  --single-transaction  <span class="token parameter variable">-A</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">-E</span> --triggers<span class="token operator">&gt;</span>/10.0.0.54/all.sql        -- 本地备份                     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-物理备份"><a href="#_4-物理备份" class="header-anchor">#</a> 4，物理备份</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>数据库服务物理备份：
<span class="token number">1</span>）利用cp命令/scp命令实现复制备份数据目录
数据物理备份迁移规划：
<span class="token number">10.0</span>.0.51  <span class="token number">3306</span>  备份数据信息
<span class="token number">10.0</span>.0.54  <span class="token number">3306</span>  没有数据信息  需要恢复数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-basy line-numbers-mode"><pre class="language-text"><code>步骤一：在51数据库中做数据备份
[root@db-01 ~]# systemctl stop mysql80
[root@db-01 ~]# scp -rp /data/3306/data 10.0.0.54:/backup/data

----------------------------------

步骤二：在54数据库服务器中安装数据库服务程序
安装mysql二进制包
ll /usr/local/mysql -d
lrwxrwxrwx 1 root root 35 Apr 26  2023 /usr/local/mysql -&gt; mysql-8.0.26-linux-glibc2.12-x86_64
确认是否有数据目录
# ll -d /data/3306/data/
drwxr-xr-x 2 mysql mysql 6 Oct 16 16:15 /data/3306/data/
需要编写配置文件
[root@manager ~ 16:17]# cat /etc/my.cnf
[mysqld]
user=mysql
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
[mysql]
prompt=db03 [\d]&gt;

不初始化，不要启动，不要启动。

----------------------------------

步骤三：迁移恢复数据信息
[root@db02 data]# \cp -r /backup/data/* /data/3306/data/
[root@db02 backup]# chown -R mysql.mysql /data/3306/data/

----------------------------------

步骤四：启动运行54数据库服务
/etc/init.d/mysql.server start 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>主库<span class="token punctuation">(</span><span class="token number">10.0</span>.0.51<span class="token punctuation">)</span>操作：
<span class="token number">1</span>）关闭数据库服务
<span class="token number">2</span>）备份数据信息（cp/scp）

备份数据库<span class="token punctuation">(</span><span class="token number">10.0</span>.0.54<span class="token punctuation">)</span>操作：
<span class="token number">1</span>）安装数据库服务（安装和主库版本相同的服务 或者比主库版本高的服务）
<span class="token number">2</span>）将备份数据迁移到数据目录中
<span class="token number">3</span>）编写数据库服务配置文件
<span class="token number">4</span>）启动新的数据库服务
PS：以上物理备份方式，需要停止主库业务，造成网站业务中断/没有增量备份数据方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_5-xbk物理备份-全量备份"><a href="#_5-xbk物理备份-全量备份" class="header-anchor">#</a> 5，xbk物理备份（全量备份）</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">2</span>）利用第三方工具实现物理备份（xbk--物理热备 增量备份）
备份工具兼容性问题：
- 对于数据库8.0.20+版本   	需要使用PXB <span class="token number">8.0</span>.12+以上版本
- 对于数据库8.0.11~8.0.19 	需要使用PXB <span class="token number">8.0</span>版本
- 对于数据库5.x版本       	需要使用PXB <span class="token number">2.4</span>版本  

安装xbk物理备份工具：
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> percona-xtrabackup-80-8.0.32-26.1.el7.x86_64.rpm

安装了上面的软件，就有xtrabackup这个命令了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>物理备份（全量备份）
- 备份操作：备份不需要停止mysql（热备）
<span class="token function">mkdir</span> /data/backup/full <span class="token parameter variable">-p</span>  （用于物理备份的目录一定是空目录）
<span class="token comment"># /data/3306/my.cnf =&gt; /data/3306/data/*</span>
<span class="token comment"># --host=10.0.0.51 --port=3306 --user=root --password=123456  让xbk软件连接mysql</span>
xtrabackup --defaults-file<span class="token operator">=</span>/data/3306/my.cnf <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--user</span><span class="token operator">=</span>root2 <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token number">123456</span>  <span class="token parameter variable">--backup</span>  --target-dir<span class="token operator">=</span>/data/backup/full

------------------------------

- 恢复操作： 在10.0.0.54上操作
systemctl stop mysql80 
<span class="token function">mv</span> /data/3306/data /backup 
或者
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /data/3306/data/*        --确认数据目录是空目录

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--prepare</span> --target-dir<span class="token operator">=</span>/data/backup/full     -- 恢复数据前的准备工作      恢复内存数据
xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data --copy-back  --target-dir<span class="token operator">=</span>/data/backup/full  -- 将备份数据复制回数据目录  恢复磁盘数据（恢复到数据目录）
<span class="token function">chown</span> <span class="token parameter variable">-R</span> mysql. /data/3306/data/
systemctl start mysql80

补充说明：参数--prepare有什么作用
严谨解释：prepare和事务提交的过程--两阶段提交
通俗解释：xbk备份工具，可以备份数据库所有数据（之前的历史数据备份-磁盘数据 还有备份过程中的增量数据也会备份-内存中数据） 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_6-xbk物理备份-增量备份"><a href="#_6-xbk物理备份-增量备份" class="header-anchor">#</a> 6，xbk物理备份（增量备份）</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>物理备份（增量备份）
- 备份操作：
第一次备份：（全量备份）
xtrabackup --defaults-file<span class="token operator">=</span>/data/3306/my.cnf <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--user</span><span class="token operator">=</span>root2 <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--backup</span> <span class="token parameter variable">--parallel</span><span class="token operator">=</span><span class="token number">4</span> --target-dir<span class="token operator">=</span>/data/backup/full

看一下第1次备份出来的文件体积大小：
<span class="token punctuation">[</span>root@db-01 backup<span class="token punctuation">]</span><span class="token comment"># du -sh full/</span>
149M	full/

------------------------------
第二次备份：
create database test02<span class="token punctuation">;</span> -- 模拟生成增量数据
<span class="token function">mkdir</span> /data/backup/add01/ <span class="token parameter variable">-p</span>
xtrabackup --defaults-file<span class="token operator">=</span>/data/3306/my.cnf <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--user</span><span class="token operator">=</span>root2 <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--backup</span> <span class="token parameter variable">--parallel</span><span class="token operator">=</span><span class="token number">4</span> --target-dir<span class="token operator">=</span>/data/backup/add01 --incremental-basedir<span class="token operator">=</span>/data/backup/full

------------------------------
第三次备份：
create database test03<span class="token punctuation">;</span>
<span class="token function">mkdir</span> /data/backup/add02/ <span class="token parameter variable">-p</span>
xtrabackup --defaults-file<span class="token operator">=</span>/data/3306/my.cnf <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--user</span><span class="token operator">=</span>root2 <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span> <span class="token parameter variable">--backup</span> <span class="token parameter variable">--parallel</span><span class="token operator">=</span><span class="token number">4</span> --target-dir<span class="token operator">=</span>/data/backup/add02 --incremental-basedir<span class="token operator">=</span>/data/backup/add01

<span class="token punctuation">..</span><span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>- 恢复操作：
systemctl stop mysql80
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /data/3306/data/*

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--prepare</span>  --apply-log-only  --target-dir<span class="token operator">=</span>/data/backup/full  -- 加载全量备份过程内存中数据（磁盘数据）

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--prepare</span>  --apply-log-only  --target-dir<span class="token operator">=</span>/data/backup/full --incremental-dir<span class="token operator">=</span>/data/backup/add01 -- 将第一次增量备份过程的内存数据和全量的内存数据做整合（磁盘数据）

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--prepare</span>  --apply-log-only  --target-dir<span class="token operator">=</span>/data/backup/full --incremental-dir<span class="token operator">=</span>/data/backup/add02 -- 将第二次增量备份过程的内存数据和全量的内存数据做整合（磁盘数据）

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data <span class="token parameter variable">--prepare</span>  --target-dir<span class="token operator">=</span>/data/backup/full   -- 将所有内存部分数据做恢复

xtrabackup <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data --copy-back  --target-dir<span class="token operator">=</span>/data/backup/full

<span class="token function">chown</span> <span class="token parameter variable">-R</span> mysql. /data/3306/data/
systemctl start mysql80
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="九-日志"><a href="#九-日志" class="header-anchor">#</a> 九，日志</h2> <h3 id="_1-错误日志"><a href="#_1-错误日志" class="header-anchor">#</a> 1，错误日志</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>02 数据库服务日志管理 
数据服务日志信息作用：
<span class="token number">1</span>）查看数据库服务运行状态（服务异常排查） -- 错误日志
<span class="token number">2</span>）查看数据库服务用户情况（审计信息记录） -- 通用日志  （日志量比较大-默认关闭-测试使用）
<span class="token number">3</span>）查看记录数据库事务信息（记录写入信息） -- 二进制日志- binlog <span class="token punctuation">(</span>恢复数据/实现主从同步<span class="token punctuation">)</span> delete update
<span class="token number">8.0</span> 默认开启 <span class="token number">8.0</span>之前默认关闭
<span class="token number">4</span>）查看数据库慢查询语句                -- 慢查询日志（日志量比较大-默认关闭-优化需求）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>错误日志： 
默认日志存储路径信息：ll /data/3306/data/db-01.err
日志配置信息：
<span class="token assign-left variable">log_error</span><span class="token operator">=</span>/data/3306/log/error.log
错误说明：若错误日志不能自动创建，可以手动进行创建
<span class="token function">touch</span> /data/3306/log/error.log <span class="token operator">&amp;&amp;</span> <span class="token function">chown</span> mysql.mysql /data/3306/log/error.log

----------------------------------

<span class="token punctuation">[</span>root@db-01 add01<span class="token punctuation">]</span><span class="token comment"># cat /data/3306/my.cnf </span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">secure_file_priv</span><span class="token operator">=</span>/tmp/
<span class="token assign-left variable">log_error</span><span class="token operator">=</span>/data/3306/log/error.log

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_2-通用日志"><a href="#_2-通用日志" class="header-anchor">#</a> 2，通用日志</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>通用日志：
通用日志配置：
<span class="token assign-left variable">general_log</span><span class="token operator">=</span>OFF          
-- 默认日志功能处于关闭，建议在需要做调试工作时（功能测试、语句审计）可以打开；
<span class="token assign-left variable">general_log_file</span><span class="token operator">=</span>/data/3306/log/general.log
-- 定义日志存储路径和名称信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-二进制日志"><a href="#_3-二进制日志" class="header-anchor">#</a> 3，二进制日志</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>二进制日志： 
二进制日志基础配置：
<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>/data/3306/log/mysql-bin
<span class="token punctuation">[</span>root@db-01 <span class="token number">3306</span><span class="token punctuation">]</span><span class="token comment"># chown -R mysql. /data/3306</span>

-------------------------

<span class="token punctuation">[</span>root@db-01 <span class="token number">3306</span><span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">8</span>
drwxr-xr-x. <span class="token number">11</span> mysql mysql <span class="token number">4096</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 data
drwxr-xr-x   <span class="token number">2</span> mysql mysql   <span class="token number">89</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 log
-rw-r--r--   <span class="token number">1</span> mysql mysql  <span class="token number">284</span> Oct <span class="token number">25</span> <span class="token number">16</span>:00 my.cnf

-------------------------

<span class="token punctuation">[</span>root@db-01 data<span class="token punctuation">]</span><span class="token comment"># cat /data/3306/my.cnf </span>
<span class="token punctuation">[</span>client<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">secure_file_priv</span><span class="token operator">=</span>/tmp/
<span class="token assign-left variable">log_error</span><span class="token operator">=</span>/data/3306/log/error.log
<span class="token assign-left variable">general_log</span><span class="token operator">=</span>on
<span class="token assign-left variable">general_log_file</span><span class="token operator">=</span>/data/3306/log/general.log
<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>/data/3306/log/mysql-bin

<span class="token punctuation">[</span>root@db-01 <span class="token number">3306</span><span class="token punctuation">]</span><span class="token comment"># cd log/</span>
<span class="token punctuation">[</span>root@db-01 log<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">28</span>
-rw-r--r-- <span class="token number">1</span> mysql mysql <span class="token number">14704</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 error.log
-rw-r--r-- <span class="token number">1</span> mysql mysql  <span class="token number">3503</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 general.log
-rw-r----- <span class="token number">1</span> mysql mysql   <span class="token number">157</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 mysql-bin.000001
-rw-r----- <span class="token number">1</span> mysql mysql    <span class="token number">32</span> Oct <span class="token number">25</span> <span class="token number">16</span>:03 mysql-bin.index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>create database db01<span class="token punctuation">;</span>
use db01<span class="token punctuation">;</span>
create table t1<span class="token punctuation">(</span>id int,name char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,age int,primary key<span class="token punctuation">(</span>id<span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'xiaoA'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">'xiaoB'</span>,20<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">'xiaoC'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">4</span>,<span class="token string">'xiaoD'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">5</span>,<span class="token string">'xiaoE'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">6</span>,<span class="token string">'xiaoF'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">7</span>,<span class="token string">'xiaoH'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">8</span>,<span class="token string">'xiaoI'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>二进制日志信息查看：
方法一：在数据库中进行二进制日志查看
mysql<span class="token operator">&gt;</span> show binary logs<span class="token punctuation">;</span>  -- 查看数据库服务所有binlog日志信息
+------------------+-----------+-----------+
<span class="token operator">|</span> Log_name         <span class="token operator">|</span> File_size <span class="token operator">|</span> Encrypted <span class="token operator">|</span>
+------------------+-----------+-----------+
<span class="token operator">|</span> mysql-bin.000001 <span class="token operator">|</span>     <span class="token number">11018</span> <span class="token operator">|</span> No        <span class="token operator">|</span>
<span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span>      <span class="token number">2946</span> <span class="token operator">|</span> No        <span class="token operator">|</span>
+------------------+-----------+-----------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>二进制日志切割设置：
方式一： 
mysql<span class="token operator">&gt;</span> flush logs<span class="token punctuation">;</span>

方式二： 
mysqladmin <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock flush-logs
PS:如果想实现日志信息自动切割，需要编写脚本文件+定时任务

方式三：重启数据库服务
/etc/init.d/mysql.server restart 

方式四：根据文件容量大小自动切换
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@max_binlog_size<span class="token punctuation">;</span>  -- 默认1G大小<span class="token punctuation">(</span>最小4096<span class="token punctuation">)</span>，会自动切割
+-------------------+
<span class="token operator">|</span> @@max_binlog_size <span class="token operator">|</span>
+-------------------+
<span class="token operator">|</span>        <span class="token number">1073741824</span> <span class="token operator">|</span>
+-------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> mysql-bin.000002 <span class="token operator">|</span>     <span class="token number">2946</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

Position     -- 完成写入操作的事件位置点信息（可以用于修复数据 同步数据）
Binlog_Do_DB      -- 记录日志信息白名单功能（指定某个数据库中的操作，进行记录）
Binlog_Ignore_DB  -- 记录日志信息黑名单功能（指定某个数据库中的操作，不进行记录）

<span class="token comment"># 查看一个具体的binlog长什么样</span>
mysql<span class="token operator">&gt;</span> show binlog events <span class="token keyword">in</span> <span class="token string">'mysql-bin.000002'</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>root@db-01 log<span class="token punctuation">]</span><span class="token comment"># mysqlbinlog /data/3306/log/mysql-bin.000002</span>

默认DML操作信息会进行编码处理，方式一：利用解码方式进行查看
mysqlbinlog --base64-output<span class="token operator">=</span>decode-rows <span class="token parameter variable">-vvv</span> /data/3306/log/mysql-bin.000002
INSERT INTO <span class="token variable"><span class="token variable">`</span>school<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>student<span class="token variable">`</span></span> SET @1<span class="token operator">=</span><span class="token number">17</span> @2<span class="token operator">=</span><span class="token string">'jiahua'</span> @3<span class="token operator">=</span><span class="token string">'20'</span> @4<span class="token operator">=</span><span class="token number">2</span> @5<span class="token operator">=</span><span class="token string">'2024:10:01'</span> 

方式二：不进行编码处理记录dml信息
<span class="token builtin class-name">set</span> global <span class="token assign-left variable">binlog_format</span><span class="token operator">=</span><span class="token string">'statement'</span><span class="token punctuation">;</span>
statement（SBR） -- 语句格式记录 怎么写的dml命令，怎么记录到binlog
row      （RBR） -- 行格式记录   将DML语句编码处理后，进行记录 
mixed    （MBR） -- 混合格式记录 由数据库服务自己决定 dml语句是以编码处理记录 还是以明文方式记录

statement  vs  row 
statement: （记录命令信息）
好处：便于读取操作命令信息
坏处：有可能主从同步或者恢复数据，出现不一致情况

row：（记录一行的具体数据信息）
好处：数据恢复或数据同步时，可以保证数据一致性
坏度：不便于读取操作命令信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code>02 需要保证日志信息及时记录 （sync_binlog-数据安全-双一配置） 
sync_binlog=1
参数信息配置0：表示由操作系统缓存自己决定，什么时候刷新日志到磁盘中(保存到binlog文件)
参数信息配置1：表示每次事务提交，立即刷新日志到磁盘中；(此方式配置更安全)（commit）    --- 一个语句 -IO消耗大- 磁盘   xxx commit xxx commit   -- 磁盘
参数信息配置N: 表示每组事务提交，按照组的事务次数定义，确定刷新日志到磁盘中的频次；（可以有效减少IO性能损耗）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>03 关闭语句操作的记录功能  （game--table--dml语句---库/表/行 损坏 -- 恢复 执行过的语句重新再执行一遍 不用再进行记录）
方式一：关闭所有语句记录功能，这个不能永久配置
sql_log_bin: 表示是否将SQL语句信息记录到binlog日志中（1-是将语句记录 <span class="token number">0</span>-是将语句不进行记录）
<span class="token builtin class-name">set</span> session <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

方式二：设置日志记录的白名单或者黑名单功能
在mysql的配置文件中：/data/3306/my.cnf
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">binlog_do_db</span><span class="token operator">=</span>test01
<span class="token assign-left variable">binlog_do_db</span><span class="token operator">=</span>test02
<span class="token assign-left variable">binlog_ignore_db</span><span class="token operator">=</span>db1

binlog_do_db：    设置某个数据库白名单，将白名单指定数据库操作信息都做记录     
binlog_ignore_db：设置某个数据库黑名单，将黑名单指定数据库操作信息都不做记录  

mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> mysql-bin.000003 <span class="token operator">|</span>      <span class="token number">157</span> <span class="token operator">|</span> test01 test02<span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
-- 单独设置binlog白名单信息

mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> mysql-bin.000003 <span class="token operator">|</span>      <span class="token number">157</span> <span class="token operator">|</span>              <span class="token operator">|</span> db1              <span class="token operator">|</span>                   <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
-- 单独设置binlog黑名单信息

mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> mysql-bin.000005 <span class="token operator">|</span>      <span class="token number">157</span> <span class="token operator">|</span> test01 test02<span class="token operator">|</span> test01           <span class="token operator">|</span>                   <span class="token operator">|</span>
+------------------+----------+--------------+------------------+-------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>04 日志信息过滤方法
create database db2<span class="token punctuation">;</span>
use db2<span class="token punctuation">;</span>
create table t1<span class="token punctuation">(</span>id int,name char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,age int,primary key<span class="token punctuation">(</span>id<span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'xiaoA'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">'xiaoB'</span>,20<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">'xiaoC'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
drop table t1<span class="token punctuation">;</span>

方式一：在数据库中进行过滤 
mysql<span class="token operator">&gt;</span> pager <span class="token function">less</span>                 -- 开启过滤功能,可以实现日志内容字符过滤
mysql<span class="token operator">&gt;</span> pager <span class="token function">grep</span> <span class="token string">&quot;DROP TABLE&quot;</span>    -- 指定日志需要过滤的内容信息


方式二：在文件中进行过滤
mysqlbinlog --base64-output<span class="token operator">=</span>decode-rows <span class="token parameter variable">-vvv</span> /data/3306/log/mysql-bin.000004<span class="token operator">|</span><span class="token function">grep</span> /sed /awk

mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token parameter variable">-e</span> <span class="token string">&quot;show binlog events in 'mysql-bin.000004'&quot;</span><span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;drop&quot;</span>
mysql-bin.000004	<span class="token number">1526</span>	Query	<span class="token number">1</span>	<span class="token number">1655</span>	use <span class="token variable"><span class="token variable">`</span>xiaoB<span class="token variable">`</span></span><span class="token punctuation">;</span> DROP TABLE <span class="token variable"><span class="token variable">`</span>t1<span class="token variable">`</span></span> /* generated by server */ /* <span class="token assign-left variable">xid</span><span class="token operator">=</span><span class="token number">75</span> */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>二进制日志清理设置：
方式一：自动进行日志清理
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%expire%'</span><span class="token punctuation">;</span>
+--------------------------------+---------+
<span class="token operator">|</span> Variable_name                  <span class="token operator">|</span> Value   <span class="token operator">|</span>
+--------------------------------+---------+
<span class="token operator">|</span> binlog_expire_logs_seconds     <span class="token operator">|</span> <span class="token number">2592000</span> <span class="token operator">|</span>   --根据binlog日志存在秒信息，做清理  00001  0002
<span class="token operator">|</span> expire_logs_days               <span class="token operator">|</span> <span class="token number">0</span>       <span class="token operator">|</span>   --根据binlog日志存在天信息，做清理  00001  0002
+--------------------------------+---------+
<span class="token number">4</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

方式二：手工方式立即清理
mysql<span class="token operator">&gt;</span> purge binary logs to <span class="token string">'mysql-bin.000003'</span><span class="token punctuation">;</span>
-- 删除到指定日志文件前结束
mysql<span class="token operator">&gt;</span> PURGE BINARY LOGS BEFORE <span class="token string">'2019-04-02 22:46:26'</span><span class="token punctuation">;</span>
-- 可以基于日志时间点信息进行日志清理
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>二进制日志远程备份：（拉取进行备份/可以实现数据补偿--高可用）
<span class="token function">mkdir</span>  <span class="token parameter variable">-p</span> /backup/binlog_10.0.0.51-3306
<span class="token builtin class-name">cd</span> /backup/binlog_10.0.0.51-3306/
mysqlbinlog <span class="token parameter variable">-R</span> <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51  <span class="token parameter variable">--user</span><span class="token operator">=</span>root2 <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">--raw</span> --stop-never mysql-bin.000003 <span class="token operator">&amp;</span>

<span class="token parameter variable">-R</span> <span class="token builtin class-name">:</span>    实现远程备份binlog信息
--host：需要远程备份日志的主机地址
--port：需要远程备份日志的实例端口
--user：连接数据库用户
--password： 连接数据用户密码
--raw： 读取binlog信息
--stop-never：一直拉取binlog日志信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>利用二进制日志文件如何修复数据信息：
步骤一：生成binlog日志内容
create database db3<span class="token punctuation">;</span>
use db3<span class="token punctuation">;</span>
create table t1<span class="token punctuation">(</span>id int,name char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>,age int,primary key<span class="token punctuation">(</span>id<span class="token punctuation">))</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">'xiaoA'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">2</span>,<span class="token string">'xiaoB'</span>,20<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values <span class="token punctuation">(</span><span class="token number">3</span>,<span class="token string">'xiaoC'</span>,18<span class="token punctuation">)</span><span class="token punctuation">;</span>

步骤二：查看binlog日志信息
show binlog events <span class="token keyword">in</span> <span class="token string">'mysql-bin.000005'</span><span class="token punctuation">;</span>
<span class="token number">234</span>  -- <span class="token number">1435</span>   生成数据信息位置点

步骤三：模拟数据损坏
drop database db3<span class="token punctuation">;</span>
<span class="token number">1466</span> -- <span class="token number">1543</span>   删除了数据库信息

步骤四：利用binlog文件修复数据
<span class="token punctuation">[</span>root@db-01 ~<span class="token punctuation">]</span><span class="token comment"># mysqlbinlog -uroot2 -p123456 --start-position='234' --stop-position='1435'  /data/3306/log/mysql-bin.000005 &gt;/tmp/binlog.sql</span>

mysql <span class="token parameter variable">-S</span> /tmp/mysql.sock <span class="token operator">&lt;</span>/tmp/binlog.sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>利用binlog日志修复数据信息特殊情况；
情况一：日志文件被清理过，可能建库/建表语句所在日志已经清理；

情况二：所需日志跨越多个文件，如何进行日志信息的截取；
创建库操作   --  binlog-000001    <span class="token number">200</span>-300  
创建表操作   --  binlog-000002   <span class="token number">240</span>-310   
创建数据信息 -- 添加数据 -- binlog-000003    <span class="token number">500</span>-600
创建数据信息 -- 修改数据 -- binlog-000004   <span class="token number">600</span>-650

情况三：如何从日志文件中恢复单库、单表、或者部分行数据信息；（截取 恢复数据时间 如何过滤指定数据）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="十-主从"><a href="#十-主从" class="header-anchor">#</a> 十，主从</h2> <h3 id="_1-传统主从复制-centos7"><a href="#_1-传统主从复制-centos7" class="header-anchor">#</a> 1，传统主从复制（centos7）</h3> <p>特别注意：同步的数据库版本最好一致(8.0.32)。</p> <p>准备了两台机器：</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPsAAAA9CAYAAABrwx8PAAAGc0lEQVR4nO3cMW/jNhgG4FdFt/YPFF3tDEFwWxcZN7dyFk+eCnSjRnvJDYWBJIDbJYu0tLC2Qzt5MgpE+gGHaGmng5Eh0lr0Z7CDpFi2KIVyLhfLfB/AwJ1lfyQVfSZFJ58lpZQgoqP3xWt3gIg+jy9fuwNtXF9fa7/28vLyBXtC1D2dSnZAL4nbfCgQmeIol/H6s3oKf2DBsgbwU9XxCK5lwRr4UB5WvTZ/uNFuUz4GpePVNrO+VN63b3sHo9xP1XnOjg/UP4AtqT8onT8LVmXQ+rFM1LmZvfApl/S2DSxvU0wmva3nU3+OQKuFCK41BEIJ6QBZ4rqInAUcAIhcWMM1vETirmgi9THoW7gPJRaO9lD02jsYKfzBEGsvgZz0svPQd3EiF3CQwh/0MY0FhNCLltzHsL0Edzs/J+wRy0iyQ66urpT/1n1PVSI9G1J4nrQhZFg5ZkvPExK2J5OmRhJP2rWvCaUApAhVh4TEY7t5X1Sva9XeAUl2z6t6jKGAtL2nRxOKp8+PbiwTHeUyvrWTCWYiwLy8/ItuMMUY5yfFE9kye2uJGLnZEr93grN4ihvVUjpaIbA9XKimXGcEgTUe2q46m9rLGt1a4m/6XNwqFLcnLtydMaX+oHTbohun5jYnuUcsRqXVRg8nZ8C69YCzNh/WQDAs+uPiYO9cDhSTPeeMBOLpTX4BpfDnAcRsgs2CsYfJTCBe3j5e2NGqeI2DRSjyC7HNRdjHqR3jPmnd24b2IrjWHKeJhJQSUiYYL/tb9/TBcIWRlJB3Cyy2xpTidhnnY2oTp3yeNtKHdduBNehhclf0RSLx1hhq7aVQ4aiS/d1fDj7+92G/NzsX8Ox8do9uMIViNnZGEPEStykARFgFAqPiNc5icxEqN4/q2DjtNx2v2eCqay9aIUCMab94Tx/TeHs2FWHp3r48pvQWyzgfU9s4in72Ts40z4HmmEt6k1npZ0E6jirZP/77Ae9WzlbS6+/Mb2ZufxXAHp8rZisHF162mZf6cwRbS9Q8yuQOUoYQwTCbBZ0RRO0S/wbT+Awnqmmx1OZCFjPaHXb3pirtAYDtIZGbWVBKqdjU2sQfiTgb0+0S8C42Y2oZR9nP9UNp9s2W4mfNA35yzLSfo0r2girpteSJOQ0EZjVXWO98DCxvcLMEvGLqT30MKjN5MWM7uPBsBMOdGSr1MRgGO7Ojpqb2FB8ukdt8a+FceI9jGp/n494jjiIwPJRi1K2YtKRIt7ZLhgjsMc75QaCtc8ne5iu3Iun//OdXzXdkiQnFjP2oN8HsLECA0oXWm+D96bz0HfAQCDczUm9yB5mMseyXviPuTxErNu42G1ANG1+N7TlYJB7WpTir0RMfKL1zjBEgOJuVZtE94lQDY/K+FGMIhDX39zpuf9r0Zbj2kDwjloksKbv5hzDX19eVJfoPv3+99f83377Fj9/9jDffvP2kbUeuhfmp6vve9nGGAbLlMi9cemGd/aWaJi+V5ACA1Mc8EJjJ56ems5CQi0/QJyINnU728pL+8vLyZZMcm5lYhPLAflON6GmdXcYTUTud26Ajov0w2YkMwWQnMgSTncgQTHYiQ3TqqzfWoCPaX6eSHWANOqJ9HeUynjXoDknDn6tGbsP5qGqsQdcylok6N7MXWIOu6zXoIrjzUyRSZn8TsHVMrb4GXftYRvrMZbCehTXodNo7IJo16DKhFLBlU/k4nRp0urFMdJTL+NZYg+7xna9Wgy5aIUBTIY8WNeiejGUmJnuONeiycb9KDTqtQh6aNeieUxTkyB1VsrMGHTpXgy71B7D6S4yT8t7FfjXo1LGocFTJzhp0+ZMdqUEXuRb69zPFuNrXoKuPRYWjSvYCa9B1oAZdXgQk1J6CG2rQtY5lqFfYFNzb1dXV4+66apf9+9++Uj7++PuXmojV3eHEsyXKT4TV3fhQoPJc4tkSwOOjsmuceNIuHQd2Y2R9qT++G66hvZ22NsfqdsPztncPtI6j7GgpRmlnPhTbY607b7t9VJ2b1rHM1NniFaxBR9ROZ3+ppglr0BFVdTrZWYOOSF9nl/FE1M5R7sYTURWTncgQTHYiQzDZiQzBZCcyBJOdyBBMdiJDMNmJDMFkJzIEk53IEEx2IkMw2YkMwWQnMgSTncgQTHYiQzDZiQzBZCcyBJOdyBBMdiJDMNmJDMFkJzIEk53IEEx2IkMw2YkM8T8wqEAJFtaBGgAAAABJRU5ErkJggg==" alt="1730683422190"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">10.0</span>.0.51  主
<span class="token number">10.0</span>.0.52  从

需要2台或以上节点，通过把主库binlog传输到从库解析回放到数据库里,实现数据复制同步。当然也可以在一台机器上搞多个实例也可以实现。我们的实验就搞两台机器。

作用：
<span class="token number">1</span>）可以实现数据信息的使用同步
<span class="token number">2</span>）可以实现数据库服务冗余特性 （主库故障了 从库可以对接前端页面）
<span class="token number">3</span>）可以实现数据库数据备份功能 （热备 冷备 逻辑备份 物理备份-从库） 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>传统的主从复制：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>db01  <span class="token number">10.0</span>.0.51  主
db02  <span class="token number">10.0</span>.0.52  从
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在主上操作：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 看一下，是否可以连网：</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ping www.baidu.com</span>

<span class="token comment"># 设置名称和地址解析（可选的）</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># hostnamectl set-hostname db01</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># echo &quot;10.0.0.51 db01&quot;&gt;&gt;/etc/hosts</span>

<span class="token comment"># 关闭系统的安全功能</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># systemctl disable firewalld</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># sed -i '7s#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config</span>

<span class="token comment"># 清理系统中的数据库服务</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa|grep mariadb</span>
mariadb-libs-5.5.68-1.el7.x86_64
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># yum remove -y `rpm -qa|grep mariadb`</span>

<span class="token comment"># 安装mysql依赖软件</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y libaio-devel</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y lrzsz tree vim wget net-tools</span>

<span class="token comment"># 创建服务用户与存储数据目录</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># useradd mysql -M -s /sbin/nologin</span>
<span class="token punctuation">[</span>root@db-01-51 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/3306/data &amp;&amp; chown mysql.mysql /data/3306/data</span>


<span class="token comment"># 解压安装数据库软件程序</span>
<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># cd /usr/local/</span>
<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/usr/local


<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># tar xvf mysql-8.0.32-linux-glibc2.12-x86_64.tar.xz</span>

<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># ln -s mysql-8.0.32-linux-glibc2.12-x86_64 mysql    --重要目录bin，存放数据库的命令信息（mysql mysqladmin mysqldump ...)</span>

<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># vim /etc/profile</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">&quot;<span class="token environment constant">$PATH</span>:/usr/local/mysql/bin&quot;</span>           -- 保存配置信息

<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># source /etc/profile            -- 加载最新环境变量配置</span>

<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># mysql -V          -- 可以看到数据库版本信息，表示数据库安装完毕</span>
mysql  Ver <span class="token number">8.0</span>.32 <span class="token keyword">for</span> Linux on x86_64 <span class="token punctuation">(</span>MySQL Community Server - GPL<span class="token punctuation">)</span>

编写数据库服务配置文件,默认是没有my.cnf的，需要创建。下面的内容先不要管。
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/my.cnf <span class="token operator">&lt;&lt;</span><span class="token string">eof
[mysql]
socket=/tmp/mysql.sock
[mysqld]
user=mysql
socket=/tmp/mysql.sock
basedir=/usr/local/mysql
datadir=/data/3306/data
server_id=51
port=3306
eof</span>

---------------- 大家copy上面的命令就行。
<span class="token punctuation">[</span>root@db-01-51 local<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token number">51</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>

<span class="token comment"># 不安全初始化</span>
mysqld --initialize-insecure <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data

<span class="token comment"># 启动Mysql</span>
<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># cp /usr/local/mysql/support-files/mysql.server /etc/init.d/</span>
<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server start</span>
Starting MySQL.Logging to <span class="token string">'/data/3306/data/db01-51.err'</span><span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span> SUCCESS<span class="token operator">!</span>

<span class="token comment"># 连接一下 成功</span>
<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># mysql -uroot</span>
mysql<span class="token operator">&gt;</span> 

<span class="token comment"># 设置密码：(没有密码可以设置密码）</span>
<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># mysqladmin -uroot password &quot;123456&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>在10.0.0.52上也是这样操作：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>重复上面10.0.0.51的操作，注意有51的地方，需要换成52
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>确认【主库】开启binlog日志。
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@log_bin<span class="token punctuation">;</span>
+-----------+
<span class="token operator">|</span> @@log_bin <span class="token operator">|</span>
+-----------+
<span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>
+-----------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@log_bin_basename<span class="token punctuation">;</span>
+------------------------+
<span class="token operator">|</span> @@log_bin_basename     <span class="token operator">|</span>
+------------------------+
<span class="token operator">|</span> /data/3306/data/binlog <span class="token operator">|</span>
+------------------------+

-----------------------------------------------------

修改my.cnf
log_bin <span class="token operator">=</span> /data/3306/data/binlog

<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># cat /etc/my.cnf </span>
<span class="token punctuation">[</span>mysql<span class="token punctuation">]</span>
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token assign-left variable">user</span><span class="token operator">=</span>mysql
<span class="token assign-left variable">socket</span><span class="token operator">=</span>/tmp/mysql.sock
<span class="token assign-left variable">basedir</span><span class="token operator">=</span>/usr/local/mysql
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/data/3306/data
<span class="token assign-left variable">server_id</span><span class="token operator">=</span><span class="token number">51</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>/data/3306/data/binlog

-----------------------------------------------------

确保主从环境server_id和server_uuid不同
<span class="token number">1</span>）查看  <span class="token number">51</span>上面的
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@server_id<span class="token punctuation">;</span>
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">51</span> <span class="token operator">|</span>
+-------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@server_uuid<span class="token punctuation">;</span>
+--------------------------------------+
<span class="token operator">|</span> @@server_uuid                        <span class="token operator">|</span>
+--------------------------------------+
<span class="token operator">|</span> a9c7eadc-9a4e-11ef-960d-000c29aa8066 <span class="token operator">|</span>
+--------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token number">1</span>）查看  <span class="token number">52</span>上面的
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@server_id<span class="token punctuation">;</span>
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">52</span> <span class="token operator">|</span>
+-------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @@server_uuid<span class="token punctuation">;</span>
+--------------------------------------+
<span class="token operator">|</span> @@server_uuid                        <span class="token operator">|</span>
+--------------------------------------+
<span class="token operator">|</span> 4c14c8f6-9a50-11ef-9b0b-000c299ce8c4 <span class="token operator">|</span>
+--------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

如果你的52是克隆出来的（我们的不是），那么这个server_uuid是一样的。
修改从库server_uuid
<span class="token function">rm</span> <span class="token parameter variable">-f</span> /data/3306/data/auto.cnf
重启mysql会生成新的uuid
<span class="token punctuation">[</span>root@db01-51 local<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server restart</span>
-----------------------------------------------------
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>主库51创建主从复制用户并授权
create user repl@<span class="token string">'10.0.0.%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span>
grant replication slave on *.* to repl@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>

<span class="token comment">#replication slave 仅用来复制权限。</span>

在主库51上创建一个数据库：
mysql<span class="token operator">&gt;</span> create database sy01<span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sy01               <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
+--------------------+

需要将主库数据备份，备份时，主数据库锁住，mysql<span class="token operator">&gt;</span> flush table with <span class="token builtin class-name">read</span> lock<span class="token punctuation">;</span> <span class="token comment">##窗口不能关.</span>
备份完毕后，还需要解锁：mysql<span class="token operator">&gt;</span> unlock tables<span class="token punctuation">;</span>
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123456</span> <span class="token parameter variable">-A</span> --source-data<span class="token operator">=</span><span class="token number">2</span> --single-transaction <span class="token parameter variable">-R</span> <span class="token parameter variable">-E</span> <span class="token parameter variable">--triggers</span> <span class="token operator">&gt;</span>/tmp/all.sql
<span class="token function">scp</span> <span class="token parameter variable">-rp</span> /tmp/all.sql <span class="token number">10.0</span>.0.52:/tmp

从库恢复数据 
<span class="token punctuation">[</span>root@db02-52 local<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456 &lt;/tmp/all.sql</span>
mysql<span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sy01               <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
+--------------------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

现在可以看一下主库的binlog如下：
mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span>
+---------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> File          <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span>
+---------------+----------+--------------+------------------+-------------------+
<span class="token operator">|</span> binlog.000001 <span class="token operator">|</span>     <span class="token number">1195</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span>
+---------------+----------+--------------+------------------+-------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>测试在主库51上面创建一些增量数据，这些数据在从库上是没有的
mysql<span class="token operator">&gt;</span> use sy01<span class="token punctuation">;</span>
Database changed

mysql<span class="token operator">&gt;</span> create table t1<span class="token punctuation">(</span>name int<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> insert into t1 values<span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

从库进行主从配置 
   CHANGE MASTER TO
   <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.51'</span>,
   <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
   <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repl'</span>,
   <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
   <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'binlog.000001'</span>,
   <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">1195</span>,
   <span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>

解释：
	<span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.000001'</span>, <span class="token comment">#这里要对上show master status;文件</span>
	<span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">1195</span>, <span class="token comment">#表示从哪个位置点开始主从同步</span>
	
CHANGE MASTER TO语句，5.7以前写到从库master.info文件里，5.7及以后写到一张表里<span class="token punctuation">(</span>mysql.slave_master_info<span class="token punctuation">)</span>.

开始在从库上执行：
mysql<span class="token operator">&gt;</span>    CHANGE MASTER TO
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.51'</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repl'</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'binlog.000001'</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">1195</span>,
    -<span class="token operator">&gt;</span>    <span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected, <span class="token number">10</span> warnings <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>

查看：
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from mysql.slave_master_info<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
                Number_of_lines: <span class="token number">33</span>
                Master_log_name: mysql-bin.000001
                 Master_log_pos: <span class="token number">1195</span>
                           Host: <span class="token number">10.0</span>.0.51
                      User_name: repl
                  User_password: <span class="token number">123456</span>
                           Port: <span class="token number">3306</span>
                  Connect_retry: <span class="token number">10</span>
                  
在从库上启动主从关系（开启同步开关）
mysql<span class="token operator">&gt;</span> start slave<span class="token punctuation">;</span>

查看主从关系是否成功，在从库上操作：
mysql<span class="token operator">&gt;</span> show slave status<span class="token punctuation">\</span>G
成功标志:两个Yes
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    
查看从库是否同步过来了数据：
mysql<span class="token operator">&gt;</span> use sy01<span class="token punctuation">;</span>
Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names
You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>

Database changed
mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+----------------+
<span class="token operator">|</span> Tables_in_sy01 <span class="token operator">|</span>
+----------------+
<span class="token operator">|</span> t1             <span class="token operator">|</span>
+----------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from t1<span class="token punctuation">;</span>
+------+
<span class="token operator">|</span> name <span class="token operator">|</span>
+------+
<span class="token operator">|</span>  <span class="token number">111</span> <span class="token operator">|</span>
+------+

-------------------------------------- 

在主库上再添加一条数据，看一下，是否能同步到从库中：
mysql<span class="token operator">&gt;</span> use sy01<span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> insert into t1 values<span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

看从库是否同步了：
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from t1<span class="token punctuation">;</span>
+------+
<span class="token operator">|</span> name <span class="token operator">|</span>
+------+
<span class="token operator">|</span>  <span class="token number">111</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">222</span> <span class="token operator">|</span>
+------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>查看主从是否成功，在从库上执行如下命令：
mysql<span class="token operator">&gt;</span> show slave status<span class="token punctuation">\</span>G
成功标志:两个Yes
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
  
如果不是两个Yes,就是部署的有问题,执行下面步骤后重做:
<span class="token number">1</span>.从库stop slave<span class="token punctuation">;</span>reset slave all<span class="token punctuation">;</span>reset master<span class="token punctuation">;</span>
<span class="token number">2</span>.从新导入全备.
<span class="token number">3</span>.从新change master
<span class="token number">4</span>.start slave<span class="token punctuation">;</span>
<span class="token number">5</span>.show slave status<span class="token punctuation">\</span>G
<span class="token number">6</span>.看是否有两个Yes
    Replica_IO_Running: Yes
    Replica_SQL_Running: Yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-主从原理"><a href="#_2-主从原理" class="header-anchor">#</a> 2，主从原理</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>）主从同步激活后，会在从库系统中创建两个线程（SQL thread IO thread）
<span class="token number">2</span>）利用IO线程读取master_info, 获取主库信息
<span class="token number">3</span>）利用IO线程向主库发起同步建立请求，和主机建立TCP连接
<span class="token number">4</span>）在主从建立连接后，主库会生成dump thread线程；可以监控/收集主库binlog信息  可以将主库binlog信息推送给从库
<span class="token number">5</span>）从库IO线程接收到binlog信息，将binlog信息位置点信息更新到master_info中，将binlog信息存储到relay_log文件中（SQL语句）；
<span class="token number">6</span>）利用SQL线程读取relay_log信息，将relay_log信息进行数据回放（SQL语句执行-从库）
<span class="token number">7</span>）利用SQL线程将恢复relay_log日志位置点，记录到relay_log_info文件中，当SQL线程异常退出，重新恢复后可以获取回放的位置点
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/devops/public/assets/img/1729778410682.b40fd288.png" alt="1729778410682"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>在主库开启<span class="token punctuation">[</span>binlog日志<span class="token punctuation">]</span>,然后从库获取主库binlog日志,在从数据库里异步回放来实现的。这个过程是<span class="token punctuation">[</span>异步<span class="token punctuation">]</span>的工作模式.

复制的时候有3个线程
<span class="token comment"># 从库有两个线程</span>
IO线程  ： 
	a. 负责连接主库
	b. 和主库的Binlog Dump线程交互 
	c. 接收和存储binlog dump线程发过来的binlog日志，存储到从库relay-log（中继日志）中
	d. 同时将获取到的binlog日志的文件和位置点更新到master.info中<span class="token punctuation">(</span><span class="token number">5.7</span>以后mysql.slave_master_info <span class="token punctuation">)</span>

SQL线程
	a.回放relay-log中的日志解析将SQL语句应用到从数据库中。
	b.记录回放的位置到relay-log.info中，8.0没有此文件了，而是记录到了表里slave_relay_log_info。

<span class="token comment"># 主库线程</span>
binlog dump线程，负责与从库IO线程沟通,同时投递binlog给从库。
作用： 
	a. 与从库IO线程进行交互
	b. 监控主库binlog的变化
    c. 投递binlog给从库IO线程
监控： 
	show processlist<span class="token punctuation">;</span>
    <span class="token comment">## Binlog Dump |  531 | Source has sent all binlog to replica; waiting for more updates</span>
    
    
涉及到4个文件：
<span class="token number">4</span>个文件：
- binlog文件    二进制日志。 
- master_info文件   存放连接主库的信息（ip、port、user、password、已经获取的binlog位置点）
	 <span class="token number">5.7</span>以上在表中，5.7以前是磁盘上文件。
- relay_log文件
	中继日志，从库用来临时存储接收到的binlog日志。
- relay_log_info文件
	存储SQL线程回放过的日志位置信息。 <span class="token number">5.7</span>以上在表中，5.7以前是磁盘上文件。
	
<span class="token number">8.0</span>主从复制文件转成表变化: 
原始master.info文件转成了table,mysql.slave_master_info
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from mysql.slave_master_info<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
                Number_of_lines: <span class="token number">33</span>
                Master_log_name: binlog.000001
                 Master_log_pos: <span class="token number">1195</span>
                           Host: <span class="token number">10.0</span>.0.51
                      User_name: repl
                  User_password: <span class="token number">123456</span>
                           Port: <span class="token number">3306</span>
                  Connect_retry: <span class="token number">10</span>
                    Enabled_ssl: <span class="token number">0</span>

relay-log.info文件转成了table mysql.slave_relay_log_info
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from mysql.slave_relay_log_info<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
                             Number_of_lines: <span class="token number">14</span>
                              Relay_log_name: ./db02-52-relay-bin.000002
                               Relay_log_pos: <span class="token number">1059</span>
                             Master_log_name: binlog.000001
                              Master_log_pos: <span class="token number">1931</span>
                                   Sql_delay: <span class="token number">0</span>
                           Number_of_workers: <span class="token number">4</span>
                                          Id: <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="_3-主从复制监控"><a href="#_3-主从复制监控" class="header-anchor">#</a> 3，主从复制监控</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>自带命令 show slave status <span class="token punctuation">\</span>G
主从复制状态核心参数:
	Slave_IO_Running:  Yes
	Slave_SQL_Running: Yes
	
主从延迟判断的3个方法：	

方法1：
Seconds_Behind_Master: <span class="token number">0</span>   <span class="token comment">#从库更新延迟主库的秒数  注意:不是特别准确</span>
<span class="token punctuation">[</span>root@db02 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p123456 -e &quot;show slave status\G&quot;|egrep &quot;Seconds_Behind_Master&quot;</span>
        Seconds_Behind_Master: <span class="token number">0</span>

方法2：
pt-heartbeat监控主从

方法3：看状态中的IO的binlog位置，SQL对应binlog位置，确定延迟的日志量。

mysql<span class="token operator">&gt;</span> show slave status<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
               Slave_IO_State: Waiting <span class="token keyword">for</span> <span class="token builtin class-name">source</span> to send event
                  Master_Host: <span class="token number">10.0</span>.0.51
                  Master_User: repl
                  Master_Port: <span class="token number">3306</span>
                Connect_Retry: <span class="token number">10</span>
              Master_Log_File: binlog.000001
          Read_Master_Log_Pos: <span class="token number">1931</span>
          
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from mysql.slave_relay_log_info<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
                             Number_of_lines: <span class="token number">14</span>
                              Relay_log_name: ./db02-52-relay-bin.000002
                               Relay_log_pos: <span class="token number">1059</span>
                             Master_log_name: binlog.000001
                              Master_log_pos: <span class="token number">1931</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Master_Log_File: binlog.000001  --- IO线程收集到的主库binlog信息
Read_Master_Log_Pos: <span class="token number">1931</span>

Relay_Master_Log_File: binlog.000001   --- SQL线程回放binlog事件信息的位置点
Exec_Master_Log_Pos: <span class="token number">1931</span>

以上两组内容信息一致，表示主从数据一致

------------------------------------------

看延迟：
 Seconds_Behind_Master: <span class="token number">0</span>
 
------------------------------------------

<span class="token comment"># 主从复制线程故障</span>
Slave_IO_Running: Yes
Slave_SQL_Running: Yes

Last_IO_Errno: <span class="token number">0</span>   <span class="token comment">##IO故障号码</span>
Last_IO_Error:     <span class="token comment">##IO故障提示</span>

Last_SQL_Errno: <span class="token number">0</span>  <span class="token comment">##SQL故障号码</span>
Last_SQL_Error:    <span class="token comment">##SQL故障提示</span>
			


<span class="token comment"># 过滤复制相关信息			</span>
Replicate_Do_DB: 
Replicate_Ignore_DB: 
Replicate_Do_Table: 
Replicate_Ignore_Table: 
Replicate_Wild_Do_Table: 
Replicate_Wild_Ignore_Table: 


<span class="token comment"># 主从之间延时的秒数</span>
Seconds_Behind_Master: <span class="token number">0</span>


<span class="token comment"># 延时从库状态</span>
SQL_Delay: <span class="token number">0</span>
SQL_Remaining_Delay: NULL
    
	
<span class="token comment"># GTID 复制	</span>
Retrieved_Gtid_Set: 
Executed_Gtid_Set: 

------------------------------------------

*************************** <span class="token number">1</span>. row ***************************
               Slave_IO_State: Waiting <span class="token keyword">for</span> <span class="token builtin class-name">source</span> to send event
                  Master_Host: <span class="token number">10.0</span>.0.51
                  Master_User: repl
                  Master_Port: <span class="token number">3306</span>
                Connect_Retry: <span class="token number">10</span>
              Master_Log_File: binlog.000001  --- IO线程收集到的主库binlog信息
          Read_Master_Log_Pos: <span class="token number">1931</span>
               Relay_Log_File: db02-52-relay-bin.000002
                Relay_Log_Pos: <span class="token number">1059</span>
        Relay_Master_Log_File: binlog.000001   --- SQL线程回放binlog事件信息的位置点
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: <span class="token number">0</span>
                   Last_Error: 
                 Skip_Counter: <span class="token number">0</span>
          Exec_Master_Log_Pos: <span class="token number">1931</span>
              Relay_Log_Space: <span class="token number">1271</span>
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: <span class="token number">0</span>
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: <span class="token number">0</span>
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: <span class="token number">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span class="token number">0</span>
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: <span class="token number">51</span>
                  Master_UUID: a9c7eadc-9a4e-11ef-960d-000c29aa8066
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: <span class="token number">0</span>
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Replica has <span class="token builtin class-name">read</span> all relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> <span class="token function">more</span> updates
           Master_Retry_Count: <span class="token number">86400</span>
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: <span class="token number">0</span>
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
       Master_public_key_path: 
        Get_master_public_key: <span class="token number">0</span>
            Network_Namespace: 

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><h3 id="_4-主从同步不成功原因分析"><a href="#_4-主从同步不成功原因分析" class="header-anchor">#</a> 4，主从同步不成功原因分析</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>主从同步不成功原因：
- IO线程异常，正常的话是一个Yes
- SQL线程异常，正常的话是一个Yes
- 主从延迟比较大，正常是0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>IO线程的状态：
	- YES  正常的
	- NO   不正常   需要关注错误码和错误信息
	- Connecting  不正常   需要关注错误码和错误信息
	
常见的报错场景：
	通信问题：
		网络断，防火墙等网站问题
		ip<span class="token punctuation">\</span>port<span class="token punctuation">\</span>user<span class="token punctuation">\</span>passwd 错误
		主库连接数上限，默认是151
	请求日志：
		主库binlog确失
		文件名/位置不对
	主从server_id/server_uuid重复
	
解决思路：
	<span class="token number">1</span>. stop slave
	<span class="token number">2</span>. reset slave all
	<span class="token number">3</span>. 正确的写change master to
	<span class="token number">4</span>. start slave
	<span class="token number">5</span>. show slave status<span class="token punctuation">\</span>G
	
如果还不是YES，检查：主从server_id/server_uuid重复
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>SQL线程的状态：
	- YES  正常的
	- NO   不正常   需要关注错误码和错误信息

relaylog回放出问题：
	<span class="token number">1</span>，先从库上创建一个jh01数据库，然后又去主库上创建一个jh01数据库。
    
解决：
	<span class="token number">1</span>. 以主库为准，将从库中准备数据删除了，如果没有必须，跳过不执行。
	<span class="token number">2</span>. 不要人为操作从库，你可以把从库设置成只读。
		mysql<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> global <span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
		<span class="token function">vim</span> /etc/my.conf  
		<span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span>
	<span class="token number">3</span>. 用户授权，主库可以授权CURD，从库只需要授权select
	<span class="token number">4</span>. 跳过错误
		命令行：
			msyql<span class="token operator">&gt;</span>stop slave<span class="token punctuation">;</span>
			mysql<span class="token operator">&gt;</span>set global <span class="token assign-left variable">sql_skip_counter</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
			mysql<span class="token operator">&gt;</span>start slave<span class="token punctuation">;</span>
		配置文件：
			<span class="token function">vim</span> /etc/my.cnf
			<span class="token assign-left variable">slave_skip_errors</span><span class="token operator">=</span><span class="token number">1062,1007</span>,10032
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>主从有延时：
	主库做的事，从库过了很久才做。
	
如何知道是否有延时： show slave master<span class="token punctuation">\</span>G
	Seconds_Behind_Master: <span class="token number">0</span>
	---------------
	Master_Log_File: binlog.000001  --- IO线程收集到的主库binlog信息
    Read_Master_Log_Pos: <span class="token number">1931</span>

    Relay_Master_Log_File: binlog.000001   --- SQL线程回放binlog事件信息的位置点
    Exec_Master_Log_Pos: <span class="token number">1931</span>

    以上两组内容信息一致，表示主从数据一致
    -----------------
   
原因：
	外部：
		硬件差异
		锁问题，大事务，存储过程
	主库：	
		超大事务或者很多的慢查询
		更新了大量的数据，update 1w行 
	从库：
		从库数据较多，一般从库数据不会超过5个
		SQL线程只有一个，使用SQL线程回放时，较慢
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>）IO线程异常：connecting/no
connecting：始终无法实现主从建立连接
- 连接地址、端口、用户、密码信息不对可能会导致连接异常；
- 防火墙安全策略阻止连接建立、网络通讯配置异常影响连接建立；
- 到达数据库服务连接数上限，造成主从连接产生异常；

Last_IO_Errno: <span class="token number">2003</span>
Last_IO_Error: error connecting to master <span class="token string">'repl@10.0.0.51:3306'</span> - retry-time: <span class="token number">10</span> retries: <span class="token number">3</span> message: Can<span class="token string">'t connect to MySQL server on '</span><span class="token number">10.0</span>.0.51:3306<span class="token string">' (111)
mysql -urepl -p123456 -h10.0.0.51 -P3306
mysql: [Warning] Using a password on the command line interface can be insecure.
ERROR 2003 (HY000): Can'</span>t connect to MySQL server on <span class="token string">'10.0.0.51:3306'</span> <span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>

stop slave<span class="token punctuation">;</span>
reset slave all<span class="token punctuation">;</span>                        -- 清除主从配置信息

<span class="token keyword">select</span> * from mysql.slave_master_info<span class="token punctuation">;</span>  -- 显示内容为空
CHANGE MASTER TO
<span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.51'</span>,
<span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3307</span>,
<span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repl'</span>,
<span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
<span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'mysql-bin.000033'</span>,    --- 同步位置获取正确
<span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">277</span>,                    --- 同步位置获取正确
<span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>

max_connections   --- 表示数据库默认会话连接上限（151）（2000-3000-硬件性能高  <span class="token number">500</span>-1000-硬件性能低）
Last_IO_Errno: <span class="token number">1040</span>
Last_IO_Error: error connecting to master <span class="token string">'repl@10.0.0.51:3307'</span> - retry-time: <span class="token number">10</span> retries: <span class="token number">1</span> message: Too many connections

IO线程异常
no：不能接收binlog 不能保存binlog 

IO线程异常：
可能导致异常原因：
- IO线程在请求日志信息失败，有可能日志信息被无意清理了；
- IO线程在请求日志信息失败，有可能主从配置的标识信息重复冲突了；（server_id  / server_uuid）

Last_IO_Errno: <span class="token number">13114</span>
Last_IO_Error: Got fatal error <span class="token number">1236</span> from master when reading data from binary log: <span class="token string">'Could not open log file'</span>
恢复主库binlog文件信息

Last_IO_Errno: <span class="token number">13117</span>
Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server ids<span class="token punctuation">;</span> 
               these ids must be different <span class="token keyword">for</span> replication to work <span class="token punctuation">(</span>or the --replicate-same-server-id option must be used on slave but this does not always <span class="token function">make</span> sense<span class="token punctuation">;</span> please check the manual before using it<span class="token punctuation">)</span>.
Last_IO_Errno: <span class="token number">13117</span>
Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs<span class="token punctuation">;</span> 
               these UUIDs must be different <span class="token keyword">for</span> replication to work.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">2</span>）SQL线程异常：no <span class="token punctuation">(</span>SQL线程加载relay_log文件回放数据信息失败，重新执行SQL语句信息失败<span class="token punctuation">)</span>
原因导致SQL线程状态变为no 
可能导致异常原因：（从库数据或设置异常导致）
- 创建的对象已经存在，涉及到的对象可能有库、表、用户、索引<span class="token punctuation">..</span>.<span class="token punctuation">;</span> 
- 插入（insert）的操作对象有异常、修改（update alter）的操作对象有异常、删除（delete drop）的操作对象有异常；
- 由于数据库设置的约束信息，与执行的SQL语句产生冲突问题； 
- 在数据库不同版本之间进行数据同步时，可能出现配置冲突问题（比如：5.6可以识别时间为0字段，5.7不能识别时间为0字段 sql_mode）
可能造成异常情况：
- 在进行主从配置时，指定的位置点出现错误（change master to）；  GTID
- 在进行主从配置前，从库被写入相应的数据信息了，与主库同步数据产生冲突（误连接从库进行操作了）； 限制从库不能做写入数据  <span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span>/super_read_only<span class="token operator">=</span><span class="token number">1</span>
- 在从库工作繁忙状态时，从库宕机了，业务恢复后可能出现异步同步数据错乱（主库操作创建表操作没同步，同步了插入表操作）；  数据补偿机制
- 在进行主从切换时（假设进行的是手工切换），没有正确操作锁定源主库和binlog日志信息；（画图说明）  主从切换时，确认主库需要设置锁库操作
  导致切换前主库数据没有完全同步，切换后从库数据（原主库）比主库数据（原从库）信息更全；  
- 在应用数据库双主结构时，没有正确使用（经常导致相互同步数据，主键或唯一键冲突）（画图说明）
  若企业创建必须使用双主架构，实现双写机制，可以使用全局序列机制，实现主键或唯一键的统一分配；  

Last_Errno: <span class="token number">1007</span>
Last_Error: Coordinator stopped because there were error<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> the worker<span class="token punctuation">(</span>s<span class="token punctuation">)</span>. 
            The <span class="token function">most</span> recent failure being: Worker <span class="token number">1</span> failed executing transaction <span class="token string">'ANONYMOUS'</span> at master log mysql-bin.000033, end_log_pos <span class="token number">792</span>. 
			See error log and/or performance_schema.replication_applier_status_by_worker table <span class="token keyword">for</span> <span class="token function">more</span> details about this failure or others, <span class="token keyword">if</span> any.
			
如何解决SQL线程异常问题：
方式一：处理冲突的数据信息
将从库中冲突的数据信息清理；

方式二：跳过冲突的数据信息
sql_slave_skip_counter    --- 跳过重复或冲突事务信息<span class="token punctuation">;</span>     
slave_skip_errors         --- 根据错误编码忽略错误信息<span class="token punctuation">;</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>主从同步出现延迟
影响高可用数据一致性，主库数据多，从库数据少； 
影响读写分离架构数据一致性，当读取主库数据全的，当读取从库数据少的；

- 外部因素导致的延时问题：
  - 网络通讯不稳定，有带宽阻塞等情况，造成主从数据传输同步延时；
  - 主从硬件差异大，从库磁盘性能较低，内存和CPU资源都不够充足；
  - 主从配置区别大，从库配置没有优化，导致并发处理能力低于主库； 

- 主库因素导致的延时问题：
  - 主要涉及Dump thread工作效率缓慢，可能是由于主库并发压力比较大；  （高并发访问--服务层--分析器-优化器-执行器--CPU--分库分表 分布式存储数据）
  - 主要涉及Dump thread工作效率缓慢，可能是由于从库数量比较多导致；  （3-5个从库）
  - 主要涉及Dump thread工作效率缓慢，主要由于线程本身串型工作方式；  （<span class="token variable"><span class="token variable">`</span>利用组提交缓解此类问题-5.6开始 group commit<span class="token variable">`</span></span>）
    主库本身可以并发多个事务运行，默认情况下主从同步Dump thread只有一个，只能采用串型方式传输事务日志信息；
    binlog_group_commit_sync_delay               -- 控制dump线程延迟多少毫秒,统一把多个事务信息传输给IO线程  
    -- 表示延迟多少微秒同步到磁盘
    <span class="token assign-left variable">binlog_group_commit_sync_no_delay_count</span><span class="token operator">=</span><span class="token number">10</span>   -- 控制dump线程每次传输多少个事务信息,
    -- 表示延迟提交的最大事务数量

- 从库因素导致的延时问题：
  - 从库产生延迟受SQL线程影响较大，由于线程本身串型工作方式导致；
    利用不同数据库并行执行事务操作，但是一个库有多张表情况，产生大量并发事务操作，依旧是串型的（5.6开始 多SQL线程回放）
    利用logical_clock机制进行并发回放，由于组提交事务是没有冲突的，从库并行执行也不会产生冲突（5.7开始 多SQL线程回放）
    根据日志内容信息，获取logical_clock机制的组提交标记信息：<span class="token variable"><span class="token variable">`</span>（事务级别并发）<span class="token variable">`</span></span>

    可以优化SQL线程数量：
	<span class="token assign-left variable">slave_parallel_workers</span><span class="token operator">=</span><span class="token number">8</span>
	可以优化SQL线程并行执行事务的逻辑：
	<span class="token assign-left variable">slave_parallel_type</span><span class="token operator">=</span>LOGICAL_CLOCK<span class="token punctuation">;</span>
	
- 其他因素导致的延时问题：
  - 由于数据库大事务产生的数据同步延时问题；（更新100W数据/尽量切割事务）
  - 由于数据库锁冲突机制的数据同步延时问题；（资源被锁无法同步/隔离级别配置RR-锁冲突严重，可调整RC降低延时 索引主从一致）
  - 由于数据库过度追求安全配置也会导致同步延时问题（从库关闭双一参数）；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_5-gtid主从复制"><a href="#_5-gtid主从复制" class="header-anchor">#</a> 5，GTID主从复制</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>GTID介绍
GTID<span class="token punctuation">(</span>Global Transaction ID<span class="token punctuation">)</span>是对于一个已提交事务的唯一编号，并且是一个全局<span class="token punctuation">(</span>主从复制<span class="token punctuation">)</span>唯一的编号。

保证sever_uuid和server-id 唯一。
<span class="token keyword">select</span> @@server_id<span class="token punctuation">;</span>
<span class="token keyword">select</span> @@server_uuid<span class="token punctuation">;</span>

在开启gtid主从复制的重要参数：
gtid-mode<span class="token operator">=</span>on  --启用gtid类型，否则就是普通的复制架构
enforce-gtid-consistency<span class="token operator">=</span>true   --强制GTID的一致性
log-slave-updates<span class="token operator">=</span><span class="token number">1</span>                 --8.0以前从库记录binlog
<span class="token assign-left variable">log_replica_updates</span><span class="token operator">=</span><span class="token number">1</span>               --8.0后从库记录binlog
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>环境：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">10.0</span>.0.51 主库
<span class="token number">10.0</span>.0.52 从库
<span class="token number">10.0</span>.0.53 从库
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>清理环境，在51和52上都去清理：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">pkill</span> mysqld
<span class="token function">sleep</span> <span class="token number">2</span>
<span class="token punctuation">\</span>rm <span class="token parameter variable">-rf</span> /data/3306/data/*
<span class="token punctuation">\</span>mv /etc/my.cnf /tmp
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/3306/data
<span class="token function">chown</span> <span class="token parameter variable">-R</span> mysql.mysql /data/*
<span class="token function">ls</span> /data/3306/data

执行3遍
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>再去准备一个53的从库：</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAO4AAABOCAYAAAAn8irMAAAJY0lEQVR4nO2dP4zjaBnGH+/N3t0IEBVIJxA0yRRD7rr757C0nDMSSgEpYNEhgewKJRSzBUSaiQgUjIScBhQXSAtXpYpOGrtAiGJJdAKqJRqhsaE7nQSigAOOg4OPwnHiOLZjZ/PHjp+fFGk3jt/3+xw/837+7O+JJIQQIITkijv7bgAhJD0ULiE5hMIlJIcc7Tphp9NJ/NmLi4sttoSQ/LJz4QLJBJlG4IQUjcwOlZNXWwe9qgRJqqLnhG23oEkSpGoPoZvDPjt9aVYwVQ9V3/blnG5blvZbN19m8Lcz7Di726vhX8ACTq/qO34SpKVOJ49VZPZScT02OWyWZWBw7aDZLC287/S6MBJlsKBJNcAUEArgilCDpfShAIClQapNoNsCIy+F00O1LOHGFOgribuSLF9mcNCr1jDRbYhmyT0OZQ0nog8FDnrVMlpjFaqaLJp9M4as2xgFviesEavQiB1zeXkZ+u+k+yxjC12GUHVdyFCFubRNFrquCsi6sOOS2LqQIz9jChUQqhm2SRWY5Z22JexzqfJlCDt4XMP7aKoQsr66N6a6+vgkjVVkMjtUTs1JE23VQNc/xLKu0EIDZyfeG+5QdmEYZmnuMLp0gsq4hauw4ao1hCHrOA8rhUodKia4TTuyi8vnJl0YRs/b7A3HvUsADVqgT06v6rs0SBon4lLCvsFYrftGASWcVIBJ6g67OW8ngFHz2qMhs1cHGedwhAtAqasYt66mJ4ODXteA2m5iPigrodlWMR5cz05Sa+h9RkHfVKcnVZoTqoxTeYwbO3VrY/JZ0KQuTm0BIQSEsNEYlBeugY3aEHUhIEZ99Bf65OB6MJ72KU0c/3Ga49xO0nYshhKaI68tArY+QS3R3AMJkjnhPnhTweN3Hq23s3IOXZ5WXesKLYRUSaUOdTzAtQMAFoaGirr3GaU/P6FCJ06ikHFajtseMbkTlc8awsAYrbK3Txmt8WKVU03ftbC/T841BuNpn9LGCWln6aSS8Bgk7LOPUrPt+y5IGjIn3MdvP8KDobIg4OQzzPOK2hsakBtnIVVEwbnuTmQ5vS6MhWHgNEpzBCFMqEbNrU5KHWrkMPoKrXEFJ2HlypezL7xKM0JwXmYpHwDIOmwxr05CiJAJnXn8ujp2+3Q9APTzeZ9Sxglt5+TWVxXd4W4lvsMr+0yejMwJ1yNMwImYiqxlqGhHnC2lswYwuMLVANC9kuz0UF2qsF4lVXCuyzBqgcrh9FCtGYGqlZC4fCF/KCwtfviunOuzPjXOpv1eI05IYOjwxYgaySTCgbMwvVCDITdwRlGnZi/CTXMbyBPwG7/9fsI9XJEhpJLOKDXRrhgw4DtpSk08PO367jHWAHNeKUrNEYTdwKDsuwdZbmEcMmk1n3yJmfSJzaegb+uY+OIM6yv+OJTO0IABo9L2Vbc14iwHRvOhL0YNMCOuh5Nw/fq8LbWJDvsJYhUZSYj9LevrdDpLw+DXfvzhhf+/8Il7uP/it/HCc/c2mtvSJHRPw+4npo9TM+AOSXkSkh2x1wcw4tiWYAEATg9dQ0VbPLnMlL6A6G+gTYSkYO/C9Q+bLy4utitYzCukaoqMPaFESHL2OlQmhKxHZmeVCSHRULiE5BAKl5AcQuESkkMoXEJyCD2nCMkh9JwiJIdkdqhMz6ksEbNEz9JijscysZ5TKWMVGXpOzaDnVDhxnlMWtO4pbCHcZ7QXtoUT7TmVPlah2bFVDj2nEuXLEAk9p1xMoUIWcXZRSTynksYqMpkdKqeGnlOzPffmOWUNYSDOVCCF59TKWMXmcIQLek7t1XMqkalAQs+pJzEoKAiZEy49p5A7zymnV4VUHqBh+6/11/OcCo9FgmROuPScmr6ZE88pS5NQvmmH9Cu951R0LBIkc8L1oOdUDjynpoYEZuLSGOM5lTpWwdn1bNjl5eVsljhstvjzP/pQ6Otnv/leRMTlWU5blwX8b5jLs8qmiqX3bF0WAGavpdlPWxeybzsQjOG2JXp7MFxMvkCu+baoWd1p7uCG1HFCG+qL4ZthNtXFvkYdt2Abw45N6ljFhp5T9JwiOWTv1jVR0HOKkGj2Llx6ThGSHnpOEZJDIiuu+Ps/8N7VD/HBze932R5CDg7p+BjPfuNruPu5z24uZlTF/efFd/Gvn/x0Y4kIKTLSM8/go+Nf4s7HP7aReJH3cVlpCdkc4v338Z+f/2Jj8TL7AAYhh8adT39qY7ESzyoff+ubOHr15Y0lJuTQebdxf/GNp57aWOzEwj169WXc3YJwVy2mp+8UyStHr7yED9769XZibyVqSqLESd8pQsLJzDVup9NZevnfj4aeU9snbomef9vqBQyxnlMpYxWZzAgXcCtv2CsJnudUkLU8p6aLzk+7vpPH0mbrRIW3XG36Q9frCW5Fvszg85wSAsKsoFXW5mYF1elCfCFgqgZqKw6G5zk1O4az1UDpYxWZTPsqp6HSaGDSuoLV9C+xc3A9AHRdRWuwIoBzi4ms4+Fs5xKaI+8hZAtazYBqisV1oqUmRuYNpJqGelpTs9h8GWK6ML/tOeQp59DlMoZWH4qy2GalrgLdWzhQYhdbVEIXL68Xq6jspeKmraaJoOfUbM99eU5ZkeYFs5Yl9pxaHavY7G2ovPradU5SgdNzyu33Tj2nfNf9w3qcuwaw0nMqVaxis9drXE+QfgE/eFPB79751XoB6Tm1e8+pUhOjqRDrQymi0if0nIqMRYLsfXIqOGR+/PYjnA9fW1PA9JzatefUwt590yfE9J5T0bFIkL0LN4q1BUzPqZ16Tvn74PS6cw+pUOI9p9LFKjhRnjZ//eKXxV8+WZq9/j1+ayNeOXF+U0LQcyoqVyY9p5b6EPwliYg2RhybdLGyz7Y0JESM59TfvvSVhce1PjJ4YyOPPAYdL4LQc4ocCtvSELCH+7hhE1Jh0HOKkGgy9Wt9nufUV1/8Dp5/bnNuAX7oOUUOgb0JN+re7A++sN3H3FghySGQ2VllQkg0FC4hOYTCJSSHULiE5JDEk1PvNu7j6JWXttkWQg6KbdnWAClnlbfZEEJIciKHytLx8S7bQcjBs0lNRQr32a+/Djz99MYSEVJk7t6TcfT8ZzYWL/ZHv/73pz/jv3/448aSEVJEpONjV7Qb9FXmr/URkkN4O4iQHELhEpJDKFxCcgiFS0gOoXAJySEULiE5hMIlJIdQuITkEAqXkBzyf+5esjuAMBZTAAAAAElFTkSuQmCC" alt="1730773592813"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>现在51,52,53mysql数据库都安装好了。

准备配置文件：
<span class="token comment">#主库db01：</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/my.cnf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mysqld]
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
server_id=51
port=3306
secure-file-priv=/tmp
log_bin=/data/3306/data/binlog
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log_replica_updates=1
report_host=10.0.0.51
[mysql]
socket=/tmp/mysql.sock
prompt=db01 [<span class="token entity" title="\\">\\</span>d]&gt;
EOF</span>

<span class="token comment">#slave1(db02)：</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/my.cnf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mysqld]
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
server_id=52
port=3306
secure-file-priv=/tmp
log_bin=/data/3306/data/binlog
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log_replica_updates=1
report_host=10.0.0.52
[mysql]
socket=/tmp/mysql.sock
prompt=db02 [<span class="token entity" title="\\">\\</span>d]&gt;
EOF</span>

<span class="token comment">#slave2(db03)：</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/my.cnf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[mysqld]
basedir=/usr/local/mysql
datadir=/data/3306/data
socket=/tmp/mysql.sock
server_id=53
port=3306
secure-file-priv=/tmp
log_bin=/data/3306/data/binlog
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log_replica_updates=1
report_host=10.0.0.53
[mysql]
socket=/tmp/mysql.sock
prompt=db03 [<span class="token entity" title="\\">\\</span>d]&gt;
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 不安全初始化，3台都需要进行初始化</span>
mysqld --initialize-insecure <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/data/3306/data

<span class="token comment"># 3台都启动mysql</span>
<span class="token function">cp</span> /usr/local/mysql/support-files/mysql.server /etc/init.d/
/etc/init.d/mysql.server start

保证sever_uuid和server-id 唯一。
<span class="token keyword">select</span> @@server_id<span class="token punctuation">;</span>
<span class="token keyword">select</span> @@server_uuid<span class="token punctuation">;</span>

保存三台机器上mysql版本是一样的：
mysql <span class="token parameter variable">-e</span> <span class="token string">&quot;select version();&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>构建GTID主从：
master:51
slave :52,53

<span class="token comment"># 在51上创建repl用户</span>
db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> create user repl@<span class="token string">'10.0.0.%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span>
db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> grant replication slave on *.* to repl@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>


<span class="token comment"># 52\53: 在52和53上操作</span>
change master to 
<span class="token assign-left variable">master_host</span><span class="token operator">=</span><span class="token string">'10.0.0.51'</span>,
<span class="token assign-left variable">master_user</span><span class="token operator">=</span><span class="token string">'repl'</span>,
<span class="token assign-left variable">master_password</span><span class="token operator">=</span><span class="token string">'123456'</span> ,

<span class="token assign-left variable">MASTER_AUTO_POSITION</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">###如果新从库从1开始，有relaylog从指定GTID开始</span>

<span class="token comment"># 52\53: 在52和53上操作</span>
db02 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>start slave<span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>start slave<span class="token punctuation">;</span>

<span class="token comment"># 查看状态：</span>
db02 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show slave status<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show slave status<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
最主要的是看那2个YES。

<span class="token comment">#GTID位置</span>
Retrieved_Gtid_Set: 1052dbab-9b1f-11ef-a141-000c29aa8066:1-2
Executed_Gtid_Set: 1052dbab-9b1f-11ef-a141-000c29aa8066:1-2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>测试搭建的是否OK:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>在51上面创建一个数据库：
db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>create database sy01<span class="token punctuation">;</span>

在52和53上测试：
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> sy01               <span class="token operator">|</span>
<span class="token operator">|</span> sys                <span class="token operator">|</span>
+--------------------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="十一-高可用mha"><a href="#十一-高可用mha" class="header-anchor">#</a> 十一，高可用MHA</h2> <p>MHA是建立在主从同步架构之上的。</p> <h3 id="_1-高可用搭建"><a href="#_1-高可用搭建" class="header-anchor">#</a> 1，高可用搭建</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>实现高可用的方式：
<span class="token number">99.9</span>%      keepalived+双主架构，但需要人为干预
<span class="token number">99.99</span>%     MHA ORCH（Orchestrator） TMHA，具有自动监控，自动切换，自动数据补偿，但还是属于半自动化
           比较适合非金融类互联网公司 eg: facebook taobao前端-TMHA--<span class="token operator">&gt;</span>polaradb 
<span class="token number">99.999</span>%    PXC MGR MGC，数据是强一致性
           比较适合金融类互联网公司 
<span class="token number">99.9999</span>%   自动化、云计算化、平台化，仍然属于概念阶段 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>构建数据库高可用架构：MHA
步骤一：下载获取MHA高可用服务软件
MHA Manager  -- 需要部署在管理节点
MHA Node     -- 需要部署在数据节点

<span class="token number">10.0</span>.0.51  主库     MHA Node 
<span class="token number">10.0</span>.0.52  从库     MHA Node 
<span class="token number">10.0</span>.0.53  从库     MHA Node  MHA Manager    

步骤二：准备MHA高可用架构环境
<span class="token number">1</span>）搭建主从同步架构  OK 
db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show slave hosts<span class="token punctuation">;</span>
ERROR <span class="token number">2013</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: Lost connection to MySQL server during query
No connection. Trying to reconnect<span class="token punctuation">..</span>.
Connection id:    <span class="token number">15</span>
Current database: *** NONE ***
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token operator">|</span> Server_id <span class="token operator">|</span> Host      <span class="token operator">|</span> Port <span class="token operator">|</span> Master_id <span class="token operator">|</span> Slave_UUID                           <span class="token operator">|</span>
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token operator">|</span>        <span class="token number">53</span> <span class="token operator">|</span> <span class="token number">10.0</span>.0.53 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span>        <span class="token number">51</span> <span class="token operator">|</span> 30a16694-9b2d-11ef-a608-000c291edca5 <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">52</span> <span class="token operator">|</span> <span class="token number">10.0</span>.0.52 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span>        <span class="token number">51</span> <span class="token operator">|</span> 22ff2702-9b2d-11ef-aae2-000c299ce8c4 <span class="token operator">|</span>
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


<span class="token number">2</span>）实现主从与管理节点互信
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /root/.ssh 
ssh-keygen
<span class="token builtin class-name">cd</span> /root/.ssh 
<span class="token function">mv</span> id_rsa.pub authorized_keys
<span class="token function">scp</span>  <span class="token parameter variable">-r</span>  /root/.ssh  <span class="token number">10.0</span>.0.52:/root 
<span class="token function">scp</span>  <span class="token parameter variable">-r</span>  /root/.ssh  <span class="token number">10.0</span>.0.53:/root
-- 选择高可用架构主库和从库，执行以上操作

<span class="token function">ssh</span> <span class="token number">10.0</span>.0.51 <span class="token function">date</span>
<span class="token function">ssh</span> <span class="token number">10.0</span>.0.52 <span class="token function">date</span>
<span class="token function">ssh</span> <span class="token number">10.0</span>.0.53 <span class="token function">date</span>
-- 进行ssh互信测试

<span class="token number">3</span>）创建数据库命令的软链接，在3台机器上都操作
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/mysql/bin/mysql /usr/bin/mysql

步骤三：安装MHA软件程序
数据节点： <span class="token number">51</span> <span class="token number">52</span> <span class="token number">53</span>
<span class="token builtin class-name">cd</span> /usr/local
yum <span class="token function">install</span> perl-DBD-MySQL <span class="token parameter variable">-y</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> mha4mysql-node-0.58-0.el7.centos.noarch.rpm 

管理节点： <span class="token number">53</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> perl-Config-Tiny epel-release perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> mha4mysql-manager-0.58-0.el7.centos.noarch.rpm 

步骤四：启动运行MHA服务
创建主从同步用户（主库创建）,在主从搭建时，已经创建好了，需要保证3台机器上都有repl用户
create user repl@<span class="token string">'10.0.0.%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span>
grant replication slave on *.* to repl@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>

db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> repl             <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>

db02 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> repl             <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>

db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select user,host from mysql.user<span class="token punctuation">;</span>
+------------------+-----------+
<span class="token operator">|</span> user             <span class="token operator">|</span> <span class="token function">host</span>      <span class="token operator">|</span>
+------------------+-----------+
<span class="token operator">|</span> repl             <span class="token operator">|</span> <span class="token number">10.0</span>.0.%  <span class="token operator">|</span>

创建MHA管理用户，在主库上创建，会同步到从库上，manager会通过这个用户连接其它节点
create user mha@<span class="token string">'10.0.0.%'</span> identified with mysql_native_password by <span class="token string">'mha'</span><span class="token punctuation">;</span>
grant all privileges on *.* to mha@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
 

编写配置文件： 在53上操作
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/mha   -- 创建配置文件目录
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/log/mha/app1  -- 创建日志目录

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/mha/app1.cnf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[server default]
manager_log=/var/log/mha/app1/manager         
-- MHA的工作日志设置
manager_workdir=/var/log/mha/app1             
-- MHA的工作目录        
master_binlog_dir=/data/3306/data                
-- 主库的binlog目录
user=mha                                      
-- 监控用户，利用此用户连接各个节点，做心跳检测（主要是检测主库的状态）                      
password=mha                                  
-- 监控密码
ping_interval=2                              
-- 心跳检测的间隔时间
repl_password=123456                             
-- 复制密码
repl_user=repl                                
-- 复制用户（用于告知从节点通过新主同步数据信息的用户信息）
ssh_user=root                                
-- ssh互信的用户（可以利用互信用户从主库scp获取binlog日志信息，便于从库进行数据信息补偿）
[server1]                                     
-- 节点信息....
hostname=10.0.0.51
port=3306                              
[server2]            
hostname=10.0.0.52
port=3306
#candidate_master=1
[server3]
hostname=10.0.0.53
port=3306
EOF</span>

上面的配置文件有大量的注释，也不行，删除注释：
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/mha/app1.cnf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[server default]
manager_log=/var/log/mha/app1/manager      
manager_workdir=/var/log/mha/app1              
master_binlog_dir=/data/3306/data      
user=mha                                                    
password=mha                                
ping_interval=2                           
repl_password=123456                          
repl_user=repl                        
ssh_user=root                         
[server1]                             
hostname=10.0.0.51
port=3306                             
[server2]  
hostname=10.0.0.52
port=3306
[server3]
hostname=10.0.0.53
port=3306
EOF</span>

检测MHA高可用环境：
MHA架构互信检测：
masterha_check_ssh   <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf  
Tue Nov  <span class="token number">5</span> <span class="token number">11</span>:49:49 <span class="token number">2024</span> - <span class="token punctuation">[</span>info<span class="token punctuation">]</span> All SSH connection tests passed successfully. 说明互信是没有问题的。

检查主从同步状态，确认主从数据库上都需要有repl同步用户
masterha_check_repl  <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf 
MySQL Replication Health is OK<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>启动MHA，在53上启动：
<span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> /var/log/mha/app1/manager.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

<span class="token parameter variable">--remove_dead_master_conf</span>
作用：当主节点异常故障后，会自动将主节点从配置文件中删除

<span class="token parameter variable">--ignore_last_failover</span>
作用：当MHA出现高可用切换后，默认需要清理failover切换日志信息，才能从新恢复高可用功能；但加上此参数，可以不用清除切换日志，也可以直接恢复高可用功能

<span class="token operator">&lt;</span> /dev/null
-- 忽略MHA启动脚本运行时产生的交互信息  

<span class="token operator">&gt;</span> /var/log/mha/app1/manager.log
-- 启动MHA时，产生的日志信息放到manager.log中

高可用是一次性的，如果坏了，需要我们手动修复。

检测MHA的状态，也是在53上检测：
<span class="token punctuation">[</span>root@db03-53 local<span class="token punctuation">]</span><span class="token comment"># masterha_check_status --conf=/etc/mha/app1.cnf </span>
app1 <span class="token punctuation">(</span>pid:4640<span class="token punctuation">)</span> is running<span class="token punctuation">(</span><span class="token number">0</span>:PING_OK<span class="token punctuation">)</span>, master:10.0.0.51
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MHA服务监控功能（原理）
需要监控主库是否可以处理SQL语句，利用masterha_master_monitor脚本进行主库监控
实现监控主库操作
<span class="token comment"># 监控脚本验证主节点存活方法</span>
<span class="token punctuation">[</span>root@db03-53 local<span class="token punctuation">]</span><span class="token comment"># mysql -umha -pmha -h10.0.0.51 -e &quot;select user();&quot;</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
+---------------+
<span class="token operator">|</span> user<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">|</span>
+---------------+
<span class="token operator">|</span> mha@10.0.0.53 <span class="token operator">|</span>
+---------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">3</span>）MHA服务选主过程（原理）
首先创建4个数组信息：
alive  存活数组 主要用于探测存活的节点状态；当主库宕机后，探测的就是两个从库节点 
latest 最新数组 表示获取日志最新的从库信息，即数据量最接近主库的从库（根据GTID信息 或 position信息）
pref   备选数组 在数组中具有candidate_master参数判断条件，此参数可以放入配置文件节点中，便于节点优先选择为新主 
bad    不选数组 
       如果设定了参数：no_master<span class="token operator">=</span><span class="token number">1</span>，表示相应节点不参与竞选主；
       如果设定了参数：log_bin<span class="token operator">=</span><span class="token number">0</span>（二进制日志没开），表示相应节点不参与竞选主；
	   如何发现了延迟：check_slave_delay，检查从库延迟主库100M数据信息日志量，表示节点不参与竞选主 
	   
根据规则进行选主：
<span class="token assign-left variable">alive</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">52,53</span>,54,55,56,57<span class="token punctuation">}</span>
<span class="token assign-left variable">latest</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">52,53</span>,54,55<span class="token punctuation">}</span>
<span class="token assign-left variable">pref</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">52,53</span>,54<span class="token punctuation">}</span>
<span class="token assign-left variable">bad</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">52</span><span class="token punctuation">}</span>

优先级 <span class="token operator">|</span> alive数组 <span class="token operator">|</span> latest数组 <span class="token operator">|</span> pref数组 <span class="token operator">|</span> bad数组 <span class="token operator">|</span> 选主策略     <span class="token operator">|</span> 多个选择情况         
 ---- <span class="token operator">|</span> --------- <span class="token operator">|</span> ---------- <span class="token operator">|</span> -------- <span class="token operator">|</span> ------- <span class="token operator">|</span> ------------ <span class="token operator">|</span> --------------
01     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>    <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>   <span class="token operator">|</span> 不满足  <span class="token operator">|</span> 优选选择     <span class="token operator">|</span> 按照节点号码顺序选择 
02     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>    <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>     <span class="token operator">|</span> 不满足   <span class="token operator">|</span> 不满足  <span class="token operator">|</span> 优选选择     <span class="token operator">|</span> 按照节点号码顺序选择 
03     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>    <span class="token operator">|</span> 不满足     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>   <span class="token operator">|</span> 不满足  <span class="token operator">|</span> 优选选择     <span class="token operator">|</span> 按照节点号码顺序选择 
04     <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>满足<span class="token variable">`</span></span>    <span class="token operator">|</span> 不满足     <span class="token operator">|</span> 不满足   <span class="token operator">|</span> 不满足  <span class="token operator">|</span> 优选活着节点 <span class="token operator">|</span> 按照节点号码顺序选择 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MHA数据补偿
MHA数据补偿三种方式
<span class="token number">1</span>）当主数据库系统没有宕机（ssh连接主库系统）
   各个从节点自动调用：<span class="token variable"><span class="token variable">`</span>save_binary_logs<span class="token variable">`</span></span>脚本文件，立即保存缺失部分的bin_log，到各节点/var/tmp/目录；
<span class="token number">2</span>）当主数据库系统宕机停止（ssh连接主库失败）
   各个从节点自动调用：<span class="token variable"><span class="token variable">`</span>apply_diff_relay_logs<span class="token variable">`</span></span>脚本文件，进行relay_log日志差异信息补偿；
<span class="token number">3</span>）当主数据库系统宕机停止（ssh连接主库失败）
   MHA提供了binlog_server功能，可以实时拉取主库的binlog日志到备份节点，从而进行数据额外补偿；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MHA业务切换（重新构建主从关系），这个过程是自动的，不需要我们操作
stop slave<span class="token punctuation">;</span>
reset slave all<span class="token punctuation">;</span>
change master to 新主机建立关系
start slave<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>今天要用到的脚本：</p> <p><img src="/devops/public/assets/img/1730861261270.2ca0effe.png" alt="1730861261270"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MHA实现应用透明（漂移VIP地址）
master_ip_failover  -- 此脚本文件可以实现MHA应用透明功能

<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cd /usr/local/bin/  把上面的脚本都传上来</span>
<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># chmod +x /usr/local/bin/*   --确认脚本文件有执行权限</span>

<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># dos2unix /usr/local/bin/*</span>

<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">28</span>
-rwxr-xr-x <span class="token number">1</span> root root   <span class="token number">581</span> Oct <span class="token number">10</span>  <span class="token number">2022</span> app1.cnf
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">2230</span> Oct <span class="token number">10</span>  <span class="token number">2022</span> master_ip_failover
-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">10312</span> Oct <span class="token number">10</span>  <span class="token number">2022</span> master_ip_online_change
-rwxr-xr-x <span class="token number">1</span> root root   <span class="token number">789</span> Oct <span class="token number">10</span>  <span class="token number">2022</span> mha_check.sh
-rwxr-xr-x <span class="token number">1</span> root root  <span class="token number">2238</span> Oct <span class="token number">10</span>  <span class="token number">2022</span> send_report

编辑脚本：
<span class="token function">vim</span> master_ip_failover
my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">'10.0.0.50/24'</span><span class="token punctuation">;</span>
my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span> 
my <span class="token variable">$if</span> <span class="token operator">=</span> <span class="token string">'ens33'</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> <span class="token variable">$vip</span>&quot;</span><span class="token punctuation">;</span>  
my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> down&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_Bcast_arp</span><span class="token operator">=</span> <span class="token string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.50&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><img src="/devops/public/assets/img/1730861798538.2d76318e.png" alt="1730861798538"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">13</span> my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">'10.0.0.50/24'</span><span class="token punctuation">;</span>
<span class="token number">14</span> my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span>  -- 网卡的别名设置
<span class="token number">15</span> my <span class="token variable">$if</span> <span class="token operator">=</span> <span class="token string">'ens33'</span><span class="token punctuation">;</span> -- 在哪个网卡上生成vip地址
<span class="token number">16</span> my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> <span class="token variable">$vip</span>&quot;</span><span class="token punctuation">;</span>  -- 需要机器上有ifconfig命令  yum <span class="token function">install</span> net-tools 
<span class="token number">17</span> my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> down&quot;</span><span class="token punctuation">;</span>
<span class="token number">18</span> my <span class="token variable">$ssh_Bcast_arp</span><span class="token operator">=</span> <span class="token string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.50&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>在52上手动执行测试：
<span class="token function">ifconfig</span> ens33:1 <span class="token number">10.0</span>.0.50/24
<span class="token function">ifconfig</span> 
<span class="token function">ifconfig</span> ens33:1 down 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> /etc/mha/app1.cnf 
<span class="token punctuation">[</span>server default<span class="token punctuation">]</span>
<span class="token assign-left variable">master_ip_failover_script</span><span class="token operator">=</span>/usr/local/bin/master_ip_failover
--- MHA服务进程加载切换VIP脚本

先不重启MAH，后面配置完毕后，再重启。

由于当前主节点是51，先在51上面创建一个VIP：
<span class="token function">ifconfig</span> ens33:1 <span class="token number">10.0</span>.0.50/24
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建一个root用户，可以前端远程连接，在51上操作：
create user root@<span class="token string">'10.0.0.%'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
grant all on *.* to  root@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
使用sqlyog测试，sqlyog当成java代码。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/devops/public/assets/img/1730863388743.9ddb0a39.png" alt="1730863388743"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>实现MHA高可用切换报警功能
send_report  --- 实现邮件报警
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/devops/public/assets/img/1730863440331.ae837f52.png" alt="1730863440331"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>在53节点上操作：
<span class="token builtin class-name">cd</span> /usr/local/bin
<span class="token function">vim</span> send_report
my <span class="token variable">$smtp</span><span class="token operator">=</span><span class="token string">'smtp.qq.com'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_from</span><span class="token operator">=</span><span class="token string">'717628672@qq.com'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_user</span><span class="token operator">=</span><span class="token string">'717628672'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_pass</span><span class="token operator">=</span><span class="token string">'yttqcxvqzwfqbfdh'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_to</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'1694502381@qq.com'</span>,<span class="token string">'2053161436@qq.com'</span>,<span class="token string">'1603975798@qq.com'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/devops/public/assets/img/1730863662913.88c3f245.png" alt="1730863662913"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> /etc/mha/app1.cnf 
<span class="token punctuation">[</span>server default<span class="token punctuation">]</span>
<span class="token assign-left variable">report_script</span><span class="token operator">=</span>/usr/local/bin/send_report
--- MHA服务进程加载报警脚本
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>实现高可用额外补偿功能（先不做了）
我们让53机器充当binlog备份机器，如果使用了一个新的节点，也需要和51，52，53互信
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/binlog_server/
<span class="token builtin class-name">cd</span> /data/binlog_server/
mysqlbinlog <span class="token parameter variable">-R</span> <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--user</span><span class="token operator">=</span>mha <span class="token parameter variable">--password</span><span class="token operator">=</span>mha <span class="token parameter variable">--raw</span> --stop-never binlog.000003 <span class="token operator">&amp;</span>

查看主库的binlog:
show master status<span class="token punctuation">;</span>
flush logs<span class="token punctuation">;</span>
在53节点上查看一下是否同步

<span class="token function">vim</span> /etc/mha/app1.cnf  新增一个标签
<span class="token punctuation">[</span>binlog1<span class="token punctuation">]</span>  
<span class="token assign-left variable">no_master</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.53
<span class="token assign-left variable">master_binlog_dir</span><span class="token operator">=</span>/data/binlog_server/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>重启MHA服务，重新加载配置文件
masterha_stop <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf  停止高可用服务

重新启动高可用
<span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> /var/log/mha/app1/manager.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

检测：
masterha_check_status <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf  
或者
<span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> masterha  看一个mha进程是否一直存在。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-高可用测试"><a href="#_2-高可用测试" class="header-anchor">#</a> 2，高可用测试</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>停止主库51
/etc/init.d/mysql.server stop

<span class="token number">1</span>）是否实现VIP切换功能
看51上没有了vip,看52或53是否有vip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/devops/public/assets/img/1730866976044.a7496bc7.png" alt="1730866976044"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>前端连接是不需要改的，应用透明。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>db02 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show slave hosts<span class="token punctuation">;</span>
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token operator">|</span> Server_id <span class="token operator">|</span> Host      <span class="token operator">|</span> Port <span class="token operator">|</span> Master_id <span class="token operator">|</span> Slave_UUID                           <span class="token operator">|</span>
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token operator">|</span>        <span class="token number">53</span> <span class="token operator">|</span> <span class="token number">10.0</span>.0.53 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span>        <span class="token number">52</span> <span class="token operator">|</span> 9e241442-9bf3-11ef-8b53-000c291edca5 <span class="token operator">|</span>
+-----------+-----------+------+-----------+--------------------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> set, <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show slave status<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
               Slave_IO_State: Waiting <span class="token keyword">for</span> <span class="token builtin class-name">source</span> to send event
                  Master_Host: <span class="token number">10.0</span>.0.52
                  Master_User: repl
                  Master_Port: <span class="token number">3306</span>
                Connect_Retry: <span class="token number">60</span>
              Master_Log_File: binlog.000002
          Read_Master_Log_Pos: <span class="token number">2197</span>
               Relay_Log_File: db03-53-relay-bin.000002
                Relay_Log_Pos: <span class="token number">411</span>
        Relay_Master_Log_File: binlog.000002
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

<span class="token number">3</span>）是否实现高可用报警功能
Master <span class="token number">10.0</span>.0.51<span class="token punctuation">(</span><span class="token number">10.0</span>.0.51:3306<span class="token punctuation">)</span> is down<span class="token operator">!</span>

Check MHA Manager logs at db03.com:/var/log/mha/app1/manager <span class="token keyword">for</span> details.

Started automated<span class="token punctuation">(</span>non-interactive<span class="token punctuation">)</span> failover.
Invalidated master IP address on <span class="token number">10.0</span>.0.51<span class="token punctuation">(</span><span class="token number">10.0</span>.0.51:3306<span class="token punctuation">)</span>
Selected <span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span> as a new master.
<span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span>: OK: Applying all logs succeeded.
<span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span>: OK: Activated master IP address.
<span class="token number">10.0</span>.0.53<span class="token punctuation">(</span><span class="token number">10.0</span>.0.53:3306<span class="token punctuation">)</span>: OK: Slave started, replicating from <span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span>
<span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span>: Resetting slave info succeeded.
Master failover to <span class="token number">10.0</span>.0.52<span class="token punctuation">(</span><span class="token number">10.0</span>.0.52:3306<span class="token punctuation">)</span> completed successfully.

<span class="token number">4</span>）是否实现高可用的一次性切换
测试发现高可用也挂了
<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
app1 is stopped<span class="token punctuation">(</span><span class="token number">2</span>:NOT_RUNNING<span class="token punctuation">)</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_3-日常维护管理"><a href="#_3-日常维护管理" class="header-anchor">#</a> 3，日常维护管理</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>）需要修复MHA高可用功能
步骤一：需要恢复主数据库功能，就是修复51，看日志，分析原因，可以尝试启动，看一下能否启动。
/etc/init.d/mysql.server start
Starting MySQL<span class="token punctuation">..</span> SUCCESS<span class="token operator">!</span> 

步骤二：将原有主库信息恢复到MHA配置文件中
<span class="token function">vim</span> /etc/mha/app1.cnf 
<span class="token punctuation">[</span>server1<span class="token punctuation">]</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>

也可以通过命令添加：
masterha_conf_host <span class="token parameter variable">--command</span><span class="token operator">=</span>add <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--block</span><span class="token operator">=</span>server1 <span class="token parameter variable">--params</span><span class="token operator">=</span><span class="token string">&quot;port=3306&quot;</span>
masterha_conf_host <span class="token parameter variable">--command</span><span class="token operator">=</span>delete <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--block</span><span class="token operator">=</span>server1 

步骤三：重新设置binlog额外补充功能<span class="token punctuation">(</span>先不做了<span class="token punctuation">)</span>
也是在53节点上操作
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/binlog_server/
<span class="token builtin class-name">cd</span> /data/binlog_server/
mysqlbinlog <span class="token parameter variable">-R</span> <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.52 <span class="token parameter variable">--user</span><span class="token operator">=</span>mha <span class="token parameter variable">--password</span><span class="token operator">=</span>mha <span class="token parameter variable">--raw</span> --stop-never binlog.000004 <span class="token operator">&amp;</span>

查看：
<span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> mysqlbinlog
ll 

步骤四：建立原有主库和新主库的主从关系
在51上操作：
CHANGE MASTER TO
<span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'10.0.0.52'</span>,
<span class="token assign-left variable">MASTER_PORT</span><span class="token operator">=</span><span class="token number">3306</span>,
<span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'repl'</span>,
<span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
<span class="token assign-left variable">master_auto_position</span><span class="token operator">=</span><span class="token number">1</span>,
<span class="token assign-left variable">MASTER_CONNECT_RETRY</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
-- 原有主库或者新创建数据库上，执行主从配置
start slave<span class="token punctuation">;</span>

步骤四：重新启动恢复MHA服务功能
在53上操作：
masterha_check_ssh   <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf 
masterha_check_repl  <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf

重启mha：
<span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> /var/log/mha/app1/manager.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
查看：
masterha_check_status <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="_4-维护性切换主从"><a href="#_4-维护性切换主从" class="header-anchor">#</a> 4，维护性切换主从</h3> <p>如果还想让51重新充当主库，操作如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>步骤一：关闭MHA高可用服务，在53上操作
masterha_stop <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf

步骤二：编写脚本文件实现切换VIP
<span class="token builtin class-name">cd</span> /usr/local/bin/
<span class="token function">vim</span> master_ip_online_change
my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">&quot;10.0.0.50/24&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig ens33:<span class="token variable">$key</span> <span class="token variable">$vip</span>&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig ens33:<span class="token variable">$key</span> <span class="token variable">$vip</span> down&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_Bcast_arp</span><span class="token operator">=</span> <span class="token string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.50&quot;</span><span class="token punctuation">;</span>

<span class="token function">vim</span> /etc/mha/app1.cnf 
<span class="token punctuation">[</span>server default<span class="token punctuation">]</span>
<span class="token assign-left variable">master_ip_online_change_script</span><span class="token operator">=</span>/usr/local/bin/master_ip_online_change

步骤三：执行命令完成手工切换高可用主角色
masterha_master_switch <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--master_state</span><span class="token operator">=</span>alive <span class="token parameter variable">--new_master_host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51 <span class="token parameter variable">--orig_master_is_new_slave</span> <span class="token parameter variable">--running_updates_limit</span><span class="token operator">=</span><span class="token number">10000</span>

<span class="token parameter variable">--master_state</span><span class="token operator">=</span>alive           --- 在主节点处于存活状态进行切换
<span class="token parameter variable">--new_master_host</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51    --- 指定手工切换后的新主节点地址
<span class="token parameter variable">--orig_master_is_new_slave</span>     --- 让当前主节点变为从节点，和新主建立主从同步
<span class="token parameter variable">--running_updates_limit</span>        --- 指定切换的时间，在指定时间内如果切换失败，会终止切换过程

在执行上面的命令时，会有一个提示，FLUSH NO_WRITE_TO_BINLOG TABLES，在52上执行一下。

Switching master to <span class="token number">10.0</span>.0.51<span class="token punctuation">(</span><span class="token number">10.0</span>.0.51:3306<span class="token punctuation">)</span> completed successfully.

步骤四：恢复高可用功能
masterha_check_ssh   <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf 
masterha_check_repl  <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf

<span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> /var/log/mha/app1/manager.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

masterha_check_status <span class="token parameter variable">--conf</span><span class="token operator">=</span>/etc/mha/app1.cnf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="_5-用到的脚本"><a href="#_5-用到的脚本" class="header-anchor">#</a> 5，用到的脚本</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat master_ip_failover </span>
<span class="token comment">#!/usr/bin/env perl</span>

use strict<span class="token punctuation">;</span>
use warnings FATAL <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'all'</span><span class="token punctuation">;</span>

use Getopt::Long<span class="token punctuation">;</span>

my <span class="token punctuation">(</span>
    <span class="token variable">$command</span>,          <span class="token variable">$ssh_user</span>,        <span class="token variable">$orig_master_host</span>, <span class="token variable">$orig_master_ip</span>,
    <span class="token variable">$orig_master_port</span>, <span class="token variable">$new_master_host</span>, <span class="token variable">$new_master_ip</span>,    <span class="token variable">$new_master_port</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">'10.0.0.50/24'</span><span class="token punctuation">;</span>
my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span> 
my <span class="token variable">$if</span> <span class="token operator">=</span> <span class="token string">'ens33'</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> <span class="token variable">$vip</span>&quot;</span><span class="token punctuation">;</span>  
my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig <span class="token variable">$if</span>:<span class="token variable">$key</span> down&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_Bcast_arp</span><span class="token operator">=</span> <span class="token string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.50&quot;</span><span class="token punctuation">;</span>
GetOptions<span class="token punctuation">(</span>
    <span class="token string">'command=s'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$command</span>,
    <span class="token string">'ssh_user=s'</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$ssh_user</span>,
    <span class="token string">'orig_master_host=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_host</span>,
    <span class="token string">'orig_master_ip=s'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_ip</span>,
    <span class="token string">'orig_master_port=i'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_port</span>,
    <span class="token string">'new_master_host=s'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_host</span>,
    <span class="token string">'new_master_ip=s'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_ip</span>,
    <span class="token string">'new_master_port=i'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_port</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token builtin class-name">exit</span> <span class="token operator">&amp;</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sub main <span class="token punctuation">{</span>

    print <span class="token string">&quot;<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>IN SCRIPT TEST====<span class="token variable">$ssh_stop_vip</span>==<span class="token variable">$ssh_start_vip</span>===<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;stop&quot;</span> <span class="token operator">||</span> <span class="token variable">$command</span> eq <span class="token string">&quot;stopssh&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        my <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">eval</span> <span class="token punctuation">{</span>
            print <span class="token string">&quot;Disabling the VIP on old master: <span class="token variable">$orig_master_host</span> <span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>stop_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            warn <span class="token string">&quot;Got Error: <span class="token variable">$@</span><span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
            <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;start&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

        my <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">eval</span> <span class="token punctuation">{</span>
            print <span class="token string">&quot;Enabling the VIP - <span class="token variable">$vip</span> on the new master - <span class="token variable">$new_master_host</span> <span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>start_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            warn <span class="token variable">$@</span><span class="token punctuation">;</span>
            <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;status&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print <span class="token string">&quot;Checking the Status of the script.. OK <span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span>usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

sub <span class="token function-name function">start_vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $ssh_user<span class="token punctuation">\</span>@$new_master_host <span class="token punctuation">\</span>&quot; $ssh_start_vip <span class="token punctuation">\</span>&quot;<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sub <span class="token function-name function">stop_vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token builtin class-name">return</span> <span class="token number">0</span>  unless  <span class="token punctuation">(</span><span class="token variable">$ssh_user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $ssh_user<span class="token punctuation">\</span>@$orig_master_host <span class="token punctuation">\</span>&quot; $ssh_stop_vip <span class="token punctuation">\</span>&quot;<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

sub usage <span class="token punctuation">{</span>
    print
    <span class="token string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat master_ip_online_change </span>
<span class="token comment">#!/usr/bin/env perl</span>

use strict<span class="token punctuation">;</span>
use warnings FATAL <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'all'</span><span class="token punctuation">;</span>
use Getopt::Long<span class="token punctuation">;</span>
use MHA::DBHelper<span class="token punctuation">;</span>
use MHA::NodeUtil<span class="token punctuation">;</span>
use Time::HiRes qw<span class="token punctuation">(</span> <span class="token function">sleep</span> gettimeofday tv_interval <span class="token punctuation">)</span><span class="token punctuation">;</span>
use Data::Dumper<span class="token punctuation">;</span>
my <span class="token variable">$_tstart</span><span class="token punctuation">;</span>
my <span class="token variable">$_running_interval</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
my <span class="token punctuation">(</span>
  <span class="token variable">$command</span>,              <span class="token variable">$orig_master_is_new_slave</span>, <span class="token variable">$orig_master_host</span>,
  <span class="token variable">$orig_master_ip</span>,       <span class="token variable">$orig_master_port</span>,         <span class="token variable">$orig_master_user</span>,
  <span class="token variable">$orig_master_password</span>, <span class="token variable">$orig_master_ssh_user</span>,     <span class="token variable">$new_master_host</span>,
  <span class="token variable">$new_master_ip</span>,        <span class="token variable">$new_master_port</span>,          <span class="token variable">$new_master_user</span>,
  <span class="token variable">$new_master_password</span>,  <span class="token variable">$new_master_ssh_user</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">###########################################################################</span>
my <span class="token variable">$vip</span> <span class="token operator">=</span> <span class="token string">&quot;10.0.0.50/24&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_start_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig ens33:<span class="token variable">$key</span> <span class="token variable">$vip</span>&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_stop_vip</span> <span class="token operator">=</span> <span class="token string">&quot;/sbin/ifconfig ens33:<span class="token variable">$key</span> <span class="token variable">$vip</span> down&quot;</span><span class="token punctuation">;</span>
my <span class="token variable">$ssh_Bcast_arp</span><span class="token operator">=</span> <span class="token string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.50&quot;</span><span class="token punctuation">;</span>
<span class="token comment">###########################################################################</span>
 
GetOptions<span class="token punctuation">(</span>
  <span class="token string">'command=s'</span>                <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$command</span>,
  <span class="token string">'orig_master_is_new_slave'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_is_new_slave</span>,
  <span class="token string">'orig_master_host=s'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_host</span>,
  <span class="token string">'orig_master_ip=s'</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_ip</span>,
  <span class="token string">'orig_master_port=i'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_port</span>,
  <span class="token string">'orig_master_user=s'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_user</span>,
  <span class="token string">'orig_master_password=s'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_password</span>,
  <span class="token string">'orig_master_ssh_user=s'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$orig_master_ssh_user</span>,
  <span class="token string">'new_master_host=s'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_host</span>,
  <span class="token string">'new_master_ip=s'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_ip</span>,
  <span class="token string">'new_master_port=i'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_port</span>,
  <span class="token string">'new_master_user=s'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_user</span>,
  <span class="token string">'new_master_password=s'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_password</span>,
  <span class="token string">'new_master_ssh_user=s'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_ssh_user</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin class-name">exit</span> <span class="token operator">&amp;</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sub current_time_us <span class="token punctuation">{</span>
  my <span class="token punctuation">(</span> <span class="token variable">$sec</span>, <span class="token variable">$microsec</span> <span class="token punctuation">)</span> <span class="token operator">=</span> gettimeofday<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  my <span class="token variable">$curdate</span> <span class="token operator">=</span> localtime<span class="token punctuation">(</span><span class="token variable">$sec</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin class-name">return</span> <span class="token variable">$curdate</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; &quot;</span> <span class="token builtin class-name">.</span> sprintf<span class="token punctuation">(</span> <span class="token string">&quot;%06d&quot;</span>, <span class="token variable">$microsec</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sub sleep_until <span class="token punctuation">{</span>
  my <span class="token variable">$elapsed</span> <span class="token operator">=</span> tv_interval<span class="token punctuation">(</span><span class="token variable">$_tstart</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$_running_interval</span> <span class="token operator">&gt;</span> <span class="token variable">$elapsed</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sleep<span class="token punctuation">(</span> <span class="token variable">$_running_interval</span> - <span class="token variable">$elapsed</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
sub get_threads_util <span class="token punctuation">{</span>
  my <span class="token variable">$dbh</span>                    <span class="token operator">=</span> <span class="token builtin class-name">shift</span><span class="token punctuation">;</span>
  my <span class="token variable">$my_connection_id</span>       <span class="token operator">=</span> <span class="token builtin class-name">shift</span><span class="token punctuation">;</span>
  my <span class="token variable">$running_time_threshold</span> <span class="token operator">=</span> <span class="token builtin class-name">shift</span><span class="token punctuation">;</span>
  my <span class="token variable">$type</span>                   <span class="token operator">=</span> <span class="token builtin class-name">shift</span><span class="token punctuation">;</span>
  <span class="token variable">$running_time_threshold</span> <span class="token operator">=</span> <span class="token number">0</span> unless <span class="token punctuation">(</span><span class="token variable">$running_time_threshold</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$type</span>                   <span class="token operator">=</span> <span class="token number">0</span> unless <span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  my @threads<span class="token punctuation">;</span>
  my <span class="token variable">$sth</span> <span class="token operator">=</span> <span class="token variable">$dbh</span>-<span class="token operator">&gt;</span>prepare<span class="token punctuation">(</span><span class="token string">&quot;SHOW PROCESSLIST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$sth</span>-<span class="token operator">&gt;</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> my <span class="token variable">$ref</span> <span class="token operator">=</span> <span class="token variable">$sth</span>-<span class="token operator">&gt;</span>fetchrow_hashref<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    my <span class="token variable">$id</span>         <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>Id<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$user</span>       <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>User<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$host</span>       <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>Host<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$command</span>    <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>Command<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$state</span>      <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>State<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$query_time</span> <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>Time<span class="token punctuation">}</span><span class="token punctuation">;</span>
    my <span class="token variable">$info</span>       <span class="token operator">=</span> <span class="token variable">$ref</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>Info<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token variable">$info</span> <span class="token operator">=~</span> s/^<span class="token punctuation">\</span>s*<span class="token punctuation">(</span>.*?<span class="token punctuation">)</span><span class="token punctuation">\</span>s*$/<span class="token variable">$1</span>/ <span class="token keyword">if</span> defined<span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    next <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$my_connection_id</span> <span class="token operator">==</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$query_time</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$query_time</span> <span class="token operator">&lt;</span> <span class="token variable">$running_time_threshold</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span>    <span class="token operator">&amp;&amp;</span> <span class="token variable">$command</span> eq <span class="token string">&quot;Binlog Dump&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span>       <span class="token operator">&amp;&amp;</span> <span class="token variable">$user</span> eq <span class="token string">&quot;system user&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    next
      <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token variable">$command</span> eq <span class="token string">&quot;Sleep&quot;</span>
      <span class="token operator">&amp;&amp;</span> defined<span class="token punctuation">(</span><span class="token variable">$query_time</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token variable">$query_time</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$type</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$command</span> eq <span class="token string">&quot;Sleep&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$command</span> eq <span class="token string">&quot;Connect&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$type</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$info</span> <span class="token operator">=~</span> m/^select/i <span class="token punctuation">)</span><span class="token punctuation">;</span>
      next <span class="token keyword">if</span> <span class="token punctuation">(</span> defined<span class="token punctuation">(</span><span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$info</span> <span class="token operator">=~</span> m/^show/i <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    push @threads, <span class="token variable">$ref</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token builtin class-name">return</span> @threads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sub main <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;stop&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">## Gracefully killing connections on the current master</span>
    <span class="token comment"># 1. Set read_only= 1 on the new master</span>
    <span class="token comment"># 2. DROP USER so that no app user can establish new connections</span>
    <span class="token comment"># 3. Set read_only= 1 on the current master</span>
    <span class="token comment"># 4. Kill current queries</span>
    <span class="token comment"># * Any database access failure will result in script die.</span>
    my <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">eval</span> <span class="token punctuation">{</span>
      <span class="token comment">## Setting read_only=1 on the new master (to avoid accident)</span>
      my <span class="token variable">$new_master_handler</span> <span class="token operator">=</span> new MHA::DBHelper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment"># args: hostname, port, user, password, raise_error(die_on_error)_or_not</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>connect<span class="token punctuation">(</span> <span class="token variable">$new_master_ip</span>, <span class="token variable">$new_master_port</span>,
        <span class="token variable">$new_master_user</span>, <span class="token variable">$new_master_password</span>, <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Set read_only on the new master.. &quot;</span><span class="token punctuation">;</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>enable_read_only<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>is_read_only<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print <span class="token string">&quot;ok.<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        die <span class="token string">&quot;Failed!<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment"># Connecting to the orig master, die if any database error happens</span>
      my <span class="token variable">$orig_master_handler</span> <span class="token operator">=</span> new MHA::DBHelper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>connect<span class="token punctuation">(</span> <span class="token variable">$orig_master_ip</span>, <span class="token variable">$orig_master_port</span>,
        <span class="token variable">$orig_master_user</span>, <span class="token variable">$orig_master_password</span>, <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">## Drop application user so that nobody can connect. Disabling per-session binlog beforehand</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>disable_log_bin_local<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Drpping app user on the orig master..<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
<span class="token comment">###########################################################################</span>
      <span class="token comment">#FIXME_xxx_drop_app_user($orig_master_handler);</span>
<span class="token comment">###########################################################################</span>
      <span class="token comment">## Waiting for N * 100 milliseconds so that current connections can exit</span>
      my <span class="token variable">$time_until_read_only</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
      <span class="token variable">$_tstart</span> <span class="token operator">=</span> <span class="token punctuation">[</span>gettimeofday<span class="token punctuation">]</span><span class="token punctuation">;</span>
      my @threads <span class="token operator">=</span> get_threads_util<span class="token punctuation">(</span> <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>dbh<span class="token punctuation">}</span>,
        <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>connection_id<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">$time_until_read_only</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$#</span>threads <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$time_until_read_only</span> % <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin class-name">printf</span>
<span class="token string">&quot;%s Waiting all running %d threads are disconnected.. (max %d milliseconds)<span class="token entity" title="\n">\n</span>&quot;</span>,
            current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token variable">$#</span>threads + <span class="token number">1</span>, <span class="token variable">$time_until_read_only</span> * <span class="token number">100</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$#</span>threads <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            print Data::Dumper-<span class="token operator">&gt;</span>new<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token variable">$_</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Indent<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Terse<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Dump <span class="token builtin class-name">.</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>&quot;</span>
              foreach <span class="token punctuation">(</span>@threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        sleep_until<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_tstart</span> <span class="token operator">=</span> <span class="token punctuation">[</span>gettimeofday<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$time_until_read_only</span>--<span class="token punctuation">;</span>
        @threads <span class="token operator">=</span> get_threads_util<span class="token punctuation">(</span> <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>dbh<span class="token punctuation">}</span>,
          <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>connection_id<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">## Setting read_only=1 on the current master so that nobody(except SUPER) can write</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Set read_only=1 on the orig master.. &quot;</span><span class="token punctuation">;</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>enable_read_only<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>is_read_only<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print <span class="token string">&quot;ok.<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        die <span class="token string">&quot;Failed!<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">## Waiting for M * 100 milliseconds so that current update queries can complete</span>
      my <span class="token variable">$time_until_kill_threads</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      @threads <span class="token operator">=</span> get_threads_util<span class="token punctuation">(</span> <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>dbh<span class="token punctuation">}</span>,
        <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>connection_id<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">$time_until_kill_threads</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$#</span>threads <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$time_until_kill_threads</span> % <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin class-name">printf</span>
<span class="token string">&quot;%s Waiting all running %d queries are disconnected.. (max %d milliseconds)<span class="token entity" title="\n">\n</span>&quot;</span>,
            current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token variable">$#</span>threads + <span class="token number">1</span>, <span class="token variable">$time_until_kill_threads</span> * <span class="token number">100</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$#</span>threads <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            print Data::Dumper-<span class="token operator">&gt;</span>new<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token variable">$_</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Indent<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Terse<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span>Dump <span class="token builtin class-name">.</span> <span class="token string">&quot;<span class="token entity" title="\n">\n</span>&quot;</span>
              foreach <span class="token punctuation">(</span>@threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        sleep_until<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$_tstart</span> <span class="token operator">=</span> <span class="token punctuation">[</span>gettimeofday<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$time_until_kill_threads</span>--<span class="token punctuation">;</span>
        @threads <span class="token operator">=</span> get_threads_util<span class="token punctuation">(</span> <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>dbh<span class="token punctuation">}</span>,
          <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>connection_id<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token comment">###########################################################################</span>
      print <span class="token string">&quot;disable the VIP on old master: <span class="token variable">$orig_master_host</span> <span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>stop_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">###########################################################################</span>
      <span class="token comment">## Terminating all threads</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Killing all application threads..<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>kill_threads<span class="token punctuation">(</span>@threads<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$#</span>threads <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; done.<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>enable_log_bin_local<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$orig_master_handler</span>-<span class="token operator">&gt;</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">## After finishing the script, MHA executes FLUSH TABLES WITH READ LOCK</span>
      <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      warn <span class="token string">&quot;Got Error: <span class="token variable">$@</span><span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;start&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">## Activating master ip on the new master</span>
    <span class="token comment"># 1. Create app user with write privileges</span>
    <span class="token comment"># 2. Moving backup script if needed</span>
    <span class="token comment"># 3. Register new master's ip to the catalog database</span>
    my <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">eval</span> <span class="token punctuation">{</span>
      my <span class="token variable">$new_master_handler</span> <span class="token operator">=</span> new MHA::DBHelper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment"># args: hostname, port, user, password, raise_error_or_not</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>connect<span class="token punctuation">(</span> <span class="token variable">$new_master_ip</span>, <span class="token variable">$new_master_port</span>,
        <span class="token variable">$new_master_user</span>, <span class="token variable">$new_master_password</span>, <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">## Set read_only=0 on the new master</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>disable_log_bin_local<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Set read_only=0 on the new master.<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>disable_read_only<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">## Creating an app user on the new master</span>
      print current_time_us<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin class-name">.</span> <span class="token string">&quot; Creating app user on the new master..<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
<span class="token comment">###########################################################################</span>
      <span class="token comment">#FIXME_xxx_create_app_user($new_master_handler);</span>
<span class="token comment">###########################################################################</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>enable_log_bin_local<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$new_master_handler</span>-<span class="token operator">&gt;</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">## Update master ip on the catalog database, etc</span>
<span class="token comment">###############################################################################</span>
      print <span class="token string">&quot;enable the VIP: <span class="token variable">$vip</span> on the new master: <span class="token variable">$new_master_host</span> <span class="token entity" title="\n">\n</span> &quot;</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>start_vip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">###############################################################################</span>
      <span class="token variable">$exit_code</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$@</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      warn <span class="token string">&quot;Got Error: <span class="token variable">$@</span><span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
      <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin class-name">exit</span> <span class="token variable">$exit_code</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  elsif <span class="token punctuation">(</span> <span class="token variable">$command</span> eq <span class="token string">&quot;status&quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment"># do nothing</span>
    <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">&amp;</span>usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">###########################################################################</span>
sub <span class="token function-name function">start_vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $new_master_ssh_user<span class="token punctuation">\</span>@$new_master_host <span class="token punctuation">\</span>&quot; $ssh_start_vip <span class="token punctuation">\</span>&quot;<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sub <span class="token function-name function">stop_vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable"><span class="token variable">`</span><span class="token function">ssh</span> $orig_master_ssh_user<span class="token punctuation">\</span>@$orig_master_host <span class="token punctuation">\</span>&quot; $ssh_stop_vip <span class="token punctuation">\</span>&quot;<span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">###########################################################################</span>
sub usage <span class="token punctuation">{</span>
  print
<span class="token string">&quot;Usage: master_ip_online_change --command=start|stop|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port<span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
  die<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat mha_check.sh </span>
<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">choice</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">stop</span><span class="token operator">=</span><span class="token string">&quot;masterha_stop  --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">&quot;masterha_check_status --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">repl</span><span class="token operator">=</span><span class="token string">&quot;masterha_check_repl --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">conf_file</span><span class="token operator">=</span><span class="token string">&quot;/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">log_file</span><span class="token operator">=</span><span class="token string">&quot;/var/log/mha/app1/manager.log&quot;</span>


<span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">$choice</span>&quot;</span> <span class="token keyword">in</span> 
  stop<span class="token punctuation">)</span>
    <span class="token variable">$stop</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  start<span class="token punctuation">)</span>
    <span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span><span class="token variable">$conf_file</span> <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> <span class="token variable">$log_file</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;it is start !&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  restart<span class="token punctuation">)</span>
    <span class="token variable">$stop</span> 
    <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span><span class="token variable">$conf_file</span> <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> <span class="token variable">$log_file</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;it is start !&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  status<span class="token punctuation">)</span>
    <span class="token variable">$status</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  repl<span class="token punctuation">)</span>
    <span class="token variable">$repl</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Usages: <span class="token variable">$0</span>  {start|stop|restart|status|repl}&quot;</span>
      <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">esac</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat mha_check.sh </span>
<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">choice</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">stop</span><span class="token operator">=</span><span class="token string">&quot;masterha_stop  --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token string">&quot;masterha_check_status --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">repl</span><span class="token operator">=</span><span class="token string">&quot;masterha_check_repl --conf=/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">conf_file</span><span class="token operator">=</span><span class="token string">&quot;/etc/mha/app1.cnf&quot;</span>
<span class="token assign-left variable">log_file</span><span class="token operator">=</span><span class="token string">&quot;/var/log/mha/app1/manager.log&quot;</span>


<span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">$choice</span>&quot;</span> <span class="token keyword">in</span> 
  stop<span class="token punctuation">)</span>
    <span class="token variable">$stop</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  start<span class="token punctuation">)</span>
    <span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span><span class="token variable">$conf_file</span> <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> <span class="token variable">$log_file</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;it is start !&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  restart<span class="token punctuation">)</span>
    <span class="token variable">$stop</span> 
    <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token function">nohup</span> masterha_manager <span class="token parameter variable">--conf</span><span class="token operator">=</span><span class="token variable">$conf_file</span> <span class="token parameter variable">--remove_dead_master_conf</span> <span class="token parameter variable">--ignore_last_failover</span>  <span class="token operator">&lt;</span> /dev/null<span class="token operator">&gt;</span> <span class="token variable">$log_file</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;it is start !&quot;</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  status<span class="token punctuation">)</span>
    <span class="token variable">$status</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  repl<span class="token punctuation">)</span>
    <span class="token variable">$repl</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Usages: <span class="token variable">$0</span>  {start|stop|restart|status|repl}&quot;</span>
      <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">esac</span>
<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat send_report </span>
<span class="token comment">#!/usr/bin/perl</span>
<span class="token comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span>
<span class="token comment">#</span>
<span class="token comment">#  This program is free software; you can redistribute it and/or modify</span>
<span class="token comment">#  it under the terms of the GNU General Public License as published by</span>
<span class="token comment">#  the Free Software Foundation; either version 2 of the License, or</span>
<span class="token comment">#  (at your option) any later version.</span>
<span class="token comment">#</span>
<span class="token comment">#  This program is distributed in the hope that it will be useful,</span>
<span class="token comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="token comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="token comment">#  GNU General Public License for more details.</span>
<span class="token comment">#</span>
<span class="token comment">#  You should have received a copy of the GNU General Public License</span>
<span class="token comment">#   along with this program; if not, write to the Free Software</span>
<span class="token comment">#  Foundation, Inc.,</span>
<span class="token comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>
 
<span class="token comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span>
 
use strict<span class="token punctuation">;</span>
use warnings FATAL <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'all'</span><span class="token punctuation">;</span>
use Mail::Sender<span class="token punctuation">;</span>
use Getopt::Long<span class="token punctuation">;</span>
 
<span class="token comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span>
my <span class="token punctuation">(</span> <span class="token variable">$dead_master_host</span>, <span class="token variable">$new_master_host</span>, <span class="token variable">$new_slave_hosts</span>, <span class="token variable">$subject</span>, <span class="token variable">$body</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
my <span class="token variable">$smtp</span><span class="token operator">=</span><span class="token string">'smtp.qq.com'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_from</span><span class="token operator">=</span><span class="token string">'717628672@qq.com'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_user</span><span class="token operator">=</span><span class="token string">'717628672'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_pass</span><span class="token operator">=</span><span class="token string">'yttqcxvqzwfqbfdh'</span><span class="token punctuation">;</span>
my <span class="token variable">$mail_to</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'1694502381@qq.com'</span>,<span class="token string">'2053161436@qq.com'</span>,<span class="token string">'1603975798@qq.com'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
GetOptions<span class="token punctuation">(</span>
  <span class="token string">'orig_master_host=s'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$dead_master_host</span>,
  <span class="token string">'new_master_host=s'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_master_host</span>,
  <span class="token string">'new_slave_hosts=s'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$new_slave_hosts</span>,
  <span class="token string">'subject=s'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$subject</span>,
  <span class="token string">'body=s'</span>             <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">\</span><span class="token variable">$body</span>,
<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment"># Do whatever you want here</span>
mailToContacts<span class="token punctuation">(</span><span class="token variable">$smtp</span>,<span class="token variable">$mail_from</span>,<span class="token variable">$mail_user</span>,<span class="token variable">$mail_pass</span>,<span class="token variable">$mail_to</span>,<span class="token variable">$subject</span>,<span class="token variable">$body</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
sub mailToContacts <span class="token punctuation">{</span>
	my <span class="token punctuation">(</span><span class="token variable">$smtp</span>, <span class="token variable">$mail_from</span>, <span class="token variable">$mail_user</span>, <span class="token variable">$mail_pass</span>, <span class="token variable">$mail_to</span>, <span class="token variable">$subject</span>, <span class="token variable">$msg</span> <span class="token punctuation">)</span> <span class="token operator">=</span> @_<span class="token punctuation">;</span>
	<span class="token function">open</span> my <span class="token variable">$DEBUG</span>, <span class="token string">&quot;&gt;/tmp/mail.log&quot;</span>
		or die <span class="token string">&quot;Can't open the debug	file:<span class="token variable">$!</span><span class="token entity" title="\n">\n</span>&quot;</span><span class="token punctuation">;</span>
	my <span class="token variable">$sender</span> <span class="token operator">=</span> new Mail::Sender <span class="token punctuation">{</span>
		ctype		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'text/plain;charset=utf-8'</span>,
		encoding	<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'utf-8'</span>,
		smtp		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$smtp</span>,
		from		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$mail_from</span>,
		auth		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'LOGIN'</span>,
		TLS_allowed	<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'0'</span>,
		authid		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$mail_user</span>,
		authpwd		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$mail_pass</span>,
		to		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$mail_to</span>,
		subject		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$subject</span>,
		debug		<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$DEBUG</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token variable">$sender</span>-<span class="token operator">&gt;</span>MailMsg<span class="token punctuation">(</span>
		<span class="token punctuation">{</span>
			msg <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$msg</span>,
			debug <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$DEBUG</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span> or print <span class="token variable">$Mail</span>::Sender::Error<span class="token punctuation">;</span>
	<span class="token builtin class-name">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@db03-53 bin<span class="token punctuation">]</span><span class="token comment"># cat app1.cnf </span>
<span class="token punctuation">[</span>server default<span class="token punctuation">]</span>
<span class="token assign-left variable">manager_log</span><span class="token operator">=</span>/var/log/mha/app1/manager
<span class="token assign-left variable">manager_workdir</span><span class="token operator">=</span>/var/log/mha/app1
<span class="token assign-left variable">master_binlog_dir</span><span class="token operator">=</span>/data/3306/binlog
<span class="token assign-left variable">master_ip_failover_script</span><span class="token operator">=</span>/usr/local/bin/master_ip_failover
<span class="token assign-left variable">master_ip_online_change_script</span><span class="token operator">=</span>/usr/local/bin/master_ip_online_change
<span class="token assign-left variable">password</span><span class="token operator">=</span>mha
<span class="token assign-left variable">ping_interval</span><span class="token operator">=</span><span class="token number">2</span>
<span class="token assign-left variable">repl_password</span><span class="token operator">=</span><span class="token number">123</span>
<span class="token assign-left variable">repl_user</span><span class="token operator">=</span>repl
<span class="token assign-left variable">report_script</span><span class="token operator">=</span>/usr/local/bin/send_report
<span class="token assign-left variable">ssh_user</span><span class="token operator">=</span>root
<span class="token assign-left variable">user</span><span class="token operator">=</span>mha

<span class="token punctuation">[</span>server1<span class="token punctuation">]</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.51
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token punctuation">[</span>server2<span class="token punctuation">]</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.52
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>

<span class="token punctuation">[</span>server3<span class="token punctuation">]</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.53
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>

<span class="token punctuation">[</span>binlog1<span class="token punctuation">]</span>
<span class="token assign-left variable">no_master</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">hostname</span><span class="token operator">=</span><span class="token number">10.0</span>.0.53
<span class="token assign-left variable">master_binlog_dir</span><span class="token operator">=</span>/data/binlog_server/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="十二-读写分离"><a href="#十二-读写分离" class="header-anchor">#</a> 十二，读写分离</h2> <h3 id="_1-读写分离介绍"><a href="#_1-读写分离介绍" class="header-anchor">#</a> 1，读写分离介绍</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>什么是读写分离中间件？
就是实现当<span class="token punctuation">[</span>写<span class="token punctuation">]</span>的时候转发到主库，当<span class="token punctuation">[</span>读<span class="token punctuation">]</span>的时候转发到从库的工具。
很类似学习过的proxy,比如nginx proxy做动静分离.

<span class="token number">2</span>.为什么要实现读写分离？
<span class="token number">1</span>）让主库专注于写，因为读可以有很多从库可以干。
<span class="token number">2</span>）让多个从库接收并发读请求。
好处，增加读和写的并发,防止读写锁竞争，减轻主数据库的压力。

生产场景:读写比基本都比较大,超过10/1.

实现读写分离：
- 读请求做负载均衡（常见）
- 写请求做负载均衡（应用较少--容易处于数据写入冲突）
PS：解决写请求负载均衡（基于数据库垂直拆分-业务分库  基于数据表垂直拆分-业务分表（中间件） 基于数据表水平拆分-分片处理）

中间件插件<span class="token punctuation">(</span>对应用层透明<span class="token punctuation">)</span>
- amoeba
- mysql-proxy
- proxySQL 推荐使用 
- Atlas
- maxscale
- cobar
- mycat
- mysql-route
- <span class="token number">360</span>-atlas
- <span class="token punctuation">..</span>.

要搭建读写分离，至少你要有主从架构，也可以基于高可用搭建。

读写分离工作原理：（需要利用数据库相关中间件服务-ProxySQL mysql-route <span class="token number">360</span>-atlas）
01 中间件服务接收SQL语句请求
02 中间件服务判断SQL语句类型（读的SQL类型 写的SQL）
03 中间件服务转发前端请求到后端数据库节点，对后端也会做健康检查
04 后端数据库服务根据SQL语句信息，获取数据/存储数据信息，并将结果响应给中间件
05 中间件服务会将后端响应信息，再转发给前端服务

ProxySQL是一个高性能的MySQL代理软件，可以实现数据库读写分离，支持 Query路由功能，支持动态指定某个SQL进行缓存，支持动态加载配置信息（无需重启ProxySQL ），支持故障切换和SQL过滤功能。
ProxySQL网站：
https://www.proxysql.com/
https://github.com/sysown/proxysql/wiki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_2-搭建读写分离"><a href="#_2-搭建读写分离" class="header-anchor">#</a> 2，搭建读写分离</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>读写分离架构搭建：
步骤一：读写分离架构规划
<span class="token number">10.0</span>.0.51  主库   <span class="token number">10.0</span>.0.50
<span class="token number">10.0</span>.0.52  从库
<span class="token number">10.0</span>.0.53  从库   中间服务-ProxySQL

步骤二：下载安装proxySQL，并启动服务程序
https://www.proxysql.com/documentation/installing-proxysql/  （2.7）
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">16040</span>
-rw-------. <span class="token number">1</span> root root     <span class="token number">1513</span> May <span class="token number">17</span> <span class="token number">11</span>:14 anaconda-ks.cfg
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">16418584</span> Jan <span class="token number">17</span>  <span class="token number">2023</span> proxysql-2.4.6-1-centos7.x86_64.rpm
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># rpm -ivh proxysql-2.4.6-1-centos7.x86_64.rpm </span>
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start proxysql</span>
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status proxysql</span>
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># netstat -tnulp|grep proxysql</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:6032            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">48566</span>/proxysql      
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:6033            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">48566</span>/proxysql 

<span class="token number">6032</span>：
	管理端口：访问此端口，可以对proxysql服务进行配置；<span class="token punctuation">(</span>管理员管理端口,管理用的<span class="token punctuation">)</span>
<span class="token number">6033</span>：
	业务端口：访问此端口，可以实现中间件服务的读写分离<span class="token punctuation">(</span>对外提供服务端口,应用程序连接此端口<span class="token punctuation">)</span>

<span class="token comment"># 登录proxySQL  看到的是一个类似于数据库的界面，proxysql管理界面（可以动态调整中间件服务功能）</span>
<span class="token punctuation">[</span>root@db03 bin<span class="token punctuation">]</span><span class="token comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MySQL connection <span class="token function">id</span> is <span class="token number">1</span>
Server version: <span class="token number">5.5</span>.30 <span class="token punctuation">(</span>ProxySQL Admin Module<span class="token punctuation">)</span>

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2023</span>, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>show databases<span class="token punctuation">;</span>
+-----+---------------+-------------------------------------+
<span class="token operator">|</span> <span class="token function">seq</span> <span class="token operator">|</span> name          <span class="token operator">|</span> <span class="token function">file</span>                                <span class="token operator">|</span>
+-----+---------------+-------------------------------------+
<span class="token operator">|</span> <span class="token number">0</span>   <span class="token operator">|</span> main          <span class="token operator">|</span>                                     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span> disk          <span class="token operator">|</span> /var/lib/proxysql/proxysql.db       <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span> stats         <span class="token operator">|</span>                                     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>   <span class="token operator">|</span> monitor       <span class="token operator">|</span>                                     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>   <span class="token operator">|</span> stats_history <span class="token operator">|</span> /var/lib/proxysql/proxysql_stats.db <span class="token operator">|</span>
+-----+---------------+-------------------------------------+
<span class="token number">5</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token comment"># main  重点关注</span>
<span class="token comment"># disk      表示持久化的磁盘配置信息（持久化的磁盘的配置 ）</span>
<span class="token comment"># stats     表示统计信息的汇总 （分析读写分离状态情况）（统计信息的汇总 ）</span>
<span class="token comment"># monitor   表示监控收集的信息，比如数据库的监控状态等（监控的收集信息，比如数据库的健康状态等 ）</span>
<span class="token comment"># stats_history    表示收集的有关软件内部功能的历史指标</span>

db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>use main
Reading table information <span class="token keyword">for</span> completion of table and <span class="token function">column</span> names
You can turn off this feature to get a quicker startup with <span class="token parameter variable">-A</span>

Database changed
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>show tables<span class="token punctuation">;</span>
+----------------------------------------------------+
<span class="token operator">|</span> tables                                             <span class="token operator">|</span>
+----------------------------------------------------+
<span class="token operator">|</span> global_variables                                   <span class="token operator">|</span>
<span class="token operator">|</span> mysql_aws_aurora_hostgroups                        <span class="token operator">|</span>
<span class="token punctuation">..</span>. 
mysql_servers      表示后端可以连接mysql服务器的列表
mysql_users        表示配置后端数据库的连接账号和监控账号
mysql_query_rules  表示指定query路由到后端不同服务器的规则列表
mysql_replication_hostgroups      表示节点分组配置信息，可以配置多个写或读节点到一个组中 


默认情况下，上面的四张表中都是没有任何数据的。
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from mysql_servers<span class="token punctuation">;</span> 后端可以连接MySQL服务器的列表
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from mysql_replication_hostgroups<span class="token punctuation">;</span>  读写节点分组配置信息
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select username,password,default_hostgroup from mysql_users<span class="token punctuation">;</span>  配置后端数据库的账号和监控的账号。
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

指定Query路由到后端不同服务器的规则列表。
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select rule_id,active,match_pattern,destination_hostgroup from mysql_query_rules<span class="token punctuation">;</span>
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

ProxySQL管理接口的多层配置关系
层次一：运行时部分   使加载的配置信息立即生效
层次二：内存部分     编写中间件服务配置信息（修改配置表）
层次三：磁盘部分     将配置信息持久化保存
PS：当由上到下，进行数据迁移时，会应用save做保存；当由下到上，进行数据迁移时，会应用load做加载

RUNTIME ： 
	代表ProxySQL当前正在使用的配置，无法直接修改此配置，必须要从下一层（MEM层）load进来。 
MEMORY： 
	MEMORY层上面连接RUNTIME层，下面连接disk持久层。这层可以在线操作ProxySQL 配置，随便修改，不会影响生产环境。确认正常之后在加载到RUNTIME和持久化磁盘上。
	修改方法： 使用SQL DML语句：insert、update、delete、select。
DISK和CONFIG FILE：
	持久化配置信息。重启时，可以从磁盘快速加载回来。
	
	
日常配置其实大部分时间在MEM层配置，
然后load到RUNTIME，然后SAVE到Disk。cfg很少使用。

常见命令： 
使用SQL DML语句修改：insert、update、delete、select。

使用LOAD,SAVE生效和保存。
load xxx to runtime<span class="token punctuation">;</span>
save xxx to disk<span class="token punctuation">;</span>
XXX就是上面配置里关键字部分

注意：
	所有配置保存MEM或disk层时，都不会发生任何警告或错误。
	只有load到runtime状态时才会验证配置。当load到 runtime时，如果出现错误，将恢复为之前保存的状态，这时可以去检查错误日志。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><p><img src="/devops/public/assets/img/1730948150083.d9e8bbfa.png" alt="1730948150083"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>MySQL从库要设定read_only参数

主从复制的从库应该禁止用户写入。

ProxySQL如何判断主从（根据是否有read-only<span class="token operator">=</span><span class="token number">1</span>）
read-only<span class="token operator">=</span><span class="token number">1</span> 就是从，否则就是主。
将51设置为read-only<span class="token operator">=</span><span class="token number">0</span>
将52,53设置为read-only<span class="token operator">=</span><span class="token number">1</span>

db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select @@read_only<span class="token punctuation">;</span>
+-------------+
<span class="token operator">|</span> @@read_only <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>
+-------------+

db02 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select @@read_only<span class="token punctuation">;</span>
+-------------+
<span class="token operator">|</span> @@read_only <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>           <span class="token number">1</span> <span class="token operator">|</span>
+-------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select @@read_only<span class="token punctuation">;</span>
+-------------+
<span class="token operator">|</span> @@read_only <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>           <span class="token number">1</span> <span class="token operator">|</span>
+-------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


在mysql_replication_hostgroup表中，
配置读写组编号
<span class="token number">10</span>编号对应就是写库的组，20编号对应的就是读库的组。
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span>
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>use main<span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>insert into mysql_replication_hostgroups <span class="token punctuation">(</span>writer_hostgroup,reader_hostgroup,comment<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">10,20</span>,<span class="token string">'malu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from mysql_replication_hostgroups<span class="token punctuation">;</span>
+------------------+------------------+------------+---------+
<span class="token operator">|</span> writer_hostgroup <span class="token operator">|</span> reader_hostgroup <span class="token operator">|</span> check_type <span class="token operator">|</span> comment <span class="token operator">|</span>
+------------------+------------------+------------+---------+
<span class="token operator">|</span> <span class="token number">10</span>               <span class="token operator">|</span> <span class="token number">20</span>               <span class="token operator">|</span> read_only  <span class="token operator">|</span> malu    <span class="token operator">|</span>
+------------------+------------------+------------+---------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token comment">#从runtime_mysql_replication_hostgroups 这个表中查的时，还是空的。</span>
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from runtime_mysql_replication_hostgroups <span class="token punctuation">;</span>
Empty <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>load mysql servers to runtime<span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from runtime_mysql_replication_hostgroups <span class="token punctuation">;</span>
+------------------+------------------+------------+---------+
<span class="token operator">|</span> writer_hostgroup <span class="token operator">|</span> reader_hostgroup <span class="token operator">|</span> check_type <span class="token operator">|</span> comment <span class="token operator">|</span>
+------------------+------------------+------------+---------+
<span class="token operator">|</span> <span class="token number">10</span>               <span class="token operator">|</span> <span class="token number">20</span>               <span class="token operator">|</span> read_only  <span class="token operator">|</span> malu    <span class="token operator">|</span>
+------------------+------------------+------------+---------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>save mysql servers to disk<span class="token punctuation">;</span>

<span class="token comment"># 可以再查看一次</span>
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from mysql_replication_hostgroups<span class="token punctuation">\</span>G<span class="token punctuation">;</span>
*************************** <span class="token number">1</span>. row ***************************
writer_hostgroup: <span class="token number">10</span>
reader_hostgroup: <span class="token number">20</span>
      check_type: read_only
         comment: malu
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

说明：
	ProxySQL会根据server的read_only的取值将服务器进行分组。
	<span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">0</span>的server，master被分到编号为10的写组，
	<span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span>的server，slave则被分到编号20的读组。
	所以需要将从库设置：set global <span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	
-------------------  到此第1张表就配置完毕了！

添加主机到ProxySQL
insert into mysql_servers<span class="token punctuation">(</span>hostgroup_id,hostname,port<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">10</span>,<span class="token string">'10.0.0.50'</span>,3306<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into mysql_servers<span class="token punctuation">(</span>hostgroup_id,hostname,port<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">20</span>,<span class="token string">'10.0.0.51'</span>,3306<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into mysql_servers<span class="token punctuation">(</span>hostgroup_id,hostname,port<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">20</span>,<span class="token string">'10.0.0.52'</span>,3306<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into mysql_servers<span class="token punctuation">(</span>hostgroup_id,hostname,port<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">20</span>,<span class="token string">'10.0.0.53'</span>,3306<span class="token punctuation">)</span><span class="token punctuation">;</span>

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from mysql_servers<span class="token punctuation">;</span>
+--------------+-----------+------+-----------+--------+--------+-----------------+
<span class="token operator">|</span> hostgroup_id <span class="token operator">|</span> <span class="token function">hostname</span>  <span class="token operator">|</span> port <span class="token operator">|</span> gtid_port <span class="token operator">|</span> status <span class="token operator">|</span> weight <span class="token operator">|</span> max_connections <span class="token operator">|</span>
+--------------+-----------+------+-----------+--------+--------+-----------------+
<span class="token operator">|</span> <span class="token number">10</span>           <span class="token operator">|</span> <span class="token number">10.0</span>.0.50<span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span> <span class="token number">0</span>         <span class="token operator">|</span> ONLINE <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">1000</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>           <span class="token operator">|</span><span class="token number">10.0</span>.51 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span> <span class="token number">0</span>         <span class="token operator">|</span> ONLINE <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">1000</span>             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>           <span class="token operator">|</span> <span class="token number">10.0</span>.0.52 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span> <span class="token number">0</span>         <span class="token operator">|</span> ONLINE <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">1000</span>            <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">20</span>           <span class="token operator">|</span> <span class="token number">10.0</span>.0.53 <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span> <span class="token number">0</span>         <span class="token operator">|</span> ONLINE <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">1000</span>            <span class="token operator">|</span>
+--------------+-----------+------+-----------+--------+--------+-----------------+

db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>load mysql servers to runtime<span class="token punctuation">;</span>
db03 <span class="token punctuation">[</span>main<span class="token punctuation">]</span><span class="token operator">&gt;</span>save mysql servers to disk<span class="token punctuation">;</span>


-------------------  到此第2表就配置完毕了！查看如下：
疑问：mysql_servers表中内容加载到runtime_mysql_servers表之后，为什么表中信息会自动变化？
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br></div></div><p><img src="/devops/public/assets/img/1730950659164.b9729afd.png" alt="1730950659164"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>创建监控用户，并开启监控  global_variables

<span class="token number">51</span>主库创建监控用户，给ProxySQL连接
create user monitor@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span>
grant replication client on *.* to monitor@<span class="token string">'%'</span><span class="token punctuation">;</span> 

proxySQL库修改variables表，让proxySQL可以通过monitor用户和123456连接和监控数据库
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span>
db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>use admin
db03 <span class="token punctuation">[</span>admin<span class="token punctuation">]</span><span class="token operator">&gt;</span>show tables<span class="token punctuation">;</span>
+----------------------------------------------------+
<span class="token operator">|</span> tables                                             <span class="token operator">|</span>
+----------------------------------------------------+
<span class="token operator">|</span> global_variables                                   <span class="token operator">|</span>

db03 <span class="token punctuation">[</span>admin<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from global_variables<span class="token punctuation">;</span>
<span class="token punctuation">..</span>.
<span class="token operator">|</span> mysql-monitor_username              <span class="token operator">|</span> monitor                                    <span class="token operator">|</span>
<span class="token operator">|</span> mysql-monitor_password              <span class="token operator">|</span> monitor                                    <span class="token operator">|</span>
<span class="token punctuation">..</span>.

修改之：
<span class="token builtin class-name">set</span> mysql-monitor_username<span class="token operator">=</span><span class="token string">'monitor'</span><span class="token punctuation">;</span>
<span class="token builtin class-name">set</span> mysql-monitor_password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">;</span>

或者 ： 
UPDATE global_variables SET <span class="token assign-left variable">variable_value</span><span class="token operator">=</span><span class="token string">'monitor'</span>
WHERE <span class="token assign-left variable">variable_name</span><span class="token operator">=</span><span class="token string">'mysql-monitor_username'</span><span class="token punctuation">;</span>
UPDATE global_variables SET <span class="token assign-left variable">variable_value</span><span class="token operator">=</span><span class="token string">'123456
WHERE variable_name='</span>mysql-monitor_password'<span class="token punctuation">;</span>

db03 <span class="token punctuation">[</span>admin<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from global_variables<span class="token punctuation">;</span>
<span class="token punctuation">..</span>.
<span class="token operator">|</span> mysql-monitor_username              <span class="token operator">|</span> monitor                                    <span class="token operator">|</span>
<span class="token operator">|</span> mysql-monitor_password              <span class="token operator">|</span> <span class="token number">123456</span>                               <span class="token operator">|</span>
<span class="token punctuation">..</span>.

或者这样查看：
db03 <span class="token punctuation">[</span>admin<span class="token punctuation">]</span><span class="token operator">&gt;</span>select @@mysql-monitor_username<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
@@mysql-monitor_username: monitor
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

db03 <span class="token punctuation">[</span>admin<span class="token punctuation">]</span><span class="token operator">&gt;</span>select @@mysql-monitor_password<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
@@mysql-monitor_password: <span class="token number">123456</span>
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

load mysql variables to runtime<span class="token punctuation">;</span>
save mysql variables to disk<span class="token punctuation">;</span>

---------------------------------- 第3张表搞定

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p><img src="/devops/public/assets/img/1730951410768.57af1bd4.png" alt="1730951410768"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>疑问01：mysql_servers表中内容加载到runtime_mysql_servers表之后，为什么表中信息会自动变化？
因为此时，没有设置监控用户，无法监控到后端节点情况，默认认为后端节点都为读节点

在进行监控时，会采集check_type列中变量信息（read_only），若read_only<span class="token operator">=</span><span class="token number">0</span>，表示此节点可以为写节点；若read_only<span class="token operator">=</span><span class="token number">1</span>, 表示此节点只能为读节点
db01      主库  <span class="token builtin class-name">set</span> global <span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
db02 db03 从库  <span class="token builtin class-name">set</span> global <span class="token assign-left variable">read_only</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql_users （设置连接后端应用用户）
create user root2@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'123456'</span><span class="token punctuation">;</span>
grant all on *.* to root2@<span class="token string">'%'</span><span class="token punctuation">;</span>
-- 在后端db01-51主库中创建应用用户


<span class="token comment"># proxysql代理</span>
insert into mysql_users<span class="token punctuation">(</span>username,password,default_hostgroup<span class="token punctuation">)</span> values<span class="token punctuation">(</span><span class="token string">'root2'</span>,<span class="token string">'123456'</span>,10<span class="token punctuation">)</span><span class="token punctuation">;</span>
load mysql <span class="token function">users</span> to runtime<span class="token punctuation">;</span>
save mysql <span class="token function">users</span> to disk<span class="token punctuation">;</span>

db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>select username,password,active,default_hostgroup,max_connections from mysql_users<span class="token punctuation">;</span>
+----------+----------+--------+-------------------+-----------------+
<span class="token operator">|</span> username <span class="token operator">|</span> password <span class="token operator">|</span> active <span class="token operator">|</span> default_hostgroup <span class="token operator">|</span> max_connections <span class="token operator">|</span>
+----------+----------+--------+-------------------+-----------------+
<span class="token operator">|</span> root2    <span class="token operator">|</span> <span class="token number">123456</span>   <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span> <span class="token number">10</span>                <span class="token operator">|</span> <span class="token number">10000</span>           <span class="token operator">|</span>
+----------+----------+--------+-------------------+-----------------+

---------------------------------- 第4张表搞定
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>配置读写规则路由表mysql_query_rules
insert into mysql_query_rules<span class="token punctuation">(</span>rule_id,active,match_pattern,destination_hostgroup,apply<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">1,1</span>,<span class="token string">'^select.*for update$'</span>,10,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into mysql_query_rules<span class="token punctuation">(</span>rule_id,active,match_pattern,destination_hostgroup,apply<span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">2,1</span>,<span class="token string">'^select'</span>,20,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
默认策略，将以上没有匹配到的语句，自动划分到写组

load mysql query rules to runtime<span class="token punctuation">;</span>
save mysql query rules to disk<span class="token punctuation">;</span>

---------------------------------- 第5张表搞定
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-读写分离功能测试"><a href="#_3-读写分离功能测试" class="header-anchor">#</a> 3，读写分离功能测试</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>写操作--主库 
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot2 -p123456 -P6033 -h127.0.0.1 -e &quot;begin;select @@server_id;commit&quot;;</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">51</span> <span class="token operator">|</span>
+-------------+

读操作--主库/从库（负载均衡）
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot2 -p123456 -P6033 -h127.0.0.1 -e &quot;select @@server_id;commit&quot;;</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">52</span> <span class="token operator">|</span>
+-------------+
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot2 -p123456 -P6033 -h127.0.0.1 -e &quot;select @@server_id;commit&quot;;</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">53</span> <span class="token operator">|</span>
+-------------+
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot2 -p123456 -P6033 -h127.0.0.1 -e &quot;select @@server_id;commit&quot;;</span>
mysql: <span class="token punctuation">[</span>Warning<span class="token punctuation">]</span> Using a password on the <span class="token builtin class-name">command</span> line interface can be insecure.
+-------------+
<span class="token operator">|</span> @@server_id <span class="token operator">|</span>
+-------------+
<span class="token operator">|</span>          <span class="token number">51</span> <span class="token operator">|</span>
+-------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="十三-redis"><a href="#十三-redis" class="header-anchor">#</a> 十三，redis</h2> <h3 id="_1-什么是redis"><a href="#_1-什么是redis" class="header-anchor">#</a> 1，什么是redis</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>简历: 熟练NoSQL数据库Redis主从/哨兵集群原理及应用。

Redis分布式缓存集群技术<span class="token punctuation">(</span>也支持持久化<span class="token punctuation">)</span>,是关系型数据库的<span class="token punctuation">[</span>互补产品<span class="token punctuation">]</span>。
特点:追求高性能<span class="token punctuation">\</span>高并发, 对数据安全一致性要求比数据库要差一些。

Redis在集群架构中的角色及工作流程
<span class="token number">1</span>）内存缓存功能
	 <span class="token number">1</span>.关系数据库的缓存
	 <span class="token number">2</span>.集群后端共享session（保持会话）
	 
<span class="token number">2</span>）独立做数据库：用于一些简单的业务
	 <span class="token number">3</span>.粉丝关注业务
	 <span class="token number">4</span>.排行榜<span class="token punctuation">(</span>音乐<span class="token punctuation">\</span>游戏<span class="token punctuation">)</span>
	 
数据库产品介绍
RDBMS（关系型数据库）：MySQL，Orcal，PG<span class="token punctuation">..</span><span class="token punctuation">..</span>
NoSQL（非关系型数据库）：Redis，MongoDB，ES<span class="token punctuation">..</span>.
NewSQL：分布式数据库，国产的<span class="token punctuation">..</span>.

Redis数据存储：
缓存产品，数据存储形式是key--<span class="token operator">&gt;</span>value。key-value缓存产品还有一些其它的：
memcached  纯内存数据库，无持久化
redis   内存+持久化   胜出
ttserver  内存+持久化  日本人开发的
Tair 阿里巴巴  国产的
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_2-安装redis"><a href="#_2-安装redis" class="header-anchor">#</a> 2，安装redis</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>环境还是：51  <span class="token number">52</span>   <span class="token number">53</span>

停止msyql:
<span class="token punctuation">[</span>root@db03-51 ~<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server stop</span>
Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span>. SUCCESS<span class="token operator">!</span> 
<span class="token punctuation">[</span>root@db03-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp | grep 3306</span>
<span class="token punctuation">[</span>root@db03-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>


<span class="token punctuation">[</span>root@db03-52 ~<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server stop</span>
Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span>. SUCCESS<span class="token operator">!</span> 
<span class="token punctuation">[</span>root@db03-52 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp | grep 3306</span>
<span class="token punctuation">[</span>root@db03-52 ~<span class="token punctuation">]</span><span class="token comment"># </span>


<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysql.server stop</span>
Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span>. SUCCESS<span class="token operator">!</span> 
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp | grep 3306</span>
<span class="token punctuation">[</span>root@db03-53 ~<span class="token punctuation">]</span><span class="token comment"># </span>

----------------------------------------

<span class="token number">1</span>）下载：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cd ~</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># wget http://download.redis.io/releases/redis-3.2.12.tar.gz</span>

<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ll redis-3.2.12.tar.gz </span>
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1551468</span> Aug  <span class="token number">1</span> <span class="token number">15</span>:19 redis-3.2.12.tar.gz

<span class="token number">2</span>）解压：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># tar xf redis-3.2.12.tar.gz</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># mv redis-3.2.12 /usr/local/redis</span>

<span class="token number">3</span>）安装：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install gcc automake autoconf libtool make</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cd /usr/local/redis</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># make</span>

<span class="token number">4</span>）配置环境变量：/usr/local/redis/src
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cat&gt;&gt;/etc/profile&lt;&lt;'EOF' </span>
<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/redis/src:<span class="token environment constant">$PATH</span>
<span class="token operator">&gt;</span> EOF

-------- 大家copy下面这个
cat<span class="token operator">&gt;&gt;</span>/etc/profile<span class="token operator">&lt;&lt;</span><span class="token string">'EOF' 
export PATH=/usr/local/redis/src:$PATH
EOF</span>
-------- 

<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># tail -1 /etc/profile</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/redis/src:<span class="token environment constant">$PATH</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># source /etc/profile</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># echo $PATH</span>
/usr/local/redis/src:/usr/local/mongodb/bin:/usr/local/mongodb/bin:/usr/local/mongodb/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/usr/local/mysql/bin:/usr/local/mysql/bin
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token number">5</span><span class="token punctuation">)</span>启动redis：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-server &amp;</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 6379</span>
或
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># netstat -tnulp|grep 6379</span>

<span class="token number">6</span><span class="token punctuation">)</span>启动警告处理：
<span class="token builtin class-name">echo</span> <span class="token string">'511'</span> <span class="token operator">&gt;</span> /proc/sys/net/core/somaxconn
<span class="token builtin class-name">echo</span> never <span class="token operator">&gt;</span> /sys/kernel/mm/transparent_hugepage/enabled
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>

<span class="token comment">##以上两条放入/etc/rc.local</span>
<span class="token punctuation">[</span>root@db01 /usr/local/redis<span class="token punctuation">]</span><span class="token comment"># vim /etc/rc.local</span>
<span class="token builtin class-name">echo</span> <span class="token string">'511'</span> <span class="token operator">&gt;</span> /proc/sys/net/core/somaxconn
<span class="token builtin class-name">echo</span> never <span class="token operator">&gt;</span> /sys/kernel/mm/transparent_hugepage/enabled
<span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>

<span class="token builtin class-name">echo</span> <span class="token string">'vm.overcommit_memory = 1'</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;*    -    nofile  65535&quot;</span> <span class="token operator">&gt;&gt;</span>/etc/security/limits.conf  <span class="token comment">#永久生效</span>

---------------

<span class="token comment"># 强制关闭redis</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># kill -9 14862</span>

<span class="token number">7</span><span class="token punctuation">)</span>连接测试：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 6379</span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>       *:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14881</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">))</span></span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:6379               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14881</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> jiahua <span class="token number">20</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get jiahua
<span class="token string">&quot;20&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><h3 id="_3-配置多实例"><a href="#_3-配置多实例" class="header-anchor">#</a> 3，配置多实例</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 停止redis</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 6379</span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>       *:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14881</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">))</span></span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:6379               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14881</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># kill -9 14881</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 6379</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>+  Killed                  redis-server
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token number">1</span>）创建数据文件目录
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /data/6379 -p</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token number">2</span>）生成配置文件
<span class="token function">cat</span> <span class="token operator">&gt;</span> /data/6379/redis.conf<span class="token operator">&lt;&lt;</span><span class="token string">EOF
daemonize yes
port 6379
logfile /data/6379/redis.log
dir /data/6379
dbfilename dump.rdb
EOF</span>

<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cat /data/6379/redis.conf </span>
daemonize <span class="token function">yes</span>
port <span class="token number">6379</span>
logfile /data/6379/redis.log
<span class="token function">dir</span> /data/6379
dbfilename dump.rdb
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token number">3</span>）配置文件说明
daemonize <span class="token function">yes</span>               <span class="token comment">#是否后台运行</span>
port <span class="token number">6379</span>                   <span class="token comment">#默认端口</span>
logfile /var/log/redis.log  <span class="token comment">#日志文件位置</span>
<span class="token function">dir</span> /data/6379              <span class="token comment">#持久化文件存储位置</span>
dbfilename dump.rdb         <span class="token comment">#RDB持久化数据文件</span>

<span class="token number">4</span>）重启：
<span class="token comment">#关闭</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli shutdown</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp | grep 6379</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#启动</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-server /data/6379/redis.conf </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 6379</span>

<span class="token comment">#测试：</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli  </span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name sy
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;sy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exit</span>

<span class="token comment"># 使用systemd管理redis</span>
<span class="token number">1</span><span class="token punctuation">)</span>关闭
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli shutdown</span>

<span class="token number">2</span><span class="token punctuation">)</span>创建用户并授权
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># useradd redis -M -s /sbin/nologin</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># chown -R redis:redis /data/63*</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token number">3</span><span class="token punctuation">)</span>生成启动文件
<span class="token function">cat</span> <span class="token operator">&gt;</span>/usr/lib/systemd/system/redis6379.service<span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Redis persistent key-value database
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
ExecStart=/usr/local/redis/src/redis-server /data/6379/redis.conf --supervised systemd
ExecStop=/usr/local/redis/src/redis-cli shutdown
Type=notify
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token number">4</span><span class="token punctuation">)</span>设置开机自启动，并启动检查
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable redis6379</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/redis6379.service to /usr/lib/systemd/system/redis6379.service.
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start redis6379</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 637</span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>       *:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14943</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">))</span></span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:6379               <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14943</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment"># 测试：</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name sy
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;sy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis安全配置
redis默认开启了保护模式，只允许<span class="token punctuation">[</span>本地回环地址<span class="token punctuation">]</span>登录并访问数据库。

<span class="token comment">#protected-mode</span>
protected-mode <span class="token function">yes</span> <span class="token comment">#保护模式，是否只允许本地访问</span>

取消：CONFIG SET protected-mode no

<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cat /data/6379/redis.conf </span>
daemonize <span class="token function">yes</span>
port <span class="token number">6379</span>
logfile /data/6379/redis.log
<span class="token function">dir</span> /data/6379
dbfilename dump.rdb
protected-mode no
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

-----------------------------

Bind :指定IP进行监听
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># vim /data/6379/redis.conf</span>
<span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.51  <span class="token number">127.0</span>.0.1
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 63</span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">127.0</span>.0.1:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14977</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">))</span></span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">10.0</span>.0.51:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14977</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

-----------------------------

增加requirepass  <span class="token punctuation">{</span>password<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># vim /data/6379/redis.conf</span>
requirepass <span class="token number">123</span>

-----------------------------

<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># cat /data/6379/redis.conf </span>
daemonize <span class="token function">yes</span>
port <span class="token number">6379</span>
logfile /data/6379/redis.log
<span class="token function">dir</span> /data/6379
dbfilename dump.rdb
protected-mode no
<span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.51 <span class="token number">127.0</span>.0.1
requirepass <span class="token number">123</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

-----------------------------

重启：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli shutdown</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-server /data/6379/redis.conf </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># ss -tnulp|grep 63</span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">127.0</span>.0.1:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14991</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">))</span></span>
tcp    LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">10.0</span>.0.51:6379                  *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;redis<span class="token operator">-</span>server&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14991</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>

-----------------------------
验证：
方法一：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli </span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name jh
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required.
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required.
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name jh
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;jh&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

方法二：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> age <span class="token number">18</span>
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required.
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> auth <span class="token number">123</span>  <span class="token comment">#####授权登录</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> age <span class="token number">18</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get age
<span class="token string">&quot;18&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

方法三：
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123 -h 10.0.0.51 -p 6379</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name yj
OK
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;yj&quot;</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

也可以使用一些可视化软件连接。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><h3 id="_4-在线查看和修改参数"><a href="#_4-在线查看和修改参数" class="header-anchor">#</a> 4，在线查看和修改参数</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>参数修改：
<span class="token number">1</span>）配置文件。
<span class="token number">2</span>）在线查看和修改参数

<span class="token comment">#在线查看</span>
CONFIG GET *    <span class="token comment">##总共有70个参数</span>
CONFIG GET pro*

<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config get pro*
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;protected-mode&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;no&quot;</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

在线设置密码:
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> requirepass malu123
OK
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>root@db01-51 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 10.0.0.51 -p 6379 -a 123</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name yj
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required.
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> auth malu123
OK
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name yj
OK
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

配置文件详解：
https://www.cnblogs.com/WarBlog/p/15249895.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_5-redis持久化-内存数据保存到磁盘"><a href="#_5-redis持久化-内存数据保存到磁盘" class="header-anchor">#</a> 5，redis持久化（内存数据保存到磁盘）</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis持久化方式：RDB、AOF

<span class="token number">1</span>）RDB持久化
类似innodb 快照备份.
	在指定时间间隔内生成数据集的时间点快照（point-in-time snapshot）。
    优点：速度快，适合于用做备份，主从复制也是基于RDB持久化功能实现的。
    缺点：可能会有数据丢失
    
rdb持久化核心配置参数：
<span class="token function">vim</span> /data/6379/redis.conf
<span class="token function">dir</span> /data/6379
dbfilename dump.rdb
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
save <span class="token number">900</span> <span class="token number">1</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
配置分别表示：
<span class="token number">900</span>秒（15分钟）内有1个更改
<span class="token number">300</span>秒（5分钟）内有10个更改
<span class="token number">60</span>秒内有10000个更改

<span class="token comment">################################ 快照 #################################</span>
<span class="token comment">#</span>
<span class="token comment"># 保存数据到磁盘，格式如下:</span>
<span class="token comment">#</span>
<span class="token comment"># save &lt;seconds&gt; &lt;changes&gt;</span>
<span class="token comment">#</span>
<span class="token comment"># 指出在多长时间内，有多少次更新操作，就将数据同步到数据文件rdb。</span>
<span class="token comment"># 相当于条件触发抓取快照，这个可以多个条件配合</span>
<span class="token comment">#</span>
<span class="token comment"># 比如默认配置文件中的设置，就设置了三个条件</span>
<span class="token comment">#</span>
<span class="token comment"># 每 900 秒（15 分钟）至少有 1 次写操作时会生成一次 RDB 快照。</span>
<span class="token comment"># 每 300 秒（5 分钟）至少有 10 次写操作时会生成一次 RDB 快照。</span>
<span class="token comment"># 每 60 秒至少有 10000 次写操作时会生成一次 RDB 快照。</span>

save <span class="token number">900</span> <span class="token number">1</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span>
<span class="token comment">################################ 快照 #################################</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">2</span>）AOF持久化<span class="token punctuation">(</span>append-only log <span class="token function">file</span><span class="token punctuation">)</span>
    类似mysql的binlog
	记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。 
    AOF文件中的命令全部以Redis协议格式来保存，新命令会被追加到文件的末尾。
    
    优点：可以最大程度保证数据不丢
    缺点：日志记录量级比较大
    
AOF持久化配置参数：
appendonly <span class="token function">yes</span>       <span class="token comment">#是否打开aof日志功能</span>
<span class="token comment">######################</span>
appendfsync always   <span class="token comment">#每1个更新,都立即同步到aof。*****</span>
appendfsync everysec <span class="token comment">#每秒同步一次数据到aof。</span>
appendfsync no       <span class="token comment">#写入工作交给操作系统,由操作系统判断缓冲区大小,统一写入到aof.</span>


配置：
<span class="token function">vim</span> /data/6379/redis.conf
appendonly <span class="token function">yes</span>
appendfsync always 

面试题：redis持久化方式有哪些？有什么区别？
	rdb：基于快照持久化，速度更快，一般用作备份，主从复制也是依赖于rdb持久化功能
	aof：以追加方式记录redis操作日志的文件。可以最大程度的保证redis数据安全，类似于mysql的binlog,可以每个更新记录,每秒记录。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-数据类型"><a href="#_6-数据类型" class="header-anchor">#</a> 6，数据类型</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Redis的数据类型非常丰富

String ：      字符类型
Hash：         字典类型
List：         列表     
Set：          集合 
Sorted set：   有序集合
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>KEY的通用操作
SET                         <span class="token comment">#设置键值对 类似MySQL insert</span>
GET                         <span class="token comment">#获取键值   类似MySQL select</span>
DEL							<span class="token comment">#删除一个key   类似MySQL delete</span>

KEYS * 	 keys a  keys a*	<span class="token comment">#查看已存在所有键的名字   **** 类似MySQL select like '%%';</span>
TYPE						<span class="token comment">#返回键所存储值的类型     ****</span>
EXPIRE<span class="token punctuation">\</span>PEXPIRE 			    <span class="token comment">#以秒\毫秒设定生存时间    ***</span>
TTL<span class="token punctuation">\</span>PTTL 					<span class="token comment">#以秒\毫秒为单位返回生存时间 ***</span>
PERSIST 					<span class="token comment">#取消生存时间设置            ***</span>
EXISTS 				        <span class="token comment">#检查key是否存在  类似-e,-f,-d</span>
RENAME 				        <span class="token comment">#变更KEY名</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name sy
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;sy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> expire name <span class="token number">30</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">26</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">22</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">7</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;sy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name yj ex <span class="token number">60</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">54</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">46</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> persist name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token parameter variable">-1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token parameter variable">-1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;yj&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token string">&quot;yj&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> exists name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">rename</span> name username
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get username
<span class="token string">&quot;yj&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> del username
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get username
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>.字符串类型（string）
基本命令
A、 <span class="token builtin class-name">set</span>
B、 get
C、 incr
D、 decr
E、 append

常用命令
A、 strlen
B、 getrange
C、 setrange
D、 mset
E、 mget

---------------------------------------

<span class="token number">2</span>.哈希类型 <span class="token builtin class-name">hash</span>
基本命令
A、 hset
B、 hget
C、 hmset
D、 hmget
E、 hgetall
F、 hdel

常用命令
A、 hkeys
B、 hvals
C、 hexists

---------------------------------------

<span class="token number">3</span>.列表 list
基本命令
A、 lpush
B、 rpush
C、 lrange
D、 lindex
E、 llen

常用命令
A、 lrem
B、 lset
C、 linsert

---------------------------------------

<span class="token number">4</span>.集合类型 <span class="token builtin class-name">set</span>
基本命令
A、 sadd
B、 smembers
C、 sismember
D、 scard
E、 srem

常用命令
A、 srandmember
B、 spop

---------------------------------------

<span class="token number">5</span>.有序集合类型 zset （sorted set）
基本命令
A、 zadd
B、 zrange
C、 zrevrange
D、 zrem

常用命令
A、 zrangebyscore
B、 zrevrangebyscore
C、 zcount

原文链接：https://blog.csdn.net/qq_44794280/article/details/123557566
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Strings字符类型
<span class="token number">1</span>）应用场景
	a.集群后端session共享
	b.计数：微博数，粉丝数，订阅数、礼物数

<span class="token number">2</span><span class="token punctuation">)</span>数据存在形式
key----<span class="token operator">&gt;</span>value

数据库学生表的2行记录：
<span class="token function">id</span>   name    age  gender
<span class="token number">101</span>  sy       <span class="token number">20</span>    m
<span class="token number">102</span>  <span class="token function">wc</span>       <span class="token number">18</span>    f

----------------------------

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> mset id101 <span class="token number">101</span> name101 sy age101 <span class="token number">20</span> gender101 m
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> mset id102 <span class="token number">102</span> name102 <span class="token function">wc</span> age102 <span class="token number">18</span> gender102 f
OK
等价于以下操作：
<span class="token builtin class-name">set</span> id101 <span class="token number">101</span>
<span class="token builtin class-name">set</span> name101 sy
<span class="token builtin class-name">set</span> age101 <span class="token number">20</span>
<span class="token builtin class-name">set</span> gender101 m

取：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get id101
<span class="token string">&quot;101&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name101
<span class="token string">&quot;sy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get age101
<span class="token string">&quot;20&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get gender101
<span class="token string">&quot;m&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get id102
<span class="token string">&quot;102&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name102
<span class="token string">&quot;wc&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

一次性取多个：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> mget id101 name101 age101 gender101
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;101&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;sy&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;20&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;m&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

----------------------------
计数器（粉丝关注）
每点一次关注，都执行以下命令一次
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incr num
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get num
<span class="token string">&quot;1&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incr num
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incr num
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incr num
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get num
<span class="token string">&quot;4&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

暗箱操作：
增粉：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incrby num <span class="token number">1000</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1004</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get num
<span class="token string">&quot;1004&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

减粉：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> decrby num <span class="token number">500</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">504</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get num
<span class="token string">&quot;504&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>hash类型（字典类型）
<span class="token number">1</span>）应用场景：数据库前端缓存
存储部分变更的数据，如用户信息等。最接近<span class="token punctuation">[</span>mysql表结构的一种类型<span class="token punctuation">]</span>
主要是做<span class="token punctuation">[</span>数据库缓存<span class="token punctuation">]</span>的存储类型。

存数据：
（2）数据库学生表的2行记录：
<span class="token function">id</span>   name    age  gender
<span class="token number">101</span>  sy       <span class="token number">20</span>   m
<span class="token number">102</span>  jh       <span class="token number">21</span>  m
-------------------------------
存：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmset stu1 <span class="token function">id</span> <span class="token number">101</span> name sy age <span class="token number">20</span> gender m
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmset stu2 <span class="token function">id</span> <span class="token number">102</span> name jh age <span class="token number">21</span> gender m
OK

取：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmget stu1 <span class="token function">id</span> name age gender
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;101&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;sy&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;20&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;m&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmget stu2 <span class="token function">id</span> name age gender
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;102&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;jh&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;21&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;m&quot;</span>

案例：模拟redis缓存数据库数据的应用：
<span class="token number">1</span>.初次访问缓存，没有数据，然后请求读MySQL：
db01 <span class="token punctuation">[</span>world<span class="token punctuation">]</span><span class="token operator">&gt;</span>select * from world.city limit <span class="token number">10</span><span class="token punctuation">;</span>
+----+----------------+-------------+---------------+------------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Name           <span class="token operator">|</span> CountryCode <span class="token operator">|</span> District      <span class="token operator">|</span> Population <span class="token operator">|</span>
+----+----------------+-------------+---------------+------------+
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Kabul          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Kabol         <span class="token operator">|</span>    <span class="token number">1780000</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Qandahar       <span class="token operator">|</span> AFG         <span class="token operator">|</span> Qandahar      <span class="token operator">|</span>     <span class="token number">237500</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Herat          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Herat         <span class="token operator">|</span>     <span class="token number">186800</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> Mazar-e-Sharif <span class="token operator">|</span> AFG         <span class="token operator">|</span> Balkh         <span class="token operator">|</span>     <span class="token number">127800</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> Amsterdam      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord-Holland <span class="token operator">|</span>     <span class="token number">731200</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> Rotterdam      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Zuid-Holland  <span class="token operator">|</span>     <span class="token number">593321</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> Haag           <span class="token operator">|</span> NLD         <span class="token operator">|</span> Zuid-Holland  <span class="token operator">|</span>     <span class="token number">440900</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> Utrecht        <span class="token operator">|</span> NLD         <span class="token operator">|</span> Utrecht       <span class="token operator">|</span>     <span class="token number">234323</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> Eindhoven      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord-Brabant <span class="token operator">|</span>     <span class="token number">201843</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> Tilburg        <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord-Brabant <span class="token operator">|</span>     <span class="token number">193238</span> <span class="token operator">|</span>
+----+----------------+-------------+---------------+------------+

<span class="token number">2</span>.通过把取出的语句拼接成redis命令
实际工作<span class="token punctuation">(</span>通过程序处理<span class="token punctuation">)</span>
<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">&quot;hmset city_&quot;</span>,id,<span class="token string">&quot; id &quot;</span>,id,<span class="token string">&quot; name &quot;</span>,name<span class="token punctuation">)</span> from world.city limit <span class="token number">10</span> into outfile <span class="token string">'/tmp/hmset.txt'</span>

<span class="token number">3</span>.拼接成redis操作命令
<span class="token punctuation">[</span>root@db01 ~<span class="token punctuation">]</span><span class="token comment"># cat /tmp/hmset.txt </span>
hmset city_1 <span class="token function">id</span> <span class="token number">1</span> name Kabul
hmset city_2 <span class="token function">id</span> <span class="token number">2</span> name Qandahar
hmset city_3 <span class="token function">id</span> <span class="token number">3</span> name Herat
hmset city_4 <span class="token function">id</span> <span class="token number">4</span> name Mazar-e-Sharif
hmset city_5 <span class="token function">id</span> <span class="token number">5</span> name Amsterdam
hmset city_6 <span class="token function">id</span> <span class="token number">6</span> name Rotterdam
hmset city_7 <span class="token function">id</span> <span class="token number">7</span> name Haag
hmset city_8 <span class="token function">id</span> <span class="token number">8</span> name Utrecht
hmset city_9 <span class="token function">id</span> <span class="token number">9</span> name Eindhoven
hmset city_10 <span class="token function">id</span> <span class="token number">10</span> name Tilburg

<span class="token number">3</span>.把数据库数据缓存到Redis：
<span class="token function">cat</span> /tmp/hmset.txt<span class="token operator">|</span> redis-cli <span class="token parameter variable">-a</span> <span class="token number">123</span> <span class="token parameter variable">-h</span> <span class="token number">10.0</span>.0.51 <span class="token parameter variable">-p</span> <span class="token number">6379</span>

<span class="token number">4</span>.读取Redis缓存返回用户
<span class="token punctuation">[</span>root@db01 redis<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123 -h 10.0.0.51 -p 6379</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmget city_1 <span class="token function">id</span> name
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;Kabul&quot;</span>
<span class="token number">10.0</span>.0.51:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> hmget city_2 <span class="token function">id</span> name
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> &quot;Qandahar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>LIST列表
<span class="token number">1</span>）应用场景
消息队列系统，比如sina微博<span class="token punctuation">\</span>微信朋友圈

微信发朋友圈例子：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lpush wechat <span class="token string">&quot;today is nice day!&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lpush wechat <span class="token string">&quot;today is bad day!&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lpush wechat <span class="token string">&quot;today is good day!&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lpush wechat <span class="token string">&quot;today is rainy day!&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">4</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lpush wechat <span class="token string">&quot;today is friday!&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">5</span>

倒序输出：最新的再上面
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> lrange wechat <span class="token number">0</span> <span class="token number">5</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;today is friday!&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;today is rainy day!&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;today is good day!&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;today is bad day!&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;today is nice day!&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>SET集合类型
类似MySQL join/union

<span class="token number">1</span><span class="token punctuation">)</span>应用场景：
案例：在微博应用中，可以将一个用户所有的关注人存在一个集合中，将其所有粉丝存在一个集合。
Redis还为集合提供了求交集、并集、差集等操作，可以非常方便的实现如共同关注、共同喜好、二度好友等功能，
对上面的所有集合操作，你还可以使用不同的命令选择将结果返回给客户端还是存集到一个新的集合中。

例子：
<span class="token number">2</span><span class="token punctuation">)</span>a,b两人各自的好友
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> sadd a <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> sadd b <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

<span class="token number">3</span><span class="token punctuation">)</span>a和b结婚了摆酒请客 去重   union
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> sunion a b
 <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;0&quot;</span>
 <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
 <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
 <span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;3&quot;</span>
 <span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;4&quot;</span>
 <span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;5&quot;</span>
 <span class="token number">7</span><span class="token punctuation">)</span> <span class="token string">&quot;6&quot;</span>
 <span class="token number">8</span><span class="token punctuation">)</span> <span class="token string">&quot;7&quot;</span>
 <span class="token number">9</span><span class="token punctuation">)</span> <span class="token string">&quot;8&quot;</span>
<span class="token number">10</span><span class="token punctuation">)</span> <span class="token string">&quot;9&quot;</span>

<span class="token number">4</span>）生活中吵架了，找来共同好友说和  取交集 inner <span class="token function">join</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> sinter a b
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;5&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;6&quot;</span>

<span class="token comment">#左边不同的取出</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">sdiff</span> a b
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;3&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;4&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">sdiff</span> b a 
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;0&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;7&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;8&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;9&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>SortedSet（有序集合）
<span class="token number">1</span><span class="token punctuation">)</span>应用场景：排行榜，取TOP N操作

这个需求与上面需求的不同之处在于，前面操作以时间为权重，这个是以某个条件为权重，比如按顶的次数排序，
这时候就需要我们的sorted set出马了，将你要排序的值设置成sorted set的score，将具体的数据设置成相应的value，每次只需要执行一条ZADD命令即可。

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zadd <span class="token function">top</span> <span class="token number">0</span> smlt <span class="token number">0</span> fskl <span class="token number">0</span> fshkl <span class="token number">0</span> lzlsfs <span class="token number">0</span> wdhbx <span class="token number">0</span> wxg 
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zrevrange <span class="token function">top</span> <span class="token number">0</span> <span class="token number">2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;wxg&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;wdhbx&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;smlt&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY <span class="token function">top</span> <span class="token number">1000</span> smlt
<span class="token string">&quot;1000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>  ZINCRBY <span class="token function">top</span> <span class="token number">5000</span> fskl
<span class="token string">&quot;5000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY <span class="token function">top</span> <span class="token number">8000</span> fshkl
<span class="token string">&quot;8000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY <span class="token function">top</span> <span class="token number">9000</span> lzlsfs
<span class="token string">&quot;9000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY <span class="token function">top</span> <span class="token number">6000</span> wdhbx
<span class="token string">&quot;6000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> ZINCRBY <span class="token function">top</span> <span class="token number">3000</span> wxg
<span class="token string">&quot;3000&quot;</span>

排名前三：
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zrevrange <span class="token function">top</span> <span class="token number">0</span> <span class="token number">2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;lzlsfs&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;fshkl&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;wdhbx&quot;</span>

排名前三：显示歌曲名及票数
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> zrevrange <span class="token function">top</span> <span class="token number">0</span> <span class="token number">2</span> withscores
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;lzlsfs&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;9000&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;fshkl&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;8000&quot;</span>
<span class="token number">5</span><span class="token punctuation">)</span> <span class="token string">&quot;wdhbx&quot;</span>
<span class="token number">6</span><span class="token punctuation">)</span> <span class="token string">&quot;6000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_7-redis中的事务"><a href="#_7-redis中的事务" class="header-anchor">#</a> 7，redis中的事务</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>一个事务:
multi 
command1      
command2
<span class="token builtin class-name">exec</span>

事务回滚:
multi 
command1      
command2
discard
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_8-redis中的主从复制"><a href="#_8-redis中的主从复制" class="header-anchor">#</a> 8，redis中的主从复制</h3> <h3 id="_9-redis的高可用-哨兵"><a href="#_9-redis的高可用-哨兵" class="header-anchor">#</a> 9，redis的高可用（哨兵）</h3> <h2 id="十四-mongodb"><a href="#十四-mongodb" class="header-anchor">#</a> 十四，mongodb</h2></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#一-数据库概述" class="sidebar-link reco-side-一-数据库概述" data-v-b57cc07c>一，数据库概述</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-说明" class="sidebar-link reco-side-_1-说明" data-v-b57cc07c>1. 说明</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-概念介绍" class="sidebar-link reco-side-_2-概念介绍" data-v-b57cc07c>2. 概念介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-数据库分类" class="sidebar-link reco-side-_3-数据库分类" data-v-b57cc07c>3. 数据库分类</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-版本" class="sidebar-link reco-side-_4-版本" data-v-b57cc07c>4. 版本</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-优势特点" class="sidebar-link reco-side-_5-优势特点" data-v-b57cc07c>5. 优势特点</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#二-安装" class="sidebar-link reco-side-二-安装" data-v-b57cc07c>二，安装</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-安装方式" class="sidebar-link reco-side-_1-安装方式" data-v-b57cc07c>1. 安装方式</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-下载" class="sidebar-link reco-side-_2-下载" data-v-b57cc07c>2. 下载</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-安装过程" class="sidebar-link reco-side-_3-安装过程" data-v-b57cc07c>3. 安装过程</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#三-基础管理" class="sidebar-link reco-side-三-基础管理" data-v-b57cc07c>三，基础管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-密码管理" class="sidebar-link reco-side-_1-密码管理" data-v-b57cc07c>1. 密码管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-用户管理" class="sidebar-link reco-side-_2-用户管理" data-v-b57cc07c>2. 用户管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-权限管理" class="sidebar-link reco-side-_3-权限管理" data-v-b57cc07c>3. 权限管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-连接管理" class="sidebar-link reco-side-_4-连接管理" data-v-b57cc07c>4. 连接管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-配置管理" class="sidebar-link reco-side-_5-配置管理" data-v-b57cc07c>5. 配置管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_6-多实例" class="sidebar-link reco-side-_6-多实例" data-v-b57cc07c>6. 多实例</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#四-sql" class="sidebar-link reco-side-四-sql" data-v-b57cc07c>四，SQL</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-语句分类" class="sidebar-link reco-side-_1-语句分类" data-v-b57cc07c>1. 语句分类</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-字符设置" class="sidebar-link reco-side-_2-字符设置" data-v-b57cc07c>2. 字符设置</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-数据类型" class="sidebar-link reco-side-_3-数据类型" data-v-b57cc07c>3. 数据类型</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-约束" class="sidebar-link reco-side-_4-约束" data-v-b57cc07c>4. 约束</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-模式概念" class="sidebar-link reco-side-_5-模式概念" data-v-b57cc07c>5. 模式概念</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_6-ddl-库-表" class="sidebar-link reco-side-_6-ddl-库-表" data-v-b57cc07c>6. DDL 库 表</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_7-dml" class="sidebar-link reco-side-_7-dml" data-v-b57cc07c>7. DML</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_8-规范" class="sidebar-link reco-side-_8-规范" data-v-b57cc07c>8.规范</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_9-dql" class="sidebar-link reco-side-_9-dql" data-v-b57cc07c>9.DQL</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_10-子查询" class="sidebar-link reco-side-_10-子查询" data-v-b57cc07c>10.子查询</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_11-查询元数据-了解" class="sidebar-link reco-side-_11-查询元数据-了解" data-v-b57cc07c>11.查询元数据(了解)</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_12-体系结构" class="sidebar-link reco-side-_12-体系结构" data-v-b57cc07c>12. 体系结构</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#五-事务" class="sidebar-link reco-side-五-事务" data-v-b57cc07c>五，事务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-acid" class="sidebar-link reco-side-_1-acid" data-v-b57cc07c>1，ACID</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-事务的生命周期" class="sidebar-link reco-side-_2-事务的生命周期" data-v-b57cc07c>2，事务的生命周期</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-事务的提交方式" class="sidebar-link reco-side-_3-事务的提交方式" data-v-b57cc07c>3，事务的提交方式</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-事务隔离机制" class="sidebar-link reco-side-_4-事务隔离机制" data-v-b57cc07c>4，事务隔离机制</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-mvcc" class="sidebar-link reco-side-_5-mvcc" data-v-b57cc07c>5，MVCC</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_6-隔离机制应用的锁" class="sidebar-link reco-side-_6-隔离机制应用的锁" data-v-b57cc07c>6，隔离机制应用的锁</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#六-索引" class="sidebar-link reco-side-六-索引" data-v-b57cc07c>六，索引</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-什么是索引" class="sidebar-link reco-side-_1-什么是索引" data-v-b57cc07c>1，什么是索引</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-索引crud" class="sidebar-link reco-side-_2-索引crud" data-v-b57cc07c>2，索引CRUD</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-索引创建原则" class="sidebar-link reco-side-_4-索引创建原则" data-v-b57cc07c>4，索引创建原则</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-索引相关面试题" class="sidebar-link reco-side-_5-索引相关面试题" data-v-b57cc07c>5，索引相关面试题</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#七-存储引擎" class="sidebar-link reco-side-七-存储引擎" data-v-b57cc07c>七，存储引擎</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-存储引擎介绍" class="sidebar-link reco-side-_1-存储引擎介绍" data-v-b57cc07c>1，存储引擎介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-存储引擎结构" class="sidebar-link reco-side-_2-存储引擎结构" data-v-b57cc07c>2，存储引擎结构</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-数据恢复" class="sidebar-link reco-side-_3-数据恢复" data-v-b57cc07c>3，数据恢复</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#八-备份与恢复" class="sidebar-link reco-side-八-备份与恢复" data-v-b57cc07c>八，备份与恢复</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-备份概述" class="sidebar-link reco-side-_1-备份概述" data-v-b57cc07c>1，备份概述</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-逻辑备份与恢复" class="sidebar-link reco-side-_2-逻辑备份与恢复" data-v-b57cc07c>2，逻辑备份与恢复</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-mysqldump的参数" class="sidebar-link reco-side-_3-mysqldump的参数" data-v-b57cc07c>3，mysqldump的参数</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-物理备份" class="sidebar-link reco-side-_4-物理备份" data-v-b57cc07c>4，物理备份</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-xbk物理备份-全量备份" class="sidebar-link reco-side-_5-xbk物理备份-全量备份" data-v-b57cc07c>5，xbk物理备份（全量备份）</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_6-xbk物理备份-增量备份" class="sidebar-link reco-side-_6-xbk物理备份-增量备份" data-v-b57cc07c>6，xbk物理备份（增量备份）</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#九-日志" class="sidebar-link reco-side-九-日志" data-v-b57cc07c>九，日志</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-错误日志" class="sidebar-link reco-side-_1-错误日志" data-v-b57cc07c>1，错误日志</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-通用日志" class="sidebar-link reco-side-_2-通用日志" data-v-b57cc07c>2，通用日志</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-二进制日志" class="sidebar-link reco-side-_3-二进制日志" data-v-b57cc07c>3，二进制日志</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#十-主从" class="sidebar-link reco-side-十-主从" data-v-b57cc07c>十，主从</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-传统主从复制-centos7" class="sidebar-link reco-side-_1-传统主从复制-centos7" data-v-b57cc07c>1，传统主从复制（centos7）</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-主从原理" class="sidebar-link reco-side-_2-主从原理" data-v-b57cc07c>2，主从原理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-主从复制监控" class="sidebar-link reco-side-_3-主从复制监控" data-v-b57cc07c>3，主从复制监控</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-主从同步不成功原因分析" class="sidebar-link reco-side-_4-主从同步不成功原因分析" data-v-b57cc07c>4，主从同步不成功原因分析</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-gtid主从复制" class="sidebar-link reco-side-_5-gtid主从复制" data-v-b57cc07c>5，GTID主从复制</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#十一-高可用mha" class="sidebar-link reco-side-十一-高可用mha" data-v-b57cc07c>十一，高可用MHA</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-高可用搭建" class="sidebar-link reco-side-_1-高可用搭建" data-v-b57cc07c>1，高可用搭建</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-高可用测试" class="sidebar-link reco-side-_2-高可用测试" data-v-b57cc07c>2，高可用测试</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-日常维护管理" class="sidebar-link reco-side-_3-日常维护管理" data-v-b57cc07c>3，日常维护管理</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-维护性切换主从" class="sidebar-link reco-side-_4-维护性切换主从" data-v-b57cc07c>4，维护性切换主从</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-用到的脚本" class="sidebar-link reco-side-_5-用到的脚本" data-v-b57cc07c>5，用到的脚本</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#十二-读写分离" class="sidebar-link reco-side-十二-读写分离" data-v-b57cc07c>十二，读写分离</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-读写分离介绍" class="sidebar-link reco-side-_1-读写分离介绍" data-v-b57cc07c>1，读写分离介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-搭建读写分离" class="sidebar-link reco-side-_2-搭建读写分离" data-v-b57cc07c>2，搭建读写分离</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-读写分离功能测试" class="sidebar-link reco-side-_3-读写分离功能测试" data-v-b57cc07c>3，读写分离功能测试</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#十三-redis" class="sidebar-link reco-side-十三-redis" data-v-b57cc07c>十三，redis</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_1-什么是redis" class="sidebar-link reco-side-_1-什么是redis" data-v-b57cc07c>1，什么是redis</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_2-安装redis" class="sidebar-link reco-side-_2-安装redis" data-v-b57cc07c>2，安装redis</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_3-配置多实例" class="sidebar-link reco-side-_3-配置多实例" data-v-b57cc07c>3，配置多实例</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_4-在线查看和修改参数" class="sidebar-link reco-side-_4-在线查看和修改参数" data-v-b57cc07c>4，在线查看和修改参数</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_5-redis持久化-内存数据保存到磁盘" class="sidebar-link reco-side-_5-redis持久化-内存数据保存到磁盘" data-v-b57cc07c>5，redis持久化（内存数据保存到磁盘）</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_6-数据类型" class="sidebar-link reco-side-_6-数据类型" data-v-b57cc07c>6，数据类型</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_7-redis中的事务" class="sidebar-link reco-side-_7-redis中的事务" data-v-b57cc07c>7，redis中的事务</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_8-redis中的主从复制" class="sidebar-link reco-side-_8-redis中的主从复制" data-v-b57cc07c>8，redis中的主从复制</a></li><li class="level-3" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#_9-redis的高可用-哨兵" class="sidebar-link reco-side-_9-redis的高可用-哨兵" data-v-b57cc07c>9，redis的高可用（哨兵）</a></li><li class="level-2" data-v-b57cc07c><a href="/devops/public/blogs/devops/44-dba/day01/day01.html#十四-mongodb" class="sidebar-link reco-side-十四-mongodb" data-v-b57cc07c>十四，mongodb</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/devops/public/assets/js/app.28103306.js" defer></script><script src="/devops/public/assets/js/113.27412706.js" defer></script><script src="/devops/public/assets/js/1.774fca24.js" defer></script><script src="/devops/public/assets/js/91.3ba21402.js" defer></script>
  </body>
</html>
